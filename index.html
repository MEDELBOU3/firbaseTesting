<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Spotify Advanced Music Player</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <style>
        :root {
            --spotify-green: #1DB954;
            --spotify-black: #191414;
            --spotify-dark-gray: #282828;
            --spotify-light-gray: #B3B3B3;
            --spotify-white: #FFFFFF;
        }
        
        body {
            background-color: var(--spotify-black);
            color: var(--spotify-white);
            font-family: 'Gotham', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            min-height: 100vh;
            padding-bottom: 100px;
        }
        
        .navbar-custom {
            background-color: var(--spotify-black);
            border-bottom: 1px solid #333;
        }
        
        .logo {
            height: 40px;
        }
        
        .search-container {
            background-color: var(--spotify-dark-gray);
            border-radius: 10px;
            padding: 20px;
            margin-bottom: 30px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }
        
        .search-input {
            background-color: #333;
            border: none;
            color: var(--spotify-white);
            border-radius: 50px;
            padding: 10px 20px;
        }
        
        .search-input:focus {
            background-color: #444;
            color: var(--spotify-white);
            box-shadow: none;
            border: 1px solid var(--spotify-green);
        }
        
        .search-button {
            background-color: var(--spotify-green);
            color: var(--spotify-black);
            border: none;
            border-radius: 50px;
            padding: 10px 20px;
            font-weight: bold;
            transition: all 0.3s ease;
        }
        
        .search-button:hover {
            background-color: #1ed760;
            transform: scale(1.03);
        }
        
        .track-card {
            background-color: var(--spotify-dark-gray);
            border-radius: 8px;
            overflow: hidden;
            transition: all 0.3s ease;
            margin-bottom: 20px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .track-card:hover {
            transform: translateY(-5px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.5);
        }
        
        .track-info {
            padding: 15px;
        }
        
        .track-title {
            font-weight: bold;
            margin-bottom: 5px;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .track-artist {
            color: var(--spotify-light-gray);
            font-size: 0.9rem;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }
        
        .track-album-img {
            width: 100%;
            aspect-ratio: 1/1;
            object-fit: cover;
        }
        
        .play-button {
            position: absolute;
            bottom: 80px;
            right: 10px;
            background-color: var(--spotify-green);
            color: var(--spotify-black);
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            opacity: 0;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.5);
        }
        
        .track-card:hover .play-button {
            opacity: 1;
            transform: translateY(-10px);
        }
        
        .play-button:hover {
            transform: scale(1.1) translateY(-10px);
            background-color: #1ed760;
        }
        
        .track-image-container {
            position: relative;
        }
        
        .player-container {
            position: fixed;
            bottom: 0;
            left: 0;
            width: 100%;
            background-color: var(--spotify-dark-gray);
            padding: 15px;
            box-shadow: 0 -4px 12px rgba(0, 0, 0, 0.5);
            display: none;
            z-index: 1000;
        }
        
        .currently-playing {
            display: flex;
            align-items: center;
        }
        
        .currently-playing-img {
            width: 60px;
            height: 60px;
            border-radius: 5px;
            margin-right: 15px;
        }
        
        .currently-playing-info {
            flex-grow: 1;
        }
        
        .player-controls {
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .control-button {
            background: none;
            border: none;
            color: var(--spotify-white);
            font-size: 1.2rem;
            margin: 0 10px;
            cursor: pointer;
            transition: all 0.2s ease;
        }
        
        .control-button:hover {
            color: var(--spotify-green);
            transform: scale(1.1);
        }
        
        .play-pause {
            width: 40px;
            height: 40px;
            border-radius: 50%;
            background-color: var(--spotify-white);
            color: var(--spotify-black);
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 15px;
            transition: all 0.2s ease;
        }
        
        .play-pause:hover {
            background-color: var(--spotify-green);
            transform: scale(1.05);
        }
        
        .progress-container {
            margin-top: 10px;
        }
        
        .progress {
            height: 5px;
            background-color: #555;
            border-radius: 50px;
            cursor: pointer;
        }
        
        .progress-bar {
            background-color: var(--spotify-green);
            border-radius: 50px;
        }
        
        .volume-control {
            display: flex;
            align-items: center;
        }
        
        .volume-slider {
            width: 100px;
        }
        
        .loading-animation {
            display: flex;
            justify-content: center;
            align-items: center;
            height: 200px;
        }
        
        .loading-bar {
            width: 4px;
            height: 20px;
            margin: 0 5px;
            background-color: var(--spotify-green);
            border-radius: 2px;
            animation: loading 1s ease-in-out infinite;
        }
        
        .loading-bar:nth-child(1) {
            animation-delay: 0s;
        }
        
        .loading-bar:nth-child(2) {
            animation-delay: 0.1s;
        }
        
        .loading-bar:nth-child(3) {
            animation-delay: 0.2s;
        }
        
        .loading-bar:nth-child(4) {
            animation-delay: 0.3s;
        }
        
        @keyframes loading {
            0% {
                transform: scaleY(0.5);
            }
            50% {
                transform: scaleY(1.2);
            }
            100% {
                transform: scaleY(0.5);
            }
        }
        
        .login-section {
            text-align: center;
            padding: 100px 0;
        }
        
        .login-button {
            background-color: var(--spotify-green);
            color: var(--spotify-white);
            border: none;
            border-radius: 50px;
            padding: 15px 40px;
            font-weight: bold;
            font-size: 1.2rem;
            transition: all 0.3s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .login-button:hover {
            background-color: #1ed760;
            transform: translateY(-3px);
            box-shadow: 0 8px 16px rgba(0, 0, 0, 0.4);
        }
        
        .visualizer-container {
            height: 50px;
            display: flex;
            align-items: flex-end;
            justify-content: center;
            margin-top: 10px;
        }
        
        .visualizer-bar {
            width: 5px;
            background-color: var(--spotify-green);
            margin: 0 2px;
            border-radius: 2px 2px 0 0;
            transition: height 0.2s ease;
        }
        
        .category-pills {
            margin-bottom: 30px;
            display: flex;
            overflow-x: auto;
            padding-bottom: 10px;
        }
        
        .category-pill {
            background-color: var(--spotify-dark-gray);
            color: var(--spotify-white);
            border: 1px solid #444;
            border-radius: 50px;
            padding: 8px 20px;
            margin-right: 10px;
            white-space: nowrap;
            transition: all 0.3s ease;
            cursor: pointer;
        }
        
        .category-pill:hover, .category-pill.active {
            background-color: var(--spotify-green);
            color: var(--spotify-black);
            border-color: var(--spotify-green);
        }
        
        .playlists-section, .recommendations-section {
            margin-top: 40px;
        }
        
        .section-title {
            font-size: 1.8rem;
            font-weight: bold;
            margin-bottom: 20px;
            position: relative;
            padding-bottom: 10px;
        }
        
        .section-title::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            width: 50px;
            height: 3px;
            background-color: var(--spotify-green);
        }
        
        /* Toast Notification */
        .toast-container {
            position: fixed;
            top: 20px;
            right: 20px;
            z-index: 1100;
        }
        
        .toast {
            background-color: var(--spotify-green);
            color: var(--spotify-black);
            padding: 15px;
            border-radius: 5px;
            margin-bottom: 10px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            opacity: 0;
            transform: translateX(100%);
            transition: all 0.5s ease;
        }
        
        .toast.show {
            opacity: 1;
            transform: translateX(0);
        }
        
        /* Responsive adjustments */
        @media (max-width: 768px) {
            .player-container {
                padding: 10px;
            }
            
            .currently-playing-img {
                width: 50px;
                height: 50px;
            }
            
            .control-button {
                font-size: 1rem;
                margin: 0 5px;
            }
            
            .play-pause {
                width: 35px;
                height: 35px;
                margin: 0 10px;
            }
            
            .volume-control {
                display: none;
            }
            
            .progress-container {
                margin-top: 5px;
            }
            
            .currently-playing-title {
                font-size: 0.9rem;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                max-width: 120px;
            }
            
            .currently-playing-artist {
                font-size: 0.8rem;
                white-space: nowrap;
                overflow: hidden;
                text-overflow: ellipsis;
                max-width: 120px;
            }
        }
    </style>
</head>
<body>
    <nav class="navbar navbar-dark navbar-custom mb-4">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="#">
                <svg class="logo me-2" viewBox="0 0 1134 340" xmlns="http://www.w3.org/2000/svg">
                    <path fill="#1DB954" d="M8 171c0 92 76 168 168 168s168-76 168-168S268 4 176 4 8 79 8 171zm230 78c-39-24-89-30-147-17-14 2-16-18-4-20 64-15 118-8 162 19 11 7 0 24-11 18zm17-45c-45-28-114-36-167-20-17 5-23-21-7-25 61-18 136-9 188 23 14 9 0 31-14 22zM80 133c-17 6-28-23-9-30 59-18 159-15 221 22 17 9 1 37-17 27-54-32-144-35-195-19zm379 91c-17 0-33-6-47-20-1 0-1 1-1 1l-16 19c-1 1-1 2 0 3 18 16 40 24 64 24 34 0 55-19 55-47 0-24-15-37-50-46-29-7-34-12-34-22s10-16 23-16 25 5 39 15c0 0 1 1 2 1s1-1 1-1l14-20c1-1 1-1 0-2-16-13-35-20-56-20-31 0-53 19-53 46 0 29 20 38 52 46 28 6 32 12 32 22 0 11-10 17-25 17zm95-77v-13c0-1-1-2-2-2h-26c-1 0-2 1-2 2v147c0 1 1 2 2 2h26c1 0 2-1 2-2v-46c10 11 21 16 36 16 27 0 54-21 54-61s-27-60-54-60c-15 0-26 5-36 17zm30 78c-18 0-31-15-31-35s13-34 31-34 30 14 30 34-12 35-30 35zm68-34c0 34 27 60 62 60s62-27 62-61-26-60-61-60-63 27-63 61zm30-1c0-20 13-34 32-34s33 15 33 35-13 34-32 34-33-15-33-35zm140-58v-29c0-1 0-2-1-2h-26c-1 0-2 1-2 2v29h-13c-1 0-2 1-2 2v22c0 1 1 2 2 2h13v58c0 23 11 35 34 35 9 0 18-2 25-6 1 0 1-1 1-2v-21c0-1 0-2-1-2h-2c-5 3-11 4-16 4-8 0-12-4-12-12v-54h30c1 0 2-1 2-2v-22c0-1-1-2-2-2h-30zm129-3c0-11 4-15 13-15 5 0 10 0 15 2h1s1-1 1-2V93c0-1 0-2-1-2-5-2-12-3-22-3-24 0-36 14-36 39v5h-13c-1 0-2 1-2 2v22c0 1 1 2 2 2h13v89c0 1 1 2 2 2h26c1 0 1-1 1-2v-89h25l38 89c-4 9-8 11-14 11-5 0-10-1-15-4h-1l-1 1-9 19c0 1 0 3 1 3 9 5 17 7 27 7 19 0 30-9 39-33l45-116v-2c0-1-1-1-2-1h-27c-1 0-1 1-1 2l-28 78-30-78c0-1-1-2-2-2h-44v-3zm-83 3c-1 0-2 1-2 2v113c0 1 1 2 2 2h26c1 0 1-1 1-2V134c0-1 0-2-1-2h-26zm-6-33c0 10 9 19 19 19s18-9 18-19-8-18-18-18-19 8-19 18zm245 69c10 0 19-8 19-18s-9-18-19-18-18 8-18 18 8 18 18 18zm0-34c9 0 17 7 17 16s-8 16-17 16-16-7-16-16 7-16 16-16zm4 18c3-1 5-3 5-6 0-4-4-6-8-6h-8v19h4v-6h4l4 6h5zm-3-9c2 0 4 1 4 3s-2 3-4 3h-4v-6h4z"></path>
                </svg>
                <span>Spotify Advanced Player</span>
            </a>
            <div id="user-profile" class="d-none">
                <img id="user-avatar" src="/api/placeholder/32/32" alt="User Avatar" class="rounded-circle me-2" width="32" height="32">
                <span id="user-name" class="text-white"></span>
            </div>
        </div>
    </nav>

    <div class="container">
        <div id="login-section" class="login-section">
            <h1 class="mb-4">Welcome to Spotify Advanced Player</h1>
            <p class="mb-5">Connect your Spotify account to start playing your favorite music</p>
            <button id="login-button" class="login-button">
                <i class="fab fa-spotify me-2"></i> Connect with Spotify
            </button>
        </div>

        <div id="main-content" class="d-none">
            <div class="search-container">
                <div class="row align-items-center">
                    <div class="col-md-10">
                        <input type="text" id="search-input" class="form-control search-input" placeholder="Search for songs, artists, or albums...">
                    </div>
                    <div class="col-md-2 mt-3 mt-md-0">
                        <button id="search-button" class="btn search-button w-100">
                            <i class="fas fa-search me-2"></i> Search
                        </button>
                    </div>
                </div>
            </div>

            <div class="category-pills">
                <div class="category-pill active" data-category="all">All</div>
                <div class="category-pill" data-category="tracks">Songs</div>
                <div class="category-pill" data-category="artists">Artists</div>
                <div class="category-pill" data-category="albums">Albums</div>
                <div class="category-pill" data-category="playlists">Playlists</div>
            </div>

            <div id="loading" class="loading-animation d-none">
                <div class="loading-bar"></div>
                <div class="loading-bar"></div>
                <div class="loading-bar"></div>
                <div class="loading-bar"></div>
            </div>

            <div id="search-results" class="row"></div>

            <div id="recommendations-section" class="recommendations-section d-none">
                <h2 class="section-title">Recommended for You</h2>
                <div id="recommendations" class="row"></div>
            </div>

            <div id="playlists-section" class="playlists-section d-none">
                <h2 class="section-title">Your Playlists</h2>
                <div id="playlists" class="row"></div>
            </div>
        </div>
    </div>

    <div id="player-container" class="player-container">
        <div class="row align-items-center">
            <div class="col-md-3">
                <div class="currently-playing">
                    <img id="currently-playing-img" src="/api/placeholder/60/60" alt="Currently Playing" class="currently-playing-img">
                    <div class="currently-playing-info">
                        <div id="currently-playing-title" class="currently-playing-title fw-bold"></div>
                        <div id="currently-playing-artist" class="currently-playing-artist text-muted"></div>
                    </div>
                </div>
            </div>
            <div class="col-md-6">
                <div class="player-controls">
                    <button id="prev-button" class="control-button">
                        <i class="fas fa-step-backward"></i>
                    </button>
                    <button id="play-pause-button" class="play-pause">
                        <i class="fas fa-play"></i>
                    </button>
                    <button id="next-button" class="control-button">
                        <i class="fas fa-step-forward"></i>
                    </button>
                </div>
                <div class="progress-container">
                    <div class="d-flex justify-content-between text-muted mb-1">
                        <small id="current-time">0:00</small>
                        <small id="total-time">0:00</small>
                    </div>
                    <div class="progress" id="progress-bar-container">
                        <div id="progress-bar" class="progress-bar" role="progressbar" style="width: 0%"></div>
                    </div>
                </div>
                <div class="visualizer-container" id="audio-visualizer">
                    <!-- Visualizer bars will be generated with JS -->
                </div>
            </div>
            <div class="col-md-3">
                <div class="volume-control d-flex align-items-center justify-content-end">
                    <button id="volume-button" class="control-button">
                        <i class="fas fa-volume-up"></i>
                    </button>
                    <input type="range" class="form-range volume-slider" id="volume-slider" min="0" max="100" value="100">
                </div>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://sdk.scdn.co/spotify-player.js"></script>
    <script>
        // Spotify API Configuration
        const SPOTIFY_CLIENT_ID = '4d0ff47f37aa45778cba889ad86cfb5a';
        const SPOTIFY_CLIENT_SECRET = '24b3a55b7dac49de80673395c6165df0';
        const REDIRECT_URI = window.location.origin + window.location.pathname;
        const SCOPE = 'user-read-private user-read-email streaming user-read-playback-state user-modify-playback-state';
        
        // State variables
        let accessToken = null;
        let currentTrack = null;
        let isPlaying = false;
        let volume = 100;
        let audioElement = new Audio();
        let currentPlaybackTimer = null;
        let visualizerBars = [];
        let visualizerAnimationFrame = null;
        let audioContext = null;
        let analyser = null;
        let dataArray = null;
        let currentCategory = 'all';
        
        // DOM Elements
        const loginSection = document.getElementById('login-section');
        const mainContent = document.getElementById('main-content');
        const loginButton = document.getElementById('login-button');
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const searchResults = document.getElementById('search-results');
        const loadingElement = document.getElementById('loading');
        const playerContainer = document.getElementById('player-container');
        const currentlyPlayingImg = document.getElementById('currently-playing-img');
        const currentlyPlayingTitle = document.getElementById('currently-playing-title');
        const currentlyPlayingArtist = document.getElementById('currently-playing-artist');
        const playPauseButton = document.getElementById('play-pause-button');
        const prevButton = document.getElementById('prev-button');
        const nextButton = document.getElementById('next-button');
        const progressBar = document.getElementById('progress-bar');
        const progressBarContainer = document.getElementById('progress-bar-container');
        const currentTimeDisplay = document.getElementById('current-time');
        const totalTimeDisplay = document.getElementById('total-time');
        const volumeSlider = document.getElementById('volume-slider');
        const volumeButton = document.getElementById('volume-button');
        const audioVisualizer = document.getElementById('audio-visualizer');
        const userProfile = document.getElementById('user-profile');
        const userName = document.getElementById('user-name');
        const userAvatar = document.getElementById('user-avatar');
        const recommendationsSection = document.getElementById('recommendations-section');
        const recommendations = document.getElementById('recommendations');
        const playlistsSection = document.getElementById('playlists-section');
        const playlists = document.getElementById('playlists');
        const categoryPills = document.querySelectorAll('.category-pill');
        
        // Initialize the app
        function init() {
            // Check if there's a token in the URL hash
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            accessToken = params.get('access_token');
            
            if (accessToken) {
                // Remove the hash from the URL
                history.replaceState({}, document.title, window.location.pathname);
                onAuthenticated();
            }
            
            // Event listeners
            loginButton.addEventListener('click', authenticate);
            searchButton.addEventListener('click', performSearch);
            searchInput.addEventListener('keypress', function(e) {
                if (e.key === 'Enter') {
                    performSearch();
                }
            });
            
            playPauseButton.addEventListener('click', togglePlayPause);
            prevButton.addEventListener('click', playPrevious);
            nextButton.addEventListener('click', playNext);
            
            progressBarContainer.addEventListener('click', seekTrack);
            volumeSlider.addEventListener('input', changeVolume);
            volumeButton.addEventListener('click', toggleMute);
            
            audioElement.addEventListener('timeupdate', updateProgressBar);
            audioElement.addEventListener('ended', playNext);
            
            // Category pills event listeners
            categoryPills.forEach(pill => {
                pill.addEventListener('click', function() {
                    categoryPills.forEach(p => p.classList.remove('active'));
                    this.classList.add('active');
                    currentCategory = this.dataset.category;
                    
                    // If we have search results, filter them
                    if (searchResults.children.length > 0) {
                        filterSearchResults();
                    }
                });
            });
            
            // Create visualizer bars
            createVisualizer();
        }
        
        window.onSpotifyWebPlaybackSDKReady = () => {
            const player = new Spotify.Player({
               name: 'Spotify Advanced Player',
               getOAuthToken: cb => { cb(accessToken); }
           });
  
            // Connect to the player
             player.connect();
        };
        // Authenticate with Spotify
        function authenticate() {
            const authUrl = `https://accounts.spotify.com/authorize?client_id=${SPOTIFY_CLIENT_ID}&response_type=token&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=${encodeURIComponent(SCOPE)}`;
            window.location.href = authUrl;
        }
        
        // Handle authenticated user
        function onAuthenticated() {
            loginSection.classList.add('d-none');
            mainContent.classList.remove('d-none');
            
            // Get user profile
            fetchUserProfile();
            
            // Get recommendations and playlists
            fetchRecommendations();
            fetchUserPlaylists();
        }
        
        // Fetch user profile
        async function fetchUserProfile() {
            try {
                const response = await fetch('https://api.spotify.com/v1/me', {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    userName.textContent = data.display_name;
                    
                    if (data.images && data.images.length > 0) {
                        userAvatar.src = data.images[0].url;
                    }
                    
                    userProfile.classList.remove('d-none');
                }
            } catch (error) {
                console.error('Error fetching user profile:', error);
                showToast('Failed to load your profile', 'error');
            }
        }
        
        // Perform search
        async function performSearch() {
            const query = searchInput.value.trim();
            
            if (!query) return;
            
            showLoading();
            
            try {
                const response = await fetch(`https://api.spotify.com/v1/search?q=${encodeURIComponent(query)}&type=track,artist,album,playlist&limit=50`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                if (response.ok) {
                    const data = await response.json();
                    displaySearchResults(data);
                } else {
                    if (response.status === 401) {
                        // Token expired
                        authenticate();
                    } else {
                        throw new Error('Search failed');
                    }
                }
            } catch (error) {
    console.error('Error searching:', error);
    showToast('Search failed. Please try again.', 'error');
} finally {
    hideLoading();
}
}

// Display search results
function displaySearchResults(data) {
    searchResults.innerHTML = '';
    
    let hasResults = false;
    
    // Display tracks
    if (data.tracks && data.tracks.items.length > 0) {
        hasResults = true;
        data.tracks.items.forEach(track => {
            if (currentCategory === 'all' || currentCategory === 'tracks') {
                const trackElement = createTrackCard(track);
                searchResults.appendChild(trackElement);
            }
        });
    }
    
    // Display artists
    if (data.artists && data.artists.items.length > 0) {
        hasResults = true;
        data.artists.items.forEach(artist => {
            if (currentCategory === 'all' || currentCategory === 'artists') {
                const artistElement = createArtistCard(artist);
                searchResults.appendChild(artistElement);
            }
        });
    }
    
    // Display albums
    if (data.albums && data.albums.items.length > 0) {
        hasResults = true;
        data.albums.items.forEach(album => {
            if (currentCategory === 'all' || currentCategory === 'albums') {
                const albumElement = createAlbumCard(album);
                searchResults.appendChild(albumElement);
            }
        });
    }
    
    // Display playlists
    if (data.playlists && data.playlists.items.length > 0) {
        hasResults = true;
        data.playlists.items.forEach(playlist => {
            if (currentCategory === 'all' || currentCategory === 'playlists') {
                const playlistElement = createPlaylistCard(playlist);
                searchResults.appendChild(playlistElement);
            }
        });
    }
    
    if (!hasResults) {
        searchResults.innerHTML = `
            <div class="col-12 text-center p-5">
                <h3>No results found</h3>
                <p>Try a different search term</p>
            </div>
        `;
    }
}

// Filter search results based on category
function filterSearchResults() {
    Array.from(searchResults.children).forEach(child => {
        if (currentCategory === 'all' || child.dataset.type === currentCategory) {
            child.classList.remove('d-none');
        } else {
            child.classList.add('d-none');
        }
    });
}

// Create a track card
function createTrackCard(track) {
    const colDiv = document.createElement('div');
    colDiv.className = 'col-md-3 col-sm-6 mb-4';
    colDiv.dataset.type = 'tracks';
    
    const imageUrl = track.album.images.length > 0 ? track.album.images[0].url : '/api/placeholder/300/300';
    
    colDiv.innerHTML = `
        <div class="track-card">
            <div class="track-image-container">
                <img src="${imageUrl}" alt="${track.name}" class="track-album-img">
                <div class="play-button" data-track-uri="${track.uri}" data-track-id="${track.id}">
                    <i class="fas fa-play"></i>
                </div>
            </div>
            <div class="track-info">
                <div class="track-title">${track.name}</div>
                <div class="track-artist">${track.artists.map(artist => artist.name).join(', ')}</div>
            </div>
        </div>
    `;
    
    // Add click event to play button
    colDiv.querySelector('.play-button').addEventListener('click', function() {
        const trackUri = this.dataset.trackUri;
        const trackId = this.dataset.trackId;
        playTrack(track);
    });
    
    return colDiv;
}

// Create an artist card
function createArtistCard(artist) {
    const colDiv = document.createElement('div');
    colDiv.className = 'col-md-3 col-sm-6 mb-4';
    colDiv.dataset.type = 'artists';
    
    const imageUrl = artist.images.length > 0 ? artist.images[0].url : '/api/placeholder/300/300';
    
    colDiv.innerHTML = `
        <div class="track-card">
            <div class="track-image-container">
                <img src="${imageUrl}" alt="${artist.name}" class="track-album-img">
                <div class="play-button" data-artist-id="${artist.id}">
                    <i class="fas fa-play"></i>
                </div>
            </div>
            <div class="track-info">
                <div class="track-title">${artist.name}</div>
                <div class="track-artist">${artist.followers.total.toLocaleString()} followers</div>
            </div>
        </div>
    `;
    
    // Add click event to play button
    colDiv.querySelector('.play-button').addEventListener('click', function() {
        const artistId = this.dataset.artistId;
        playArtistTopTracks(artistId);
    });
    
    return colDiv;
}

// Create an album card
function createAlbumCard(album) {
    const colDiv = document.createElement('div');
    colDiv.className = 'col-md-3 col-sm-6 mb-4';
    colDiv.dataset.type = 'albums';
    
    const imageUrl = album.images.length > 0 ? album.images[0].url : '/api/placeholder/300/300';
    
    colDiv.innerHTML = `
        <div class="track-card">
            <div class="track-image-container">
                <img src="${imageUrl}" alt="${album.name}" class="track-album-img">
                <div class="play-button" data-album-id="${album.id}">
                    <i class="fas fa-play"></i>
                </div>
            </div>
            <div class="track-info">
                <div class="track-title">${album.name}</div>
                <div class="track-artist">${album.artists.map(artist => artist.name).join(', ')}</div>
            </div>
        </div>
    `;
    
    // Add click event to play button
    colDiv.querySelector('.play-button').addEventListener('click', function() {
        const albumId = this.dataset.albumId;
        playAlbumTracks(albumId);
    });
    
    return colDiv;
}

// Create a playlist card
function createPlaylistCard(playlist) {
    const colDiv = document.createElement('div');
    colDiv.className = 'col-md-3 col-sm-6 mb-4';
    colDiv.dataset.type = 'playlists';
    
    const imageUrl = playlist.images.length > 0 ? playlist.images[0].url : '/api/placeholder/300/300';
    
    colDiv.innerHTML = `
        <div class="track-card">
            <div class="track-image-container">
                <img src="${imageUrl}" alt="${playlist.name}" class="track-album-img">
                <div class="play-button" data-playlist-id="${playlist.id}">
                    <i class="fas fa-play"></i>
                </div>
            </div>
            <div class="track-info">
                <div class="track-title">${playlist.name}</div>
                <div class="track-artist">${playlist.tracks.total} tracks</div>
            </div>
        </div>
    `;
    
    // Add click event to play button
    colDiv.querySelector('.play-button').addEventListener('click', function() {
        const playlistId = this.dataset.playlistId;
        playPlaylistTracks(playlistId);
    });
    
    return colDiv;
}

// Play a track
// Play a track
function playTrack(track) {
    // Stop the current track if playing
    audioElement.pause();
    audioElement.currentTime = 0;
    
    // Get preview URL
    const previewUrl = track.preview_url;
    
    if (!previewUrl) {
        // Show a more informative message
        showToast('This track has no preview available. This is a limitation of Spotify\'s free API.', 'warning');
        
        // Still update the UI to show what would play
        isPlaying = false;
        updatePlayPauseButton();
        showPlayerUI(track);
        currentTrack = track;
        return;
    }
    
    // Set the audio source
    audioElement.src = previewUrl;
    audioElement.volume = volume / 100;
    
    // Play the audio
    const playPromise = audioElement.play();
    
    if (playPromise !== undefined) {
        playPromise.then(_ => {
            // Update UI
            isPlaying = true;
            updatePlayPauseButton();
            showPlayerUI(track);
            
            // Set up audio analyzer for visualizer if not already done
            setupAudioAnalyzer();
            
            // Store the current track
            currentTrack = track;
        }).catch(error => {
            console.error('Error playing track:', error);
            
            // More specific error message
            if (error.name === 'NotAllowedError') {
                showToast('Playback was blocked. Try interacting with the page first.', 'error');
            } else if (error.name === 'NotSupportedError') {
                showToast('This audio format is not supported by your browser.', 'error');
            } else {
                showToast('Failed to play track: ' + error.message, 'error');
            }
        });
    }
}
// Play top tracks from an artist
async function playArtistTopTracks(artistId) {
    showLoading();
    
    try {
        const response = await fetch(`https://api.spotify.com/v1/artists/${artistId}/top-tracks?market=US`, {
            headers: {
                'Authorization': `Bearer ${accessToken}`
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            
            if (data.tracks && data.tracks.length > 0) {
                playTrack(data.tracks[0]);
            } else {
                showToast('No tracks available for this artist', 'warning');
            }
        } else {
            throw new Error('Failed to get artist tracks');
        }
    } catch (error) {
        console.error('Error getting artist tracks:', error);
        showToast('Failed to play artist tracks', 'error');
    } finally {
        hideLoading();
    }
}

// Play tracks from an album
async function playAlbumTracks(albumId) {
    showLoading();
    
    try {
        const response = await fetch(`https://api.spotify.com/v1/albums/${albumId}/tracks`, {
            headers: {
                'Authorization': `Bearer ${accessToken}`
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            
            if (data.items && data.items.length > 0) {
                // Get the full track info for the first track
                const trackResponse = await fetch(`https://api.spotify.com/v1/tracks/${data.items[0].id}`, {
                    headers: {
                        'Authorization': `Bearer ${accessToken}`
                    }
                });
                
                if (trackResponse.ok) {
                    const trackData = await trackResponse.json();
                    playTrack(trackData);
                } else {
                    throw new Error('Failed to get track info');
                }
            } else {
                showToast('No tracks available in this album', 'warning');
            }
        } else {
            throw new Error('Failed to get album tracks');
        }
    } catch (error) {
        console.error('Error getting album tracks:', error);
        showToast('Failed to play album tracks', 'error');
    } finally {
        hideLoading();
    }
}

// Play tracks from a playlist
async function playPlaylistTracks(playlistId) {
    showLoading();
    
    try {
        const response = await fetch(`https://api.spotify.com/v1/playlists/${playlistId}/tracks`, {
            headers: {
                'Authorization': `Bearer ${accessToken}`
            }
        });
        
        if (response.ok) {
            const data = await response.json();
            
            if (data.items && data.items.length > 0) {
                playTrack(data.items[0].track);
            } else {
                showToast('No tracks available in this playlist', 'warning');
            }
        } else {
            throw new Error('Failed to get playlist tracks');
        }
    } catch (error) {
        console.error('Error getting playlist tracks:', error);
        showToast('Failed to play playlist tracks', 'error');
    } finally {
        hideLoading();
    }
}

// Toggle play/pause
function togglePlayPause() {
    if (!currentTrack) return;
    
    if (isPlaying) {
        audioElement.pause();
        isPlaying = false;
    } else {
        audioElement.play();
        isPlaying = true;
    }
    
    updatePlayPauseButton();
}

// Update play/pause button UI
function updatePlayPauseButton() {
    playPauseButton.innerHTML = isPlaying ? 
        '<i class="fas fa-pause"></i>' : 
        '<i class="fas fa-play"></i>';
}

// Show player UI with current track info
function showPlayerUI(track) {
    currentlyPlayingImg.src = track.album.images.length > 0 ? 
        track.album.images[0].url : 
        '/api/placeholder/60/60';
    
    currentlyPlayingTitle.textContent = track.name;
    currentlyPlayingArtist.textContent = track.artists.map(artist => artist.name).join(', ');
    
    playerContainer.style.display = 'block';
}

// Update progress bar
function updateProgressBar() {
    const currentTime = audioElement.currentTime;
    const duration = audioElement.duration || 1;
    const percentage = (currentTime / duration) * 100;
    
    progressBar.style.width = `${percentage}%`;
    
    // Update time displays
    currentTimeDisplay.textContent = formatTime(currentTime);
    totalTimeDisplay.textContent = formatTime(duration);
}

// Format time (seconds to MM:SS)
function formatTime(seconds) {
    const minutes = Math.floor(seconds / 60);
    const secs = Math.floor(seconds % 60);
    return `${minutes}:${secs < 10 ? '0' : ''}${secs}`;
}

// Seek track
function seekTrack(event) {
    if (!currentTrack) return;
    
    const progressBarWidth = progressBarContainer.offsetWidth;
    const clickPosition = event.offsetX;
    const percentage = clickPosition / progressBarWidth;
    
    audioElement.currentTime = percentage * audioElement.duration;
}

// Change volume
function changeVolume() {
    volume = volumeSlider.value;
    audioElement.volume = volume / 100;
    
    // Update volume icon
    updateVolumeIcon();
}

// Toggle mute
function toggleMute() {
    if (audioElement.volume > 0) {
        // Store current volume and set to 0
        volume = volumeSlider.value;
        volumeSlider.value = 0;
        audioElement.volume = 0;
    } else {
        // Restore volume
        volumeSlider.value = volume;
        audioElement.volume = volume / 100;
    }
    
    // Update icon
    updateVolumeIcon();
}

// Update volume icon based on current volume
function updateVolumeIcon() {
    const volumeLevel = audioElement.volume;
    let iconClass = '';
    
    if (volumeLevel === 0) {
        iconClass = 'fa-volume-mute';
    } else if (volumeLevel < 0.5) {
        iconClass = 'fa-volume-down';
    } else {
        iconClass = 'fa-volume-up';
    }
    
    volumeButton.innerHTML = `<i class="fas ${iconClass}"></i>`;
}

// Play previous track
function playPrevious() {
    // Implement previous track functionality
    showToast('Previous track feature coming soon', 'info');
}

// Play next track
function playNext() {
    // Implement next track functionality
    showToast('Next track feature coming soon', 'info');
}

// Create audio visualizer
function createVisualizer() {
    // Create 30 bars
    for (let i = 0; i < 30; i++) {
        const bar = document.createElement('div');
        bar.className = 'visualizer-bar';
        bar.style.height = '3px';
        audioVisualizer.appendChild(bar);
        visualizerBars.push(bar);
    }
}

// Set up audio analyzer for visualizer
function setupAudioAnalyzer() {
    if (!audioContext) {
        audioContext = new (window.AudioContext || window.webkitAudioContext)();
        analyser = audioContext.createAnalyser();
        analyser.fftSize = 64;
        
        const source = audioContext.createMediaElementSource(audioElement);
        source.connect(analyser);
        analyser.connect(audioContext.destination);
        
        dataArray = new Uint8Array(analyser.frequencyBinCount);
        
        // Start visualizer animation
        updateVisualizer();
    }
}

// Update visualizer animation
function updateVisualizer() {
    if (!isPlaying) {
        // Reset bars when not playing
        visualizerBars.forEach(bar => {
            bar.style.height = '3px';
        });
        
        visualizerAnimationFrame = requestAnimationFrame(updateVisualizer);
        return;
    }
    
    analyser.getByteFrequencyData(dataArray);
    
    for (let i = 0; i < visualizerBars.length; i++) {
        const index = Math.floor(i * (dataArray.length / visualizerBars.length));
        const value = dataArray[index];
        const height = value / 2;
        
        visualizerBars[i].style.height = `${height}px`;
    }
    
    visualizerAnimationFrame = requestAnimationFrame(updateVisualizer);
}

// Fetch recommendations
async function fetchRecommendations() {
    try {
        // First get user's top tracks to use as seed
        const topTracksResponse = await fetch('https://api.spotify.com/v1/me/top/tracks?limit=5', {
            headers: {
                'Authorization': `Bearer ${accessToken}`
            }
        });
        
        if (!topTracksResponse.ok) {
            throw new Error('Failed to get top tracks');
        }
        
        const topTracksData = await topTracksResponse.json();
        
        if (!topTracksData.items || topTracksData.items.length === 0) {
            // User doesn't have top tracks, use a generic seed
            return fetchGenericRecommendations();
        }
        
        // Use top tracks as seeds
        const trackIds = topTracksData.items.map(track => track.id).join(',');
        
        const recommendationsResponse = await fetch(`https://api.spotify.com/v1/recommendations?seed_tracks=${trackIds}&limit=8`, {
            headers: {
                'Authorization': `Bearer ${accessToken}`
            }
        });
        
        if (!recommendationsResponse.ok) {
            throw new Error('Failed to get recommendations');
        }
        
        const recommendationsData = await recommendationsResponse.json();
        
        if (recommendationsData.tracks && recommendationsData.tracks.length > 0) {
            displayRecommendations(recommendationsData.tracks);
        }
    } catch (error) {
        console.error('Error fetching recommendations:', error);
        fetchGenericRecommendations();
    }
}

// Fetch generic recommendations (fallback)
async function fetchGenericRecommendations() {
    try {
        const response = await fetch('https://api.spotify.com/v1/browse/featured-playlists?limit=1', {
            headers: {
                'Authorization': `Bearer ${accessToken}`
            }
        });
        
        if (!response.ok) {
            throw new Error('Failed to get featured playlists');
        }
        
        const data = await response.json();
        
        if (data.playlists && data.playlists.items.length > 0) {
            const playlistId = data.playlists.items[0].id;
            
            const tracksResponse = await fetch(`https://api.spotify.com/v1/playlists/${playlistId}/tracks?limit=8`, {
                headers: {
                    'Authorization': `Bearer ${accessToken}`
                }
            });
            
            if (!tracksResponse.ok) {
                throw new Error('Failed to get playlist tracks');
            }
            
            const tracksData = await tracksResponse.json();
            
            if (tracksData.items && tracksData.items.length > 0) {
                const tracks = tracksData.items.map(item => item.track);
                displayRecommendations(tracks);
            }
        }
    } catch (error) {
        console.error('Error fetching generic recommendations:', error);
    }
}

// Display recommendations
function displayRecommendations(tracks) {
    recommendations.innerHTML = '';
    
    tracks.forEach(track => {
        const trackElement = createTrackCard(track);
        recommendations.appendChild(trackElement);
    });
    
    recommendationsSection.classList.remove('d-none');
}

// Fetch user playlists
async function fetchUserPlaylists() {
    try {
        const response = await fetch('https://api.spotify.com/v1/me/playlists?limit=8', {
            headers: {
                'Authorization': `Bearer ${accessToken}`
            }
        });
        
        if (!response.ok) {
            throw new Error('Failed to get playlists');
        }
        
        const data = await response.json();
        
        if (data.items && data.items.length > 0) {
            displayPlaylists(data.items);
        }
    } catch (error) {
        console.error('Error fetching playlists:', error);
    }
}

// Display playlists
function displayPlaylists(playlistsData) {
    playlists.innerHTML = '';
    
    playlistsData.forEach(playlist => {
        const playlistElement = createPlaylistCard(playlist);
        playlists.appendChild(playlistElement);
    });
    
    playlistsSection.classList.remove('d-none');
}

// Show loading animation
function showLoading() {
    loadingElement.classList.remove('d-none');
}

// Hide loading animation
function hideLoading() {
    loadingElement.classList.add('d-none');
}

// Show toast notification
function showToast(message, type = 'success') {
    const toastContainer = document.getElementById('toast-container');
    
    const toast = document.createElement('div');
    toast.className = 'toast';
    toast.innerHTML = message;
    
    // Apply styles based on type
    if (type === 'error') {
        toast.style.backgroundColor = '#E22134';
    } else if (type === 'warning') {
        toast.style.backgroundColor = '#F59B23';
    } else if (type === 'info') {
        toast.style.backgroundColor = '#3498db';
    }
    
    toastContainer.appendChild(toast);
    
    // Show toast with animation
    setTimeout(() => {
        toast.classList.add('show');
    }, 10);
    
    // Remove toast after 3 seconds
    setTimeout(() => {
        toast.classList.remove('show');
        
        // Remove from DOM after animation
        setTimeout(() => {
            toastContainer.removeChild(toast);
        }, 500);
    }, 3000);
}

// Initialize the app when page loads
window.addEventListener('DOMContentLoaded', init);
    </script>
    <script src="https://kit.fontawesome.com/a076d05399.js"></script>
</body>
</html>
         
