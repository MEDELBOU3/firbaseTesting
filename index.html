<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Flix-Party: Watch Together</title>
    <!-- We will use JS imports for Firebase, so no script tags needed here -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Netflix+Sans:wght@300;400;700;800&display=swap" rel="stylesheet">
    <style>
        :root { --primary-color: #e50914; --dark-color: #141414; --darker-color: #0d0d0d; --bs-body-bg: var(--darker-color); --bs-body-color: #fff; }
        body { font-family: 'Netflix Sans', sans-serif; background-color: var(--bs-body-bg); color: var(--bs-body-color); overflow: hidden; }
        .view { display: none; min-height: 100vh; animation: fadeIn 0.5s; }
        .view.active { display: flex; }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }

        /* --- AUTH VIEW --- */
        #auth-view { flex-direction: column; justify-content: center; align-items: center; background: radial-gradient(circle, rgba(20,20,20,1) 0%, rgba(13,13,13,1) 100%); }
        .auth-container { background-color: rgba(0,0,0,0.75); padding: 60px; border-radius: 8px; max-width: 450px; width: 100%; }
        .auth-container h1 { margin-bottom: 2rem; }
        .form-control { background-color: #333; border: none; color: #fff; }
        .form-control:focus { background-color: #454545; box-shadow: none; border-color: #fff; }
        .btn-brand { background-color: var(--primary-color); font-weight: bold; }
        .auth-toggle { cursor: pointer; color: #777; } .auth-toggle:hover { color: #fff; text-decoration: underline; }

        /* --- LOBBY VIEW --- */
        #lobby-view { flex-direction: column; justify-content: center; align-items: center; }
        .lobby-box { text-align: center; }
        .lobby-box .btn { font-size: 1.5rem; padding: 1rem 2rem; }
        #user-info { position: absolute; top: 2rem; right: 2rem; }
        #user-info #sign-out-btn { color: #777; } #user-info #sign-out-btn:hover { color: #fff; }

        /* --- PARTY VIEW --- */
        #party-view { width: 100%; height: 100vh; overflow: hidden; }
        .main-content { flex-grow: 1; height: 100vh; overflow-y: auto; padding-top: 80px; /* Header height */ }
        #party-sidebar { width: 350px; flex-shrink: 0; background-color: var(--dark-color); height: 100vh; display: flex; flex-direction: column; }
        .party-header { padding: 1.5rem; border-bottom: 1px solid #333; text-align: center; }
        .party-header #party-id { background-color: #000; padding: 5px 10px; border-radius: 5px; font-family: monospace; }
        #member-list, #chat-messages { overflow-y: auto; scrollbar-width: thin; scrollbar-color: #555 #333; }
        #member-list .member { padding: 0.5rem 1.5rem; }
        #member-list .member .fa-crown { color: #ffc107; }
        #chat-messages { flex-grow: 1; padding: 1rem; }
        .chat-message { margin-bottom: 1rem; }
        .chat-message strong { color: #b0b0b0; font-size: 0.9rem; }
        .chat-message p { margin: 0; padding: 0.5rem 0.8rem; background-color: #2a2a2a; border-radius: 10px; }
        .chat-input { background-color: #2a2a2a; border: 1px solid #444; color: #fff; }
        
        /* PLAYER OVERLAY */
        #player-overlay { position: fixed; top: 0; left: 0; width: calc(100% - 350px); height: 100%; background: #000; z-index: 1050; animation: fadeIn 0.3s; }
        #player-overlay .back-btn { position: absolute; top: 2rem; left: 2rem; z-index: 2; font-size: 1.8rem; }
        #player-overlay iframe { width: 100%; height: 100%; border: none; }
    </style>
</head>
<body>

    <!-- ======== VIEWS ======== -->

    <!-- 1. Authentication View -->
    <div id="auth-view" class="view active">
        <div class="auth-container">
            <h1 id="auth-title">Sign In</h1>
            <div id="auth-error" class="alert alert-danger d-none"></div>
            <form id="auth-form">
                <input type="email" id="email" class="form-control mb-3" placeholder="Email" required>
                <input type="password" id="password" class="form-control mb-4" placeholder="Password" required>
                <button type="submit" id="auth-submit-btn" class="btn btn-brand w-100 py-2">Sign In</button>
            </form>
            <div class="mt-4">
                <span id="auth-toggle-text" class="text-muted">New to Flix-Party?</span>
                <span id="auth-toggle-btn" class="auth-toggle fw-bold">Sign up now.</span>
            </div>
        </div>
    </div>

    <!-- 2. Lobby View (Create/Join Party) -->
    <div id="lobby-view" class="view">
        <div id="user-info">
            <span id="user-display-name"></span>
            <button id="sign-out-btn" class="btn btn-link"><i class="fas fa-sign-out-alt"></i></button>
        </div>
        <div class="lobby-box">
            <h1>Welcome to Flix-Party!</h1>
            <p class="lead">Watch movies and shows together, in real-time.</p>
            <div class="d-grid gap-3 d-sm-flex justify-content-sm-center">
                <button id="create-party-btn" class="btn btn-danger btn-lg">Create a Party</button>
                <button id="join-party-btn" class="btn btn-outline-light btn-lg">Join a Party</button>
            </div>
        </div>
    </div>
    
    <!-- 3. Main Party View (Movie Browser + Sidebar) -->
    <div id="party-view" class="view">
        <main class="main-content">
            <!-- Movie browser content will be injected here -->
        </main>
        <aside id="party-sidebar">
            <div class="party-header">
                <h5>Party ID</h5>
                <p id="party-id" class="fw-bold">------ <button id="copy-id-btn" class="btn btn-sm btn-dark ms-2"><i class="far fa-copy"></i></button></p>
            </div>
            <h6 class="text-muted px-4 mt-3 mb-2">IN THE PARTY (<span id="member-count">0</span>)</h6>
            <div id="member-list">
                <!-- Members injected here -->
            </div>
            <div id="chat-messages">
                <!-- Chat messages injected here -->
            </div>
            <div class="p-3 border-top border-secondary-subtle">
                <form id="chat-form">
                    <input type="text" id="chat-input" class="form-control chat-input" placeholder="Say something..." autocomplete="off">
                </form>
            </div>
        </aside>

        <!-- Player overlay will be injected here -->
    </div>

    <!-- Global App-level spinner -->
    <div id="global-spinner" class="d-none position-fixed top-0 start-0 w-100 h-100 d-flex justify-content-center align-items-center" style="background: rgba(0,0,0,0.7); z-index: 9999;">
        <div class="spinner-border text-danger" style="width: 4rem; height: 4rem;"></div>
    </div>

    <!-- ======================= -->
    
    <script type="module">
        // Import Firebase modules
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-auth.js";
        import { getDatabase, ref, set, get, onValue, push, onDisconnect, remove } from "https://www.gstatic.com/firebasejs/10.8.0/firebase-database.js";

        const App = {
            // ========================
            //  CONFIGURATION
            // ========================
            firebaseConfig: {
                apiKey: "AIzaSyDp2V0ULE-32AcIJ92a_e3mhMe6f6yZ_H4",
                authDomain: "sm4movies.firebaseapp.com",
                databaseURL: "https://sm4movies-default-rtdb.firebaseio.com",
                projectId: "sm4movies",
                storageBucket: "sm4movies.firebasestorage.app",
                messagingSenderId: "277353836953",
                appId: "1:277353836953:web:85e02783526c7cb58de308",
                measurementId: "G-690RSNJ2Q2"
            },
            tmdb: {
                API_KEY: '431fb541e27bceeb9db2f4cab69b54e1', // A public TMDB key
                API_BASE_URL: 'https://api.themoviedb.org/3',
                IMAGE_BASE_URL: 'https://image.tmdb.org/t/p/w500',
                BACKDROP_BASE_URL: 'https://image.tmdb.org/t/p/w1280',
                ROW_CONFIG: [ { title: 'Trending Now', endpoint: '/trending/all/week' }, { title: 'Top Rated Movies', endpoint: '/movie/top_rated' }, { title: 'Action & Adventure', endpoint: '/discover/movie?with_genres=28' } ]
            },

            // ========================
            //  STATE & DOM
            // ========================
            state: {
                isSigningUp: false,
                currentUser: null,
                currentPartyId: null,
                currentPartyData: null,
                partyListeners: []
            },
            dom: {},
            
            // ========================
            //  INITIALIZATION
            // ========================
            init() {
                if(this.firebaseConfig.apiKey === 'YOUR_API_KEY_HERE') {
                    document.body.innerHTML = '<div class="d-flex align-items-center justify-content-center vh-100"><h1 class="text-center text-danger p-5">FATAL ERROR: Firebase config is missing. Please add your project configuration to the script.</h1></div>';
                    return;
                }

                // Initialize Firebase
                this.firebase = {
                    app: initializeApp(this.firebaseConfig),
                    auth: getAuth(),
                    db: getDatabase()
                };

                this.cacheDOMElements();
                this.registerEventListeners();
                this.handleAuthState();
            },
            
            cacheDOMElements() {
                // Auth View
                this.dom.authView = document.getElementById('auth-view');
                this.dom.authTitle = document.getElementById('auth-title');
                this.dom.authError = document.getElementById('auth-error');
                this.dom.authForm = document.getElementById('auth-form');
                this.dom.authSubmitBtn = document.getElementById('auth-submit-btn');
                this.dom.authToggleText = document.getElementById('auth-toggle-text');
                this.dom.authToggleBtn = document.getElementById('auth-toggle-btn');
                
                // Lobby View
                this.dom.lobbyView = document.getElementById('lobby-view');
                this.dom.userDisplayName = document.getElementById('user-display-name');
                this.dom.createPartyBtn = document.getElementById('create-party-btn');
                this.dom.joinPartyBtn = document.getElementById('join-party-btn');
                this.dom.signOutBtn = document.getElementById('sign-out-btn');

                // Party View
                this.dom.partyView = document.getElementById('party-view');
                this.dom.mainContent = this.dom.partyView.querySelector('.main-content');
                this.dom.partyIdDisplay = document.getElementById('party-id');
                this.dom.copyIdBtn = document.getElementById('copy-id-btn');
                this.dom.memberCount = document.getElementById('member-count');
                this.dom.memberList = document.getElementById('member-list');
                this.dom.chatMessages = document.getElementById('chat-messages');
                this.dom.chatForm = document.getElementById('chat-form');
                this.dom.chatInput = document.getElementById('chat-input');
                this.dom.globalSpinner = document.getElementById('global-spinner');
            },

            registerEventListeners() {
                // Auth listeners
                this.dom.authToggleBtn.addEventListener('click', () => this.toggleAuthMode());
                this.dom.authForm.addEventListener('submit', (e) => this.handleAuthSubmit(e));

                // Lobby listeners
                this.dom.signOutBtn.addEventListener('click', () => signOut(this.firebase.auth));
                this.dom.createPartyBtn.addEventListener('click', () => this.createParty());
                this.dom.joinPartyBtn.addEventListener('click', () => this.joinParty());

                // Party listeners
                this.dom.copyIdBtn.addEventListener('click', () => this.copyPartyId());
                this.dom.chatForm.addEventListener('submit', (e) => this.handleChatSubmit(e));

                // Global router
                window.addEventListener('hashchange', () => this.syncFromHash());
            },

            // ========================
            //  AUTHENTICATION & ROUTING
            // ========================
            handleAuthState() {
                onAuthStateChanged(this.firebase.auth, (user) => {
                    if (user) {
                        this.state.currentUser = { uid: user.uid, email: user.email, displayName: user.email.split('@')[0] };
                        this.syncFromHash();
                    } else {
                        this.state.currentUser = null;
                        this.cleanupParty();
                        this.showView('auth');
                        window.location.hash = '';
                    }
                });
            },

            syncFromHash() {
                const partyId = window.location.hash.split('/')[2];
                if (this.state.currentUser) {
                    if(partyId) {
                        this.enterParty(partyId);
                    } else {
                        this.cleanupParty();
                        this.dom.userDisplayName.textContent = `Hi, ${this.state.currentUser.displayName}`;
                        this.showView('lobby');
                    }
                } else {
                    this.showView('auth');
                }
            },
            
            toggleAuthMode() {
                this.state.isSigningUp = !this.state.isSigningUp;
                this.dom.authTitle.textContent = this.state.isSigningUp ? 'Sign Up' : 'Sign In';
                this.dom.authSubmitBtn.textContent = this.state.isSigningUp ? 'Sign Up' : 'Sign In';
                this.dom.authToggleText.textContent = this.state.isSigningUp ? 'Already have an account?' : 'New to Flix-Party?';
                this.dom.authToggleBtn.textContent = this.state.isSigningUp ? 'Sign in.' : 'Sign up now.';
                this.dom.authError.classList.add('d-none');
            },

            async handleAuthSubmit(e) {
                e.preventDefault();
                this.showSpinner(true);
                const email = this.dom.authForm.email.value;
                const password = this.dom.authForm.password.value;
                try {
                    if (this.state.isSigningUp) {
                        await createUserWithEmailAndPassword(this.firebase.auth, email, password);
                    } else {
                        await signInWithEmailAndPassword(this.firebase.auth, email, password);
                    }
                    this.dom.authError.classList.add('d-none');
                } catch (error) {
                    this.dom.authError.textContent = error.message;
                    this.dom.authError.classList.remove('d-none');
                } finally {
                    this.showSpinner(false);
                }
            },
            
            // ========================
            //  LOBBY & PARTY MANAGEMENT
            // ========================
            async createParty() {
                this.showSpinner(true);
                const partyId = this.generateId();
                const partyRef = ref(this.firebase.db, `parties/${partyId}`);
                const partyData = {
                    info: {
                        hostId: this.state.currentUser.uid,
                        createdAt: Date.now(),
                    },
                    playerState: { isPlaying: false, currentTime: 0, lastUpdated: 0 },
                    members: {},
                    chat: {}
                };
                await set(partyRef, partyData);
                this.showSpinner(false);
                window.location.hash = `#/party/${partyId}`;
            },

            async joinParty() {
                const partyId = prompt("Please enter the Party ID:");
                if(!partyId) return;

                this.showSpinner(true);
                const partyRef = ref(this.firebase.db, `parties/${partyId}`);
                const snapshot = await get(partyRef);
                if (snapshot.exists()) {
                    window.location.hash = `#/party/${partyId}`;
                } else {
                    alert("Party not found. Please check the ID.");
                }
                this.showSpinner(false);
            },
            
            async enterParty(partyId) {
                this.cleanupParty(); // Cleanup previous party listeners
                this.state.currentPartyId = partyId;
                const partyRef = ref(this.firebase.db, `parties/${partyId}`);

                const snapshot = await get(partyRef);
                if (!snapshot.exists()) {
                    alert('This party does not exist or has ended.');
                    window.location.hash = '';
                    return;
                }
                
                this.showView('party');
                this.dom.partyIdDisplay.firstChild.textContent = partyId + ' ';
                this.setupPartyPresence(partyId);
                this.setupPartyListeners(partyId);
                this.ui.renderMovieBrowser();
            },
            
            cleanupParty() {
                this.state.partyListeners.forEach(off => off()); // Unsubscribe from all listeners
                this.state.partyListeners = [];
                this.state.currentPartyId = null;
                this.state.currentPartyData = null;
                if(this.dom.mainContent) this.dom.mainContent.innerHTML = '';
            },

            setupPartyPresence(partyId) {
                const userRef = ref(this.firebase.db, `parties/${partyId}/members/${this.state.currentUser.uid}`);
                set(userRef, this.state.currentUser.displayName);
                onDisconnect(userRef).remove();
            },

            setupPartyListeners(partyId) {
                const infoRef = ref(this.firebase.db, `parties/${partyId}/info`);
                const membersRef = ref(this.firebase.db, `parties/${partyId}/members`);
                const chatRef = ref(this.firebase.db, `parties/${partyId}/chat`);
                
                const offInfo = onValue(infoRef, (snapshot) => {
                    this.state.currentPartyData = snapshot.val();
                    this.ui.updatePlayerFromState();
                });
                const offMembers = onValue(membersRef, (snapshot) => this.ui.updateMemberList(snapshot.val()));
                const offChat = onValue(chatRef, (snapshot) => this.ui.updateChat(snapshot.val()));

                this.state.partyListeners.push(offInfo, offMembers, offChat);
            },

            // ========================
            //  PARTY ACTIONS (Play, Chat, etc)
            // ========================
            selectMedia(media) {
                if (this.state.currentUser.uid !== this.state.currentPartyData.hostId) {
                    alert('Only the host can change the movie!');
                    return;
                }
                const mediaRef = ref(this.firebase.db, `parties/${this.state.currentPartyId}/info/currentMedia`);
                const playerStateRef = ref(this.firebase.db, `parties/${this.state.currentPartyId}/playerState`);
                set(mediaRef, {
                    id: media.id,
                    type: media.title ? 'movie' : 'tv',
                    title: media.title || media.name
                });
                // Reset player when new media is selected
                set(playerStateRef, { isPlaying: false, currentTime: 0 });
            },

            handleChatSubmit(e) {
                e.preventDefault();
                const text = this.dom.chatInput.value.trim();
                if(!text) return;
                
                const chatRef = ref(this.firebase.db, `parties/${this.state.currentPartyId}/chat`);
                push(chatRef, {
                    uid: this.state.currentUser.uid,
                    displayName: this.state.currentUser.displayName,
                    text: text,
                    timestamp: Date.now()
                });
                this.dom.chatInput.value = '';
            },
            
            // ========================
            //  UI RENDERING & HELPERS
            // ========================
            ui: {
                _app: null, init(app) { this._app = app; },
                showView(viewName) {
                    document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
                    document.getElementById(`${viewName}-view`).classList.add('active');
                },

                showSpinner(show) { this.dom.globalSpinner.classList.toggle('d-none', !show); },
                
                async renderMovieBrowser() {
                    this.dom.mainContent.innerHTML = `<div class="p-5 text-center"><div class="spinner-border text-danger"></div></div>`;
                    let contentHtml = '<div id="player-container"></div>'; // Placeholder for player
                    const docFragment = document.createDocumentFragment();
                    for(const config of this._app.tmdb.ROW_CONFIG) {
                        const data = await this._app.api.fetchTMDB(config.endpoint);
                        if (data?.results) docFragment.appendChild(this.createMovieRow(config, data.results));
                    }
                    contentHtml += docFragment;
                    this.dom.mainContent.innerHTML = contentHtml;

                    this.dom.mainContent.querySelectorAll('.backdrop-card').forEach(card => {
                        card.addEventListener('click', () => {
                            const media = {id: card.dataset.id, type: card.dataset.mediaType, title: card.dataset.title};
                            this._app.selectMedia(media);
                        });
                    });

                    this.updatePlayerFromState();
                },
                
                createMovieRow(config, items) { /* ... Similar to previous versions, builds HTML for a row ... */ return document.createElement('div'); },
                createBackdropCard(item, mediaType) { /* ... Builds HTML for a card ... */ return document.createElement('div'); },

                updatePlayerFromState() {
                    const media = this._app.state.currentPartyData?.currentMedia;
                    const playerContainer = this.dom.mainContent.querySelector('#player-container');
                    if(!playerContainer) return;
                    
                    if (media?.id) {
                        playerContainer.innerHTML = `<div id="player-overlay"><button class="btn btn-link text-white back-btn"><i class="fas fa-arrow-left"></i></button><iframe src="${this._app.config.STREAMING_BASE_URL}${media.type}/${media.id}"></iframe></div>`;
                        playerContainer.querySelector('.back-btn').onclick = () => {
                            set(ref(this._app.firebase.db, `parties/${this._app.state.currentPartyId}/info/currentMedia`), null);
                        };
                    } else {
                        playerContainer.innerHTML = `<div class="p-5 text-center bg-dark rounded m-4"><h2>Welcome to the Party!</h2><p>The host can select a movie or show to begin.</p></div>`;
                    }
                },
                
                updateMemberList(members) {
                    if (!members) { this.dom.memberList.innerHTML = ''; this.dom.memberCount.textContent = 0; return; }
                    const hostId = this._app.state.currentPartyData?.hostId;
                    const memberKeys = Object.keys(members);
                    this.dom.memberCount.textContent = memberKeys.length;
                    this.dom.memberList.innerHTML = memberKeys.map(uid => `
                        <div class="member d-flex align-items-center">
                            <i class="fas fa-user-circle me-2"></i>
                            <span class="flex-grow-1">${members[uid]}</span>
                            ${uid === hostId ? '<i class="fas fa-crown"></i>' : ''}
                        </div>
                    `).join('');
                },

                updateChat(messages) {
                    if (!messages) { this.dom.chatMessages.innerHTML = ''; return; }
                    const sortedMessages = Object.values(messages).sort((a,b) => a.timestamp - b.timestamp);
                    this.dom.chatMessages.innerHTML = sortedMessages.map(msg => `
                        <div class="chat-message">
                            <strong>${msg.displayName}</strong>
                            <p>${msg.text}</p>
                        </div>
                    `).join('');
                    this.dom.chatMessages.scrollTop = this.dom.chatMessages.scrollHeight;
                },

                copyPartyId() { navigator.clipboard.writeText(this.state.currentPartyId).then(() => alert('Party ID copied to clipboard!')); }
            },
            
            // ========================
            //  API & HELPERS
            // ========================
            api: {
                async fetchTMDB(endpoint) {
                    const url = `${App.tmdb.API_BASE_URL}${endpoint}?api_key=${App.tmdb.API_KEY}`;
                    try {
                        const res = await fetch(url);
                        if (!res.ok) throw new Error('TMDB API Error');
                        return res.json();
                    } catch (err) {
                        console.error("fetchTMDB failed", err);
                        return null;
                    }
                }
            },
            generateId(length = 6) {
                const chars = 'ABCDEFGHIJKLMNPQRSTUVWXYZ123456789';
                let result = '';
                for (let i = 0; i < length; i++) result += chars.charAt(Math.floor(Math.random() * chars.length));
                return result;
            },
        };

        // --- Bootstraping UI helper methods that were too long to fit inline
        App.ui.createMovieRow = (config, items) => { const row = document.createElement('div'); row.className = "movie-row-wrapper"; let cardsHTML = ''; items.forEach(item => { if (item.backdrop_path || item.poster_path) { cardsHTML += App.ui.createBackdropCard(item, item.media_type || (item.title ? 'movie' : 'tv')).outerHTML; } }); row.innerHTML = `<h4 class="row-title">${config.title}</h4><div class="posters-container">${cardsHTML}</div>`; return row; };
        App.ui.createBackdropCard = (item, mediaType) => { const card = document.createElement('div'); const usePoster = !item.backdrop_path; card.className = `backdrop-card ${usePoster ? 'poster-card' : ''}`; card.dataset.id = item.id; card.dataset.mediaType = mediaType; card.dataset.title = item.title || item.name; const imagePath = usePoster ? item.poster_path : item.backdrop_path; card.innerHTML = `<img class="backdrop-img" src="${App.tmdb.IMAGE_BASE_URL}${imagePath}" alt="${item.title || item.name}" loading="lazy">`; return card; };


        // Finally, initialize the entire app.
        App.ui.init(App);
        App.init();

        // For convenience in browser console
        window.FlixPartyApp = App;
    </script>
</body>
</html>
