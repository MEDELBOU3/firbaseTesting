<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Party System with Firestore and Auth</title>
<style>
  body { font-family: Arial, sans-serif; max-width: 600px; margin: 40px auto; padding: 10px; }
  h1 { text-align: center; }
  input, textarea, button { width: 100%; padding: 8px; margin: 6px 0; box-sizing: border-box; }
  .section { border: 1px solid #ddd; padding: 15px; margin-bottom: 20px; border-radius: 6px; }
  .party-info { background: #f0f8ff; padding: 10px; border-radius: 6px; }
  .error { color: red; }
  .success { color: green; }
  #userStatus { margin-bottom: 15px; }
</style>
</head>
<body>

<h1>Party System (Firestore + Auth)</h1>

<div id="userStatus">Checking authentication...</div>

<div class="section" id="create-party-section" style="display:none;">
  <h2>Create Party</h2>
  <input type="text" id="partyName" placeholder="Party Name" />
  <textarea id="partyDesc" placeholder="Party Description" rows="3"></textarea>
  <button id="createPartyBtn">Create Party</button>
  <p id="createResult"></p>
</div>

<div class="section" id="join-party-section" style="display:none;">
  <h2>Join Party</h2>
  <input type="text" id="joinPartyKey" placeholder="Enter Party Key" />
  <button id="joinPartyBtn">Join Party</button>
  <p id="joinResult"></p>
</div>

<div class="section" id="partyDetails" style="display:none;">
  <h2>Party Details</h2>
  <div class="party-info" id="partyInfo"></div>
</div>

<script type="module">
// Firebase imports
import { initializeApp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-app.js";
import { getAuth, onAuthStateChanged, signInAnonymously } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-auth.js";
import { getFirestore, doc, setDoc, getDoc, collection, query, where, getDocs, Timestamp } from "https://www.gstatic.com/firebasejs/11.10.0/firebase-firestore.js";

// Your config
const firebaseConfig = {
  apiKey: "AIzaSyDp2V0ULE-32AcIJ92a_e3mhMe6f6yZ_H4",
  authDomain: "sm4movies.firebaseapp.com",
  projectId: "sm4movies",
  storageBucket: "sm4movies.firebasestorage.app",
  messagingSenderId: "277353836953",
  appId: "1:277353836953:web:85e02783526c7cb58de308",
  measurementId: "G-690RSNJ2Q2"
};

// Initialize
const app = initializeApp(firebaseConfig);
const auth = getAuth(app);
const db = getFirestore(app);

// UI Elements
const userStatus = document.getElementById('userStatus');
const createPartySection = document.getElementById('create-party-section');
const joinPartySection = document.getElementById('join-party-section');
const partyDetailsSection = document.getElementById('partyDetails');

const partyNameInput = document.getElementById("partyName");
const partyDescInput = document.getElementById("partyDesc");
const createPartyBtn = document.getElementById("createPartyBtn");
const createResult = document.getElementById("createResult");

const joinPartyKeyInput = document.getElementById("joinPartyKey");
const joinPartyBtn = document.getElementById("joinPartyBtn");
const joinResult = document.getElementById("joinResult");

const partyInfoDiv = document.getElementById("partyInfo");

let currentUser = null;

// Simple party key generator (6 chars uppercase)
function generatePartyKey() {
  return Math.random().toString(36).substring(2, 8).toUpperCase();
}

// Auth state observer
onAuthStateChanged(auth, user => {
  if (user) {
    currentUser = user;
    userStatus.textContent = `Signed in as UID: ${user.uid}`;
    createPartySection.style.display = "block";
    joinPartySection.style.display = "block";
  } else {
    userStatus.textContent = "Signing in anonymously...";
    // Sign in anonymously if no user
    signInAnonymously(auth).catch(error => {
      userStatus.textContent = `Auth error: ${error.message}`;
    });
  }
});

// Create party
createPartyBtn.addEventListener("click", async () => {
  const name = partyNameInput.value.trim();
  const desc = partyDescInput.value.trim();

  if (!name) {
    createResult.textContent = "Party name is required.";
    createResult.className = "error";
    return;
  }

  const key = generatePartyKey();

  try {
    const partyRef = doc(db, "parties", key);
    await setDoc(partyRef, {
      name,
      description: desc,
      createdAt: Timestamp.now(),
      createdBy: currentUser.uid
    });

    createResult.textContent = `Party created! Your party key is: ${key}`;
    createResult.className = "success";
    partyNameInput.value = "";
    partyDescInput.value = "";
  } catch (err) {
    createResult.textContent = "Error creating party: " + err.message;
    createResult.className = "error";
  }
});

// Join party
joinPartyBtn.addEventListener("click", async () => {
  const key = joinPartyKeyInput.value.trim().toUpperCase();

  if (!key) {
    joinResult.textContent = "Please enter a party key.";
    joinResult.className = "error";
    partyDetailsSection.style.display = "none";
    return;
  }

  try {
    const partyRef = doc(db, "parties", key);
    const partySnap = await getDoc(partyRef);

    if (partySnap.exists()) {
      const partyData = partySnap.data();
      joinResult.textContent = "Joined party successfully!";
      joinResult.className = "success";

      partyInfoDiv.innerHTML = `
        <strong>Name:</strong> ${partyData.name} <br/>
        <strong>Description:</strong> ${partyData.description || "No description"} <br/>
        <strong>Created:</strong> ${partyData.createdAt.toDate().toLocaleString()} <br/>
        <strong>Created By UID:</strong> ${partyData.createdBy}
      `;

      partyDetailsSection.style.display = "block";
      joinPartyKeyInput.value = "";
    } else {
      joinResult.textContent = "Party not found with that key.";
      joinResult.className = "error";
      partyDetailsSection.style.display = "none";
    }
  } catch (err) {
    joinResult.textContent = "Error joining party: " + err.message;
    joinResult.className = "error";
    partyDetailsSection.style.display = "none";
  }
});
</script>

</body>
</html>
