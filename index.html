<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AppHub Pro - Professional App Store</title>

  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous">
  <!-- Font Awesome -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css" integrity="sha512-DTOQO9RWCH3ppGqcWaEA1BIZOC6xxalwEsw9c2QQeAIftl+Vegovlnee1c9QX4TctnWMn13TZye+giMm8e2LwA==" crossorigin="anonymous" referrerpolicy="no-referrer" />

  <style>
    :root {
      /* Light Theme (Default) */
      --bg-color: #f8f9fa; /* Light Gray */
      --text-color: #212529; /* Dark Gray / Black */
      --card-bg: #fff;
      --card-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.075);
      --card-hover-shadow: 0 0.75rem 1.5rem rgba(0, 0, 0, 0.1);
      --border-color: #dee2e6;
      --primary-accent: #0D6EFD; /* Bootstrap Primary Blue */
      --primary-accent-hover: #0b5ed7;
      --secondary-text: #6c757d; /* Bootstrap Secondary Gray */
      --navbar-bg: #fff;
      --navbar-text: var(--primary-accent);
      --sidebar-bg: #fff;
      --sidebar-link-color: #495057;
      --sidebar-link-active-bg: var(--primary-accent);
      --sidebar-link-active-color: #fff;
      --modal-header-bg: var(--primary-accent);
      --modal-header-text: #fff;
      --btn-primary-bg: var(--primary-accent);
      --btn-primary-border: var(--primary-accent);
      --btn-primary-hover-bg: var(--primary-accent-hover);
      --btn-primary-hover-border: var(--primary-accent-hover);
      --placeholder-gradient-start: var(--primary-accent);
      --placeholder-gradient-end: #589bff;
      --link-color: var(--primary-accent);
      --footer-bg: #343a40;
      --footer-text: #f8f9fa;
    }

    body[data-theme="dark"] {
      --bg-color: #1a1d24; /* Darker Gray */
      --text-color: #e9ecef; /* Light Gray / White */
      --card-bg: #2c303a;   /* Dark Card Background */
      --card-shadow: 0 0.5rem 1rem rgba(0, 0, 0, 0.2);
      --card-hover-shadow: 0 0.75rem 1.5rem rgba(0, 0, 0, 0.25);
      --border-color: #495057; /* Darker Border */
      --primary-accent: #28a745; /* Forest Green */
      --primary-accent-hover: #1e7e34; /* Darker Forest Green */
      --secondary-text: #adb5bd; /* Lighter secondary text */
      --navbar-bg: #212529; /* Dark Navbar */
      --navbar-text: var(--primary-accent);
      --sidebar-bg: #212529; /* Dark Sidebar */
      --sidebar-link-color: #ced4da;
      --sidebar-link-active-bg: var(--primary-accent);
      --sidebar-link-active-color: #fff;
      --modal-header-bg: var(--primary-accent);
      --modal-header-text: #fff;
      --btn-primary-bg: var(--primary-accent);
      --btn-primary-border: var(--primary-accent);
      --btn-primary-hover-bg: var(--primary-accent-hover);
      --btn-primary-hover-border: var(--primary-accent-hover);
      --placeholder-gradient-start: var(--primary-accent);
      --placeholder-gradient-end: #38c172; /* Lighter green for gradient */
      --link-color: var(--primary-accent);
      --footer-bg: #111317;
      --footer-text: #ced4da;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background-color: var(--bg-color);
      color: var(--text-color);
      display: flex;
      flex-direction: column;
      min-height: 100vh;
      transition: background-color 0.3s, color 0.3s;
    }

    .navbar {
      background-color: var(--navbar-bg);
      box-shadow: 0 0.125rem 0.25rem rgba(0,0,0,0.075);
      transition: background-color 0.3s;
    }

    .navbar-brand {
      font-weight: bold;
      color: var(--navbar-text) !important;
    }

    #main-content {
        padding-top: 1rem;
        flex: 1;
    }
    
    .sidebar {
      background-color: var(--sidebar-bg);
      padding: 1.5rem 1rem;
      border-right: 1px solid var(--border-color);
      height: calc(100vh - 56px); 
      position: sticky;
      top: 56px; 
      overflow-y: auto;
      transition: background-color 0.3s, border-color 0.3s;
    }

    .sidebar .nav-link {
      color: var(--sidebar-link-color);
      padding: 0.5rem 1rem;
      border-radius: 0.375rem;
      transition: background-color 0.2s, color 0.2s;
    }
    .sidebar .nav-link:hover, .sidebar .nav-link.active {
      background-color: var(--sidebar-link-active-bg);
      color: var(--sidebar-link-active-color);
    }
    .sidebar .nav-link .fas {
      margin-right: 0.5rem;
    }
    .sidebar h5 {
        color: var(--primary-accent);
        margin-top: 1rem;
        margin-bottom: 0.5rem;
        font-size: 0.9rem;
        text-transform: uppercase;
        letter-spacing: 0.5px;
        transition: color 0.3s;
    }


    .app-card {
      transition: all 0.3s ease;
      box-shadow: var(--card-shadow);
      border: 1px solid var(--border-color);
      background-color: var(--card-bg);
      height: 100%; 
    }

    .app-card:hover {
      transform: translateY(-5px);
      box-shadow: var(--card-hover-shadow);
    }

    .app-card .card-img-top-placeholder {
      width: 100%;
      height: 180px; 
      background: linear-gradient(45deg, var(--placeholder-gradient-start), var(--placeholder-gradient-end));
      display: flex;
      align-items: center;
      justify-content: center;
      color: white;
      font-size: 3rem;
      font-weight: bold;
      border-top-left-radius: calc(0.375rem - 1px);
      border-top-right-radius: calc(0.375rem - 1px);
      transition: background 0.3s;
    }
    .app-card .card-title {
      font-weight: 600;
      color: var(--text-color);
    }
    .app-card .card-subtitle {
      font-size: 0.9rem;
      color: var(--secondary-text);
    }
    .app-card .app-rating .fas.fa-star {
      color: #ffc107; 
    }
    .app-card .app-category-tag {
        background-color: var(--bg-color); /* Use main bg for contrast */
        color: var(--primary-accent);
        padding: 0.25em 0.6em;
        font-size: 0.75em;
        border-radius: 10rem;
        border: 1px solid var(--primary-accent);
        transition: background-color 0.3s, color 0.3s, border-color 0.3s;
    }

    .modal-content {
        background-color: var(--card-bg); /* Use card-bg for modal consistency */
        color: var(--text-color);
        border: 1px solid var(--border-color);
    }
    .modal-header {
        background-color: var(--modal-header-bg);
        color: var(--modal-header-text);
        border-bottom: 1px solid var(--border-color);
    }
    .modal-header .btn-close {
        filter: invert(1) grayscale(100%) brightness(200%) var(--theme-filter, ''); /* Allow theme-specific filter */
    }
    body[data-theme="dark"] .modal-header .btn-close {
        --theme-filter: brightness(100%); /* Adjust if needed for dark theme */
    }

    .form-control, .form-select {
        background-color: var(--card-bg); /* Use card-bg for inputs */
        color: var(--text-color);
        border: 1px solid var(--border-color);
    }
    .form-control:focus, .form-select:focus {
        background-color: var(--card-bg);
        color: var(--text-color);
        border-color: var(--primary-accent);
        box-shadow: 0 0 0 0.25rem rgba(var(--primary-accent-rgb, 13, 110, 253), 0.25); /* Dynamically set RGB for shadow */
    }
    body[data-theme="dark"] .form-control:focus, 
    body[data-theme="dark"] .form-select:focus {
      --primary-accent-rgb: 40, 167, 69; /* RGB for forest green */
    }


    .upload-area {
      border: 2px dashed var(--primary-accent);
      border-radius: 0.375rem;
      padding: 40px;
      text-align: center;
      cursor: pointer;
      transition: all 0.3s ease;
      background-color: rgba(var(--primary-accent-rgb, 13, 110, 253), 0.02);
    }
    .upload-area:hover, .upload-area.dragover {
      background-color: rgba(var(--primary-accent-rgb, 13, 110, 253), 0.05);
    }
    body[data-theme="dark"] .upload-area {
      --primary-accent-rgb: 40, 167, 69; /* RGB for forest green */
    }


    .btn-primary {
        background-color: var(--btn-primary-bg);
        border-color: var(--btn-primary-border);
        color: #fff; /* Ensure text is white on primary buttons */
    }
    .btn-primary:hover {
        background-color: var(--btn-primary-hover-bg);
        border-color: var(--btn-primary-hover-border);
        color: #fff;
    }
    .btn-outline-primary {
        color: var(--primary-accent);
        border-color: var(--primary-accent);
    }
    .btn-outline-primary:hover {
        color: #fff;
        background-color: var(--primary-accent);
        border-color: var(--primary-accent);
    }
     .btn-outline-secondary {
        color: var(--secondary-text);
        border-color: var(--secondary-text);
    }
    .btn-outline-secondary:hover {
        color: var(--bg-color); /* Contrast with secondary button hover background */
        background-color: var(--secondary-text);
        border-color: var(--secondary-text);
    }


    .status-message {
      font-weight: 500;
    }

    .content-area {
      min-height: calc(100vh - 56px - 2rem); 
    }
    .footer {
        background-color: var(--footer-bg);
        color: var(--footer-text);
        padding: 1rem 0;
        text-align: center;
        margin-top: auto; 
        transition: background-color 0.3s, color 0.3s;
    }

    .stat-card {
        background-color: var(--card-bg);
        border-radius: 0.5rem;
        padding: 1.5rem;
        text-align: center;
        box-shadow: var(--card-shadow);
        margin-bottom: 1rem;
        border: 1px solid var(--border-color);
        transition: background-color 0.3s, border-color 0.3s;
    }
    .stat-card .stat-number {
        font-size: 2.5rem;
        font-weight: bold;
        color: var(--primary-accent);
        transition: color 0.3s;
    }
    .stat-card .stat-label {
        font-size: 1rem;
        color: var(--secondary-text);
        transition: color 0.3s;
    }

    .apps-grid .col {
        margin-bottom: 1.5rem;
    }

    /* Theme toggle button specific styles */
    #themeToggle {
        min-width: 40px; /* Ensure it has some width for the icon */
    }
    .dropdown-menu {
        background-color: var(--card-bg);
        border: 1px solid var(--border-color);
    }
    .dropdown-item {
        color: var(--text-color);
    }
    .dropdown-item:hover, .dropdown-item:focus {
        background-color: rgba(var(--primary-accent-rgb, 13, 110, 253), 0.1);
        color: var(--primary-accent);
    }
    body[data-theme="dark"] .dropdown-item:hover,
    body[data-theme="dark"] .dropdown-item:focus {
         --primary-accent-rgb: 40, 167, 69;
    }
    .dropdown-divider {
        border-top: 1px solid var(--border-color);
    }
    .border-bottom {
        border-bottom: 1px solid var(--border-color) !important;
    }


  </style>
</head>
<body data-theme="light"> <!-- Default theme -->

  <!-- Navbar -->
  <nav class="navbar navbar-expand-lg sticky-top">
    <div class="container-fluid">
      <a class="navbar-brand" href="#" onclick="navigateTo('discover', event)"><i class="fas fa-rocket"></i> AppHub Pro</a>
      <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav" aria-controls="navbarNav" aria-expanded="false" aria-label="Toggle navigation">
        <span class="navbar-toggler-icon"></span>
      </button>
      <div class="collapse navbar-collapse" id="navbarNav">
        <ul class="navbar-nav me-auto mb-2 mb-lg-0">
          <!-- Future nav items -->
        </ul>
        <form class="d-flex me-3" role="search" id="searchForm">
          <input class="form-control me-2" type="search" placeholder="Search apps..." aria-label="Search" id="searchInputGlobal">
          <button class="btn btn-outline-primary" type="submit"><i class="fas fa-search"></i></button>
        </form>
        <button class="btn btn-outline-secondary me-2" id="themeToggle" title="Toggle Theme">
            <i class="fas fa-moon"></i> <!-- Moon for dark, Sun for light -->
        </button>
        <div id="authSectionNav">
          <!-- Populated by JS: Sign In button or User Dropdown -->
        </div>
      </div>
    </div>
  </nav>

  <div class="container-fluid" id="main-content">
    <div class="row">
      <!-- Sidebar -->
      <nav id="sidebarMenu" class="col-md-3 col-lg-2 d-md-block sidebar collapse">
        <div class="position-sticky pt-3">
          <ul class="nav flex-column">
            <li class="nav-item">
              <a class="nav-link active" href="#" onclick="navigateTo('discover', event)">
                <i class="fas fa-compass"></i> Discover
              </a>
            </li>
            <li class="nav-item" id="myAppsSidebarLink" style="display: none;">
              <a class="nav-link" href="#" onclick="navigateTo('myapps', event)">
                <i class="fas fa-mobile-alt"></i> My Apps
              </a>
            </li>
            <li class="nav-item" id="analyticsSidebarLink" style="display: none;">
              <a class="nav-link" href="#" onclick="navigateTo('analytics', event)">
                <i class="fas fa-chart-line"></i> Platform Stats
              </a>
            </li>
            <li class="nav-item" id="uploadAppSidebarLink" style="display: none;">
                <a class="nav-link" href="#" onclick="showUploadModal(); event.preventDefault();">
                  <i class="fas fa-upload"></i> Upload App
                </a>
              </li>
          </ul>

          <h5 class="sidebar-heading d-flex justify-content-between align-items-center px-3 mt-4 mb-1" id="categoriesHeader">
            <span>Categories</span>
          </h5>
          <ul class="nav flex-column mb-2" id="categoryFilterList">
            <li class="nav-item"><a class="nav-link filter-category active" href="#" data-category="">All Categories</a></li>
            <li class="nav-item"><a class="nav-link filter-category" href="#" data-category="productivity">Productivity</a></li>
            <li class="nav-item"><a class="nav-link filter-category" href="#" data-category="games">Games</a></li>
            <li class="nav-item"><a class="nav-link filter-category" href="#" data-category="education">Education</a></li>
            <li class="nav-item"><a class="nav-link filter-category" href="#" data-category="utilities">Utilities</a></li>
            <li class="nav-item"><a class="nav-link filter-category" href="#" data-category="entertainment">Entertainment</a></li>
            <li class="nav-item"><a class="nav-link filter-category" href="#" data-category="business">Business</a></li>
          </ul>
        </div>
      </nav>

      <!-- Main content -->
      <main class="col-md-9 ms-sm-auto col-lg-10 px-md-4 content-area">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
          <h1 class="h2" id="pageTitle">Discover Apps</h1>
          <div class="btn-toolbar mb-2 mb-md-0" id="pageActions">
            <select class="form-select form-select-sm me-2" id="sortFilter" style="width: auto;">
              <option value="newest">Sort: Newest</option>
              <option value="popular">Sort: Popular</option>
              <option value="rating">Sort: Highest Rated</option>
            </select>
          </div>
        </div>

        <!-- Content sections, one active at a time -->
        <div id="discoverContent" class="page-section">
          <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 row-xl-4 g-4 apps-grid" id="appsGrid">
            <!-- App cards will be injected here -->
          </div>
          <div id="noAppsMessage" class="text-center p-5" style="display:none;">
            <h3><i class="fas fa-box-open fa-2x mb-3"></i></h3>
            <h4>No apps found.</h4>
            <p>Try adjusting your search or filters.</p>
          </div>
        </div>

        <div id="myAppsContent" class="page-section" style="display: none;">
          <div class="row mb-4">
            <div class="col-lg-4 col-md-6 mb-3">
                <div class="stat-card">
                    <div class="stat-number" id="myTotalApps">0</div>
                    <div class="stat-label">My Total Apps</div>
                </div>
            </div>
            <div class="col-lg-4 col-md-6 mb-3">
                <div class="stat-card">
                    <div class="stat-number" id="myTotalDownloads">0</div>
                    <div class="stat-label">My App Downloads</div>
                </div>
            </div>
            <div class="col-lg-4 col-md-12 mb-3"> <!-- Make avg rating full width on md if only 3 stats -->
                <div class="stat-card">
                    <div class="stat-number" id="myAvgRating">0.0</div>
                    <div class="stat-label">My Average Rating</div>
                </div>
            </div>
          </div>
          <div class="row row-cols-1 row-cols-sm-2 row-cols-lg-3 row-xl-4 g-4 apps-grid" id="myAppsGrid">
            <!-- My App cards -->
          </div>
           <div id="noMyAppsMessage" class="text-center p-5" style="display:none;">
            <h3><i class="fas fa-folder-plus fa-2x mb-3"></i></h3>
            <h4>You haven't uploaded any apps yet.</h4>
            <button class="btn btn-primary mt-3" onclick="showUploadModal()"><i class="fas fa-upload"></i> Upload Your First App</button>
          </div>
        </div>

        <div id="analyticsContent" class="page-section" style="display: none;">
          <div class="row">
             <div class="col-lg-4 col-md-6 mb-3">
                <div class="stat-card">
                    <div class="stat-number" id="platformApps">0</div>
                    <div class="stat-label">Total Platform Apps</div>
                </div>
            </div>
            <div class="col-lg-4 col-md-6 mb-3">
                <div class="stat-card">
                    <div class="stat-number" id="activeUsers">0</div>
                    <div class="stat-label">Active Developers</div>
                </div>
            </div>
            <div class="col-lg-4 col-md-12 mb-3">
                <div class="stat-card">
                    <div class="stat-number" id="platformDownloads">0</div>
                    <div class="stat-label">Total Platform Downloads</div>
                </div>
            </div>
          </div>
        </div>

      </main>
    </div>
  </div>

  <footer class="footer">
      <div class="container">
          <span>Â© 2024 AppHub Pro. Crafted with <i class="fas fa-heart text-danger"></i>.</span>
      </div>
  </footer>

  <!-- Auth Modal -->
  <div class="modal fade" id="authModal" tabindex="-1" aria-labelledby="authModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="authModalLabel">Sign In to AppHub Pro</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <div class="form-floating mb-3">
            <input type="email" class="form-control" id="authEmail" placeholder="name@example.com">
            <label for="authEmail">Email address</label>
          </div>
          <div class="form-floating mb-3">
            <input type="password" class="form-control" id="authPassword" placeholder="Password">
            <label for="authPassword">Password</label>
          </div>
          <div id="authStatus" class="mb-3"></div>
        </div>
        <div class="modal-footer justify-content-between">
            <button type="button" class="btn btn-link" onclick="promptSignUp()">New user? Create account</button>
            <div>
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" onclick="signIn()">Sign In</button>
            </div>
        </div>
      </div>
    </div>
  </div>

  <!-- Upload Modal -->
  <div class="modal fade" id="uploadModal" tabindex="-1" aria-labelledby="uploadModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg modal-dialog-centered">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="uploadModalLabel">Upload New App</h5>
          <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
        </div>
        <div class="modal-body">
          <form id="uploadForm">
            <div class="mb-3">
              <label for="appName" class="form-label">App Name *</label>
              <input type="text" class="form-control" id="appName" required>
            </div>
            <div class="mb-3">
              <label for="appDescription" class="form-label">Description *</label>
              <textarea class="form-control" id="appDescription" rows="3" required></textarea>
            </div>
            <div class="row">
                <div class="col-md-6 mb-3">
                    <label for="appCategory" class="form-label">Category *</label>
                    <select class="form-select" id="appCategory" required>
                        <option value="">Select Category...</option>
                        <option value="productivity">Productivity</option>
                        <option value="games">Games</option>
                        <option value="education">Education</option>
                        <option value="utilities">Utilities</option>
                        <option value="entertainment">Entertainment</option>
                        <option value="business">Business</option>
                    </select>
                </div>
                <div class="col-md-6 mb-3">
                    <label for="appVersion" class="form-label">Version</label>
                    <input type="text" class="form-control" id="appVersion" placeholder="e.g., 1.0.0">
                </div>
            </div>
            <div class="mb-3">
              <label for="appFile" class="form-label">App File * <small>(.zip, .apk, .ipa - Max 50MB)</small></label>
              <div class="upload-area" id="uploadDropArea">
                <p><i class="fas fa-cloud-upload-alt fa-3x"></i></p>
                <p id="uploadAreaText">Click or drag & drop file here</p>
              </div>
              <input type="file" id="appFile" accept=".zip,.apk,.ipa" class="d-none">
            </div>
            <div id="uploadStatus" class="mb-3"></div>
            <div class="d-flex justify-content-end">
                <button type="button" class="btn btn-secondary me-2" data-bs-dismiss="modal">Cancel</button>
                <button type="submit" class="btn btn-primary"><i class="fas fa-upload"></i> Upload App</button>
            </div>
          </form>
        </div>
      </div>
    </div>
  </div>


  <!-- Firebase -->
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-auth-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-storage-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

  <!-- Bootstrap JS -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js" integrity="sha384-C6RzsynM9kWDrMNeT87bh95OGNyZPhcTNXj1NW7RuBCsyN/o0jlpcV8Qyq46cDfL" crossorigin="anonymous"></script>

  <script>
    // Firebase Configuration (REPLACE with your actual config)
    const firebaseConfig = {
      apiKey: "YOUR_API_KEY",
      authDomain: "YOUR_AUTH_DOMAIN",
      projectId: "YOUR_PROJECT_ID",
      storageBucket: "YOUR_STORAGE_BUCKET",
      messagingSenderId: "YOUR_MESSAGING_SENDER_ID",
      appId: "YOUR_APP_ID",
      measurementId: "YOUR_MEASUREMENT_ID" // Optional
    };

    // Initialize Firebase
    firebase.initializeApp(firebaseConfig);
    const auth = firebase.auth();
    const storage = firebase.storage();
    const db = firebase.firestore();

    // Global variables
    let currentUser = null;
    let allApps = []; 
    let currentCategoryFilter = ""; 
    let currentSortFilter = "newest";
    let currentSearchTerm = "";

    // Bootstrap Modals
    let authModalInstance, uploadModalInstance;

    // --- Theme Management ---
    const themeToggle = document.getElementById('themeToggle');
    const currentTheme = localStorage.getItem('theme') ? localStorage.getItem('theme') : 'light';

    function applyTheme(theme) {
        document.body.setAttribute('data-theme', theme);
        localStorage.setItem('theme', theme);
        themeToggle.innerHTML = theme === 'dark' ? '<i class="fas fa-sun"></i>' : '<i class="fas fa-moon"></i>';
         // Update RGB variables for focus outlines dynamically
        if (theme === 'dark') {
            document.documentElement.style.setProperty('--primary-accent-rgb', '40, 167, 69'); // Forest green RGB
        } else {
            document.documentElement.style.setProperty('--primary-accent-rgb', '13, 110, 253'); // Bootstrap blue RGB
        }
    }
    applyTheme(currentTheme); // Apply stored theme on load

    themeToggle.addEventListener('click', () => {
        let theme = document.body.getAttribute('data-theme');
        applyTheme(theme === 'dark' ? 'light' : 'dark');
    });


    // --- UI Navigation & State ---
    function navigateTo(page, event) {
        if(event) event.preventDefault();

        document.querySelectorAll('.page-section').forEach(section => section.style.display = 'none');
        document.querySelectorAll('#sidebarMenu .nav-link').forEach(link => link.classList.remove('active'));
        
        const pageTitle = document.getElementById('pageTitle');
        const pageActions = document.getElementById('pageActions'); // Div containing sort filter
        const categoriesHeader = document.getElementById('categoriesHeader');
        const categoryFilterList = document.getElementById('categoryFilterList');

        if (page === 'discover') {
            pageActions.style.display = 'flex';
            categoriesHeader.style.display = 'block';
            categoryFilterList.style.display = 'block';
        } else {
            pageActions.style.display = 'none';
            categoriesHeader.style.display = 'none';
            categoryFilterList.style.display = 'none';
        }

        switch(page) {
            case 'discover':
                document.getElementById('discoverContent').style.display = 'block';
                document.querySelector('#sidebarMenu .nav-link[onclick*="discover"]').classList.add('active');
                pageTitle.textContent = 'Discover Apps';
                loadApps();
                break;
            case 'myapps':
                if (!currentUser) { showAuthModal(); return; }
                document.getElementById('myAppsContent').style.display = 'block';
                document.querySelector('#sidebarMenu .nav-link[onclick*="myapps"]').classList.add('active');
                pageTitle.textContent = 'My Apps Dashboard';
                loadMyApps();
                break;
            case 'analytics': // Renamed to Platform Stats in UI
                if (!currentUser) { showAuthModal(); return; }
                document.getElementById('analyticsContent').style.display = 'block';
                document.querySelector('#sidebarMenu .nav-link[onclick*="analytics"]').classList.add('active');
                pageTitle.textContent = 'Platform Statistics';
                loadPlatformAnalytics();
                break;
        }
    }


    // --- Authentication ---
    auth.onAuthStateChanged((user) => {
      currentUser = user;
      updateAuthUI();
      if (user) {
        // No need to auto-load myapps/analytics here, navigateTo handles it
      } else {
        if(document.getElementById('myAppsContent').style.display === 'block' || 
           document.getElementById('analyticsContent').style.display === 'block') {
            navigateTo('discover'); // If on a protected page, redirect
        }
      }
    });

    function updateAuthUI() {
      const authSectionNav = document.getElementById('authSectionNav');
      const myAppsSidebarLink = document.getElementById('myAppsSidebarLink');
      const analyticsSidebarLink = document.getElementById('analyticsSidebarLink');
      const uploadAppSidebarLink = document.getElementById('uploadAppSidebarLink');

      if (currentUser) {
        authSectionNav.innerHTML = `
          <div class="dropdown">
            <button class="btn btn-outline-primary dropdown-toggle" type="button" id="userDropdown" data-bs-toggle="dropdown" aria-expanded="false">
              <i class="fas fa-user-circle me-1"></i> ${currentUser.email.split('@')[0]}
            </button>
            <ul class="dropdown-menu dropdown-menu-end" aria-labelledby="userDropdown">
              <li><a class="dropdown-item" href="#" onclick="navigateTo('myapps', event)"><i class="fas fa-mobile-alt fa-fw me-2"></i>My Apps</a></li>
              <li><a class="dropdown-item" href="#" onclick="navigateTo('analytics', event)"><i class="fas fa-chart-line fa-fw me-2"></i>Platform Stats</a></li>
              <li><hr class="dropdown-divider"></li>
              <li><a class="dropdown-item" href="#" onclick="showUploadModal()"><i class="fas fa-upload fa-fw me-2"></i>Upload App</a></li>
              <li><a class="dropdown-item" href="#" onclick="signOut()"><i class="fas fa-sign-out-alt fa-fw me-2"></i>Sign Out</a></li>
            </ul>
          </div>
        `;
        myAppsSidebarLink.style.display = 'block';
        analyticsSidebarLink.style.display = 'block';
        uploadAppSidebarLink.style.display = 'block';

      } else {
        authSectionNav.innerHTML = `
          <button class="btn btn-primary" onclick="showAuthModal()">
            <i class="fas fa-sign-in-alt me-1"></i> Sign In
          </button>
        `;
        myAppsSidebarLink.style.display = 'none';
        analyticsSidebarLink.style.display = 'none';
        uploadAppSidebarLink.style.display = 'none';
      }
    }

    function showAuthModal() {
      authModalInstance.show();
    }
    
    function promptSignUp() {
        const email = document.getElementById('authEmail').value;
        const password = document.getElementById('authPassword').value;
        if (!email || !password) {
            showStatus('authStatus', 'Please enter email and password to create an account.', 'warning', 'authModal');
            return;
        }
        if (password.length < 6) {
            showStatus('authStatus', 'Password should be at least 6 characters.', 'warning', 'authModal');
            return;
        }
        signUp(email, password);
    }

    async function signIn() {
      const email = document.getElementById('authEmail').value;
      const password = document.getElementById('authPassword').value;
      try {
        await auth.signInWithEmailAndPassword(email, password);
        authModalInstance.hide();
        showGlobalToast('Signed in successfully!', 'success');
      } catch (error) {
        showStatus('authStatus', error.message, 'danger', 'authModal');
      }
    }

    async function signUp(email, password) { 
      try {
        await auth.createUserWithEmailAndPassword(email, password);
        authModalInstance.hide();
        showGlobalToast('Account created! You are now signed in.', 'success');
      } catch (error) {
        showStatus('authStatus', error.message, 'danger', 'authModal');
      }
    }

    function signOut() {
      auth.signOut().then(() => {
        showGlobalToast('Signed out successfully.', 'info');
      });
    }

    // --- App Upload ---
    function showUploadModal() {
      if (!currentUser) {
        showAuthModal();
        return;
      }
      document.getElementById('uploadForm').reset();
      document.getElementById('uploadAreaText').textContent = 'Click or drag & drop file here';
      document.getElementById('uploadStatus').innerHTML = '';
      uploadModalInstance.show();
    }
    
    const uploadDropArea = document.getElementById('uploadDropArea');
    const appFileInput = document.getElementById('appFile');
    const uploadAreaText = document.getElementById('uploadAreaText');

    uploadDropArea.addEventListener('click', () => appFileInput.click());
    appFileInput.addEventListener('change', (e) => handleFileSelect(e.target.files));

    ['dragenter', 'dragover', 'dragleave', 'drop'].forEach(eventName => {
      uploadDropArea.addEventListener(eventName, preventDefaults, false);
    });
    function preventDefaults(e) { e.preventDefault(); e.stopPropagation(); }
    ['dragenter', 'dragover'].forEach(eventName => {
      uploadDropArea.addEventListener(eventName, () => uploadDropArea.classList.add('dragover'), false);
    });
    ['dragleave', 'drop'].forEach(eventName => {
      uploadDropArea.addEventListener(eventName, () => uploadDropArea.classList.remove('dragover'), false);
    });
    uploadDropArea.addEventListener('drop', (e) => handleFileSelect(e.dataTransfer.files), false);

    function handleFileSelect(files) {
        if (files.length > 0) {
            appFileInput.files = files; 
            uploadAreaText.textContent = `Selected: ${files[0].name}`;
        }
    }

    document.getElementById('uploadForm').addEventListener('submit', async (e) => {
      e.preventDefault();
      if (!currentUser) {
        showStatus('uploadStatus', 'You must be signed in.', 'danger', 'uploadModal');
        return;
      }

      const name = document.getElementById('appName').value;
      const description = document.getElementById('appDescription').value;
      const category = document.getElementById('appCategory').value;
      const version = document.getElementById('appVersion').value || '1.0.0';
      const file = appFileInput.files[0];

      if (!file || !name || !description || !category) {
        showStatus('uploadStatus', 'Please fill all required fields and select an app file.', 'warning', 'uploadModal');
        return;
      }
      if (file.size > 50 * 1024 * 1024) { // 50MB
        showStatus('uploadStatus', 'File size exceeds 50MB limit.', 'warning', 'uploadModal');
        return;
      }

      showStatus('uploadStatus', `<div class="progress" style="height: 20px;"><div class="progress-bar progress-bar-striped progress-bar-animated" role="progressbar" style="width: 10%" aria-valuenow="10" aria-valuemin="0" aria-valuemax="100">Uploading...</div></div>`, 'info', 'uploadModal', false);
      const progressBar = document.querySelector('#uploadStatus .progress-bar');

      try {
        const fileRef = storage.ref().child(`apps/${currentUser.uid}/${Date.now()}_${file.name}`);
        const uploadTask = fileRef.put(file);

        uploadTask.on('state_changed',
          (snapshot) => {
            const progress = (snapshot.bytesTransferred / snapshot.totalBytes) * 100;
            if(progressBar) progressBar.style.width = progress + '%';
          },
          (error) => {
            console.error('Upload error:', error);
            showStatus('uploadStatus', `Upload failed: ${error.message}`, 'danger', 'uploadModal');
          },
          async () => {
            const downloadURL = await fileRef.getDownloadURL();
            await db.collection('apps').add({
              name, description, category, version, downloadURL,
              fileName: file.name, fileSize: file.size,
              developerEmail: currentUser.email, developerId: currentUser.uid,
              createdAt: firebase.firestore.FieldValue.serverTimestamp(),
              updatedAt: firebase.firestore.FieldValue.serverTimestamp(),
              downloads: 0, ratingSum: 0, ratingCount: 0, 
              ratingAverage: 0, // Initialize average rating
              status: 'active' 
            });
            showStatus('uploadStatus', 'App uploaded successfully!', 'success', 'uploadModal');
            document.getElementById('uploadForm').reset();
            uploadAreaText.textContent = 'Click or drag & drop file here';
            setTimeout(() => {
                uploadModalInstance.hide();
                if (document.getElementById('discoverContent').style.display === 'block') loadApps();
                if (document.getElementById('myAppsContent').style.display === 'block') loadMyApps();
            }, 1500);
          }
        );
      } catch (error) {
        console.error('Upload error:', error);
        showStatus('uploadStatus', `Upload failed: ${error.message}`, 'danger', 'uploadModal');
      }
    });

    // --- App Loading & Display ---
    async function loadApps() {
      try {
        let query = db.collection('apps').where('status', '==', 'active');
        
        if (currentCategoryFilter) {
            query = query.where('category', '==', currentCategoryFilter);
        }
        
        // Sorting
        if (currentSortFilter === 'popular') query = query.orderBy('downloads', 'desc');
        else if (currentSortFilter === 'rating') query = query.orderBy('ratingAverage', 'desc'); 
        else query = query.orderBy('createdAt', 'desc'); // newest

        const snapshot = await query.limit(24).get(); // Increased limit slightly

        allApps = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

        let appsToDisplay = allApps;
        if (currentSearchTerm) {
            appsToDisplay = allApps.filter(app => 
                (app.name && app.name.toLowerCase().includes(currentSearchTerm)) ||
                (app.description && app.description.toLowerCase().includes(currentSearchTerm)) ||
                (app.developerEmail && app.developerEmail.toLowerCase().includes(currentSearchTerm))
            );
        }
        displayApps(appsToDisplay, 'appsGrid', 'noAppsMessage');

      } catch (error) {
        console.error('Error loading apps:', error);
        showGlobalToast(`Error loading apps: ${error.message}`, 'danger');
      }
    }

    function displayApps(apps, gridId, noAppsMessageId) {
      const grid = document.getElementById(gridId);
      const noAppsMsg = document.getElementById(noAppsMessageId);
      grid.innerHTML = '';

      if (apps.length === 0) {
        if(noAppsMsg) noAppsMsg.style.display = 'block';
        return;
      }
      if(noAppsMsg) noAppsMsg.style.display = 'none';

      apps.forEach(app => {
        const appCard = createAppCard(app, gridId === 'myAppsGrid');
        const col = document.createElement('div');
        col.className = 'col'; 
        col.appendChild(appCard);
        grid.appendChild(col);
      });
    }

    function createAppCard(app, isMyAppsCard = false) {
      const card = document.createElement('div');
      card.className = 'card app-card';
      
      const avgRating = app.ratingAverage || 0; // Use pre-calculated average
      let starsHTML = '';
      for (let i = 1; i <= 5; i++) {
        if (avgRating >= i) starsHTML += `<i class="fas fa-star"></i>`;
        else if (avgRating >= i - 0.5) starsHTML += `<i class="fas fa-star-half-alt"></i>`;
        else starsHTML += `<i class="far fa-star"></i>`; // Empty star
      }
      if (app.ratingCount === 0) {
          starsHTML = '<small class="text-muted">No ratings yet</small>';
      } else {
          starsHTML += ` <small class="text-muted">(${app.ratingCount || 0})</small>`;
      }

      const iconLetter = app.name ? app.name.charAt(0).toUpperCase() : 'A';
      const descriptionShort = (app.description || 'No description.').substring(0, 70) + 
                                ((app.description && app.description.length > 70) ? '...' : '');

      card.innerHTML = `
        <div class="card-img-top-placeholder d-flex align-items-center justify-content-center"><span>${iconLetter}</span></div>
        <div class="card-body d-flex flex-column">
          <h5 class="card-title text-truncate" title="${app.name || 'Untitled App'}">${app.name || 'Untitled App'}</h5>
          <h6 class="card-subtitle mb-2 text-muted text-truncate" title="${app.developerEmail || 'Unknown'}">${app.developerEmail || 'Unknown Developer'}</h6>
          <p class="app-rating mb-1 small">${starsHTML}</p>
          <p class="card-text small flex-grow-1">${descriptionShort}</p>
          <div class="mt-auto"> <!-- Push content below to bottom of card -->
            <span class="app-category-tag mb-2 d-inline-block">${app.category || 'N/A'}</span>
            <div class="d-flex justify-content-between align-items-center">
              <button class="btn btn-sm btn-primary" onclick="downloadApp(event, '${app.id}', '${app.downloadURL}', '${app.fileName}')">
                  <i class="fas fa-download"></i> Download
              </button>
              <small class="text-muted">${app.downloads || 0} <i class="fas fa-cloud-download-alt"></i></small>
            </div>
            ${isMyAppsCard ? `
              <hr class="my-2">
              <div class="d-flex justify-content-start gap-1 flex-wrap">
                  <button class="btn btn-sm btn-outline-secondary" onclick="editApp(event, '${app.id}')"><i class="fas fa-edit"></i></button>
                  <button class="btn btn-sm btn-outline-${app.status === 'active' ? 'warning' : 'success'}" onclick="toggleAppStatus(event, '${app.id}', '${app.status}')">
                      <i class="fas ${app.status === 'active' ? 'fa-pause-circle' : 'fa-play-circle'}"></i> 
                  </button>
              </div>
              <small class="d-block mt-1 text-muted">Status: <span class="fw-bold text-${app.status === 'active' ? 'success' : 'danger'}">${app.status}</span></small>
            ` : ''}
          </div>
        </div>
      `;
      return card;
    }

    async function downloadApp(event, appId, downloadURL, fileName) {
      event.stopPropagation();
      try {
        const appRef = db.collection('apps').doc(appId);
        await appRef.update({
          downloads: firebase.firestore.FieldValue.increment(1)
        });
        const link = document.createElement('a');
        link.href = downloadURL;
        link.download = fileName;
        document.body.appendChild(link);
        link.click();
        document.body.removeChild(link);
        
        // Optimistically update UI or full reload
        const appCard = event.target.closest('.app-card');
        if (appCard) {
            const downloadsElement = appCard.querySelector('.text-muted i.fa-cloud-download-alt');
            if (downloadsElement && downloadsElement.previousSibling) {
                const currentDownloads = parseInt(downloadsElement.previousSibling.textContent.trim()) || 0;
                downloadsElement.previousSibling.textContent = `${currentDownloads + 1} `;
            }
        } else { // Fallback to reload if card not found
            if (document.getElementById('discoverContent').style.display === 'block') loadApps();
            if (document.getElementById('myAppsContent').style.display === 'block') loadMyApps();
        }


      } catch (error) {
        console.error('Download error:', error);
        showGlobalToast(`Download failed: ${error.message}`, 'danger');
      }
    }

    // --- My Apps Specific ---
    async function loadMyApps() {
        if (!currentUser) return;
        try {
            const snapshot = await db.collection('apps')
                .where('developerId', '==', currentUser.uid)
                .orderBy('createdAt', 'desc')
                .get();

            let myAppsList = [];
            let totalMyDownloads = 0;
            let sumMyAvgRatings = 0; // Sum of pre-calculated average ratings
            let myAppsWithRatings = 0;

            snapshot.forEach(doc => {
                const app = { id: doc.id, ...doc.data() };
                myAppsList.push(app);
                totalMyDownloads += app.downloads || 0;
                if (app.ratingCount > 0 && typeof app.ratingAverage === 'number') {
                    sumMyAvgRatings += app.ratingAverage;
                    myAppsWithRatings++;
                }
            });
            displayApps(myAppsList, 'myAppsGrid', 'noMyAppsMessage');
            
            document.getElementById('myTotalApps').textContent = myAppsList.length;
            document.getElementById('myTotalDownloads').textContent = totalMyDownloads;
            document.getElementById('myAvgRating').textContent = myAppsWithRatings > 0 ? (sumMyAvgRatings / myAppsWithRatings).toFixed(1) : '0.0';

        } catch (error) {
            console.error('Error loading my apps:', error);
            showGlobalToast(`Error loading your apps: ${error.message}`, 'danger');
        }
    }

    function editApp(event, appId) {
        event.stopPropagation();
        showGlobalToast(`Edit app (ID: ${appId}) - Feature not fully implemented.`, 'info');
    }

    async function toggleAppStatus(event, appId, currentStatus) {
        event.stopPropagation();
        const newStatus = currentStatus === 'active' ? 'disabled' : 'active';
        try {
            await db.collection('apps').doc(appId).update({
                status: newStatus,
                updatedAt: firebase.firestore.FieldValue.serverTimestamp()
            });
            showGlobalToast(`App status changed to ${newStatus}.`, 'success');
            loadMyApps();
            if (document.getElementById('discoverContent').style.display === 'block') loadApps();
        } catch (error) {
            console.error('Error updating app status:', error);
            showGlobalToast(`Error updating status: ${error.message}`, 'danger');
        }
    }


    // --- Platform Analytics ---
    async function loadPlatformAnalytics() {
      try {
        const appsSnapshot = await db.collection('apps').get(); // Could be large, consider aggregation for prod
        let totalPlatformDownloads = 0;
        const developerIds = new Set();
        
        appsSnapshot.forEach(doc => {
          const app = doc.data();
          totalPlatformDownloads += app.downloads || 0;
          if (app.developerId) developerIds.add(app.developerId);
        });

        document.getElementById('platformApps').textContent = appsSnapshot.size;
        document.getElementById('activeUsers').textContent = developerIds.size;
        document.getElementById('platformDownloads').textContent = totalPlatformDownloads;
      } catch (error) {
        console.error('Error loading platform analytics:', error);
      }
    }

    // --- Filtering & Sorting Event Listeners ---
    document.getElementById('searchForm').addEventListener('submit', (e) => {
        e.preventDefault();
        currentSearchTerm = document.getElementById('searchInputGlobal').value.trim().toLowerCase();
        if(document.getElementById('discoverContent').style.display === 'block') {
            loadApps(); // Search applies to discover page
        } else {
            // Optionally, switch to discover page on search
            // navigateTo('discover');
            // setTimeout(() => loadApps(), 50); // Small delay to allow navigation
        }
    });
    // Live search (optional, can be performance intensive without backend search)
    /*
    document.getElementById('searchInputGlobal').addEventListener('input', (e) => {
        currentSearchTerm = e.target.value.trim().toLowerCase();
        if(document.getElementById('discoverContent').style.display === 'block') {
            loadApps();
        }
    });
    */
    
    document.getElementById('sortFilter').addEventListener('change', (e) => {
        currentSortFilter = e.target.value;
        if(document.getElementById('discoverContent').style.display === 'block') loadApps();
    });

    document.querySelectorAll('.filter-category').forEach(link => {
        link.addEventListener('click', (e) => {
            e.preventDefault();
            document.querySelectorAll('.filter-category').forEach(el => el.classList.remove('active'));
            e.target.classList.add('active');
            currentCategoryFilter = e.target.dataset.category;
            if(document.getElementById('discoverContent').style.display === 'block') {
                 loadApps(); // Category filter applies to discover page
            } else {
                navigateTo('discover'); // If on another page, switch to discover and apply
                // setTimeout(() => loadApps(), 50); // Allow navigation to complete
            }
        });
    });


    // --- Utilities ---
    function showStatus(elementId, message, type, modalId, autoClear = true) {
      const statusElement = document.getElementById(elementId);
      if (!statusElement) return;
      statusElement.innerHTML = `<div class="alert alert-${type} alert-dismissible fade show" role="alert">
                                  ${message}
                                  ${ modalId ? '' : '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button>'}
                               </div>`;
      if (autoClear && (type === 'success' || type === 'info')) {
        setTimeout(() => {
          if (statusElement.firstChild) {
            const alertInstance = bootstrap.Alert.getInstance(statusElement.firstChild);
            if(alertInstance) alertInstance.close();
            else statusElement.innerHTML = '';
          }
        }, 3000);
      }
    }

    function showGlobalToast(message, type = 'info') {
        const toastContainer = document.createElement('div');
        toastContainer.style.position = 'fixed';
        toastContainer.style.top = '70px';
        toastContainer.style.right = '20px';
        toastContainer.style.zIndex = '1090';

        const toastId = `toast-${Date.now()}`;
        const toastHTML = `
            <div id="${toastId}" class="toast align-items-center text-bg-${type} border-0" role="alert" aria-live="assertive" aria-atomic="true">
              <div class="d-flex">
                <div class="toast-body">${message}</div>
                <button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
              </div>
            </div>
        `;
        toastContainer.innerHTML = toastHTML;
        document.body.appendChild(toastContainer);
        
        const toastElement = document.getElementById(toastId);
        const toast = new bootstrap.Toast(toastElement, { delay: 3500 });
        toast.show();
        toastElement.addEventListener('hidden.bs.toast', () => toastContainer.remove());
    }

    // --- Initial Load ---
    document.addEventListener('DOMContentLoaded', () => {
      authModalInstance = new bootstrap.Modal(document.getElementById('authModal'));
      uploadModalInstance = new bootstrap.Modal(document.getElementById('uploadModal'));
      
      navigateTo('discover'); 
      updateAuthUI(); 
    });

  </script>
</body>
</html>
