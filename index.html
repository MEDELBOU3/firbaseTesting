<!DOCTYPE html>
<html lang="fr">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Plateforme d'Apprentissage FPN — Université Mohamed Premier</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.min.css" rel="stylesheet" />
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.0/dist/quill.snow.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.0/dist/quill.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/bootstrap5@6.1.11/index.global.min.js"></script>

    <link rel="stylesheet" href="style.css" />
</head>

<body data-theme="light">
    <!-- Thème par défaut -->

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container-fluid">
            <!-- Sidebar Toggle -->
            <button class="btn btn-link me-2 d-lg-none" id="sidebarToggle">
                <i class="bi bi-list fs-4"></i>
            </button>

            <!-- Logo -->
            <a class="navbar-brand d-flex gap-3 align-items-center" href="#">
                <img src="https://espace-fpn.ump.ma/src/logo.svg" alt="logo" height="44" />
                <div class="d-none d-md-block">
                    <div style="font-weight: 700; color: var(--brand); font-size: 14px">
                        Université Mohamed Premier
                    </div>
                    <div style="font-size: 11px; color: var(--muted)">
                        Faculté des Sciences - Plateforme d'Apprentissage
                    </div>
                </div>
            </a>

            <!-- Right Side -->
            <div class="d-flex ms-auto gap-3 align-items-center">
                <!-- Search Box -->
                <div class="search-box d-none d-md-block">
                    <i class="bi bi-search"></i>
                    <input type="text" class="form-control" placeholder="Rechercher des cours, matériaux..."
                        id="searchInput" />
                </div>

                <!-- Notifications -->
                <div class="dropdown">
                    <button class="btn btn-link position-relative" id="notifBtn" data-bs-toggle="dropdown"
                        aria-expanded="false">
                        <i class="bi bi-bell fs-5"></i>
                        <!-- Unread count badge (will be managed by JS) -->
                        <span class="notification-badge d-none" id="notifCount">0</span>
                    </button>
                    <div class="dropdown-menu dropdown-menu-end shadow-lg border-0 p-2" id="notifDropdown"
                        style="width: 350px">
                        <div class="px-3 py-2 d-flex justify-content-between align-items-center">
                            <h6 class="dropdown-header p-0">Notifications</h6>
                            <button class="btn btn-sm btn-link" id="markAllAsReadBtn">
                                Tout marquer comme lu
                            </button>
                        </div>
                        <div id="notifListContainer" class="list-group list-group-flush">
                            <!-- Notifications will be loaded here -->
                            <div class="text-center text-muted p-4">Chargement...</div>
                        </div>
                        <div class="text-center mt-2">
                            <a class="dropdown-item text-center" href="#" data-view="notifications">
                                Voir toutes les notifications
                            </a>
                        </div>
                    </div>
                </div>
                <!-- Profile Dropdown -->
                <div class="dropdown" id="profileDropdown" style="display: none">
                    <a href="#" class="d-flex align-items-center gap-2 text-decoration-none dropdown-toggle"
                        id="profileMenu" data-bs-toggle="dropdown" aria-expanded="false">
                        <img id="userPhoto" src="" alt="Avatar" style="
                  width: 40px;
                  height: 40px;
                  border-radius: 50%;
                  object-fit: cover;
                  border: 2px solid var(--accent);
                " />
                        <span id="userName" class="fw-semibold d-none d-md-inline"></span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0 p-2" aria-labelledby="profileMenu">
                        <li class="px-3 pb-2 border-bottom">
                            <small class="text-muted" id="userEmail"></small>
                        </li>
                        <li>
                            <a class="dropdown-item" href="#" data-view="settings"><i
                                    class="bi bi-gear me-2"></i>Paramètres</a>
                        </li>
                        <li>
                            <button class="dropdown-item text-danger" id="btnLogout">
                                <i class="bi bi-box-arrow-right me-2"></i>Déconnexion
                            </button>
                        </li>
                    </ul>
                </div>

                <!-- Login Button -->
                <button id="btnLogin" class="btn btn-primary">Se connecter</button>
            </div>
        </div>
    </nav>

    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="p-3">
            <h6 class="text-muted text-uppercase" style="font-size: 11px; letter-spacing: 1px">
                Navigation
            </h6>
        </div>

        <a class="sidebar-item active" data-view="dashboard">
            <i class="bi bi-speedometer2"></i>
            <span>Tableau de bord</span>
        </a>
        <a class="sidebar-item" data-view="courses">
            <i class="bi bi-collection"></i>
            <span>Tous les cours</span>
        </a>
        <a class="sidebar-item" data-view="videos">
            <i class="bi bi-play-circle"></i>
            <span>Tutoriels vidéo</span>
        </a>
        <a class="sidebar-item" data-view="contributed">
            <i class="bi bi-people"></i>
            <span>Contenu contribué</span>
        </a>
        <a class="sidebar-item" data-view="documents">
            <i class="bi bi-file-earmark-text"></i>
            <span>Documents</span>
        </a>
        <!-- NOUVEL ÉLÉMENT -->
        <a class="sidebar-item" data-view="library">
            <i class="bi bi-book-half"></i>
            <span>Bibliothèque FPN</span>
        </a>
        <!-- FIN NOUVEL ÉLÉMENT -->

        <a class="sidebar-item" data-view="assignments">
            <i class="bi bi-clipboard-check"></i>
            <span>Devoirs</span>
        </a>

        <div class="p-3">
            <h6 class="text-muted text-uppercase" style="font-size: 11px; letter-spacing: 1px">
                Personnalisé
            </h6>
        </div>

        <a class="sidebar-item" data-view="calendar">
            <i class="bi bi-calendar-event"></i>
            <span>Calendrier</span>
        </a>

        <a class="sidebar-item" data-view="discussions">
            <i class="bi bi-chat-square-dots"></i>
            <span>Discussions</span>
        </a>
        <a class="sidebar-item" data-view="notifications">
            <i class="bi bi-bell"></i>
            <span>Notifications</span>
        </a>
        <div class="p-3 mt-3">
            <h6 class="text-muted text-uppercase" style="font-size: 11px; letter-spacing: 1px">
                Outils
            </h6>
        </div>

        <a class="sidebar-item" data-view="notes">
            <i class="bi bi-journal-text"></i>
            <span>Mes notes</span>
        </a>
        <a class="sidebar-item" data-view="progress">
            <i class="bi bi-graph-up"></i>
            <span>Suivi des progrès</span>
        </a>
        <a class="sidebar-item" data-view="settings">
            <i class="bi bi-gear"></i>
            <span>Paramètres</span>
        </a>
    </aside>

    <!-- Main Content -->
    <main class="main-content" id="mainContent">
        <!-- Tableau de bord View -->
        <div id="dashboardView" class="view-content">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 style="color: var(--brand); font-weight: 700">
                        Bienvenue de retour,
                        <span id="welcomeUserName" style="color: var(--accent)"></span> !
                    </h2>

                    <p class="text-muted">Continuez votre parcours d'apprentissage</p>
                </div>
                <div class="d-flex gap-2">
                    <select class="form-select" id="semesterFilter">
                        <option>Tous les semestres</option>
                        <option>Semestre 1</option>
                        <option>Semestre 2</option>
                    </select>
                </div>
            </div>

            <!-- Stats -->
            <div class="row g-4 mb-4">
                <div class="col-md-3">
                    <div class="stat-card">
                        <i class="bi bi-book"></i>
                        <div style="position: relative; z-index: 1">
                            <small style="opacity: 0.9">Total des cours</small>
                            <h3 id="totalCourses">0</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card" style="
                background: linear-gradient(135deg, var(--success), #20c997);
              ">
                        <i class="bi bi-check-circle"></i>
                        <div style="position: relative; z-index: 1">
                            <small style="opacity: 0.9">Complétés</small>
                            <h3 id="completedCourses">0</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card" style="
                background: linear-gradient(135deg, var(--accent), #e6c84f);
              ">
                        <i class="bi bi-clock-history"></i>
                        <div style="position: relative; z-index: 1">
                            <small style="opacity: 0.9">En cours</small>
                            <h3 id="inProgressCourses">0</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card" style="background: linear-gradient(135deg, #6f42c1, #8b5cf6)">
                        <i class="bi bi-trophy"></i>
                        <div style="position: relative; z-index: 1">
                            <small style="opacity: 0.9">Score d'accomplissement</small>
                            <h3>85%</h3>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Continuer l'apprentissage -->
            <div class="card card-modern mb-4">
                <div class="card-body">
                    <h5 class="mb-3">
                        <i class="bi bi-play-circle me-2"></i>Continuer l'apprentissage
                    </h5>
                    <div class="row g-3" id="continueSection">
                        <div class="col-12 text-center text-muted py-4">
                            <i class="bi bi-folder2-open fs-1"></i>
                            <p class="mt-2">Chargement de vos cours...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Activité récente -->
            <div class="row g-4">
                <div class="col-lg-8">
                    <div class="card card-modern">
                        <div class="card-body">
                            <h5 class="mb-4">
                                <i class="bi bi-clock-history me-2"></i>Activité récente
                            </h5>
                            <div id="activityTimeline">
                                <div class="timeline-item">
                                    <div class="timeline-dot"><i class="bi bi-check"></i></div>
                                    <div>
                                        <strong>Complété : Module de conception d'algorithmes</strong>
                                        <p class="text-muted small mb-0">Il y a 2 heures</p>
                                    </div>
                                </div>
                                <div class="timeline-item">
                                    <div class="timeline-dot">
                                        <i class="bi bi-file-earmark"></i>
                                    </div>
                                    <div>
                                        <strong>Téléchargé : Notes de cours sur les structures de
                                            données</strong>
                                        <p class="text-muted small mb-0">Hier</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="card card-modern">
                        <div class="card-body">
                            <h5 class="mb-4">
                                <i class="bi bi-calendar-event me-2"></i>À venir
                            </h5>
                            <div class="d-flex flex-column gap-3">
                                <div class="d-flex gap-3 align-items-center">
                                    <div class="bg-primary text-white p-2 rounded"
                                        style="min-width: 48px; text-align: center">
                                        <div style="font-size: 20px; font-weight: 700">18</div>
                                        <div style="font-size: 10px">OCT</div>
                                    </div>
                                    <div>
                                        <strong style="font-size: 14px">Examen de base de données</strong>
                                        <p class="text-muted small mb-0">10:00</p>
                                    </div>
                                </div>
                                <div class="d-flex gap-3 align-items-center">
                                    <div class="bg-warning text-white p-2 rounded"
                                        style="min-width: 48px; text-align: center">
                                        <div style="font-size: 20px; font-weight: 700">20</div>
                                        <div style="font-size: 10px">OCT</div>
                                    </div>
                                    <div>
                                        <strong style="font-size: 14px">Soumission de projet</strong>
                                        <p class="text-muted small mb-0">23:59</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tous les cours View -->
        <div id="coursesView" class="view-content d-none">
            <div id="breadcrumb" class="mb-3"></div>
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 style="color: var(--brand); font-weight: 700">Tous les cours</h2>
                <div class="d-flex gap-2">
                    <select class="form-select" id="categoryFilter">
                        <option value="all">Toutes les catégories</option>
                        <option value="video">Vidéos</option>
                        <option value="document">Documents</option>
                        <option value="folder">Dossiers</option>
                    </select>
                    <select class="form-select" id="sortBy">
                        <option>Trier par nom</option>
                        <option>Trier par date</option>
                        <option>Trier par type</option>
                    </select>
                </div>
            </div>

            <div id="loader" class="py-5 text-center">
                <div class="loader"></div>
                <div class="mt-3 text-muted">
                    Chargement des cours depuis Drive...
                </div>
            </div>

            <div class="row g-4" id="coursesGrid"></div>
            <div class="card card-modern mt-4 d-none" id="folderContributedSection">
                <div class="card-body">
                    <h5 class="mb-3">Tutoriels contribués pour ce cours</h5>
                    <div class="row g-4" id="folderContributedGrid"></div>
                </div>
            </div>
        </div>

        <!-- Tutoriels vidéo View -->
        <div id="videosView" class="view-content d-none">
            <h2 class="mb-4" style="color: var(--brand); font-weight: 700">
                Tutoriels vidéo
            </h2>
            <div class="row g-4" id="videosGrid"></div>
            <div class="card card-modern mt-4">
                <div class="card-body">
                    <h5 class="mb-3">Tutoriels YouTube recommandés</h5>
                    <div class="row g-4" id="youtubeVideosGrid"></div>
                </div>
            </div>
            <div class="card card-modern mt-4">
                <div class="card-body">
                    <h5 class="mb-3">Tutoriels contribués</h5>
                    <div class="row g-4" id="contributedVideosGrid"></div>
                </div>
            </div>
        </div>

        <!-- Contenu contribué View -->
        <div id="contributedView" class="view-content d-none">
            <h2 class="mb-4" style="color: var(--brand); font-weight: 700">
                Contenu contribué
            </h2>
            <!-- In #contributedView -->
            <form id="addContentForm" class="card card-modern mb-4">
                <div class="card-body">
                    <h5 class="card-title mb-3">Partager une ressource</h5>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="contentUrl" class="form-label">URL de la ressource</label>
                            <input id="contentUrl" class="form-control" placeholder="Collez l'URL ici..." required />
                        </div>
                        <div class="col-md-6">
                            <label for="contentType" class="form-label">Type de contenu</label>
                            <select id="contentType" class="form-select" required>
                                <option value="youtube" selected>
                                    Vidéo / Playlist YouTube
                                </option>
                                <option value="gdrive_video">Vidéo Google Drive</option>
                                <option value="gdrive_doc">
                                    Document Google Drive (PDF, Livre)
                                </option>
                                <option value="link">Lien Web / Article</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="contentTitle" class="form-label">Titre (optionnel)</label>
                            <input id="contentTitle" class="form-control" placeholder="Titre personnalisé..." />
                        </div>
                        <div class="col-md-6">
                            <label for="contentCourse" class="form-label">Associer à un cours (optionnel)</label>
                            <select id="contentCourse" class="form-select">
                                <option value="">Aucun cours spécifique</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-primary mt-3" type="submit">
                        Ajouter le contenu
                    </button>
                </div>
            </form>
            <div class="row g-4" id="contributedGrid"></div>
        </div>

        <!-- Documents View -->
        <div id="documentsView" class="view-content d-none">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 style="color: var(--brand); font-weight: 700">
                    Documents & Matériaux
                </h2>

                <!-- START: NEW LAYOUT TOGGLE -->
                <div class="btn-group" role="group" aria-label="Layout Toggle">
                    <button type="button" class="btn btn-outline-primary active" id="btnGridDocuments">
                        <i class="bi bi-grid-3x3-gap-fill"></i> Grille
                    </button>
                    <button type="button" class="btn btn-outline-primary" id="btnListDocuments">
                        <i class="bi bi-list"></i> Liste
                    </button>
                </div>
                <!-- END: NEW LAYOUT TOGGLE -->
            </div>
            <div class="row g-4" id="documentsGrid"></div>
        </div>

        <!-- Bibliothèque FPN View -->
        <!--<div id="libraryView" class="view-content d-none">
            <h2 class="mb-4" style="color:var(--brand); font-weight:700">Bibliothèque FPN</h2>

            <div class="row g-4 mb-4">
                <div class="col-md-12">
                    <div class="card card-modern p-3">
                        <form id="librarySearchForm" class="d-flex gap-2">
                            <input type="text" id="librarySearchInput" class="form-control"
                                placeholder="Rechercher par titre, auteur ou sujet (Ex: Algorithmes, Chimie, Einstein)..."
                                required>
                            <button type="submit" class="btn btn-primary" id="librarySearchBtn">
                                <i class="bi bi-search me-1"></i> Rechercher
                            </button>
                        </form>
                    </div>
                </div>
            </div>

            <div class="row g-4 mb-4" id="libraryStats">
             
            </div>
            <h5 class="mb-3 mt-4">Résultats (<span id="libraryResultCount">0</span>)</h5>
            <div id="libraryResultsGrid" class="row g-4">
                <div class="col-12 text-center text-muted py-5" id="libraryInitialMessage">
                    <i class="bi bi-book fs-1"></i>
                    <p class="mt-2">Recherchez dans la bibliothèque OpenLibrary pour trouver des ressources académiques.
                    </p>
                </div>
            </div>

            <div id="libraryPagination" class="d-flex justify-content-center mt-4"></div>

        </div>-->
        <!-- Bibliothèque FPN View -->
        <div id="libraryView" class="view-content d-none">

            <!-- Sous-vue 1: Liste des Résultats et Recherche -->
            <div id="libraryList">
                <h2 class="mb-4" style="color:var(--brand); font-weight:700">Bibliothèque FPN</h2>

                <div class="row g-4 mb-4">
                    <div class="col-md-12">
                        <div class="card card-modern p-3">
                            <form id="librarySearchForm" class="d-flex gap-2">
                                <input type="text" id="librarySearchInput" class="form-control"
                                    placeholder="Rechercher par titre, auteur ou sujet (Ex: Algorithmes, Chimie, Einstein)..."
                                    required>
                                <button type="submit" class="btn btn-primary" id="librarySearchBtn">
                                    <i class="bi bi-search me-1"></i> Rechercher
                                </button>
                            </form>
                        </div>
                    </div>
                </div>

                <!-- Statistiques / Filtres Avancés (Laissé vide) -->
                <div class="row g-4 mb-4" id="libraryStats"></div>

                <!-- Résultats de la Recherche -->
                <h5 class="mb-3 mt-4">
                    Résultats (<span id="libraryResultCount">0</span> trouvés)
                    <span id="libraryShowingCount" class="text-muted small"></span>
                </h5>
                <div id="libraryResultsGrid" class="row g-4">
                    <div class="col-12 text-center text-muted py-5" id="libraryInitialMessage">
                        <i class="bi bi-book fs-1"></i>
                        <p class="mt-2">Chargement des livres populaires...</p>
                    </div>
                </div>

                <!-- CORRIGÉ: Bouton Charger Plus avec onclick -->
                <div id="loadMoreContainer" class="d-flex justify-content-center mt-4 d-none">
                    <button class="btn btn-outline-primary" id="loadMoreBtn" onclick="loadMoreBooks()">Charger plus de
                        résultats</button>
                    <!--<button class="btn btn-outline-primary" id="loadMoreBtn" onclick="loadMoreBooks()">
                        <span id="loadMoreLoader" class="spinner-border spinner-border-sm me-2 d-none" role="status"
                            aria-hidden="true"></span>
                        Charger plus de résultats
                    </button>-->
                </div>

            </div>

            <!-- Sous-vue 2: Détails du Livre -->
            <div id="bookDetailView" class="d-none">
                <div id="bookDetailContent">
                    <!-- Le contenu sera injecté ici par JavaScript -->
                </div>
            </div>

        </div>

        <!-- Devoirs View -->
        <div id="assignmentsView" class="view-content d-none">
            <h2 class="mb-4" style="color: var(--brand); font-weight: 700">
                Devoirs
            </h2>
            <div class="row g-4" id="assignmentsGrid"></div>
        </div>

        <!-- Calendrier View 
        <div id="calendarView" class="view-content d-none">
            <h2 class="mb-4" style="color:var(--brand); font-weight:700">Calendrier</h2>
            <div class="card card-modern">
                <div class="card-body">
                    <div id="calendarEvents"></div>
                </div>
            </div>
        </div>-->

        <!-- Calendrier View -->
        <div id="calendarView" class="view-content d-none">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 style="color: var(--brand); font-weight: 700">Calendrier</h2>
                <button id="addEventButton" class="btn btn-primary">
                    <i class="bi bi-plus-circle me-2"></i>Ajouter un événement
                </button>
            </div>
            <div class="card card-modern">
                <div class="card-body">
                    <!-- FullCalendar will be rendered here -->
                    <div id="calendar"></div>
                </div>
            </div>
        </div>

        <!-- Event Modal -->
        <div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="eventModalLabel">
                            Ajouter/Modifier un événement
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="eventForm">
                            <!-- Hidden input to store event ID for updates -->
                            <input type="hidden" id="eventId" />
                            <div class="mb-3">
                                <label for="eventTitle" class="form-label">Titre de l'événement</label>
                                <input type="text" class="form-control" id="eventTitle" required />
                            </div>
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="eventStart" class="form-label">Début</label>
                                    <input type="datetime-local" class="form-control" id="eventStart" required />
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="eventEnd" class="form-label">Fin</label>
                                    <input type="datetime-local" class="form-control" id="eventEnd" required />
                                </div>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="eventAllDay" />
                                <label class="form-check-label" for="eventAllDay">Toute la journée</label>
                                <div class="mb-3">
                                    <label for="eventColor" class="form-label"><i
                                            class="bi bi-palette-fill me-2"></i>Couleur de
                                        l'événement</label>
                                    <input type="color" class="form-control form-control-color" id="eventColor"
                                        value="#0b3b61" title="Choisissez une couleur" />
                                </div>
                            </div>

                            <!-- START: NEW ALARM SECTION -->
                            <div class="border-top pt-3">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="eventAlarm" class="form-label"><i
                                                class="bi bi-alarm me-2"></i>Rappel / Alarme</label>
                                        <select id="eventAlarm" class="form-select">
                                            <option value="none" selected>Aucun</option>
                                            <option value="5">5 minutes avant</option>
                                            <option value="15">15 minutes avant</option>
                                            <option value="30">30 minutes avant</option>
                                            <option value="60">1 heure avant</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="eventSound" class="form-label"><i
                                                class="bi bi-music-note-beamed me-2"></i>Son de
                                            l'alarme</label>
                                        <select id="eventSound" class="form-select">
                                            <option value="chime" selected>Carillon</option>
                                            <option value="notification">Notification</option>
                                            <option value="digital">Digital</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <!-- END: NEW ALARM SECTION -->
                        </form>
                    </div>
                    <div class="modal-footer justify-content-between">
                        <button type="button" class="btn btn-danger" id="deleteEventButton" style="display: none">
                            Supprimer
                        </button>
                        <div>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                                Annuler
                            </button>
                            <button type="submit" form="eventForm" class="btn btn-primary">
                                Enregistrer
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Discussions View -->
        <div id="discussionsView" class="view-content d-none">
            <!-- Sub-view: List of all discussion threads -->
            <div id="discussionsList">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 style="color: var(--brand); font-weight: 700">Discussions</h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newDiscussionModal">
                        <i class="bi bi-plus-circle me-2"></i>Démarrer une nouvelle
                        discussion
                    </button>
                </div>
                <div id="threadsContainer" class="d-flex flex-column gap-3">
                    <!-- Discussion threads will be loaded here -->
                    <div class="text-center p-5">
                        <div class="loader"></div>
                    </div>
                </div>
            </div>

            <!-- Sub-view: A single discussion thread with replies -->
            <div id="discussionDetail" class="d-none">
                <div class="mb-4">
                    <button class="btn btn-outline-secondary" id="backToDiscussions">
                        <i class="bi bi-arrow-left me-2"></i>Retour aux discussions
                    </button>
                </div>

                <!-- Original Post -->
                <div class="card card-modern mb-4">
                    <div class="card-body">
                        <h3 id="threadTitle" style="color: var(--brand)"></h3>
                        <p class="text-muted border-bottom pb-2 mb-3">
                            Par <strong id="threadAuthor"></strong> le
                            <span id="threadDate"></span>
                        </p>
                        <div id="threadContent" class="ql-snow">
                            <div class="ql-editor"></div>
                        </div>
                    </div>
                </div>

                <!-- Replies Section -->
                <h4 class="mb-3">Réponses</h4>
                <div id="repliesContainer" class="d-flex flex-column gap-3 mb-4">
                    <!-- Replies will be loaded here -->
                </div>

                <!-- Reply Editor -->
                <div class="card card-modern">
                    <div class="card-body">
                        <h5 class="mb-3">Votre réponse</h5>
                        <form id="replyForm">
                            <!-- Quill editor for the reply -->
                            <div id="replyEditor" style="min-height: 150px"></div>
                            <button type="submit" class="btn btn-primary mt-3">
                                Publier la réponse
                            </button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notifications View (Full Page) -->
        <div id="notificationsView" class="view-content d-none">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 style="color: var(--brand); font-weight: 700">
                    Toutes les notifications
                </h2>
            </div>
            <div class="card card-modern">
                <div class="card-body">
                    <div id="fullNotifList" class="list-group list-group-flush">
                        <!-- Full notification history will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal for Creating a New Discussion -->
        <div class="modal fade" id="newDiscussionModal" tabindex="-1" aria-labelledby="newDiscussionModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="newDiscussionModalLabel">
                            Démarrer une nouvelle discussion
                        </h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="newDiscussionForm">
                            <div class="mb-3">
                                <label for="newDiscussionTitle" class="form-label">Titre du sujet</label>
                                <input type="text" class="form-control" id="newDiscussionTitle" required />
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Votre question ou sujet</label>
                                <!-- Quill editor will be mounted here -->
                                <div id="newDiscussionEditor" style="min-height: 200px"></div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                            Annuler
                        </button>
                        <button type="submit" form="newDiscussionForm" class="btn btn-primary">
                            Publier
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mes notes View -->
        <div id="notesView" class="view-content d-none">
            <h2 class="mb-4" style="color: var(--brand); font-weight: 700">
                Mes notes
            </h2>
            <form id="noteForm" class="mb-4">
                <div class="mb-3">
                    <input id="noteTitle" class="form-control" placeholder="Titre de la note" required />
                </div>
                <div class="mb-3">
                    <textarea id="noteContent" class="form-control" rows="4" placeholder="Contenu de la note"
                        required></textarea>
                </div>
                <button class="btn btn-primary" type="submit">
                    Ajouter une note
                </button>
            </form>
            <div id="notesList" class="row g-4"></div>
        </div>

        <!-- Suivi des progrès View 
        <div id="progressView" class="view-content d-none">
            <h2 class="mb-4" style="color:var(--brand); font-weight:700">Suivi des progrès</h2>
            <div class="card card-modern">
                <div class="card-body">
                    <canvas id="progressChart" height="200"></canvas>
                </div>
            </div>
        </div>-->

        <!-- Suivi des progrès View -->
        <div id="progressView" class="view-content d-none">
            <h2 class="mb-4" style="color: var(--brand); font-weight: 700">
                Votre progression
            </h2>

            <div class="row g-4">
                <!-- Main Progress Donut and KPIs -->
                <div class="col-xl-5">
                    <div class="card card-modern h-100">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title mb-3">Progression globale</h5>
                            <div class="flex-grow-1 d-flex align-items-center justify-content-center"
                                style="min-height: 250px">
                                <canvas id="progressDonutChart"></canvas>
                            </div>
                            <div class="row text-center mt-3 pt-3 border-top">
                                <div class="col-6">
                                    <h4 id="kpiCompleted" class="mb-0">0</h4>
                                    <small class="text-muted">Cours terminés</small>
                                </div>
                                <div class="col-6">
                                    <h4 id="kpiInProgress" class="mb-0">0</h4>
                                    <small class="text-muted">En cours</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Progress by Course -->
                <div class="col-xl-7">
                    <div class="card card-modern h-100">
                        <div class="card-body">
                            <h5 class="card-title mb-3">Progression par cours</h5>
                            <div style="min-height: 400px">
                                <canvas id="progressByCourseChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="col-12">
                    <div class="card card-modern">
                        <div class="card-body">
                            <h5 class="card-title mb-3">Activité des 7 derniers jours</h5>
                            <div style="min-height: 250px">
                                <canvas id="activityLineChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Paramètres View -->
        <div id="settingsView" class="view-content d-none">
            <h2 class="mb-4" style="color: var(--brand); font-weight: 700">
                Paramètres
            </h2>

            <!-- Theme Settings -->
            <div class="card card-modern">
                <div class="card-body">
                    <h5 class="card-title mb-3">Préférences d'affichage</h5>
                    <div class="mb-3">
                        <label for="themeSelect" class="form-label">Thème</label>
                        <select id="themeSelect" class="form-select">
                            <option value="light">Clair</option>
                            <option value="dark">Sombre</option>
                            <option value="modern">Moderne</option>
                            <option value="pastel">Pastel</option>
                            <option value="forest">Forêt</option>
                            <option value="ocean">Océan</option>
                            <option value="midnight">Minuit</option>
                            <option value="system">Système</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- START: NEW BACKGROUND IMAGE SETTINGS -->
            <div class="card card-modern mt-4">
                <div class="card-body">
                    <h5 class="card-title mb-3">Image de fond</h5>
                    <p class="text-muted small">
                        Sélectionnez un fond d'écran pour personnaliser l'interface
                        (visible derrière la barre latérale).
                    </p>
                    <div id="backgroundSelectorGrid" class="row g-2">
                        <!-- Images options will be rendered here by JS -->
                    </div>
                </div>
            </div>

            <!-- START: NEW ACCOUNT SETTINGS SECTION -->
            <div id="accountSettingsWrapper">
                <!-- Account Profile Settings -->
                <div class="card card-modern mt-4">
                    <div class="card-body">
                        <h5 class="card-title mb-4">Profil du compte</h5>

                        <!-- NOUVEAU: Saisie de l'URL de Photo de Profil -->
                        <div class="d-flex align-items-center mb-4 gap-4">
                            <img id="profilePhotoPreview" src="" alt="Photo de profil"
                                style="width:96px;height:96px;border-radius:50%;object-fit:cover;border:4px solid var(--accent)">
                            <div>
                                <label for="photoUrlInput" class="form-label">URL de la photo de profil</label>
                                <input type="url" class="form-control mb-2" id="photoUrlInput"
                                    placeholder="Collez ici l'URL de votre avatar (ex: Gravatar, Imgur, CDN)" />
                                <div class="form-text">
                                    Utilisez une URL HTTPS pour votre photo (PNG, JPG).
                                </div>
                            </div>
                        </div>
                        <!-- FIN NOUVEAU: Saisie de l'URL de Photo de Profil -->

                        <form id="profileSettingsForm">
                            <div class="mb-3">
                                <label for="accountName" class="form-label">Nom complet</label>
                                <input type="text" class="form-control" id="accountName"
                                    placeholder="Votre nom complet" />
                            </div>
                            <div class="mb-3">
                                <label for="accountEmail" class="form-label">Adresse e-mail</label>
                                <input type="email" class="form-control" id="accountEmail"
                                    placeholder="Votre adresse e-mail" disabled />
                                <div class="form-text">
                                    L'adresse e-mail ne peut pas être modifiée.
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                Enregistrer les modifications
                            </button>
                        </form>
                    </div>
                </div>
                <!--<div class="card card-modern mt-4">
                    <div class="card-body">
                        <h5 class="card-title mb-4">Profil du compte</h5>

                        <div class="d-flex align-items-center mb-4 gap-4">
                            <img id="profilePhotoPreview" src="" alt="Photo de profil"
                                style="width:96px;height:96px;border-radius:50%;object-fit:cover;border:4px solid var(--accent)">
                            <div>
                                <label for="photoUploadInput" class="btn btn-sm btn-outline-secondary mb-2">
                                    <i class="bi bi-cloud-arrow-up me-2"></i>Changer la photo
                                </label>
                                <input type="file" id="photoUploadInput" class="d-none" accept="image/*">
                                <button id="btnRemovePhoto" class="btn btn-sm btn-outline-danger d-none">
                                    <i class="bi bi-trash me-2"></i>Supprimer
                                </button>
                                <div class="form-text">Max 2MB. Format JPG ou PNG.</div>
                            </div>
                        </div>
                        <form id="profileSettingsForm">
                            <div class="mb-3">
                                <label for="accountName" class="form-label">Nom complet</label>
                                <input type="text" class="form-control" id="accountName"
                                    placeholder="Votre nom complet" />
                            </div>
                            <div class="mb-3">
                                <label for="accountEmail" class="form-label">Adresse e-mail</label>
                                <input type="email" class="form-control" id="accountEmail"
                                    placeholder="Votre adresse e-mail" disabled />
                                <div class="form-text">
                                    L'adresse e-mail ne peut pas être modifiée.
                                </div>
                            </div>
                            <button type="submit" class="btn btn-primary">
                                Enregistrer les modifications
                            </button>
                        </form>
                    </div>
                </div>-->

                <!-- Password Settings -->
                <div class="card card-modern mt-4" id="passwordSettingsCard" style="display: none">
                    <div class="card-body">
                        <h5 class="card-title mb-4">Changer le mot de passe</h5>
                        <form id="passwordChangeForm">
                            <div class="mb-3">
                                <label for="newPassword" class="form-label">Nouveau mot de passe</label>
                                <input type="password" class="form-control" id="newPassword" required />
                            </div>
                            <button type="submit" class="btn btn-primary">
                                Mettre à jour le mot de passe
                            </button>
                        </form>
                    </div>
                </div>

                <!-- Danger Zone -->
                <div class="card card-modern mt-4">
                    <div class="card-body">
                        <h5 class="card-title mb-3 text-danger">Zone de danger</h5>
                        <p class="text-muted">
                            Cette action est irréversible. Toutes vos données, y compris vos
                            progrès et vos notes, seront définitivement supprimées.
                        </p>
                        <button class="btn btn-outline-danger" id="btnDeleteAccount">
                            Supprimer mon compte
                        </button>
                    </div>
                </div>
            </div>
            <!-- END: NEW ACCOUNT SETTINGS SECTION -->
        </div>
    </main>

    <!-- Vidéo Modal (Upgraded for Playlists) -->
    <div class="modal fade video-modal" id="videoModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen-lg-down modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="videoTitle">Tutoriel vidéo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-2">
                    <div class="row g-2 h-100">
                        <!-- Main Video Player Column (80%) -->
                        <div class="col-lg-9 h-100">
                            <div class="video-container" id="videoContainer"
                                style="padding-bottom: 0; min-height: 0; height: 100%">
                                <!-- Iframe will be inserted here -->
                            </div>
                        </div>
                        <!-- History Panel Column (20%) -->
                        <div class="col-lg-3 h-100 d-none flex-column" id="playlistPanel">
                            <div class="card h-100">
                                <div class="card-body d-flex flex-column p-2">
                                    <!-- START: NEW HEADER -->
                                    <div class="d-flex justify-content-between align-items-center px-2 pt-1 mb-2">
                                        <h6 class="card-title mb-0">Historique</h6>
                                        <button class="btn btn-sm btn-outline-danger" id="clearHistoryBtn"
                                            title="Effacer l'historique">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                    <!-- END: NEW HEADER -->
                                    <div id="historyQueue" class="list-group list-group-flush flex-grow-1">
                                        <!-- History items will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Document Modal -->
    <div class="modal fade document-modal" id="documentModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="documentTitle">Document</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="document-container" id="documentContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div class="modal fade" id="modalAuth" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <ul class="nav nav-tabs nav-tabs-modern w-100">
                        <li class="nav-item">
                            <button class="nav-link active" id="signinTab" data-bs-toggle="tab"
                                data-bs-target="#signin">
                                Se connecter
                            </button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" id="signupTab" data-bs-toggle="tab" data-bs-target="#signup">
                                Créer un compte
                            </button>
                        </li>
                    </ul>
                </div>
                <div class="modal-body p-4">
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="signin">
                            <h4 class="text-center mb-4" style="color: var(--brand)">
                                Connectez-vous à votre compte
                            </h4>

                            <button id="googleSignIn" class="btn btn-outline-dark w-100 mb-3 py-2">
                                <i class="bi bi-google me-2"></i> Continuer avec Google
                            </button>

                            <div class="text-center my-3 text-muted">ou</div>

                            <form id="signinForm">
                                <div class="mb-3">
                                    <input id="signinEmail" type="email" class="form-control"
                                        placeholder="Adresse email" required />
                                </div>
                                <div class="mb-3">
                                    <input id="signinPassword" type="password" class="form-control"
                                        placeholder="Mot de passe" required />
                                </div>
                                <button class="btn btn-primary w-100 py-2" type="submit">
                                    Se connecter
                                </button>
                            </form>
                        </div>

                        <div class="tab-pane fade" id="signup">
                            <h4 class="text-center mb-4" style="color: var(--brand)">
                                Créer un nouveau compte
                            </h4>

                            <button id="googleSignup" class="btn btn-outline-dark w-100 mb-3 py-2">
                                <i class="bi bi-google me-2"></i> S'inscrire avec Google
                            </button>

                            <div class="text-center my-3 text-muted">ou</div>

                            <form id="signupForm">
                                <div class="mb-3">
                                    <input id="signupName" type="text" class="form-control" placeholder="Nom complet"
                                        required />
                                </div>
                                <div class="mb-3">
                                    <input id="signupEmail" type="email" class="form-control"
                                        placeholder="Adresse email" required />
                                </div>
                                <div class="mb-3">
                                    <input id="signupPassword" type="password" class="form-control"
                                        placeholder="Mot de passe" required />
                                </div>
                                <button class="btn btn-primary w-100 py-2" type="submit">
                                    Créer un compte
                                </button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="modal fade" id="editReplyModal" tabindex="-1" aria-labelledby="editReplyModalLabel" aria-hidden="true">
        <div class="modal-dialog modal-lg modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="editReplyModalLabel">
                        Modifier la réponse
                    </h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <form id="editReplyForm">
                        <!-- Hidden input to store the reply's ID -->
                        <input type="hidden" id="editReplyId" />

                        <label class="form-label">Votre réponse</label>
                        <!-- Quill editor for editing the reply -->
                        <div id="editReplyEditor" style="min-height: 200px"></div>
                    </form>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
                        Annuler
                    </button>
                    <button type="submit" form="editReplyForm" class="btn btn-primary">
                        Enregistrer les modifications
                    </button>
                </div>
            </div>
        </div>
    </div>
    <!-- END: NEW Edit Reply Modal -->

    <div id="toastContainer" class="position-fixed top-0 end-0 p-3" style="z-index: 1100"></div>

    <script src="setAdmin.js"></script>
    <script type="module">
        const DRIVE_API_KEY = "AIzaSyAcOuFc10xwtujaClC_TZckrGkKx3h0iNI";
        const DRIVE_FOLDER_ID = "1rWQnAn8e2fLPpGa-8_GXYHmb0NeTLNH2";
        const YOUTUBE_API_KEY = "AIzaSyBAdEcJt_IirVmn-NigdC4O4wMbrkvmR7k"; // Remplacer par une clé valide

        const ADMIN_UID = "M03Our8p9mXqhCiu3KJctBttAFk2";

        const ADMIN_VERIFIED_ICON =
            '<i class="bi bi-patch-check-fill admin-verified" title="Administrateur vérifié"></i>';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
        import {
            getAuth,
            GoogleAuthProvider,
            signInWithPopup,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            updateProfile,
            updatePassword,
            deleteUser,
        } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";

        import {
            getStorage,
            ref,
            uploadBytes,
            getDownloadURL,
            deleteObject
        } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-storage.js";


        import {
            getFirestore,
            collection,
            addDoc,
            getDocs,
            query,
            where,
            doc,
            setDoc,
            updateDoc,
            deleteDoc,
            Timestamp,
            onSnapshot,
            orderBy,
            limit,
            writeBatch, // For "Mark All as Read"
        } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";

        const firebaseConfig = {
            apiKey: "AIzaSyAgl557z1SyRSljc3UpIUELUpr2SM0SkBs",
            authDomain: "informatique-et-ia-fpn.firebaseapp.com",
            projectId: "informatique-et-ia-fpn",
            storageBucket: "informatique-et-ia-fpn.firebasestorage.app",
            messagingSenderId: "588259713629",
            appId: "1:588259713629:web:b4687934056edd5207e3b4",
            measurementId: "G-TG8DP35DG6",
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const storage = getStorage(app);
        const provider = new GoogleAuthProvider();
        provider.addScope("https://www.googleapis.com/auth/drive.readonly");

        let isAdmin = false;

        let allFiles = [];
        let currentFiles = [];
        let userProgress = {};
        let currentFolderId = DRIVE_FOLDER_ID;
        let folderPath = [{ id: DRIVE_FOLDER_ID, name: "Racine" }];
        let notes = JSON.parse(localStorage.getItem("notes") || "[]");
        let contributedContent = [];

        let googleAccessToken = localStorage.getItem("googleAccessToken") || null;

        let newDiscussionQuill, replyQuill; // To hold Quill instances
        let currentDiscussionId = null;
        let progressDonutChart, progressByCourseChart, activityLineChart;
        let unsubscribeNotifications = null; // To manage the real-time listener
        let unsubscribeInbox = null; // <<< FIX: Added missing variable declaration
        const newDiscussionModal = new bootstrap.Modal(
            document.getElementById("newDiscussionModal")
        );
        // Éléments DOM
        const btnLogin = document.getElementById("btnLogin");
        const btnLogout = document.getElementById("btnLogout");
        const modalAuth = new bootstrap.Modal(
            document.getElementById("modalAuth")
        );
        const videoModal = new bootstrap.Modal(
            document.getElementById("videoModal")
        );
        const documentModal = new bootstrap.Modal(
            document.getElementById("documentModal")
        );
        const videoModalEl = document.getElementById("videoModal");
        const documentModalEl = document.getElementById("documentModal");
        const sidebarToggle = document.getElementById("sidebarToggle");
        const sidebar = document.getElementById("sidebar");
        const mainContent = document.getElementById("mainContent");
        const body = document.body;
        const contentCourseSelect = document.getElementById("contentCourse");

        // 1. Add this constant near your other modal constants
        const playlistPanel = document.getElementById("playlistPanel");
        const playlistQueue = document.getElementById("playlistQueue");


        let editReplyQuill; // To hold the new Quill editor instance
        const editReplyModal = new bootstrap.Modal(
            document.getElementById("editReplyModal")
        );

        const BACKGROUND_IMAGES = [
            { id: "none", name: "Aucun (Défaut)", url: "none" },
            // Ambiance Minimaliste / Naturelle
            {
                id: "bg-image-1",
                name: "Géométrie Bleue (Abstrait)",
                url: "https://picsum.photos/id/1054/1920/1080",
            },
            {
                id: "bg-image-2",
                name: "Coucher de Soleil Doux",
                url: "https://picsum.photos/id/1043/1920/1080",
            },
            {
                id: "bg-image-3",
                name: "Nébuleuse Sombre",
                url: "https://picsum.photos/id/350/1920/1080",
            },
            {
                id: "bg-image-4",
                name: "Bois Minimaliste",
                url: "https://picsum.photos/id/400/1920/1080",
            },

            // NOUVELLES IMAGES : Style Anime / Cyberpunk / Fantasy (utiliser des IDs plus grands)
            {
                id: "bg-image-5",
                name: "Ville Cyberpunk Néon",
                url: "https://t3.ftcdn.net/jpg/05/36/78/84/240_F_536788448_UcOZv30qCQY36To1ygsjmFmVUaeuc7kf.jpg",
            },
            {
                id: "bg-image-6",
                name: "Paysage Manga Nuageux",
                url: "https://img1.wallspic.com/crops/0/5/8/7/6/167850/167850-boardwalk-cloud-water-street_light-purple-3840x2160.png",
            },
            {
                id: "bg-image-7",
                name: "Dragon Fantasy (Sombre/Rouge)",
                url: "https://img1.wallspic.com/crops/3/2/0/0/8/180023/180023-vegeta_dragon_ball-vegeta-goku-dragon_ball-dragon-3840x2160.jpg",
            },
            {
                id: "bg-image-8",
                name: "Planète Sci-Fi (Bleu/Violet)",
                url: "https://img1.wallspic.com/crops/9/8/2/0/5/150289/150289-man_riding_bicycle_under_blue_sky-3840x2160.jpg",
            },
            {
                id: "bg-image-9",
                name: "Naruto",
                url: "https://img1.wallspic.com/previews/8/8/5/8/7/178588/178588-itachi_faithful_night-itachi_uchiha-visual_arts-graphic_design-art-x750.jpg",
            },
            {
                id: "bg-image-10",
                name: "One piece",
                url: "https://img2.wallspic.com/previews/9/8/7/2/7/172789/172789-anime-sleeve-cartoon-animation-shonen_manga-x750.jpg",
            },
            {
                id: "bg-image-11",
                name: "Attack on Titan",
                url: "https://img1.wallspic.com/previews/6/5/6/6/7/176656/176656-attack_on_titan-eren_yeager-mikasa_ackerman-attack_on_titan_2-armin_arlert-x750.jpg",
            },
            {
                id: "bg-image-12",
                name: "Silhouette au Crépuscule",
                url: "https://img1.wallspic.com/previews/9/6/8/6/4/146869/146869-silhouette_of_man_and_woman_standing_on_brown_sand_during_sunset-x750.jpg",
            },
            {
                id: "bg-image-13",
                name: "Rochers au Coucher",
                url: "https://img1.wallspic.com/previews/3/5/5/6/2/126553/126553-sunset-rock-sea-creative_arts-formation-x750.jpg",
            },

            // EXTRA: Scenic / Abstract / Tech / Pastel / High-contrast
            {
                id: "bg-image-14",
                name: "Aurore Boréale (Vert/Violet)",
                url: "https://images.unsplash.com/photo-1446776811953-b23d57bd21aa?auto=format&fit=crop&w=1920&q=80",
            },
            {
                id: "bg-image-15",
                name: "Montagnes Brumeuses",
                url: "https://images.unsplash.com/photo-1501785888041-af3ef285b470?auto=format&fit=crop&w=1920&q=80",
            },
            {
                id: "bg-image-16",
                name: "Plage Tropicale",
                url: "https://images.unsplash.com/photo-1507525428034-b723cf961d3e?auto=format&fit=crop&w=1920&q=80",
            },
            {
                id: "bg-image-17",
                name: "Vagues Abstraites (Bleu)",
                url: "https://images.unsplash.com/photo-1500530855697-b586d89ba3ee?auto=format&fit=crop&w=1920&q=80",
            },
            {
                id: "bg-image-18",
                name: "Ville Nocturne (Bokeh)",
                url: "https://images.unsplash.com/photo-1499346030926-9a72daac6c63?auto=format&fit=crop&w=1920&q=80",
            },
            {
                id: "bg-image-19",
                name: "Circuit Électronique (Tech)",
                url: "https://images.unsplash.com/photo-1518770660439-4636190af475?auto=format&fit=crop&w=1920&q=80",
            },
            {
                id: "bg-image-20",
                name: "Papier Peint Pastel",
                url: "https://img2.wallspic.com/crops/0/5/3/9/7/179350/179350-art-la_purete_de_la_couleur-purple-azure-violette-2560x1440.jpg",
            },
            {
                id: "bg-image-21",
                name: "Fumée Colorée (Violet)",
                url: "https://images.unsplash.com/photo-1503264116251-35a269479413?auto=format&fit=crop&w=1920&q=80",
            },
            {
                id: "bg-image-22",
                name: "Galerie Abstraite (Rouge)",
                url: "https://images.unsplash.com/photo-1469474968028-56623f02e42e?auto=format&fit=crop&w=1920&q=80",
            },
            {
                id: "bg-image-23",
                name: "Forêt Enneigée",
                url: "https://images.unsplash.com/photo-1482192505345-5655af888cc4?auto=format&fit=crop&w=1920&q=80",
            },
            {
                id: "bg-image-24",
                name: "Ciel Orangé au Crépuscule",
                url: "https://img2.wallspic.com/previews/7/7/7/8/7/178777/178777-amoled-atmosphere-lecoregion-nature-afterglow-x750.jpg",
            },
            {
                id: "bg-image-25",
                name: "Minimal Gradient (Bleu → Violet)",
                url: "https://images.unsplash.com/photo-1504639725590-34d0984388bd?auto=format&fit=crop&w=1920&q=80",
            },
            {
                id: "bg-image-26",
                name: "Skyline au Crépuscule",
                url: "https://images.unsplash.com/photo-1493246507139-91e8fad9978e?auto=format&fit=crop&w=1920&q=80",
            },
            {
                id: "bg-image-27",
                name: "Cascade en Forêt",
                url: "https://img1.wallspic.com/previews/3/5/8/0/40853/40853-matin-jaune-printemps-lac-ciel-x750.jpg",
            },
            {
                id: "bg-image-28",
                name: "Dunes du Désert",
                url: "https://4kwallpapers.com/images/walls/thumbs_3t/10148.jpg",
            },
        ];

        // Initialisation
        document
            .querySelectorAll(".sidebar-item, .dropdown-item[data-view]")
            .forEach((item) => {
                item.addEventListener("click", (e) => {
                    e.preventDefault();
                    const view = item.dataset.view;

                    document
                        .querySelectorAll(".sidebar-item")
                        .forEach((i) => i.classList.remove("active"));
                    const sidebarItem = document.querySelector(
                        `.sidebar-item[data-view="${view}"]`
                    );
                    if (sidebarItem) sidebarItem.classList.add("active");

                    switchView(view);

                    if (window.innerWidth < 992) sidebar.classList.remove("show");
                });
            });

        loadTheme();

        sidebarToggle?.addEventListener("click", () => {
            sidebar.classList.toggle("show");
        });

        btnLogin.addEventListener("click", () => modalAuth.show());

        document
            .getElementById("googleSignIn")
            .addEventListener("click", async () => {
                try {
                    const result = await signInWithPopup(auth, provider);
                    const credential = GoogleAuthProvider.credentialFromResult(result);
                    googleAccessToken = credential.accessToken;
                    localStorage.setItem("googleAccessToken", googleAccessToken);
                    modalAuth.hide();
                } catch (err) {
                    showToast("Erreur de connexion : " + err.message, "danger");
                }
            });

        document
            .getElementById("googleSignup")
            .addEventListener("click", async () => {
                try {
                    const result = await signInWithPopup(auth, provider);
                    const credential = GoogleAuthProvider.credentialFromResult(result);
                    googleAccessToken = credential.accessToken;
                    localStorage.setItem("googleAccessToken", googleAccessToken);
                    await updateProfile(result.user, {
                        displayName: result.user.displayName,
                    });
                    modalAuth.hide();
                } catch (err) {
                    showToast("Erreur d'inscription : " + err.message, "danger");
                }
            });
        document
            .getElementById("signinForm")
            .addEventListener("submit", async (e) => {
                e.preventDefault();
                const email = document.getElementById("signinEmail").value;
                const password = document.getElementById("signinPassword").value;
                try {
                    await signInWithEmailAndPassword(auth, email, password);
                    modalAuth.hide();
                } catch (err) {
                    showToast("Erreur de connexion : " + err.message, "danger");
                }
            });

        document
            .getElementById("signupForm")
            .addEventListener("submit", async (e) => {
                e.preventDefault();
                const name = document.getElementById("signupName").value;
                const email = document.getElementById("signupEmail").value;
                const password = document.getElementById("signupPassword").value;
                try {
                    const result = await createUserWithEmailAndPassword(
                        auth,
                        email,
                        password
                    );
                    await updateProfile(result.user, { displayName: name });
                    modalAuth.hide();
                } catch (err) {
                    showToast("Erreur d'inscription : " + err.message, "danger");
                }
            });

        btnLogout.addEventListener("click", async () => {
            await signOut(auth);
            localStorage.removeItem("googleAccessToken");
            googleAccessToken = null;
            location.reload();
        });

        onAuthStateChanged(auth, (user) => {
            const profileDropdown = document.getElementById("profileDropdown");
            const btnLogin = document.getElementById("btnLogin");
            const welcomeEl = document.getElementById("welcomeUserName");

            if (user) {
                // --- USER IS LOGGED IN ---
                profileDropdown.style.display = "block";
                btnLogin.classList.add("d-none");
                if (welcomeEl)
                    welcomeEl.textContent = user.displayName || "Utilisateur";

                document.getElementById("userPhoto").src =
                    user.photoURL ||
                    `https://ui-avatars.com/api/?name=${encodeURIComponent(
                        user.displayName || user.email
                    )}`;
                document.getElementById("userName").innerText =
                    user.displayName || "Utilisateur";
                document.getElementById("userEmail").innerText = user.email;

                googleAccessToken = localStorage.getItem("googleAccessToken") || null;

                // --- ADMIN CHECK LOGIC ---
                user.getIdTokenResult().then((idTokenResult) => {
                    // Check for the custom 'admin' claim
                    isAdmin = !!idTokenResult.claims.admin;
                    console.log(`User is admin: ${isAdmin}`);

                    // Re-render any components that might change for an admin
                    if (
                        document
                            .getElementById("discussionsView")
                            .classList.contains("d-none") === false
                    ) {
                        showDiscussionsList();
                    }
                });

                loadUserProgress();
                fetchDriveFolder(currentFolderId);
                loadContributedContent();

                listenForNotifications(user.uid);
                listenForInboxMessages(user.uid);
                initializeAlarmSystem();
                renderCalendar();
            } else {
                // --- USER IS LOGGED OUT ---
                profileDropdown.style.display = "none";
                btnLogin.classList.remove("d-none");
                if (welcomeEl) welcomeEl.textContent = "";

                googleAccessToken = null;
                userProgress = {};
                document.getElementById("coursesGrid").innerHTML =
                    '<div class="col-12 text-center text-muted py-5"><i class="bi bi-lock fs-1"></i><p>Veuillez vous connecter pour accéder aux cours.</p></div>';

                isAdmin = false; // Reset admin status on logout
                if (unsubscribeNotifications) unsubscribeNotifications();
                if (unsubscribeInbox) unsubscribeInbox();
                stopAlarmSystem();
                if (calendar) calendar.destroy();

                updateNotificationUI([]);
            }

            loadTheme();
        });

        // Recherche
        document.getElementById("searchInput")?.addEventListener("input", (e) => {
            const query = e.target.value.toLowerCase();
            filterCourses(query);
        });

        // Formulaire de notes
        document.getElementById("noteForm")?.addEventListener("submit", (e) => {
            e.preventDefault();
            const title = document.getElementById("noteTitle").value;
            const content = document.getElementById("noteContent").value;
            notes.push({
                title,
                content,
                date: new Date().toLocaleString("fr-FR"),
            });
            localStorage.setItem("notes", JSON.stringify(notes));
            renderNotes();
            e.target.reset();
        });



        function extractGoogleDriveId(url) {
            if (!url) return null;
            // Tente de trouver l'ID dans le format standard /file/d/ID/view
            let match = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
            if (match) return match[1];

            // Tente de trouver l'ID dans les liens d'édition ou de partage ?id=ID
            match = url.match(/id=([a-zA-Z0-9_-]+)/);
            if (match) return match[1];

            // Si l'utilisateur colle un lien direct vers un fichier
            match = url.match(/drive\.google\.com\/open\?id=([a-zA-Z0-9_-]+)/);
            if (match) return match[1];

            // Si c'est juste un ID collé
            if (url.match(/^[a-zA-Z0-9_-]+$/)) return url;

            return null;
        }




        // --- FIX: Stop video/document from playing when modal is closed ---
        videoModalEl.addEventListener("hidden.bs.modal", () => {
            const videoContainer = document.getElementById("videoContainer");
            const iframe = videoContainer.querySelector("iframe");
            if (iframe) {
                iframe.src = "";
            }
            historyQueue.innerHTML = ""; // This line is correct
            playlistPanel.classList.add("d-none");
            playlistPanel.classList.remove("d-flex");
        });

        documentModalEl.addEventListener("hidden.bs.modal", () => {
            const documentContainer = document.getElementById("documentContainer");
            const iframe = documentContainer.querySelector("iframe");
            if (iframe) {
                // This is also good practice for document modals to free up resources
                iframe.src = "";
            }
        });

        // 1. Add this variable at the top with your other global variables
        let documentViewMode = "grid"; // Can be 'grid' or 'list'

        // 2. Add these event listeners for the new buttons in your initialization section
        document
            .getElementById("btnGridDocuments")
            .addEventListener("click", () => {
                documentViewMode = "grid";
                document.getElementById("btnGridDocuments").classList.add("active");
                document
                    .getElementById("btnListDocuments")
                    .classList.remove("active");
                renderDocuments();
            });

        document
            .getElementById("btnListDocuments")
            .addEventListener("click", () => {
                documentViewMode = "list";
                document.getElementById("btnListDocuments").classList.add("active");
                document
                    .getElementById("btnGridDocuments")
                    .classList.remove("active");
                renderDocuments();
            });

        // Fonction utilitaire pour convertir HEX en RGB
        function hexToRgb(hex) {
            const bigint = parseInt(hex.slice(1), 16);
            const r = (bigint >> 16) & 255;
            const g = (bigint >> 8) & 255;
            const b = bigint & 255;
            return { r, g, b };
        }

        // Fonction utilitaire pour déterminer si une couleur est claire ou sombre (luminosité YIQ)
        function isLight(color) {
            const { r, g, b } = hexToRgb(color);
            const yiq = (r * 299 + g * 587 + b * 114) / 1000;
            return yiq >= 180; // Seuil ajusté pour l'interface utilisateur
        }

        /**
         * Analyse une image pour extraire une palette de couleurs.
         * @param {string} imageUrl URL de l'image à analyser.
         * @returns {Promise<{dominant: string, accent: string, isDominantLight: boolean}>} Couleurs et détection de luminosité.
         */
        function analyzeImageColors(imageUrl) {
            return new Promise((resolve, reject) => {
                if (!imageUrl || imageUrl === "none" || imageUrl === "none") {
                    return resolve({
                        dominant: null,
                        accent: null,
                        isDominantLight: false,
                    });
                }

                const img = new Image();
                // IMPORTANT: Les images non-CORS (comme les URL non-Picsum/Unsplash sans headers CORS)
                // vont causer des erreurs de sécurité du canvas.
                // Si vous utilisez des images locales ou des domaines non configurés, l'analyse échouera.
                img.crossOrigin = "Anonymous";
                img.src = imageUrl;

                img.onload = () => {
                    const canvas = document.createElement("canvas");
                    const ctx = canvas.getContext("2d");

                    const width = 100;
                    const height = 100;
                    canvas.width = width;
                    canvas.height = height;
                    ctx.drawImage(img, 0, 0, width, height);

                    try {
                        const imageData = ctx.getImageData(0, 0, width, height).data;
                        const colors = {};
                        const step = 4 * 10; // Analyser 1 pixel sur 10

                        for (let i = 0; i < imageData.length; i += step) {
                            const r = imageData[i];
                            const g = imageData[i + 1];
                            const b = imageData[i + 2];

                            const hex =
                                "#" +
                                ((1 << 24) + (r << 16) + (g << 8) + b)
                                    .toString(16)
                                    .slice(1)
                                    .toUpperCase();
                            colors[hex] = (colors[hex] || 0) + 1;
                        }

                        const sortedColors = Object.entries(colors).sort(
                            ([, a], [, b]) => b - a
                        );

                        if (sortedColors.length === 0) {
                            return resolve({
                                dominant: null,
                                accent: null,
                                isDominantLight: false,
                            });
                        }

                        let dominant = sortedColors[0][0];
                        let accent =
                            sortedColors.length > 1 ? sortedColors[1][0] : dominant;

                        // Simple filtre: Si la couleur dominante est trop proche du soft/border du thème,
                        // on la saute pour trouver une couleur plus "vibrante".
                        const filterThreshold = 10; // Tolérance de luminosité

                        const isTooGrayOrSoft = (hex) => {
                            const { r, g, b } = hexToRgb(hex);
                            // Vérifie si la couleur est trop grise ou trop claire
                            return (
                                Math.abs(r - g) < filterThreshold &&
                                Math.abs(g - b) < filterThreshold &&
                                isLight(hex)
                            );
                        };

                        // Recherche d'une couleur dominante vibrante
                        let validDominant = dominant;
                        for (let i = 0; i < sortedColors.length && i < 10; i++) {
                            if (!isTooGrayOrSoft(sortedColors[i][0])) {
                                validDominant = sortedColors[i][0];
                                break;
                            }
                        }

                        // Recherche d'une couleur d'accentuation vibrante et différente
                        let validAccent = validDominant;
                        for (let i = 0; i < sortedColors.length && i < 10; i++) {
                            const potentialAccent = sortedColors[i][0];
                            if (
                                potentialAccent !== validDominant &&
                                !isTooGrayOrSoft(potentialAccent)
                            ) {
                                validAccent = potentialAccent;
                                break;
                            }
                        }

                        const isDomLight = isLight(validDominant);

                        resolve({
                            dominant: validDominant,
                            accent: validAccent,
                            isDominantLight: isDomLight,
                        });
                    } catch (error) {
                        console.error(
                            "Erreur lors de l'analyse des couleurs (CORS ou Canvas):",
                            error
                        );
                        resolve({ dominant: null, accent: null, isDominantLight: false });
                    }
                };

                img.onerror = () => {
                    console.warn(
                        "Impossible de charger l'image pour l'analyse des couleurs."
                    );
                    resolve({ dominant: null, accent: null, isDominantLight: false });
                };
            });
        }

        // MODIFICATION DE setBackgroundImage
        /*async function setBackgroundImage(imageId) {
              localStorage.setItem('backgroundImage', imageId);
              const main = document.getElementById('mainContent');
              const body = document.body;
              if (!main) return;
  
              const imageMeta = BACKGROUND_IMAGES.find(i => i.id === imageId);
              const imageUrl = imageMeta ? imageMeta.url : null;
  
              // 1. Suppression des classes et variables dynamiques précédentes
              main.removeAttribute('data-bg');
              body.removeAttribute('data-dynamic-text'); // Supprimer la classe globale de texte
              main.className = main.className.split(' ').filter(c => !c.startsWith('bg-image-')).join(' ');
  
              main.style.setProperty('--dynamic-brand', null);
              main.style.setProperty('--dynamic-accent', null);
              main.style.setProperty('--dynamic-text-color', null);
              main.style.setProperty('--dynamic-surface-color', null);
  
  
              if (imageId && imageId !== 'none') {
                  main.setAttribute('data-bg', imageId);
                  main.classList.add(imageId);
  
                  const { dominant, accent, isDominantLight } = await analyzeImageColors(imageUrl);
  
                  if (dominant && accent) {
                      console.log(`Couleurs extraites: Dominante=${dominant}, Accent=${accent}, Claire?=${isDominantLight}`);
  
                      // Définir la couleur de la marque et d'accentuation
                      main.style.setProperty('--dynamic-brand', dominant);
                      main.style.setProperty('--dynamic-accent', accent);
  
                      // Définir la couleur du texte et de la surface pour garantir le contraste
                      // Si la couleur dominante est claire (isDominantLight = true), le texte doit être foncé (var(--text)).
                      // Si la couleur dominante est sombre, le texte doit être clair (var(--dark-text)).
  
                      const dynamicTextColor = isDominantLight ? 'var(--text)' : 'var(--dark-text)';
                      const dynamicSurfaceColor = isDominantLight ? 'rgba(0, 0, 0, 0.75)' : 'rgba(255, 255, 255, 0.75)';
  
                      main.style.setProperty('--dynamic-text-color', dynamicTextColor);
                      main.style.setProperty('--dynamic-surface-color', dynamicSurfaceColor);
  
                      // Ajouter un attribut au body pour que le CSS puisse adapter le texte des titres
                      body.setAttribute('data-dynamic-text', isDominantLight ? 'dark' : 'light');
  
                      showToast(`Thème adapté aux couleurs de l'image !`, 'success');
                  } else {
                      showToast(`Image de fond appliquée. L'analyse des couleurs a échoué.`, 'warning');
                  }
  
              } else {
                  // Option 'None'
                  main.style.backgroundImage = 'none';
                  main.style.backgroundColor = 'var(--soft)';
                  body.removeAttribute('data-dynamic-text');
              }
  
              renderBackgroundSelector();
          }
  
          */

        // NOUVELLE VERSION DE setBackgroundImage
        async function setBackgroundImage(imageId) {
            localStorage.setItem("backgroundImage", imageId);
            const main = document.getElementById("mainContent");
            const body = document.body;
            if (!main) return;

            const imageMeta = BACKGROUND_IMAGES.find((i) => i.id === imageId);
            const imageUrl = imageMeta ? imageMeta.url : null;

            // 1. Suppression des classes et variables dynamiques précédentes (CIBLER LE BODY ET MAIN)
            main.removeAttribute("data-bg");
            body.removeAttribute("data-dynamic-text");
            body.removeAttribute("data-dynamic-bg-active"); // NOUVEL ATTRIBUT POUR ACTIVER LE STYLE GLOBAL

            // Nettoyer les variables dynamiques du body
            body.style.setProperty("--dynamic-brand", null);
            body.style.setProperty("--dynamic-accent", null);
            body.style.setProperty("--dynamic-text-color", null);
            body.style.setProperty("--dynamic-surface-color", null);

            // Nettoyer le body des anciennes classes pour éviter les fuites
            body.className = body.className
                .split(" ")
                .filter((c) => !c.startsWith("bg-image-"))
                .join(" ");
            main.className = main.className
                .split(" ")
                .filter((c) => !c.startsWith("bg-image-"))
                .join(" ");

            if (imageId && imageId !== "none") {
                // 2. Analyse des couleurs
                const { dominant, accent, isDominantLight } =
                    await analyzeImageColors(imageUrl);

                // 3. Application des classes/attributs sur le BODY (Contrôle Global)
                body.setAttribute("data-dynamic-bg-active", "true");
                body.setAttribute(
                    "data-dynamic-text",
                    isDominantLight ? "dark" : "light"
                );
                body.classList.add(imageId); // Appliquer l'image au body (pour le fond)

                // 4. Application des variables sur le BODY
                if (dominant && accent) {
                    const dynamicTextColor = isDominantLight
                        ? "var(--text)"
                        : "var(--dark-text)";

                    // Utiliser une couleur d'arrière-plan très subtile pour le body/main par défaut
                    //const dynamicSurfaceColor = isDominantLight ? 'rgba(0, 0, 0, 0.05)' : 'rgba(255, 255, 255, 0.05)';
                    //const shadowColor = isDominantLight ? 'var(--dark-text)' : 'var(--text)';

                    const dynamicSurfaceColor = isDominantLight
                        ? "rgba(255, 255, 255, 0.85)"
                        : "rgba(30, 41, 59, 0.85)"; // Utilisation de dark-surface pour l'opacité

                    const shadowColor = isDominantLight
                        ? "var(--text)"
                        : "var(--dark-text)"; // Couleur du texte inverse pour le stroke/shadow

                    const rgb = hexToRgb(dominant); // Assurez-vous d'avoir hexToRgb défini plus haut
                    const rgbString = `${rgb.r}, ${rgb.g}, ${rgb.b}`;

                    body.style.setProperty("--dynamic-brand", dominant);
                    body.style.setProperty("--dynamic-accent", accent);
                    body.style.setProperty("--dynamic-brand-rgb", rgbString);
                    body.style.setProperty("--dynamic-text-color", dynamicTextColor);
                    body.style.setProperty(
                        "--dynamic-surface-color",
                        dynamicSurfaceColor
                    );
                    body.style.setProperty("--dynamic-shadow-color", shadowColor);

                    main.style.setProperty("--dynamic-brand", dominant);
                    main.style.setProperty("--dynamic-accent", accent);
                    main.style.setProperty("--dynamic-text-color", dynamicTextColor);
                    main.style.setProperty(
                        "--dynamic-surface-color",
                        dynamicSurfaceColor
                    );
                    main.style.setProperty("--dynamic-shadow-color", shadowColor);

                    // Appliquer la même image au main content pour le défilement
                    main.setAttribute("data-bg", imageId);
                    main.classList.add(imageId);

                    showToast(`Thème dynamique appliqué !`, "success");
                } else {
                    // Si l'analyse échoue mais que l'image est sélectionnée
                    main.setAttribute("data-bg", imageId);
                    main.classList.add(imageId);
                    showToast(
                        `Image appliquée, mais l'analyse des couleurs a échoué (CORS ou faible contraste).`,
                        "warning"
                    );
                }
            } else {
                // Option 'None'
                main.style.backgroundImage = "none";
                main.style.backgroundColor = "var(--soft)";
            }

            renderBackgroundSelector();
        }

        function loadBackgroundImage() {
            const savedImage = localStorage.getItem("backgroundImage") || "none";
            setBackgroundImage(savedImage);
        }

        function renderBackgroundSelector() {
            const grid = document.getElementById("backgroundSelectorGrid");
            if (!grid) return;
            grid.innerHTML = "";

            const activeImage = localStorage.getItem("backgroundImage") || "none";

            BACKGROUND_IMAGES.forEach((img) => {
                const col = document.createElement("div");
                col.className = "col-6 col-md-3";

                // Handle "None" option separately
                const style =
                    img.id !== "none"
                        ? `background-image: url('${img.url}')`
                        : `background-color: var(--border); display: flex; align-items: center; justify-content: center;`;

                const content =
                    img.id !== "none"
                        ? `<div class="bg-thumb ${img.id === activeImage ? "active" : ""
                        }" style="${style}"></div>`
                        : `<div class="bg-thumb ${img.id === activeImage ? "active" : ""
                        }" style="${style}">
                   <i class="bi bi-x-circle fs-3 text-muted"></i>
               </div>`;

                col.innerHTML = `
            ${content}
            <small class="d-block text-center mt-1 text-muted">${img.name}</small>
        `;

                col.querySelector(".bg-thumb").addEventListener("click", () => {
                    setBackgroundImage(img.id);
                    showToast(`Fond d'écran changé : ${img.name}`, "info");
                });

                grid.appendChild(col);
            });
        }

        // Sélecteur de thème
        document
            .getElementById("themeSelect")
            ?.addEventListener("change", (e) => {
                const theme = e.target.value;
                setTheme(theme);
                renderBackgroundSelector();
            });

        // START: EVENT LISTENERS FOR ACCOUNT SETTINGS
        document
            .getElementById("profileSettingsForm")
            ?.addEventListener("submit", async (e) => {
                e.preventDefault();
                const user = auth.currentUser;
                if (!user) return;

                const newName = document.getElementById("accountName").value;
                if (newName !== user.displayName) {
                    try {
                        await updateProfile(user, { displayName: newName });
                        document.getElementById("userName").innerText = newName;
                        document.getElementById("welcomeUserName").innerText = newName;
                        showToast("Profil mis à jour avec succès !", "success");
                    } catch (error) {
                        showToast("Erreur lors de la mise à jour du profil.", "danger");
                    }
                }
            });

        document
            .getElementById("passwordChangeForm")
            ?.addEventListener("submit", async (e) => {
                e.preventDefault();
                const user = auth.currentUser;
                if (!user) return;

                const newPassword = document.getElementById("newPassword").value;
                try {
                    await updatePassword(user, newPassword);
                    showToast("Mot de passe mis à jour avec succès.", "success");
                    e.target.reset();
                } catch (error) {
                    showToast("Erreur: " + error.message, "danger");
                }
            });

        document
            .getElementById("btnDeleteAccount")
            ?.addEventListener("click", async () => {
                const user = auth.currentUser;
                if (!user) return;

                if (
                    confirm(
                        "Êtes-vous sûr de vouloir supprimer votre compte ? Cette action est irréversible."
                    )
                ) {
                    try {
                        await deleteUser(user);
                        showToast("Compte supprimé avec succès.", "info");
                        // The onAuthStateChanged will handle the UI changes after deletion.
                    } catch (error) {
                        showToast(
                            "Erreur lors de la suppression du compte: " + error.message,
                            "danger"
                        );
                    }
                }
            });
        // END: EVENT LISTENERS FOR ACCOUNT SETTINGS

        function switchView(view) {
            document
                .querySelectorAll(".view-content")
                .forEach((v) => v.classList.add("d-none"));
            const viewEl = document.getElementById(`${view}View`);
            if (viewEl) viewEl.classList.remove("d-none");

            if (view === "videos") {
                renderVideos();
                fetchYoutubeTutorials();
                renderContributedVideos();
            }
            if (view === "contributed") renderContributed();
            if (view === "documents") renderDocuments();
            if (view === 'library') {
                // Si c'est la première fois ou si la requête est vide, chargez des livres par défaut
                if (!currentSearchQuery) {
                    searchLibrary('', 1, false); // La fonction searchLibrary gère la requête par défaut si vide
                } else {
                    // Sinon, juste montrer la vue courante
                    document.getElementById("libraryList").classList.remove("d-none");
                    document.getElementById("bookDetailView").classList.add("d-none");
                }
            }
            if (view === "assignments") renderAssignments();
            if (view === "calendar") renderCalendar();
            if (view === "discussions") showDiscussionsList();
            if (view === "notifications") renderFullNotificationPage();
            if (view === "notes") renderNotes();
            if (view === "progress") renderProgress();
            if (view === "settings") renderSettings();
            renderBackgroundSelector();
        }

        function loadUserProgress() {
            const saved = localStorage.getItem("userProgress");
            if (saved) userProgress = JSON.parse(saved);
        }

        function saveProgress(fileId, progress) {
            userProgress[fileId] = progress;
            localStorage.setItem("userProgress", JSON.stringify(userProgress));
            updateStats();
        }

        async function fetchDriveFolder(folderId) {
            document.getElementById("loader").style.display = "block";
            const coursesGrid = document.getElementById("coursesGrid");

            try {
                let param = "";
                if (googleAccessToken) {
                    param = `&access_token=${googleAccessToken}`;
                } else if (DRIVE_API_KEY) {
                    param = `&key=${DRIVE_API_KEY}`;
                }

                const url = `https://www.googleapis.com/drive/v3/files?q='${folderId}'+in+parents&fields=files(id,name,mimeType,webViewLink,thumbnailLink,iconLink,webContentLink,description,createdTime,modifiedTime)&pageSize=200${param}`;

                const res = await fetch(url);
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                const json = await res.json();

                if (json.error) {
                    throw new Error(json.error.message);
                }

                currentFiles = json.files || [];
                if (folderId === DRIVE_FOLDER_ID) allFiles = currentFiles;
                document.getElementById("loader").style.display = "none";

                renderCourses();
                renderFolderContributed();
                renderDashboard();
                updateStats();
                renderBreadcrumb();
                populateCourseSelect();
            } catch (err) {
                console.error("Erreur de fetch", err);
                document.getElementById("loader").style.display = "none";
                coursesGrid.innerHTML = `<div class="col-12 text-center text-danger py-5"><i class="bi bi-exclamation-triangle fs-1"></i><p class="mt-2">Erreur de chargement des cours : ${err.message}. Vérifiez votre connexion ou les permissions Drive.</p></div>`;
            }
        }
        function populateCourseSelect() {
            contentCourseSelect.innerHTML =
                '<option value="">Associé à aucun cours</option>';
            allFiles
                .filter((f) => f.mimeType === "application/vnd.google-apps.folder")
                .forEach((folder) => {
                    const option = document.createElement("option");
                    option.value = folder.id;
                    option.textContent = folder.name;
                    contentCourseSelect.appendChild(option);
                });
        }

        async function loadContributedContent() {
            contributedContent = [];
            const q = query(collection(db, "contributed"));
            const snapshot = await getDocs(q);
            snapshot.forEach((doc) =>
                contributedContent.push({ id: doc.id, ...doc.data() })
            );
            renderContributed();
        }

        function getFileMeta(mime) {
            if (!mime)
                return {
                    kind: "file",
                    icon: "bi-file-earmark-text",
                    label: "Fichier",
                    color: "#6c757d",
                };
            if (mime === "application/vnd.google-apps.folder")
                return {
                    kind: "folder",
                    icon: "bi-folder-fill",
                    label: "Dossier",
                    color: "#ffc107",
                };
            if (mime.startsWith("video/"))
                return {
                    kind: "video",
                    icon: "bi-camera-video-fill",
                    label: "Vidéo",
                    color: "#dc3545",
                };
            if (mime === "application/pdf")
                return {
                    kind: "document",
                    icon: "bi-file-earmark-pdf-fill",
                    label: "PDF",
                    color: "#0d6efd",
                };
            if (mime.includes("document"))
                return {
                    kind: "document",
                    icon: "bi-file-earmark-text-fill",
                    label: "Document",
                    color: "#0d6efd",
                };
            if (mime.includes("spreadsheet"))
                return {
                    kind: "document",
                    icon: "bi-file-earmark-spreadsheet",
                    label: "Tableur",
                    color: "#198754",
                };
            if (mime.includes("presentation"))
                return {
                    kind: "document",
                    icon: "bi-file-earmark-slides",
                    label: "Présentation",
                    color: "#fd7e14",
                };
            return {
                kind: "file",
                icon: "bi-file-earmark",
                label: "Fichier",
                color: "#6c757d",
            };
        }

        function extractVideoId(url) {
            if (!url) return null;
            const match = url.match(
                /(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/
            );
            return match ? match[1] : null;
        }

        function extractPlaylistId(url) {
            const match = url.match(/[&?]list=([a-zA-Z0-9_-]+)/);
            return match ? match[1] : null;
        }

        function extractYoutubeId(url, type) {
            return type === "playlist"
                ? extractPlaylistId(url)
                : extractVideoId(url);
        }

        /*
          function renderBreadcrumb() {
              const breadcrumb = document.getElementById('breadcrumb');
              if (!breadcrumb) return;
              breadcrumb.innerHTML = folderPath.map((folder, index) => {
                  return index === folderPath.length - 1 ?
                      `<span>${escapeHtml(folder.name)}</span>` :
                      `<a href="#" onclick="navigateToFolder('${folder.id}', ${index})">${escapeHtml(folder.name)}</a> > `;
              }).join('');
          }
          */

        function renderBreadcrumb() {
            const breadcrumb = document.getElementById("breadcrumb");
            if (!breadcrumb) return;

            // Use join() with a separator element for cleaner logic
            breadcrumb.innerHTML = folderPath
                .map((folder, index) => {
                    if (index === folderPath.length - 1) {
                        // This is the current, non-clickable folder
                        return `<span class="breadcrumb-current">${escapeHtml(
                            folder.name
                        )}</span>`;
                    } else {
                        // These are the clickable parent folders
                        return `<a href="#" class="breadcrumb-link" onclick="navigateToFolder('${folder.id
                            }', ${index})">${escapeHtml(folder.name)}</a>`;
                    }
                })
                .join(' <i class="bi bi-chevron-right text-muted mx-1"></i> ');
        }

        window.navigateToFolder = function (folderId, index) {
            folderPath = folderPath.slice(0, index + 1);
            currentFolderId = folderId;
            fetchDriveFolder(folderId);
        };

        function renderCourses() {
            const grid = document.getElementById("coursesGrid");
            grid.innerHTML = "";

            if (!currentFiles.length) {
                grid.innerHTML =
                    '<div class="col-12 text-center text-muted py-5"><i class="bi bi-inbox fs-1"></i><p class="mt-2">Aucun cours trouvé</p></div>';
                return;
            }

            currentFiles.forEach((file) => {
                const meta = getFileMeta(file.mimeType);
                const progress = userProgress[file.id] || 0;
                const thumb =
                    file.thumbnailLink ||
                    `https://via.placeholder.com/400x250/${meta.color.replace(
                        "#",
                        ""
                    )}/ffffff?text=${encodeURIComponent(meta.label)}`;

                const col = document.createElement("div");
                col.className = "col-xl-3 col-lg-4 col-md-6";
                col.innerHTML = `
        <div class="card card-modern course-card h-100 fade-in">
          ${progress > 0 ? `<div class="progress-ring">${progress}%</div>` : ""}
          <span class="course-badge"><i class="${meta.icon} me-1"></i>${meta.label
                    }</span>
          ${meta.kind === "folder"
                        ? `<div class="course-thumbnail d-flex align-items-center justify-content-center" style="background:linear-gradient(135deg, ${meta.color}22, ${meta.color}11)">
              <i class="${meta.icon}" style="font-size:64px; color:${meta.color}"></i>
            </div>`
                        : `<img class="course-thumbnail" src="${thumb}" alt="${escapeHtml(
                            file.name
                        )}" loading="lazy">`
                    }
          <div class="card-body d-flex flex-column">
            <h6 class="card-title mb-2" style="min-height:44px; line-height:1.4">${escapeHtml(
                        file.name
                    )}</h6>
            ${file.description
                        ? `<p class="small text-muted mb-3">${escapeHtml(
                            file.description.substring(0, 80)
                        )}...</p>`
                        : ""
                    }
            ${progress > 0
                        ? `
              <div class="progress mb-3" style="height:6px">
                <div class="progress-bar bg-success" style="width:${progress}%"></div>
              </div>`
                        : ""
                    }
            <div class="mt-auto d-grid gap-2">
              ${meta.kind === "folder"
                        ? `<button class="btn btn-sm btn-primary" onclick="openFolder('${file.id
                        }', '${escapeHtml(file.name)}')">
                  <i class="bi bi-folder-symlink me-1"></i>Ouvrir
                </button>`
                        : meta.kind === "video"
                            ? `<button class="btn btn-sm btn-primary" onclick="playVideo('${file.id
                            }', '${escapeHtml(file.name)}', '${file.webViewLink || ""
                            }')">
                    <i class="bi bi-play-fill me-1"></i>Regarder
                  </button>`
                            : `<button class="btn btn-sm btn-primary" onclick="viewDocument('${file.id
                            }', '${escapeHtml(file.name)}', '${file.webViewLink || ""
                            }', '${meta.kind}')">
                    <i class="bi bi-eye me-1"></i>Voir
                  </button>`
                    }
              ${file.webContentLink
                        ? `<a class="btn btn-sm btn-outline-secondary" href="${file.webContentLink}" target="_blank">
                  <i class="bi bi-download me-1"></i>Télécharger
                </a>`
                        : ""
                    }
              <button class="btn btn-sm btn-outline-success" onclick="markComplete('${file.id
                    }')">
                <i class="bi bi-check-circle me-1"></i>${progress === 100 ? "Complété" : "Marquer comme complété"
                    }
              </button>
            </div>
          </div>
        </div>
      `;
                grid.appendChild(col);
            });
        }

        /*
          function renderFolderContributed() {
              const section = document.getElementById('folderContributedSection');
              if (!section) return;
              if (currentFolderId === DRIVE_FOLDER_ID) {
                  section.classList.add('d-none');
                  return;
              }
  
              section.classList.remove('d-none');
              const grid = document.getElementById('folderContributedGrid');
              grid.innerHTML = '';
  
              const filtered = contributedContent.filter(c => c.courseId === currentFolderId);
  
              if (!filtered.length) {
                  grid.innerHTML = `
                      <div class="col-12 text-center text-muted py-5">
                         <i class="bi bi-camera-video-off fs-2 d-block mb-2"></i>
                         Aucun tutoriel contribué
                      </div>`;
                  return;
              }
  
              filtered.forEach(content => {
                  const col = document.createElement('div');
                  col.className = 'col-md-4 col-sm-6 mb-4';
  
                  const isPlaylist = content.type === 'playlist';
                  const thumbnailUrl = isPlaylist
                      ? ''
                      : `https://img.youtube.com/vi/${content.id}/mqdefault.jpg`;
  
                  col.innerHTML = `
                      <div class="video-card fade-in ${isPlaylist ? 'playlist' : ''}" 
                          onclick="playYoutube('${content.type}', '${content.id}', '${escapeHtml(content.title)}')">
                          <div class="video-thumb">
                              ${isPlaylist ? `<span class="playlist-title">${escapeHtml(content.title || 'Playlist')}</span>` : `<img src="${thumbnailUrl}" alt="${escapeHtml(content.title)}" class="video-thumb-img">`}
                              <div class="video-overlay">
                                 <i class="bi bi-play-fill play-icon"></i>
                              </div>
                              <span class="video-badge">${content.type.charAt(0).toUpperCase() + content.type.slice(1)}</span>
                          </div>
                          <div class="video-body">
                              <h6 class="video-title">${escapeHtml(content.title || 'Sans titre')}</h6>
                              <p class="video-author">
                                  <i class="bi bi-person-circle me-1"></i>${escapeHtml(content.userName || 'Inconnu')}
                              </p>
                          </div>
                      </div>`;
  
                  grid.appendChild(col);
              });
          }*/

        function renderFolderContributed() {
            const section = document.getElementById("folderContributedSection");
            if (!section) return;
            if (currentFolderId === DRIVE_FOLDER_ID) {
                section.classList.add("d-none");
                return;
            }

            section.classList.remove("d-none");
            const grid = document.getElementById("folderContributedGrid");
            grid.innerHTML = "";

            const filtered = contributedContent.filter(
                (c) => c.courseId === currentFolderId
            );

            if (!filtered.length) {
                grid.innerHTML = `
            <div class="col-12 text-center text-muted py-5">
               <i class="bi bi-camera-video-off fs-2 d-block mb-2"></i>
               Aucun tutoriel ou ressource contribué(e) pour ce cours.
            </div>`;
                return;
            }

            filtered.forEach((content) => {
                const col = document.createElement("div");
                col.className = "col-lg-4 col-md-6";
                let cardHTML = "";
                let iconClass = "";
                let iconBg = "";
                const clickHandler = `viewContributedContent(${JSON.stringify(
                    content
                )})`;

                // DÉTERMINER LE TYPE DE CARTE ET L'APERÇU
                switch (content.type) {
                    case "youtube":
                        const ytId = content.id || content.youtubeId;
                        const isPlaylist = content.youtubeType === "playlist";
                        // FIX: S'assurer que le rendu YouTube utilise le style video-card
                        const thumbYt = isPlaylist
                            ? "" // Pas de vignette pour la playlist (le CSS gère un fond de dégradé)
                            : `https://img.youtube.com/vi/${ytId}/mqdefault.jpg`;

                        const badgeTextYt = isPlaylist ? "Playlist" : "Vidéo";

                        cardHTML = `
                    <div class="video-card h-100 fade-in ${isPlaylist ? "playlist" : ""
                            }" style="cursor: pointer;" onclick='${clickHandler}'>
                        <div class="video-thumb">
                            ${isPlaylist
                                ? `<span class="playlist-title">${escapeHtml(
                                    content.title || "Playlist YouTube"
                                )}</span>`
                                : `<img src="${thumbYt}" alt="${escapeHtml(
                                    content.title
                                )}" class="video-thumb-img">`
                            }
                            <div class="video-overlay"><i class="bi bi-play-fill play-icon"></i></div>
                            <span class="video-badge">${badgeTextYt}</span>
                        </div>
                        <div class="video-body d-flex flex-column">
                            <h6 class="video-title"><i class="bi bi-youtube text-danger me-2"></i>${escapeHtml(
                                content.title || "Vidéo YouTube"
                            )}</h6>
                            <p class="video-author mt-auto"><i class="bi bi-person-circle me-1"></i>${escapeHtml(
                                content.userName
                            )}</p>
                        </div>
                    </div>`;
                        break;

                    case "gdrive_video":
                        iconClass = "bi-camera-video-fill text-info";
                        iconBg = "linear-gradient(135deg, var(--info), var(--brand))";
                        // FIX: Utiliser la structure de carte de document/lien pour les aperçus d'icône
                        cardHTML = `
                    <div class="card card-modern h-100 fade-in hover-lift contributed-doc" style="cursor: pointer;" onclick='${clickHandler}'>
                        <div class="card-body d-flex flex-column">
                             <div class="flex-grow-1 rounded d-flex align-items-center justify-content-center" style="background: ${iconBg}; min-height: 120px; margin-bottom: 1rem;">
                                <i class="bi ${iconClass}" style="font-size: 4rem; color: #fff; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2));"></i>
                            </div>
                            <h6 class="card-title mt-1 mb-1"><i class="bi bi-google me-2"></i>${escapeHtml(
                            content.title || "Vidéo Google Drive"
                        )}</h6>
                            <small class="text-muted">Type: Vidéo Drive</small>
                            <p class="video-author mt-auto text-muted"><i class="bi bi-person-circle me-1"></i>${escapeHtml(
                            content.userName
                        )}</p>
                        </div>
                    </div>`;
                        break;

                    case "gdrive_doc":
                        iconClass = "bi-file-earmark-pdf-fill text-danger";
                        iconBg = "linear-gradient(135deg, var(--danger), #841212)";
                        cardHTML = `
                    <div class="card card-modern h-100 fade-in hover-lift contributed-doc" style="cursor: pointer;" onclick='${clickHandler}'>
                        <div class="card-body d-flex flex-column">
                             <div class="flex-grow-1 rounded d-flex align-items-center justify-content-center" style="background: ${iconBg}; min-height: 120px; margin-bottom: 1rem;">
                                <i class="bi ${iconClass}" style="font-size: 4rem; color: #fff; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2));"></i>
                            </div>
                            <h6 class="card-title mt-1 mb-1"><i class="bi bi-file-earmark-text me-2"></i>${escapeHtml(
                            content.title || "Document Google Drive"
                        )}</h6>
                             <small class="text-muted">Type: Document PDF/Slide</small>
                            <p class="video-author mt-auto text-muted"><i class="bi bi-person-circle me-1"></i>${escapeHtml(
                            content.userName
                        )}</p>
                        </div>
                    </div>`;
                        break;

                    case "link":
                        iconClass = "bi-link-45deg";
                        iconBg = "linear-gradient(135deg, var(--muted), var(--text))";
                        cardHTML = `
                     <div class="card card-modern h-100 fade-in hover-lift contributed-link" style="cursor: pointer;" onclick='${clickHandler}'>
                        <div class="card-body d-flex flex-column">
                             <div class="flex-grow-1 rounded d-flex align-items-center justify-content-center" style="background: ${iconBg}; min-height: 120px; margin-bottom: 1rem;">
                                <i class="bi ${iconClass}" style="font-size: 5rem; color: #fff; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2));"></i>
                            </div>
                            <h6 class="card-title mt-1 mb-1"><i class="bi bi-globe me-2"></i>${escapeHtml(
                            content.title || content.url
                        )}</h6>
                            <small class="text-muted">Type: Lien Web</small>
                            <p class="video-author mt-auto text-muted"><i class="bi bi-person-circle me-1"></i>${escapeHtml(
                            content.userName
                        )}</p>
                        </div>
                    </div>`;
                        break;
                }
                col.innerHTML = cardHTML;
                grid.appendChild(col);
            });
        }

        function renderDashboard() {
            const continueSection = document.getElementById("continueSection");
            const inProgress = allFiles
                .filter((f) => {
                    const prog = userProgress[f.id] || 0;
                    return prog > 0 && prog < 100;
                })
                .slice(0, 3);

            if (!inProgress.length) {
                continueSection.innerHTML = `
        <div class="col-12 text-center text-muted py-3">
          <i class="bi bi-play-circle fs-1"></i>
          <p class="mt-2">Commencez un cours pour le voir ici</p>
        </div>`;
                return;
            }

            continueSection.innerHTML = "";
            inProgress.forEach((file) => {
                const meta = getFileMeta(file.mimeType);
                const progress = userProgress[file.id] || 0;

                const col = document.createElement("div");
                col.className = "col-md-4";
                col.innerHTML = `
        <div class="card border-0 bg-light fade-in">
          <div class="card-body">
            <div class="d-flex gap-3">
              <div class="text-primary" style="font-size:32px">
                <i class="${meta.icon}"></i>
              </div>
              <div class="flex-grow-1">
                <h6 class="mb-1">${escapeHtml(file.name)}</h6>
                <small class="text-muted">${meta.label}</small>
                <div class="progress mt-2" style="height:6px">
                  <div class="progress-bar" style="width:${progress}%"></div>
                </div>
                <small class="text-muted">${progress}% complété</small>
              </div>
            </div>
            <button class="btn btn-sm btn-primary w-100 mt-3" onclick="resumeCourse('${file.id
                    }')">
              <i class="bi bi-play-fill me-1"></i>Continuer
            </button>
          </div>
        </div>
      `;
                continueSection.appendChild(col);
            });
        }

        function initializeQuill(selector) {
            return new Quill(selector, {
                theme: "snow",
                modules: {
                    toolbar: [
                        [{ header: [1, 2, false] }],
                        ["bold", "italic", "underline"],
                        ["link", "image"],
                        [{ list: "ordered" }, { list: "bullet" }],
                    ],
                },
            });
        }

        // 1. Add/update these variables at the top of your script
        const historyQueue = document.getElementById("historyQueue");
        let videoHistory = JSON.parse(localStorage.getItem("videoHistory")) || [];

        // 2. Add this NEW function. It's the brain of the history feature.
        function addVideoToHistory(videoData) {
            // videoData should be an object: { videoId, title, thumbnailUrl }

            // Remove any existing instance of this video to avoid duplicates
            videoHistory = videoHistory.filter(
                (v) => v.videoId !== videoData.videoId
            );

            // Add the new video to the beginning of the array
            videoHistory.unshift(videoData);

            // Limit the history to the last 30 videos
            if (videoHistory.length > 30) {
                videoHistory = videoHistory.slice(0, 30);
            }

            // Save to localStorage
            localStorage.setItem("videoHistory", JSON.stringify(videoHistory));

            // Refresh the visible history panel
            renderVideoHistory();
        }

        // 3. Add this NEW function to render the history panel
        function renderVideoHistory() {
            historyQueue.innerHTML = "";
            if (videoHistory.length === 0) {
                historyQueue.innerHTML =
                    '<div class="p-3 text-center text-muted small">Votre historique de lecture est vide.</div>';
                return;
            }

            videoHistory.forEach((video) => {
                const itemEl = document.createElement("button");
                itemEl.className = "list-group-item history-item";
                itemEl.innerHTML = `
            <img src="${video.thumbnailUrl}" alt="">
            <div class="flex-grow-1">
                <span class="history-title">${escapeHtml(video.title)}</span>
            </div>
        `;
                itemEl.addEventListener("click", (e) => {
                    e.preventDefault();
                    playVideoFromHistory(video, itemEl);
                });
                historyQueue.appendChild(itemEl);
            });
        }


        // ===============================
        // 📚 BIBLIOTHÈQUE FPN (OpenLibrary)
        // ===============================

        // === DOM ELEMENTS ===
        const libraryForm = document.getElementById("librarySearchForm");
        const libraryInput = document.getElementById("librarySearchInput");
        const libraryGrid = document.getElementById("libraryResultsGrid");
        const libraryResultCount = document.getElementById("libraryResultCount");
        const loadMoreContainer = document.getElementById("loadMoreContainer");
        const libraryListView = document.getElementById("libraryList");
        const bookDetailView = document.getElementById("bookDetailView");
        const bookDetailContent = document.getElementById("bookDetailContent");

        let currentSearch = "";
        let currentPage = 1;
        const RESULTS_PER_PAGE = 20;
        let totalResults = 0;

        // === FORM SUBMIT: SEARCH BOOKS ===
        libraryForm?.addEventListener("submit", async (e) => {
            e.preventDefault();
            const query = libraryInput.value.trim();
            if (!query) return;

            currentSearch = query;
            currentPage = 1;

            await searchBooks(currentSearch, currentPage);
        });

        // === FETCH BOOKS FROM OPENLIBRARY ===
        async function searchBooks(query, page = 1) {
            libraryGrid.innerHTML = `
    <div class="col-12 text-center text-muted py-5">
      <div class="spinner-border text-primary"></div>
      <p class="mt-3">Recherche de livres...</p>
    </div>`;

            try {
                const res = await fetch(
                    `https://openlibrary.org/search.json?q=${encodeURIComponent(query)}&page=${page}`
                );
                const data = await res.json();

                totalResults = data.numFound || 0;
                libraryResultCount.textContent = totalResults.toLocaleString("fr-FR");

                renderBooks(data.docs, page > 1);

                // Toggle "Load More" button
                if (data.docs.length >= RESULTS_PER_PAGE && totalResults > page * RESULTS_PER_PAGE) {
                    loadMoreContainer.classList.remove("d-none");
                } else {
                    loadMoreContainer.classList.add("d-none");
                }
            } catch (err) {
                libraryGrid.innerHTML = `
      <div class="col-12 text-center text-danger py-5">
        <i class="bi bi-exclamation-triangle fs-2"></i>
        <p class="mt-2">${err.message}</p>
      </div>`;
            }
        }

        // === RENDER BOOK CARDS ===
        function renderBooks(books, append = false) {
            const html = books
                .map((b) => {
                    const cover = b.cover_i
                        ? `https://covers.openlibrary.org/b/id/${b.cover_i}-M.jpg`
                        : "https://via.placeholder.com/200x300?text=Aucune+Image";

                    const title = b.title || "Titre inconnu";
                    const author = b.author_name ? b.author_name.join(", ") : "Auteur inconnu";

                    return `
        <div class="col-md-3 col-sm-6">
          <div class="card h-100 shadow-sm border-0">
            <img src="${cover}" class="card-img-top rounded-top" alt="${title}">
            <div class="card-body d-flex flex-column">
              <h6 class="fw-bold mb-1" title="${title}">${title}</h6>
              <p class="text-muted small flex-grow-1">${author}</p>
              <button class="btn btn-outline-primary btn-sm mt-auto" onclick="viewBookDetail('${b.key}')">
                <i class="bi bi-info-circle me-1"></i> Détails
              </button>
            </div>
          </div>
        </div>
      `;
                })
                .join("");

            libraryGrid.innerHTML = append ? libraryGrid.innerHTML + html : html;

            if (!books.length && !append) {
                libraryGrid.innerHTML = `
      <div class="col-12 text-center text-muted py-5">
        <i class="bi bi-book fs-1"></i>
        <p class="mt-2">Aucun résultat trouvé pour cette recherche.</p>
      </div>`;
            }
        }

        // === LOAD MORE RESULTS ===
        window.loadMoreBooks = async function () {
            currentPage++;
            await searchBooks(currentSearch, currentPage);
        };



        // === VIEW BOOK DETAILS (With Embedded Reader) ===
        window.viewBookDetail = async function (key) {
            libraryListView.classList.add("d-none");
            bookDetailView.classList.remove("d-none");

            bookDetailContent.innerHTML = `
    <div class="text-center text-muted py-5">
      <div class="spinner-border text-primary" role="status"></div>
      <p class="mt-2">Chargement des détails du livre...</p>
    </div>`;

            try {
                // Fetch book details from Open Library
                const res = await fetch(`https://openlibrary.org${key}.json`);
                const book = await res.json();

                // Prepare book cover
                const cover =
                    book.covers && book.covers.length
                        ? `https://covers.openlibrary.org/b/id/${book.covers[0]}-L.jpg`
                        : "https://via.placeholder.com/400x600?text=Aucune+Image";

                // Prepare book metadata
                const title = book.title || "Titre inconnu";
                const description =
                    (book.description && (book.description.value || book.description)) ||
                    "Aucune description disponible.";
                const authors =
                    book.authors && book.authors.length
                        ? book.authors
                            .map((a) => a.name || (a.author && a.author.name) || "Auteur inconnu")
                            .join(", ")
                        : "Auteur inconnu";
                const publishDate = book.publish_date || "Date inconnue";
                const publishers =
                    book.publishers && book.publishers.length
                        ? book.publishers.join(", ")
                        : "Éditeur inconnu";
                const isbn =
                    book.isbn_10 && book.isbn_10.length
                        ? book.isbn_10[0]
                        : book.isbn_13 && book.isbn_13.length
                            ? book.isbn_13[0]
                            : null;

                // Handle subjects with collapsible feature
                let subjectsHTML = "";
                if (book.subjects && book.subjects.length) {
                    const shown = book.subjects.slice(0, 8);
                    const hidden = book.subjects.slice(8);
                    subjectsHTML = `
        <div id="subjectsContainer">
          ${shown.map((s) => `<span class="badge bg-secondary me-1 mb-1">${s}</span>`).join("")}
          ${hidden.length ? `<span id="hiddenSubjects" class="d-none">${hidden.map((s) => `<span class="badge bg-secondary me-1 mb-1">${s}</span>`).join("")}</span>` : ""}
          ${hidden.length ? `<button id="toggleSubjectsBtn" class="btn btn-link p-0 mt-2 small text-decoration-none">+ Voir plus</button>` : ""}
        </div>`;
                } else {
                    subjectsHTML = "<span class='text-muted'>Aucun sujet</span>";
                }

                // Check Internet Archive availability and prepare preview
                let readerHTML = "";
                let availabilityStatus = "";
                try {
                    const archiveRes = await fetch(`https://archive.org/metadata${key}`);
                    const archiveData = await archiveRes.json();
                    const isAvailable =
                        archiveData.is_lendable || archiveData.availability?.status === "open";
                    const identifier = book.ocaid || archiveData.identifier;

                    if (identifier && isAvailable) {
                        const readerSrc = `https://archive.org/embed/${identifier}`;
                        availabilityStatus = `<span class="badge bg-success">Disponible</span>`;
                        readerHTML = `
          <div class="mt-4 p-3 rounded-3" style="background-color: #dc3545; color: white;">
            <h6 class="fw-bold mb-3">
              <i class="bi bi-book-half me-2"></i>Prévisualisation du livre ${availabilityStatus}
            </h6>
            <div class="ratio ratio-16x9 border rounded overflow-hidden shadow">
              <iframe src="${readerSrc}" frameborder="0" allowfullscreen style="width:100%;height:600px;"></iframe>
            </div>
            <p class="small mt-3 mb-2">Consultez ce livre ou des copies numériques sur Internet Archive.</p>
            <a href="https://archive.org/details/${identifier}" target="_blank" class="btn btn-light btn-sm fw-bold">
              <i class="bi bi-box-arrow-up-right me-1"></i>Ouvrir sur archive.org
            </a>
          </div>`;
                    } else {
                        availabilityStatus = `<span class="badge bg-warning">Non disponible</span>`;
                        readerHTML = `
          <div class="mt-4 p-3 rounded-3" style="background-color: #dc3545; color: white;">
            <h6 class="fw-bold mb-2"><i class="bi bi-book-half me-2"></i>Prévisualisation non disponible ${availabilityStatus}</h6>
            <p class="small mb-2">Ce livre n’a pas de version lisible sur Internet Archive.</p>
            <a href="https://archive.org/details${key}" target="_blank" class="btn btn-light btn-sm fw-bold">
              <i class="bi bi-box-arrow-up-right me-1"></i>Vérifier sur archive.org
            </a>
          </div>`;
                    }
                } catch (archiveErr) {
                    availabilityStatus = `<span class="badge bg-danger">Erreur</span>`;
                    readerHTML = `
        <div class="mt-4 p-3 rounded-3" style="background-color: #dc3545; color: white;">
          <h6 class="fw-bold mb-2"><i class="bi bi-book-half me-2"></i>Erreur de prévisualisation ${availabilityStatus}</h6>
          <p class="small mb-2">Erreur lors de la récupération de la prévisualisation : ${archiveErr.message}</p>
          <a href="https://archive.org/details${key}" target="_blank" class="btn btn-light btn-sm fw-bold">
            <i class="bi bi-box-arrow-up-right me-1"></i>Vérifier sur archive.org
          </a>
        </div>`;
                }

                // ISBN Copy Button
                const isbnHTML = isbn
                    ? `
        <div class="input-group input-group-sm">
          <input type="text" class="form-control" value="${isbn}" readonly>
          <button class="btn btn-outline-secondary copy-isbn-btn" type="button" title="Copier l'ISBN">
            <i class="bi bi-clipboard"></i>
          </button>
        </div>`
                    : "Aucun ISBN disponible";

                // Render the enhanced book view
                bookDetailContent.innerHTML = `
      <button class="btn btn-outline-secondary mb-4" onclick="backToLibraryList()">
        <i class="bi bi-arrow-left me-2"></i> Retour
      </button>

      <div class="row g-4">
        <div class="col-md-4 text-center">
          <img src="${cover}" alt="${title}" class="img-fluid rounded shadow-sm" style="max-height: 600px;">
        </div>
        <div class="col-md-8">
          <h3 class="fw-bold" style="color:var(--brand)">${title}</h3>
          <p class="text-muted">${description}</p>

          <div class="card mt-4">
            <div class="card-body">
              <h6 class="card-title text-uppercase text-muted mb-3">Détails du livre</h6>
              <ul class="list-unstyled">
                <li><strong>Auteur(s):</strong> ${authors}</li>
                <li><strong>Date de publication:</strong> ${publishDate}</li>
                <li><strong>Éditeur(s):</strong> ${publishers}</li>
                <li><strong>ISBN:</strong> ${isbnHTML}</li>
              </ul>
              <h6 class="text-uppercase text-muted mt-4">Sujets</h6>
              <div>${subjectsHTML}</div>
            </div>
          </div>

          ${readerHTML}
        </div>
      </div>
    `;

                // Handle "Voir plus" / "Voir moins" toggle for subjects
                const toggleBtn = document.getElementById("toggleSubjectsBtn");
                if (toggleBtn) {
                    toggleBtn.addEventListener("click", () => {
                        const hiddenSubjects = document.getElementById("hiddenSubjects");
                        const isHidden = hiddenSubjects.classList.contains("d-none");
                        hiddenSubjects.classList.toggle("d-none");
                        toggleBtn.textContent = isHidden ? "- Voir moins" : "+ Voir plus";
                    });
                }

                // Handle ISBN copy button
                const copyBtn = document.querySelector(".copy-isbn-btn");
                if (copyBtn) {
                    copyBtn.addEventListener("click", () => {
                        navigator.clipboard.writeText(isbn).then(() => {
                            copyBtn.innerHTML = '<i class="bi bi-check2"></i>';
                            setTimeout(() => {
                                copyBtn.innerHTML = '<i class="bi bi-clipboard"></i>';
                            }, 2000);
                        });
                    });
                }
            } catch (err) {
                bookDetailContent.innerHTML = `
      <div class="text-danger text-center py-5">
        <i class="bi bi-exclamation-circle fs-2"></i>
        <p class="mt-2">Erreur lors du chargement des détails : ${err.message}</p>
        <button class="btn btn-outline-secondary mt-3" onclick="backToLibraryList()">
          <i class="bi bi-arrow-left me-2"></i> Retour
        </button>
      </div>`;
            }
        };



        // === BACK TO LIST VIEW ===
        window.backToLibraryList = function () {
            bookDetailView.classList.add("d-none");
            libraryListView.classList.remove("d-none");
        };

        // === OPTIONAL: LOAD POPULAR BOOKS ON FIRST OPEN ===
        async function loadPopularBooks() {
            libraryGrid.innerHTML = `
    <div class="col-12 text-center text-muted py-5">
      <div class="spinner-border text-primary"></div>
      <p class="mt-2">Chargement des livres populaires...</p>
    </div>`;
            const res = await fetch("https://openlibrary.org/search.json?q=programming&page=1");
            const data = await res.json();
            libraryResultCount.textContent = data.numFound || 0;
            renderBooks(data.docs);
        }
        loadPopularBooks();


        // 4. Add the event listener for the "Clear History" button
        document.getElementById("clearHistoryBtn").addEventListener("click", () => {
            if (confirm("Êtes-vous sûr de vouloir effacer tout votre historique de lecture ?")) {
                videoHistory = [];
                localStorage.removeItem("videoHistory");
                renderVideoHistory();
                showToast("L'historique a été effacé.", "info");
            }
        });

        // 5. RENAME `playVideoFromQueue` to `playVideoFromHistory` and update it
        window.playVideoFromHistory = function (videoData, clickedElement) {
            const container = document.getElementById("videoContainer");
            container.innerHTML = `<iframe src="https://www.youtube.com/embed/${videoData.videoId}?autoplay=1" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;

            // Update the active state in the queue
            document
                .querySelectorAll(".history-item.active")
                .forEach((el) => el.classList.remove("active"));
            if (clickedElement) {
                clickedElement.classList.add("active");
                clickedElement.scrollIntoView({
                    behavior: "smooth",
                    block: "center",
                });
            }

            // Add to history again to move it to the top
            addVideoToHistory(videoData);
            document.getElementById("videoTitle").innerText = videoData.title;
        };

        function formatDate(timestamp) {
            if (!timestamp) return "date inconnue";
            return new Date(timestamp.seconds * 1000).toLocaleString("fr-FR", {
                dateStyle: "medium",
                timeStyle: "short",
            });
        }

        // Shows the main list of discussion threads
        async function showDiscussionsList() {
            document.getElementById("discussionsList").classList.remove("d-none");
            document.getElementById("discussionDetail").classList.add("d-none");
            currentDiscussionId = null;

            const threadsContainer = document.getElementById("threadsContainer");
            threadsContainer.innerHTML =
                '<div class="text-center p-5"><div class="loader"></div></div>';

            try {
                const q = query(
                    collection(db, "discussions"),
                    where("createdAt", "!=", null)
                );
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    threadsContainer.innerHTML =
                        '<div class="col-12 text-center text-muted py-5"><i class="bi bi-chat-square-quote fs-1"></i><p class="mt-2">Aucune discussion pour le moment. Soyez le premier à en démarrer une !</p></div>';
                    return;
                }

                threadsContainer.innerHTML = "";
                querySnapshot.forEach((doc) => {
                    const thread = doc.data();
                    const isAuthor =
                        auth.currentUser && thread.authorId === auth.currentUser.uid;

                    // --- ADMIN STYLE LOGIC ---
                    const isAdminPost =
                        thread.authorId === ADMIN_UID || thread.isByAdmin;
                    const adminIcon = isAdminPost ? ADMIN_VERIFIED_ICON : "";

                    const threadCard = document.createElement("div");
                    threadCard.className =
                        "card card-modern hover-lift" +
                        (isAdminPost ? " admin-thread-card" : "");
                    //threadCard.className = 'card card-modern hover-lift';
                    threadCard.style.cursor = "pointer";
                    threadCard.onclick = () => showDiscussionDetail(doc.id);

                    //Par ${escapeHtml(thread.authorName)} - ${formatDate(thread.createdAt)}
                    threadCard.innerHTML = `
                <div class="card-body d-flex align-items-center justify-content-between">
                    <div class="flex-grow-1">
                        <h5 class="card-title mb-1">${escapeHtml(
                        thread.title
                    )}</h5>
                        <small class="text-muted">
                            Par <strong>${escapeHtml(
                        thread.authorName
                    )}</strong> ${adminIcon}
                               - ${formatDate(thread.createdAt)}
                        </small>
                    </div>
                    <div class="text-center ms-3" style="min-width: 80px;">
                        <span class="fs-4 fw-bold">${thread.replyCount || 0
                        }</span><br>
                        <small class="text-muted">Réponses</small>
                    </div>
                    ${isAuthor
                            ? `
                    <div class="ms-3">
                    <button class="btn btn-sm btn-outline-primary edit-thread" data-id="${doc.id}">
                        <i class="bi bi-pencil"></i>
                    </button>
                    <button class="btn btn-sm btn-outline-danger delete-thread" data-id="${doc.id}">
                       <i class="bi bi-trash"></i>
                    </button>
                </div>`
                            : ""
                        }
             </div>
            `;
                    threadsContainer.appendChild(threadCard);
                });
            } catch (error) {
                threadsContainer.innerHTML =
                    '<div class="text-center text-danger p-5">Erreur de chargement des discussions.</div>';
                console.error("Error fetching discussions: ", error);
            }
        }

        // Shows a single thread and its replies
        async function showDiscussionDetail(threadId) {
            document.getElementById("discussionsList").classList.add("d-none");
            document.getElementById("discussionDetail").classList.remove("d-none");
            currentDiscussionId = threadId;

            try {
                // Fetch original post
                const threadRef = doc(db, "discussions", threadId);
                const threadSnap = await getDocs(
                    query(
                        collection(db, "discussions"),
                        where("__name__", "==", threadId)
                    )
                );
                if (!threadSnap.empty) {
                    const threadData = threadSnap.docs[0].data();
                    // --- ADMIN CHECK FOR ORIGINAL POST ---
                    const isAdminPost =
                        threadData.authorId === ADMIN_UID || threadData.isByAdmin;
                    const adminIcon = isAdminPost ? ADMIN_VERIFIED_ICON : "";
                    document.getElementById("threadTitle").textContent =
                        threadData.title;
                    document.getElementById("threadAuthor").textContent =
                        threadData.authorName;
                    document.getElementById("threadDate").textContent = formatDate(
                        threadData.createdAt
                    );
                    document.querySelector("#threadContent .ql-editor").innerHTML =
                        threadData.content;
                    // Apply admin card style to original post container
                    const originalPostCard = document.querySelector(
                        "#discussionDetail > .card"
                    );
                    originalPostCard.classList.toggle("admin-thread-card", isAdminPost);
                }

                // Fetch replies
                const repliesContainer = document.getElementById("repliesContainer");
                repliesContainer.innerHTML =
                    '<div class="text-center p-3"><div class="loader"></div></div>';
                const repliesQuery = query(
                    collection(db, "discussions", threadId, "replies")
                );
                const repliesSnapshot = await getDocs(repliesQuery);

                if (repliesSnapshot.empty) {
                    repliesContainer.innerHTML =
                        '<p class="text-muted">Aucune réponse pour le moment.</p>';
                } else {
                    repliesContainer.innerHTML = "";
                    repliesSnapshot.forEach((replyDoc) => {
                        const replyData = replyDoc.data();
                        const isAuthor =
                            auth.currentUser && replyData.authorId === auth.currentUser.uid;

                        // --- ADMIN CHECK FOR REPLY ---
                        const isAdminReply =
                            replyData.authorId === ADMIN_UID || replyData.isByAdmin;
                        const adminIcon = isAdminReply ? ADMIN_VERIFIED_ICON : "";

                        // --- AVATAR HANDLING ---
                        const avatarUrl = replyData.authorPhotoURL
                            ? escapeHtml(replyData.authorPhotoURL)
                            // CORRECTION: Utiliser ui-avatars pour un meilleur fallback
                            : `https://ui-avatars.com/api/?name=${encodeURIComponent(replyData.authorName || 'Utilisateur')}`;

                        const replyCard = document.createElement("div");
                        replyCard.className =
                            "card mb-2" + (isAdminReply ? " admin-reply-card" : "");

                        replyCard.innerHTML = `
                            <div class="card-body d-flex">
                                <!-- Avatar section -->
                                <div class="me-3 flex-shrink-0">
                                    <img src="${avatarUrl}" alt="${escapeHtml(replyData.authorName)}" class="reply-avatar ${isAdminReply ? "admin-avatar" : ""}">
                                </div>

                                <!-- Reply content -->
                                <div class="flex-grow-1">
                                    <div class="d-flex justify-content-between align-items-start">
                                        <p class="text-muted border-bottom pb-2 mb-2 flex-grow-1 mb-0">
                                            Par <strong>${escapeHtml(replyData.authorName)}</strong> 
                                            ${adminIcon} <small class="ms-1">le ${formatDate(replyData.createdAt)}</small>
                                        </p>
                                        ${isAuthor
                                ? `
                                            <div>
                                                <button class="btn btn-sm btn-outline-primary edit-reply" data-id="${replyDoc.id}">
                                                    <i class="bi bi-pencil"></i>
                                                </button>
                                                <button class="btn btn-sm btn-outline-danger delete-reply" data-id="${replyDoc.id}">
                                                    <i class="bi bi-trash"></i>
                                                </button>
                                            </div>
                                        `
                                : ""
                            }
                                    </div>

                                    <div class="ql-snow">
                                        <div class="ql-editor reply-content">${replyData.content}</div>
                                    </div>
                                </div>
                            </div>
                        `;

                        repliesContainer.appendChild(replyCard);
                    });

                }
            } catch (error) {
                console.error("Error fetching thread detail:", error);
            }
        }

        // 4. Add all these event listeners to your script

        document.addEventListener("DOMContentLoaded", () => {
            // Initialize Quill editor for creating new discussions
            document
                .getElementById("newDiscussionModal")
                .addEventListener("shown.bs.modal", () => {
                    if (!newDiscussionQuill) {
                        newDiscussionQuill = initializeQuill("#newDiscussionEditor");
                    }
                });

            // --- THE FIX IS HERE ---
            // Initialize Quill editor for EDITING replies
            document
                .getElementById("editReplyModal")
                .addEventListener("shown.bs.modal", () => {
                    if (!editReplyQuill) {
                        editReplyQuill = initializeQuill("#editReplyEditor");
                    }
                });
            // --- END OF FIX ---

            // Initialize the main reply editor on the discussion detail page
            if (document.getElementById("discussionDetail")) {
                replyQuill = initializeQuill("#replyEditor");
            }
            document
                .getElementById("backToLibraryList")
                ?.addEventListener("click", backToLibrary);
        });

        document
            .getElementById("editReplyForm")
            .addEventListener("submit", async (e) => {
                e.preventDefault();
                const replyId = document.getElementById("editReplyId").value;
                const newContent = editReplyQuill.root.innerHTML;
                if (!replyId || !currentDiscussionId) return;

                try {
                    await updateDoc(
                        doc(db, "discussions", currentDiscussionId, "replies", replyId),
                        { content: newContent }
                    );
                    showToast("Réponse mise à jour !", "success");
                    editReplyModal.hide();
                    showDiscussionDetail(currentDiscussionId);
                } catch (error) {
                    showToast("Erreur lors de la mise à jour.", "danger");
                }
            });

        document
            .getElementById("replyForm")
            .addEventListener("submit", async (e) => {
                e.preventDefault();
                const user = auth.currentUser;
                if (!user || !currentDiscussionId) return;
                const content = replyQuill.root.innerHTML;


                try {
                    await addDoc(
                        collection(db, "discussions", currentDiscussionId, "replies"),
                        {
                            content,
                            authorId: user.uid,
                            authorName: user.displayName || "Anonyme",
                            authorPhotoURL: user.photoURL || null,
                            isByAdmin: isAdmin, // <<< ADD THIS
                            createdAt: Timestamp.now(),
                        }
                    );

                    // Client-side counter update
                    const threadRef = doc(db, "discussions", currentDiscussionId);
                    const threadSnap = await getDocs(
                        query(
                            collection(db, "discussions"),
                            where("__name__", "==", currentDiscussionId)
                        )
                    );
                    let threadData;
                    if (!threadSnap.empty) {
                        threadData = threadSnap.docs[0].data();
                        const currentCount = threadData.replyCount || 0;
                        await updateDoc(threadRef, { replyCount: currentCount + 1 });
                    }

                    showToast("Réponse publiée !", "success");
                    replyQuill.setText("");
                    showDiscussionDetail(currentDiscussionId);

                    // Trigger notification event
                    if (threadData && threadData.authorId !== user.uid) {
                        await triggerNotificationEvent(threadData.authorId, {
                            message: `<strong>${user.displayName || "Anonyme"
                                }</strong> a répondu à : "${threadData.title}"`,
                            type: "new_reply",
                            link: `/discussions/${currentDiscussionId}`,
                        });
                    }
                } catch (error) {
                    showToast("Erreur : " + error.message, "danger");
                    console.error("Error submitting reply:", error);
                }
            });

        // ============================
        // EDIT & DELETE HANDLERS
        // ============================
        document.addEventListener("click", async (e) => {
            const target = e.target;
            const editReplyBtn = target.closest(".edit-reply");
            const deleteReplyBtn = target.closest(".delete-reply");
            const editThreadBtn = target.closest(".edit-thread");
            const deleteThreadBtn = target.closest(".delete-thread");

            if (editReplyBtn) {
                e.stopPropagation();
                const replyId = editReplyBtn.dataset.id;
                try {
                    const replyRef = doc(
                        db,
                        "discussions",
                        currentDiscussionId,
                        "replies",
                        replyId
                    );
                    const replySnap = await getDocs(
                        query(
                            collection(db, "discussions", currentDiscussionId, "replies"),
                            where("__name__", "==", replyId)
                        )
                    );

                    if (replySnap.empty)
                        return showToast("Réponse introuvable.", "danger");

                    const replyData = replySnap.docs[0].data();
                    document.getElementById("editReplyId").value = replyId;

                    // Initialize Quill editor if not already done
                    if (!editReplyQuill) {
                        editReplyQuill = initializeQuill("#editReplyEditor");
                    }

                    // Set content after a short delay to ensure Quill is ready
                    setTimeout(() => {
                        editReplyQuill.root.innerHTML = replyData.content;
                    }, 100);

                    editReplyModal.show();
                } catch (error) {
                    console.error("Error opening reply editor:", error);
                    showToast("Erreur lors de l'ouverture de l'éditeur.", "danger");
                }
            } else if (deleteReplyBtn) {
                e.stopPropagation();
                const replyId = deleteReplyBtn.dataset.id;
                if (confirm("Supprimer cette réponse ?")) {
                    try {
                        await deleteDoc(
                            doc(db, "discussions", currentDiscussionId, "replies", replyId)
                        );

                        // Update reply count
                        const threadRef = doc(db, "discussions", currentDiscussionId);
                        const threadSnap = await getDocs(
                            query(
                                collection(db, "discussions"),
                                where("__name__", "==", currentDiscussionId)
                            )
                        );

                        if (!threadSnap.empty) {
                            const currentCount = threadSnap.docs[0].data().replyCount || 0;
                            await updateDoc(threadRef, {
                                replyCount: Math.max(0, currentCount - 1),
                            });
                        }

                        showToast("Réponse supprimée.", "success");
                        showDiscussionDetail(currentDiscussionId);
                    } catch (error) {
                        console.error("Error deleting reply:", error);
                        showToast("Erreur lors de la suppression.", "danger");
                    }
                }
            } else if (editThreadBtn) {
                e.stopPropagation();
                const threadId = editThreadBtn.dataset.id;
                try {
                    const threadSnap = await getDocs(
                        query(
                            collection(db, "discussions"),
                            where("__name__", "==", threadId)
                        )
                    );

                    if (threadSnap.empty)
                        return showToast("Discussion introuvable.", "danger");

                    const threadData = threadSnap.docs[0].data();
                    const form = document.getElementById("newDiscussionForm");
                    let idInput = form.querySelector('input[name="threadId"]');
                    if (!idInput) {
                        idInput = document.createElement("input");
                        idInput.type = "hidden";
                        idInput.name = "threadId";
                        form.appendChild(idInput);
                    }
                    idInput.value = threadId;
                    document.getElementById("newDiscussionModalLabel").innerText =
                        "Modifier la discussion";
                    document.getElementById("newDiscussionTitle").value =
                        threadData.title;

                    // Initialize Quill editor if not already done
                    if (!newDiscussionQuill) {
                        newDiscussionQuill = initializeQuill("#newDiscussionEditor");
                    }

                    // Set content after a short delay
                    setTimeout(() => {
                        newDiscussionQuill.root.innerHTML = threadData.content;
                    }, 100);

                    newDiscussionModal.show();
                } catch (error) {
                    console.error("Error opening thread editor:", error);
                    showToast("Erreur lors de l'ouverture de l'éditeur.", "danger");
                }
            } else if (deleteThreadBtn) {
                e.stopPropagation();
                const threadId = deleteThreadBtn.dataset.id;
                if (confirm("Supprimer cette discussion et ses réponses ?")) {
                    try {
                        await deleteDoc(doc(db, "discussions", threadId));
                        showToast("Discussion supprimée.", "success");
                        showDiscussionsList();
                    } catch (error) {
                        console.error("Error deleting thread:", error);
                        showToast("Erreur de suppression.", "danger");
                    }
                }
            }
        });

        document
            .getElementById("editReplyForm")
            .addEventListener("submit", async (e) => {
                e.preventDefault();
                const replyId = document.getElementById("editReplyId").value;
                const newContent = editReplyQuill.root.innerHTML;

                if (!replyId || !currentDiscussionId || !newContent) return;

                try {
                    const replyRef = doc(
                        db,
                        "discussions",
                        currentDiscussionId,
                        "replies",
                        replyId
                    );
                    await updateDoc(replyRef, {
                        content: newContent,
                    });

                    showToast("Réponse mise à jour !", "success");
                    editReplyModal.hide();
                    showDiscussionDetail(currentDiscussionId); // Refresh the view to show changes
                } catch (error) {
                    console.error("Error updating reply:", error);
                    showToast("Erreur lors de la mise à jour.", "danger");
                }
            });

        document
            .getElementById("newDiscussionForm")
            .addEventListener("submit", async (e) => {
                e.preventDefault();
                const user = auth.currentUser;
                if (!user) {
                    showToast("Veuillez vous connecter.", "warning");
                    return;
                }

                const threadId = document.querySelector(
                    'input[name="threadId"]'
                )?.value;
                const title = document
                    .getElementById("newDiscussionTitle")
                    .value.trim();
                const content = newDiscussionQuill.root.innerHTML.trim();

                if (!title || content === "<p><br></p>" || !content) {
                    showToast("Veuillez remplir tous les champs.", "warning");
                    return;
                }

                try {
                    if (threadId) {
                        // Update existing thread
                        const threadRef = doc(db, "discussions", threadId);
                        await updateDoc(threadRef, {
                            title: title,
                            content: content,
                            updatedAt: Timestamp.now(),
                        });
                        showToast("✅ Discussion mise à jour !", "success");
                    } else {
                        // Create new thread - ADD authorEmail
                        await addDoc(collection(db, "discussions"), {
                            title: title,
                            content: content,
                            authorId: user.uid,
                            authorName: user.displayName || "Anonyme",
                            isByAdmin: isAdmin,
                            authorEmail: user.email, // ADD THIS LINE
                            createdAt: Timestamp.now(),
                            replyCount: 0,
                        });
                        showToast("✅ Discussion créée !", "success");
                    }

                    // Close modal and reset form
                    newDiscussionModal.hide();
                    document.getElementById("newDiscussionForm").reset();
                    document.getElementById("newDiscussionModalLabel").innerText =
                        "Démarrer une nouvelle discussion";
                    if (newDiscussionQuill) newDiscussionQuill.setText("");

                    // Remove the hidden threadId input if it exists
                    const idInput = document.querySelector('input[name="threadId"]');
                    if (idInput) idInput.remove();

                    // Refresh the discussions list
                    showDiscussionsList();
                } catch (error) {
                    console.error("Error saving discussion:", error);
                    showToast("❌ Erreur : " + error.message, "danger");
                }
            });

        document
            .getElementById("backToDiscussions")
            .addEventListener("click", showDiscussionsList);

        function renderVideos() {
            const grid = document.getElementById("videosGrid");
            const videos = allFiles.filter((f) => f.mimeType?.startsWith("video/"));

            grid.innerHTML = "";
            if (!videos.length) {
                grid.innerHTML =
                    '<div class="col-12 text-center text-muted py-5"><i class="bi bi-camera-video fs-1"></i><p class="mt-2">Aucune vidéo trouvée</p></div>';
                return;
            }

            videos.forEach((file) => {
                const progress = userProgress[file.id] || 0;
                const col = document.createElement("div");
                col.className = "col-lg-6 col-xl-4";
                col.innerHTML = `
        <div class="card card-modern h-100 fade-in">
          <div class="position-relative">
            <img src="${file.thumbnailLink ||
                    "https://via.placeholder.com/400x225/dc3545/ffffff?text=Vidéo"
                    }" class="course-thumbnail w-100" alt="${escapeHtml(file.name)}">
            <div class="position-absolute top-50 start-50 translate-middle">
              <button class="btn btn-danger btn-lg rounded-circle" style="width:64px; height:64px" onclick="playVideo('${file.id
                    }', '${escapeHtml(file.name)}', '${file.webViewLink || ""}')">
                <i class="bi bi-play-fill fs-3"></i>
              </button>
            </div>
            ${progress > 0
                        ? `<div class="progress-ring">${progress}%</div>`
                        : ""
                    }
          </div>
          <div class="card-body">
            <h6>${escapeHtml(file.name)}</h6>
            ${progress > 0
                        ? `
              <div class="progress mt-2" style="height:6px">
                <div class="progress-bar bg-danger" style="width:${progress}%"></div>
              </div>`
                        : ""
                    }
            <div class="d-flex gap-2 mt-3">
              <button class="btn btn-sm btn-outline-primary flex-grow-1" onclick="playVideo('${file.id
                    }', '${escapeHtml(file.name)}', '${file.webViewLink || ""}')">
                <i class="bi bi-play me-1"></i>Regarder
              </button>
              <button class="btn btn-sm btn-outline-secondary" onclick="saveForLater('${file.id
                    }')">
                <i class="bi bi-bookmark"></i>
              </button>
            </div>
          </div>
        </div>
      `;
                grid.appendChild(col);
            });
        }

        /*
  
          async function fetchYoutubeTutorials() {
              const grid = document.getElementById('youtubeVideosGrid');
              grid.innerHTML = '<div class="col-12 text-center"><div class="loader"></div></div>';
  
              try {
                  const queries = allFiles.filter(f => f.mimeType === 'application/vnd.google-apps.folder').map(f => f.name + ' tutorial');
                  const results = [];
                  for (const q of queries) {
                      const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(q)}&type=video,playlist&maxResults=5&key=${YOUTUBE_API_KEY}`;
                      const res = await fetch(url);
                      const json = await res.json();
                      results.push(...(json.items || []));
                  }
                  renderYoutubeResults(results);
              } catch (err) {
                  grid.innerHTML = '<div class="col-12 text-center text-muted">Erreur de chargement des tutoriels YouTube</div>';
              }
          }
          */

        async function fetchYoutubeTutorials() {
            const grid = document.getElementById("youtubeVideosGrid");
            if (!grid) return;

            // --- CACHING LOGIC (for YouTube results) ---
            const cachedResults = sessionStorage.getItem("youtubeRecommendations");
            const cacheTimestamp = sessionStorage.getItem("youtubeRecsTimestamp");

            if (
                cachedResults &&
                cacheTimestamp &&
                new Date() - new Date(cacheTimestamp) < 3600000
            ) {
                // 1 hour
                console.log("Loading YouTube recommendations from cache.");
                renderYoutubeResults(JSON.parse(cachedResults));
                return;
            }

            grid.innerHTML =
                '<div class="col-12 text-center"><div class="loader"></div><p class="text-muted mt-2">Recherche de tutoriels...</p></div>';

            try {
                // --- THE FIX: Call the new self-sufficient function ---
                const queries = await getYoutubeSearchQueries();

                if (queries.length === 0) {
                    grid.innerHTML =
                        '<div class="col-12 text-center text-muted py-3"><i class="bi bi-search-heart fs-2"></i><p class="mt-2">Aucun cours trouvé pour générer des recommandations.</p></div>';
                    return;
                }

                const fetchPromises = queries.map((q) => {
                    const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(
                        q
                    )}&type=video,playlist&maxResults=3&key=${YOUTUBE_API_KEY}`;
                    return fetch(url).then((res) => res.json());
                });

                const results = await Promise.all(fetchPromises);

                const allItems = [];
                results.forEach((json) => {
                    if (json.error) {
                        throw new Error(`Erreur API YouTube: ${json.error.message}`);
                    }
                    if (json.items) {
                        allItems.push(...json.items);
                    }
                });

                // Save the final results to cache
                sessionStorage.setItem(
                    "youtubeRecommendations",
                    JSON.stringify(allItems)
                );
                sessionStorage.setItem(
                    "youtubeRecsTimestamp",
                    new Date().toISOString()
                );

                renderYoutubeResults(allItems);
            } catch (err) {
                console.error("Erreur de chargement des tutoriels YouTube:", err);
                grid.innerHTML = `<div class="col-12 text-center text-danger py-3"><i class="bi bi-exclamation-triangle fs-2"></i><p class="mt-2">Impossible de charger les recommandations.<br><small>${err.message}</small></p></div>`;
            }
        }
        // Add this NEW helper function somewhere in your script
        async function getYoutubeSearchQueries() {
            // Use a simple cache to avoid calling the Drive API every time
            const cachedFolders = sessionStorage.getItem("courseFoldersForYT");
            if (cachedFolders) {
                return JSON.parse(cachedFolders);
            }

            try {
                // This is a targeted, lightweight API call just to get folder names
                const url = `https://www.googleapis.com/drive/v3/files?q='${DRIVE_FOLDER_ID}'+in+parents+and+mimeType='application/vnd.google-apps.folder'&fields=files(name)&key=${DRIVE_API_KEY}`;
                const res = await fetch(url);
                const json = await res.json();

                if (json.error) throw new Error(json.error.message);

                const queries = json.files.map((f) => f.name + " tutorial");

                // Save the generated queries to cache for next time
                sessionStorage.setItem("courseFoldersForYT", JSON.stringify(queries));
                return queries;
            } catch (err) {
                console.error(
                    "Could not fetch course folders for YouTube search:",
                    err
                );
                return []; // Return an empty array on failure
            }
        }

        function renderYoutubeResults(items) {
            const grid = document.getElementById("youtubeVideosGrid");
            grid.innerHTML = "";
            items.forEach((item) => {
                const isPlaylist = item.id.kind === "youtube#playlist";
                const id = isPlaylist ? item.id.playlistId : item.id.videoId;
                const type = isPlaylist ? "playlist" : "video";
                const thumb =
                    item.snippet.thumbnails?.medium?.url ||
                    "https://via.placeholder.com/320x180";
                const col = document.createElement("div");
                col.className = "col-md-4";
                col.innerHTML = `
        <div class="card card-modern h-100 fade-in">
          <div class="position-relative">
            <img src="${thumb}" class="card-img-top" alt="${escapeHtml(
                    item.snippet.title
                )}">
            <div class="position-absolute top-50 start-50 translate-middle">
              <button class="btn btn-danger rounded-circle" onclick="playYoutube('${type}', '${id}', '${escapeHtml(
                    item.snippet.title
                )}')">
                <i class="bi bi-play-fill fs-4"></i>
              </button>
            </div>
          </div>
          <div class="card-body">
            <h6 class="card-title">${escapeHtml(item.snippet.title)}</h6>
            <small class="text-muted">${item.snippet.channelTitle}</small>
          </div>
        </div>
      `;
                grid.appendChild(col);
            });
        }

        function renderContributedVideos() {
            const grid = document.getElementById("contributedVideosGrid");
            grid.innerHTML = "";
            contributedContent.forEach((content) => {
                const col = document.createElement("div");
                col.className = "col-md-4";
                col.innerHTML = `
        <div class="card card-modern h-100 fade-in">
          <div class="position-relative">
            <img src="https://img.youtube.com/vi/${content.type === "playlist" ? "" : content.id
                    }/mqdefault.jpg" class="card-img-top" alt="${escapeHtml(
                        content.title
                    )}">
            <div class="position-absolute top-50 start-50 translate-middle">
              <button class="btn btn-danger rounded-circle" onclick="playYoutube('${content.type
                    }', '${content.id}', '${escapeHtml(content.title)}')">
                <i class="bi bi-play-fill fs-4"></i>
              </button>
            </div>
          </div>
          <div class="card-body">
            <h6 class="card-title">${escapeHtml(
                        content.title || "Sans titre"
                    )}</h6>
            <small class="text-muted">${content.type.charAt(0).toUpperCase() + content.type.slice(1)
                    } - Par ${escapeHtml(content.userName)}</small>
          </div>
        </div>
      `;
                grid.appendChild(col);
            });
        }

        /*
  
          function renderContributed() {
              const grid = document.getElementById('contributedGrid');
              grid.innerHTML = '';
  
              if (contributedContent.length === 0) {
                  grid.innerHTML = '<div class="col-12 text-center text-muted py-5"><i class="bi bi-cloud-slash fs-1"></i><p class="mt-2">Aucun contenu contribué pour le moment.</p></div>';
                  return;
              }
  
              contributedContent.forEach(content => {
                  const col = document.createElement('div');
                  col.className = 'col-lg-4 col-md-6';
                  let cardHTML = '';
  
                  // --- STYLING OVERHAUL ---
                  switch (content.type) {
                      case 'youtube':
                          cardHTML = `
                      <div class="video-card h-100 fade-in" style="cursor: pointer;" onclick='viewContributedContent(${JSON.stringify(content)})'>
                          <div class="video-thumb">
                              <img src="https://img.youtube.com/vi/${content.youtubeId}/mqdefault.jpg" class="video-thumb-img" alt="${escapeHtml(content.title)}">
                              <div class="video-overlay"><i class="bi bi-play-fill play-icon"></i></div>
                          </div>
                          <div class="video-body d-flex flex-column">
                              <h6 class="video-title"><i class="bi bi-youtube text-danger me-2"></i>${escapeHtml(content.title || 'Vidéo YouTube')}</h6>
                              <p class="video-author mt-auto"><i class="bi bi-person-circle me-1"></i>${escapeHtml(content.userName)}</p>
                          </div>
                      </div>`;
                          break;
  
                      case 'gdrive_video':
                      case 'gdrive_doc':
                          const isVideo = content.type === 'gdrive_video';
                          const iconClass = isVideo ? 'bi-camera-video-fill text-primary' : 'bi-file-earmark-pdf-fill text-danger';
                          const iconBg = isVideo ? 'linear-gradient(135deg, var(--info) 20%, var(--brand) 100%)' : 'linear-gradient(135deg, var(--danger) 20%, #841212 100%)';
  
                          cardHTML = `
                      <div class="card card-modern h-100 fade-in hover-lift" style="cursor: pointer;" onclick='viewContributedContent(${JSON.stringify(content)})'>
                          <div class="card-body d-flex flex-column">
                               <div class="flex-grow-1 rounded d-flex align-items-center justify-content-center" style="background: ${iconBg};">
                                  <i class="bi ${iconClass}" style="font-size: 4rem; color: #fff; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2));"></i>
                              </div>
                              <h6 class="card-title mt-3"><i class="bi bi-google me-2"></i>${escapeHtml(content.title || 'Document Drive')}</h6>
                              <p class="video-author mt-auto text-muted"><i class="bi bi-person-circle me-1"></i>${escapeHtml(content.userName)}</p>
                          </div>
                      </div>`;
                          break;
  
                      case 'link':
                          cardHTML = `
                       <div class="card card-modern h-100 fade-in hover-lift" style="cursor: pointer;" onclick='viewContributedContent(${JSON.stringify(content)})'>
                          <div class="card-body d-flex flex-column">
                               <div class="flex-grow-1 rounded d-flex align-items-center justify-content-center" style="background: linear-gradient(135deg, var(--muted) 20%, var(--text) 100%);">
                                  <i class="bi bi-link-45deg" style="font-size: 5rem; color: #fff; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2));"></i>
                              </div>
                              <h6 class="card-title mt-3"><i class="bi bi-globe me-2"></i>${escapeHtml(content.title || 'Lien Web')}</h6>
                              <p class="video-author mt-auto text-muted"><i class="bi bi-person-circle me-1"></i>${escapeHtml(content.userName)}</p>
                          </div>
                      </div>`;
                          break;
                  }
                  col.innerHTML = cardHTML;
                  grid.appendChild(col);
              });
          }*/

        function renderContributed() {
            const grid = document.getElementById("contributedGrid");
            grid.innerHTML = "";

            if (contributedContent.length === 0) {
                grid.innerHTML =
                    '<div class="col-12 text-center text-muted py-5"><i class="bi bi-cloud-slash fs-1"></i><p class="mt-2">Aucun contenu contribué pour le moment.</p></div>';
                return;
            }

            contributedContent.forEach((content) => {
                const col = document.createElement("div");
                col.className = "col-lg-4 col-md-6";
                let cardHTML = "";
                let iconClass = "";
                let iconBg = "";

                switch (content.type) {
                    case "youtube":
                        iconClass = "bi-youtube text-danger";
                        iconBg = "linear-gradient(135deg, var(--danger), #841212)";
                        const thumbYt = `https://img.youtube.com/vi/${content.id || content.youtubeId
                            }/mqdefault.jpg`;

                        cardHTML = `
                    <div class="video-card h-100 fade-in" style="cursor: pointer;" onclick='viewContributedContent(${JSON.stringify(
                            content
                        )})'>
                        <div class="video-thumb">
                            <img src="${thumbYt}" class="video-thumb-img" alt="${escapeHtml(
                            content.title
                        )}">
                            <div class="video-overlay"><i class="bi bi-play-fill play-icon"></i></div>
                        </div>
                        <div class="video-body d-flex flex-column">
                            <h6 class="video-title"><i class="bi bi-youtube text-danger me-2"></i>${escapeHtml(
                            content.title || "Vidéo YouTube"
                        )}</h6>
                            <p class="video-author mt-auto"><i class="bi bi-person-circle me-1"></i>${escapeHtml(
                            content.userName
                        )}</p>
                        </div>
                    </div>`;
                        break;

                    case "gdrive_video":
                        iconClass = "bi-camera-video-fill text-info";
                        iconBg = "linear-gradient(135deg, var(--info), var(--brand))";
                        cardHTML = `
                    <div class="card card-modern h-100 fade-in hover-lift contributed-doc" style="cursor: pointer;" onclick='viewContributedContent(${JSON.stringify(
                            content
                        )})'>
                        <div class="card-body d-flex flex-column">
                             <div class="flex-grow-1 rounded d-flex align-items-center justify-content-center" style="background: ${iconBg}; min-height: 120px;">
                                <i class="bi ${iconClass}" style="font-size: 4rem; color: #fff; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2));"></i>
                            </div>
                            <h6 class="card-title mt-3 mb-1"><i class="bi bi-google me-2"></i>${escapeHtml(
                            content.title || "Vidéo Google Drive"
                        )}</h6>
                            <small class="text-muted">Type: Vidéo Drive</small>
                            <p class="video-author mt-auto text-muted"><i class="bi bi-person-circle me-1"></i>${escapeHtml(
                            content.userName
                        )}</p>
                        </div>
                    </div>`;
                        break;

                    case "gdrive_doc":
                        iconClass = "bi-file-earmark-pdf-fill text-danger";
                        iconBg = "linear-gradient(135deg, var(--danger), #841212)";
                        cardHTML = `
                    <div class="card card-modern h-100 fade-in hover-lift contributed-doc" style="cursor: pointer;" onclick='viewContributedContent(${JSON.stringify(
                            content
                        )})'>
                        <div class="card-body d-flex flex-column">
                             <div class="flex-grow-1 rounded d-flex align-items-center justify-content-center" style="background: ${iconBg}; min-height: 120px;">
                                <i class="bi ${iconClass}" style="font-size: 4rem; color: #fff; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2));"></i>
                            </div>
                            <h6 class="card-title mt-3 mb-1"><i class="bi bi-file-earmark-text me-2"></i>${escapeHtml(
                            content.title || "Document Google Drive"
                        )}</h6>
                             <small class="text-muted">Type: Document PDF/Slide</small>
                            <p class="video-author mt-auto text-muted"><i class="bi bi-person-circle me-1"></i>${escapeHtml(
                            content.userName
                        )}</p>
                        </div>
                    </div>`;
                        break;

                    case "link":
                        iconClass = "bi-link-45deg";
                        iconBg = "linear-gradient(135deg, var(--muted), var(--text))";
                        cardHTML = `
                     <div class="card card-modern h-100 fade-in hover-lift contributed-link" style="cursor: pointer;" onclick='viewContributedContent(${JSON.stringify(
                            content
                        )})'>
                        <div class="card-body d-flex flex-column">
                             <div class="flex-grow-1 rounded d-flex align-items-center justify-content-center" style="background: ${iconBg}; min-height: 120px;">
                                <i class="bi ${iconClass}" style="font-size: 5rem; color: #fff; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2));"></i>
                            </div>
                            <h6 class="card-title mt-3 mb-1"><i class="bi bi-globe me-2"></i>${escapeHtml(
                            content.title || content.url
                        )}</h6>
                            <small class="text-muted">Type: Lien Web</small>
                            <p class="video-author mt-auto text-muted"><i class="bi bi-person-circle me-1"></i>${escapeHtml(
                            content.userName
                        )}</p>
                        </div>
                    </div>`;
                        break;
                }
                col.innerHTML = cardHTML;
                grid.appendChild(col);
            });
        }

        window.viewContributedContent = function (content) {
            const safeContent = JSON.parse(JSON.stringify(content));

            switch (safeContent.type) {
                case "youtube":
                    playYoutube(
                        safeContent.youtubeType,
                        safeContent.youtubeId,
                        safeContent.title
                    );
                    break;

                // --- THE FIX: NEW CASE FOR GDRIVE VIDEOS ---
                case "gdrive_video":
                    // Open in the VIDEO modal
                    document.getElementById("videoTitle").innerText =
                        safeContent.title || "Vidéo";
                    const videoContainer = document.getElementById("videoContainer");
                    videoContainer.innerHTML = `<iframe src="https://drive.google.com/file/d/${safeContent.gdriveId}/preview" frameborder="0" allow="autoplay" allowfullscreen></iframe>`;

                    // Hide the history panel for non-YouTube videos
                    playlistPanel.classList.add("d-none");
                    playlistPanel.classList.remove("d-flex");

                    videoModal.show();
                    break;

                case "gdrive_doc":
                    // Open in the DOCUMENT modal
                    document.getElementById("documentTitle").innerText =
                        safeContent.title || "Document";
                    const docContainer = document.getElementById("documentContainer");
                    docContainer.innerHTML = `<iframe src="https://drive.google.com/file/d/${safeContent.gdriveId}/preview" frameborder="0"></iframe>`;
                    documentModal.show();
                    break;

                case "link":
                    if (
                        confirm(
                            `Vous allez être redirigé vers un lien externe:\n\n${safeContent.url}\n\nVoulez-vous continuer ?`
                        )
                    ) {
                        window.open(safeContent.url, "_blank", "noopener,noreferrer");
                    }
                    break;
            }
        };
        /*function renderDocuments() {
              const grid = document.getElementById('documentsGrid');
              const docs = allFiles.filter(f => {
                  const mime = f.mimeType || '';
                  return mime.includes('pdf') || mime.includes('document') || mime.includes('spreadsheet') || mime.includes('presentation');
              });
  
              grid.innerHTML = '';
              if (!docs.length) {
                  grid.innerHTML = '<div class="col-12 text-center text-muted py-5"><i class="bi bi-file-earmark fs-1"></i><p class="mt-2">Aucun document trouvé</p></div>';
                  return;
              }
  
              docs.forEach(file => {
                  const meta = getFileMeta(file.mimeType);
                  const col = document.createElement('div');
                  col.className = 'col-lg-4 col-md-6';
                  col.innerHTML = `
          <div class="card card-modern h-100 fade-in">
            <div class="card-body">
              <div class="d-flex gap-3 mb-3">
                <div style="font-size:48px; color:${meta.color}">
                  <i class="${meta.icon}"></i>
                </div>
                <div class="flex-grow-1">
                  <h6 class="mb-1">${escapeHtml(file.name)}</h6>
                  <small class="text-muted">${meta.label}</small>
                  ${file.modifiedTime ? `<div><small class="text-muted">Modifié : ${new Date(file.modifiedTime).toLocaleDateString('fr-FR')}</small></div>` : ''}
                </div>
              </div>
              <div class="d-grid gap-2">
                <button class="btn btn-sm btn-primary" onclick="viewDocument('${file.id}', '${escapeHtml(file.name)}', '${file.webViewLink || ''}', '${meta.kind}')">
                  <i class="bi bi-eye me-1"></i>Voir
                </button>
                ${file.webContentLink ?
                          `<a class="btn btn-sm btn-outline-secondary" href="${file.webContentLink}" target="_blank">
                    <i class="bi bi-download me-1"></i>Télécharger
                  </a>` : ''}
              </div>
            </div>
          </div>
        `;
                  grid.appendChild(col);
              });
          }*/

        function renderDocuments() {
            const grid = document.getElementById("documentsGrid");
            const docs = allFiles.filter((f) => {
                const mime = f.mimeType || "";
                return (
                    mime.includes("pdf") ||
                    mime.includes("document") ||
                    mime.includes("spreadsheet") ||
                    mime.includes("presentation")
                );
            });

            grid.innerHTML = "";
            if (!docs.length) {
                grid.innerHTML =
                    '<div class="col-12 text-center text-muted py-5"><i class="bi bi-file-earmark-x fs-1"></i><p class="mt-2">Aucun document trouvé</p></div>';
                return;
            }

            // Adjust grid classes based on view mode
            grid.className = documentViewMode === "grid" ? "row g-4" : "row g-2";

            docs.forEach((file) => {
                const meta = getFileMeta(file.mimeType);
                const col = document.createElement("div");

                if (documentViewMode === "grid") {
                    // --- GRID VIEW RENDER ---
                    col.className = "col-lg-4 col-md-6";
                    col.innerHTML = `
                <div class="card card-modern h-100 fade-in">
                    <div class="card-body d-flex flex-column">
                        <div class="d-flex gap-3 mb-3">
                            <div style="font-size:48px; color:${meta.color}">
                                <i class="${meta.icon}"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-1">${escapeHtml(file.name)}</h6>
                                <small class="text-muted">${meta.label}</small>
                                ${file.modifiedTime
                            ? `<div><small class="text-muted">Modifié : ${new Date(
                                file.modifiedTime
                            ).toLocaleDateString(
                                "fr-FR"
                            )}</small></div>`
                            : ""
                        }
                            </div>
                            <button class="btn btn-sm btn-link text-warning p-0" onclick="toggleFavorite('${file.id
                        }', event)" title="Ajouter aux favoris">
                                <i class="bi ${favoriteDocuments.includes(file.id)
                            ? "bi-star-fill"
                            : "bi-star"
                        }"></i>
                            </button>
                        </div>
                        <div class="mt-auto d-grid gap-2">
                            <button class="btn btn-sm btn-primary" onclick="viewDocument('${file.id
                        }', '${escapeHtml(file.name)}', '${file.webViewLink || ""
                        }', '${meta.kind}')">
                                <i class="bi bi-eye me-1"></i>Voir
                            </button>
                            ${file.webContentLink
                            ? `<a class="btn btn-sm btn-outline-secondary" href="${file.webContentLink}" target="_blank"><i class="bi bi-download me-1"></i>Télécharger</a>`
                            : ""
                        }
                        </div>
                    </div>
                </div>
            `;
                } else {
                    // --- LIST VIEW RENDER ---
                    col.className = "col-12";
                    col.innerHTML = `
                <div class="card card-modern fade-in">
                    <div class="card-body p-2 d-flex align-items-center gap-3">
                        <div style="font-size:32px; color:${meta.color
                        }; min-width: 40px; text-align: center;">
                            <i class="${meta.icon}"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="mb-0 small">${escapeHtml(file.name)}</h6>
                            <small class="text-muted">${meta.label
                        } - Modifié le ${new Date(
                            file.modifiedTime
                        ).toLocaleDateString("fr-FR")}</small>
                        </div>
                        <div class="ms-auto">
                            <button class="btn btn-sm btn-outline-warning" onclick="toggleFavorite('${file.id
                        }', event)" title="Ajouter aux favoris">
                                <i class="bi ${favoriteDocuments.includes(file.id)
                            ? "bi-star-fill"
                            : "bi-star"
                        }"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewDocument('${file.id
                        }', '${escapeHtml(file.name)}', '${file.webViewLink || ""
                        }', '${meta.kind}')" title="Voir">
                                <i class="bi bi-eye"></i>
                            </button>
                             ${file.webContentLink
                            ? `<a class="btn btn-sm btn-outline-secondary" href="${file.webContentLink}" target="_blank" title="Télécharger"><i class="bi bi-download"></i></a>`
                            : ""
                        }
                        </div>
                    </div>
                </div>
            `;
                }
                grid.appendChild(col);
            });
        }

        // 1. Add these variables at the top
        let favoriteDocuments =
            JSON.parse(localStorage.getItem("favoriteDocuments")) || [];

        // 2. Add this new function to handle toggling favorites
        window.toggleFavorite = function (fileId, event) {
            event.stopPropagation(); // Prevents the card from being clicked
            const starIcon = event.currentTarget.querySelector("i");

            const index = favoriteDocuments.indexOf(fileId);
            if (index > -1) {
                favoriteDocuments.splice(index, 1); // Remove from favorites
                starIcon.classList.remove("bi-star-fill");
                starIcon.classList.add("bi-star");
            } else {
                favoriteDocuments.push(fileId); // Add to favorites
                starIcon.classList.add("bi-star-fill");
                starIcon.classList.remove("bi-star");
            }

            localStorage.setItem(
                "favoriteDocuments",
                JSON.stringify(favoriteDocuments)
            );
            showToast("Favoris mis à jour !", "info");
        };

        function renderAssignments() {
            const grid = document.getElementById("assignmentsGrid");
            grid.innerHTML =
                '<div class="col-12 text-center text-muted py-5"><i class="bi bi-tools fs-1"></i><p class="mt-2">Cette fonctionnalité est en cours de développement.</p></div>';
        }

        /*   const eventModal = new bootstrap.Modal(document.getElementById('eventModal'));
          let calendar; // Will hold the FullCalendar instance
          let alarmIntervalId = null; // To manage the alarm checking interval
  
          // --- ALARM SOUNDS & HELPERS ---
          const alarmSounds = {
              chime: new Audio('https://cdn.freesound.org/previews/510/510323_10899534-lq.mp3'),
              notification: new Audio('https://cdn.freesound.org/previews/415/415763_6142149-lq.mp3'),
              digital: new Audio('https://cdn.freesound.org/previews/142/142641_228222-lq.mp3')
          };
  
          function formatDateTimeLocal(date) {
              if (!date) return '';
              const ten = (i) => (i < 10 ? '0' : '') + i;
              const YYYY = date.getFullYear();
              const MM = ten(date.getMonth() + 1);
              const DD = ten(date.getDate());
              const HH = ten(date.getHours());
              const II = ten(date.getMinutes());
              return `${YYYY}-${MM}-${DD}T${HH}:${II}`;
          }
  
          // --- CORE CALENDAR RENDERING FUNCTION ---
          async function renderCalendar() {
              const calendarEl = document.getElementById('calendar');
              if (!calendarEl) return;
              if (calendar) calendar.destroy();
  
              const user = auth.currentUser;
              if (!user) {
                  calendarEl.innerHTML = '<div class="text-center text-muted p-5"><i class="bi bi-lock fs-1"></i><p>Connectez-vous pour voir le calendrier.</p></div>';
                  return;
              }
  
              calendar = new FullCalendar.Calendar(calendarEl, {
                  themeSystem: 'bootstrap5',
                  locale: 'fr',
                  headerToolbar: {
                      left: 'prev,next today',
                      center: 'title',
                      right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
                  },
                  initialView: 'timeGridWeek',
                  editable: true,
                  selectable: true,
                  slotMinTime: '06:00:00',
                  slotMaxTime: '23:00:00',
                  slotDuration: '00:30:00',
                  height: 'auto',
                  nowIndicator: true,
                  displayEventTime: true,
                  displayEventEnd: true,
                  eventDisplay: 'block',
  
                  events: async (fetchInfo, successCallback, failureCallback) => {
                      try {
                          const eventsCol = collection(db, 'users', user.uid, 'events');
                          const eventSnapshot = await getDocs(eventsCol);
                          const events = eventSnapshot.docs.map(doc => {
                              const data = doc.data();
                              const startDate = data.start.toDate();
                              let endDate = data.end ? data.end.toDate() : new Date(startDate.getTime() + 3600000);
                              
                              return {
                                  id: doc.id,
                                  title: data.title,
                                  start: startDate,
                                  end: endDate,
                                  allDay: data.allDay || false,
                                  backgroundColor: data.color || '#0b3b61',
                                  borderColor: data.color || '#0b3b61',
                                  textColor: '#ffffff',
                                  extendedProps: { 
                                      alarm: data.alarm || 'none',
                                      sound: data.sound || 'chime',
                                      color: data.color || '#0b3b61'
                                  }
                              };
                          });
                          successCallback(events);
                      } catch (error) {
                          console.error("Error fetching events:", error);
                          failureCallback(error);
                      }
                  },
  
                  select: (selectionInfo) => {
                      document.getElementById('eventForm').reset();
                      document.getElementById('eventId').value = '';
                      document.getElementById('deleteEventButton').style.display = 'none';
                      document.getElementById('eventModalLabel').innerText = "Ajouter un événement";
  
                      document.getElementById('eventStart').value = formatDateTimeLocal(selectionInfo.start);
                      document.getElementById('eventEnd').value = formatDateTimeLocal(selectionInfo.end);
                      document.getElementById('eventAllDay').checked = selectionInfo.allDay;
                      document.getElementById('eventColor').value = '#0b3b61';
                      document.getElementById('eventAlarm').value = 'none';
                      document.getElementById('eventSound').value = 'chime';
  
                      eventModal.show();
                  },
  
                  eventClick: (clickInfo) => {
                      const event = clickInfo.event;
                      document.getElementById('eventForm').reset();
                      document.getElementById('eventId').value = event.id;
                      document.getElementById('eventModalLabel').innerText = "Modifier l'événement";
  
                      document.getElementById('eventTitle').value = event.title;
                      document.getElementById('eventStart').value = formatDateTimeLocal(event.start);
                      document.getElementById('eventEnd').value = formatDateTimeLocal(event.end || event.start);
                      document.getElementById('eventAllDay').checked = event.allDay;
                      document.getElementById('eventAlarm').value = event.extendedProps.alarm || 'none';
                      document.getElementById('eventSound').value = event.extendedProps.sound || 'chime';
                      document.getElementById('eventColor').value = event.extendedProps.color || '#0b3b61';
  
                      document.getElementById('deleteEventButton').style.display = 'block';
                      eventModal.show();
                  },
  
                  eventResize: async (resizeInfo) => {
                      const { id, start, end } = resizeInfo.event;
                      try {
                          await updateDoc(doc(db, 'users', user.uid, 'events', id), {
                              start: Timestamp.fromDate(start),
                              end: Timestamp.fromDate(end),
                          });
                          showToast('Durée de l\'événement mise à jour !', 'success');
                      } catch (error) {
                          showToast("Erreur lors du redimensionnement.", 'danger');
                          resizeInfo.revert();
                      }
                  },
  
                  eventDrop: async (dropInfo) => {
                      const { id, start, end, allDay } = dropInfo.event;
                      try {
                          await updateDoc(doc(db, 'users', user.uid, 'events', id), {
                              start: Timestamp.fromDate(start),
                              end: Timestamp.fromDate(end || start),
                              allDay: allDay
                          });
                          showToast('Événement déplacé !', 'success');
                      } catch (error) {
                          showToast("Erreur lors du déplacement.", 'danger');
                          dropInfo.revert();
                      }
                  }
              });
  
              calendar.render();
          }
  
          // --- EVENT FORM SUBMIT HANDLER ---
          document.getElementById('eventForm').addEventListener('submit', async (e) => {
              e.preventDefault();
              const user = auth.currentUser;
              if (!user) {
                  showToast("Veuillez vous connecter.", 'warning');
                  return;
              }
  
              const eventId = document.getElementById('eventId').value;
              const allDay = document.getElementById('eventAllDay').checked;
  
              let start, end;
              try {
                  start = new Date(document.getElementById('eventStart').value);
                  end = new Date(document.getElementById('eventEnd').value);
                  
                  if (isNaN(start.getTime()) || isNaN(end.getTime())) {
                      throw new Error("Veuillez sélectionner des dates valides.");
                  }
                  
                  if (end < start) {
                      throw new Error("La date de fin doit être après la date de début.");
                  }
              } catch (err) {
                  showToast(err.message, "danger");
                  return;
              }
  
              if (allDay) {
                  start.setHours(0, 0, 0, 0);
                  end.setHours(23, 59, 59, 999);
              }
  
              const eventData = {
                  title: document.getElementById('eventTitle').value.trim() || 'Sans titre',
                  start: Timestamp.fromDate(start),
                  end: Timestamp.fromDate(end),
                  allDay: allDay,
                  alarm: document.getElementById('eventAlarm').value,
                  sound: document.getElementById('eventSound').value,
                  color: document.getElementById('eventColor').value || '#0b3b61',
                  userId: user.uid,
                  updatedAt: Timestamp.now()
              };
  
              try {
                  if (eventId) {
                      await updateDoc(doc(db, 'users', user.uid, 'events', eventId), eventData);
                      showToast('✅ Événement mis à jour !', 'success');
                  } else {
                      eventData.createdAt = Timestamp.now();
                      await addDoc(collection(db, 'users', user.uid, 'events'), eventData);
                      showToast('✅ Événement ajouté !', 'success');
                  }
                  eventModal.hide();
                  if (calendar) calendar.refetchEvents();
              } catch (error) {
                  console.error("Error saving event:", error);
                  showToast(`❌ Erreur: ${error.message}`, 'danger');
              }
          });
  
          // --- ALARM CHECKER LOGIC ---
          function checkAlarms() {
              const user = auth.currentUser;
              if (!user) return;
  
              const now = new Date();
              const eventsQuery = query(collection(db, 'users', user.uid, 'events'));
  
              getDocs(eventsQuery).then(snapshot => {
                  snapshot.forEach(docSnap => {
                      const event = { id: docSnap.id, ...docSnap.data() };
                      
                      if (event.alarm && event.alarm !== 'none') {
                          const startTime = event.start.toDate();
                          const alarmMinutes = parseInt(event.alarm);
                          const alarmTime = new Date(startTime.getTime() - (alarmMinutes * 60000));
  
                          const timeDiff = now.getTime() - alarmTime.getTime();
                          
                          // Trigger if within 1 minute of alarm time
                          if (timeDiff >= 0 && timeDiff < 60000) {
                              const triggeredKey = `alarm_${event.id}_${alarmTime.toISOString()}`;
                              if (!sessionStorage.getItem(triggeredKey)) {
                                  triggerAlarm(event, alarmMinutes);
                                  sessionStorage.setItem(triggeredKey, 'true');
                              }
                          }
                      }
                  });
              }).catch(error => {
                  console.error("Error checking alarms:", error);
              });
          }
  
          function triggerAlarm(event, minutesBefore) {
              const sound = alarmSounds[event.sound] || alarmSounds.chime;
              sound.play().catch(e => console.warn("Audio autoplay blocked:", e));
  
              const eventStartTime = event.start.toDate().toLocaleTimeString('fr-FR', { 
                  hour: '2-digit', 
                  minute: '2-digit' 
              });
              
              const notificationMessage = minutesBefore === 0 
                  ? `🔔 "${event.title}" commence maintenant à ${eventStartTime}!`
                  : `⏰ Rappel: "${event.title}" commence dans ${minutesBefore} minutes (${eventStartTime})`;
  
              // Browser notification
              if (Notification.permission === 'granted') {
                  new Notification("Rappel d'événement 📅", {
                      body: notificationMessage,
                      icon: 'https://img.icons8.com/fluent/96/000000/alarm.png',
                      badge: 'https://img.icons8.com/fluent/48/000000/alarm.png',
                      tag: `event-${event.id}`,
                      requireInteraction: true
                  });
              }
              
              // In-app toast
              showToast(notificationMessage, 'warning');
          }
  
          // --- INITIALIZE & STOP ALARM SYSTEM ---
          function initializeAlarmSystem() {
              // Request notification permission
              if ('Notification' in window && Notification.permission === 'default') {
                  Notification.requestPermission().then(permission => {
                      if (permission === 'granted') {
                          showToast('✅ Notifications activées', 'success');
                      }
                  });
              }
              
              // Preload sounds
              Object.values(alarmSounds).forEach(sound => {
                  sound.load();
                  sound.volume = 0.7;
              });
              
              // Start checking every 30 seconds for better responsiveness
              if (alarmIntervalId) clearInterval(alarmIntervalId);
              alarmIntervalId = setInterval(checkAlarms, 30000);
              
              // Check immediately
              checkAlarms();
          }
  
          function stopAlarmSystem() {
              if (alarmIntervalId) {
                  clearInterval(alarmIntervalId);
                  alarmIntervalId = null;
              }
          }*/

        const eventModal = new bootstrap.Modal(
            document.getElementById("eventModal")
        );
        let calendar; // Will hold the FullCalendar instance
        let alarmIntervalId = null; // To manage the alarm checking interval

        // --- ALARM SOUNDS & HELPERS ---
        const alarmSounds = {
            chime: new Audio(
                "https://cdn.freesound.org/previews/510/510323_10899534-lq.mp3"
            ),
            notification: new Audio(
                "https://cdn.freesound.org/previews/415/415763_6142149-lq.mp3"
            ),
            digital: new Audio(
                "https://cdn.freesound.org/previews/142/142641_228222-lq.mp3"
            ),
        };

        function formatDateTimeLocal(date) {
            if (!date) return "";
            const ten = (i) => (i < 10 ? "0" : "") + i;
            const YYYY = date.getFullYear();
            const MM = ten(date.getMonth() + 1);
            const DD = ten(date.getDate());
            const HH = ten(date.getHours());
            const II = ten(date.getMinutes());
            return `${YYYY}-${MM}-${DD}T${HH}:${II}`;
        }

        // --- CORE CALENDAR RENDERING FUNCTION ---
        async function renderCalendar() {
            const calendarEl = document.getElementById("calendar");
            if (!calendarEl) return;
            if (calendar) calendar.destroy();

            const user = auth.currentUser;
            if (!user) {
                calendarEl.innerHTML =
                    '<div class="text-center text-muted p-5"><i class="bi bi-lock fs-1"></i><p>Connectez-vous pour voir le calendrier.</p></div>';
                return;
            }

            calendar = new FullCalendar.Calendar(calendarEl, {
                themeSystem: "bootstrap5",
                locale: "fr",
                headerToolbar: {
                    left: "prev,next today",
                    center: "title",
                    right: "dayGridMonth,timeGridWeek,timeGridDay,listWeek",
                },
                initialView: "timeGridWeek",
                editable: true,
                selectable: true,
                slotMinTime: "06:00:00",
                slotMaxTime: "23:00:00",
                slotDuration: "00:30:00",
                height: "auto",
                nowIndicator: true,
                displayEventTime: true,
                displayEventEnd: true,
                eventDisplay: "block",

                events: async (fetchInfo, successCallback) => {
                    const eventsCol = collection(db, "users", user.uid, "events");
                    const eventSnapshot = await getDocs(query(eventsCol)); // No need to order here, FullCalendar does it
                    const events = eventSnapshot.docs.map((doc) => {
                        const data = doc.data();

                        // This is the logic that adds the class for the alarm icon
                        const classNames =
                            data.alarm && data.alarm !== "none" ? ["has-alarm"] : [];

                        const event = {
                            id: doc.id,
                            title: data.title,
                            start: data.start.toDate(),
                            end: data.end ? data.end.toDate() : null,
                            allDay: data.allDay,
                            backgroundColor: data.color || "var(--brand)",
                            borderColor: data.color || "var(--brand)",
                            classNames: classNames, // Assign the class here
                            extendedProps: {
                                alarm: data.alarm,
                                sound: data.sound,
                                color: data.color,
                            },
                        };

                        // This handles correct multi-day display
                        if (event.allDay && event.end) {
                            event.end.setDate(event.end.getDate() + 1);
                        }
                        return event;
                    });
                    successCallback(events);
                },

                select: (selectionInfo) => {
                    document.getElementById("eventForm").reset();
                    document.getElementById("eventId").value = "";
                    document.getElementById("deleteEventButton").style.display = "none";
                    document.getElementById("eventModalLabel").innerText =
                        "Ajouter un événement";

                    document.getElementById("eventStart").value = formatDateTimeLocal(
                        selectionInfo.start
                    );
                    document.getElementById("eventEnd").value = formatDateTimeLocal(
                        selectionInfo.end
                    );
                    document.getElementById("eventAllDay").checked =
                        selectionInfo.allDay;
                    document.getElementById("eventColor").value = "#0b3b61";
                    document.getElementById("eventAlarm").value = "none";
                    document.getElementById("eventSound").value = "chime";

                    eventModal.show();
                },

                eventClick: (clickInfo) => {
                    const event = clickInfo.event;
                    document.getElementById("eventForm").reset();
                    document.getElementById("eventId").value = event.id;
                    document.getElementById("eventModalLabel").innerText =
                        "Modifier l'événement";

                    document.getElementById("eventTitle").value = event.title;
                    document.getElementById("eventStart").value = formatDateTimeLocal(
                        event.start
                    );
                    document.getElementById("eventEnd").value = formatDateTimeLocal(
                        event.end || event.start
                    );
                    document.getElementById("eventAllDay").checked = event.allDay;
                    document.getElementById("eventAlarm").value =
                        event.extendedProps.alarm || "none";
                    document.getElementById("eventSound").value =
                        event.extendedProps.sound || "chime";
                    document.getElementById("eventColor").value =
                        event.extendedProps.color || "#0b3b61";

                    document.getElementById("deleteEventButton").style.display =
                        "block";
                    eventModal.show();
                },

                eventResize: async (resizeInfo) => {
                    const { id, start, end } = resizeInfo.event;
                    try {
                        await updateDoc(doc(db, "users", user.uid, "events", id), {
                            start: Timestamp.fromDate(start),
                            end: Timestamp.fromDate(end),
                        });
                        showToast("Durée de l'événement mise à jour !", "success");
                    } catch (error) {
                        showToast("Erreur lors du redimensionnement.", "danger");
                        resizeInfo.revert();
                    }
                },

                eventDrop: async (dropInfo) => {
                    const { id, start, end, allDay } = dropInfo.event;
                    try {
                        await updateDoc(doc(db, "users", user.uid, "events", id), {
                            start: Timestamp.fromDate(start),
                            end: Timestamp.fromDate(end || start),
                            allDay: allDay,
                        });
                        showToast("Événement déplacé !", "success");
                    } catch (error) {
                        showToast("Erreur lors du déplacement.", "danger");
                        dropInfo.revert();
                    }
                },
            });

            calendar.render();
        }

        // --- EVENT FORM SUBMIT HANDLER ---
        document
            .getElementById("eventForm")
            .addEventListener("submit", async (e) => {
                e.preventDefault();
                const user = auth.currentUser;
                if (!user) {
                    showToast("Veuillez vous connecter.", "warning");
                    return;
                }

                const eventId = document.getElementById("eventId").value;
                const allDay = document.getElementById("eventAllDay").checked;

                let start, end;
                try {
                    start = new Date(document.getElementById("eventStart").value);
                    end = new Date(document.getElementById("eventEnd").value);

                    if (isNaN(start.getTime()) || isNaN(end.getTime())) {
                        throw new Error("Veuillez sélectionner des dates valides.");
                    }

                    if (end < start) {
                        throw new Error(
                            "La date de fin doit être après la date de début."
                        );
                    }
                } catch (err) {
                    showToast(err.message, "danger");
                    return;
                }

                if (allDay) {
                    start.setHours(0, 0, 0, 0);
                    end.setHours(23, 59, 59, 999);
                }

                const eventData = {
                    title:
                        document.getElementById("eventTitle").value.trim() ||
                        "Sans titre",
                    start: Timestamp.fromDate(start),
                    end: Timestamp.fromDate(end),
                    allDay: allDay,
                    alarm: document.getElementById("eventAlarm").value,
                    sound: document.getElementById("eventSound").value,
                    color: document.getElementById("eventColor").value || "#0b3b61",
                    userId: user.uid,
                    updatedAt: Timestamp.now(),
                };

                try {
                    if (eventId) {
                        await updateDoc(
                            doc(db, "users", user.uid, "events", eventId),
                            eventData
                        );
                        showToast("✅ Événement mis à jour !", "success");
                    } else {
                        eventData.createdAt = Timestamp.now();
                        await addDoc(
                            collection(db, "users", user.uid, "events"),
                            eventData
                        );
                        showToast("✅ Événement ajouté !", "success");
                    }
                    eventModal.hide();
                    if (calendar) calendar.refetchEvents();
                } catch (error) {
                    console.error("Error saving event:", error);
                    showToast(`❌ Erreur: ${error.message}`, "danger");
                }
            });

        // --- ALARM CHECKER LOGIC ---
        function checkAlarms() {
            const user = auth.currentUser;
            if (!user) return;

            const now = new Date();
            const eventsQuery = query(collection(db, "users", user.uid, "events"));

            getDocs(eventsQuery)
                .then((snapshot) => {
                    snapshot.forEach((docSnap) => {
                        const event = { id: docSnap.id, ...docSnap.data() };

                        if (event.alarm && event.alarm !== "none") {
                            const startTime = event.start.toDate();
                            const alarmMinutes = parseInt(event.alarm);
                            const alarmTime = new Date(
                                startTime.getTime() - alarmMinutes * 60000
                            );

                            const timeDiff = now.getTime() - alarmTime.getTime();

                            // Trigger if within 1 minute of alarm time
                            if (timeDiff >= 0 && timeDiff < 60000) {
                                const triggeredKey = `alarm_${event.id
                                    }_${alarmTime.toISOString()}`;
                                if (!sessionStorage.getItem(triggeredKey)) {
                                    triggerAlarm(event, alarmMinutes);
                                    sessionStorage.setItem(triggeredKey, "true");
                                }
                            }
                        }
                    });
                })
                .catch((error) => {
                    console.error("Error checking alarms:", error);
                });
        }

        function triggerAlarm(event, minutesBefore) {
            const sound = alarmSounds[event.sound] || alarmSounds.chime;
            sound.play().catch((e) => console.warn("Audio autoplay blocked:", e));

            const eventStartTime = event.start
                .toDate()
                .toLocaleTimeString("fr-FR", {
                    hour: "2-digit",
                    minute: "2-digit",
                });

            const notificationMessage =
                minutesBefore === 0
                    ? `🔔 "${event.title}" commence maintenant à ${eventStartTime}!`
                    : `⏰ Rappel: "${event.title}" commence dans ${minutesBefore} minutes (${eventStartTime})`;

            // Browser notification
            if (Notification.permission === "granted") {
                new Notification("Rappel d'événement 📅", {
                    body: notificationMessage,
                    icon: "https://img.icons8.com/fluent/96/000000/alarm.png",
                    badge: "https://img.icons8.com/fluent/48/000000/alarm.png",
                    tag: `event-${event.id}`,
                    requireInteraction: true,
                });
            }

            // In-app toast
            showToast(notificationMessage, "warning");
        }

        // --- INITIALIZE & STOP ALARM SYSTEM ---
        function initializeAlarmSystem() {
            // Request notification permission
            if ("Notification" in window && Notification.permission === "default") {
                Notification.requestPermission().then((permission) => {
                    if (permission === "granted") {
                        showToast("✅ Notifications activées", "success");
                    }
                });
            }

            // Preload sounds
            Object.values(alarmSounds).forEach((sound) => {
                sound.load();
                sound.volume = 0.7;
            });

            // Start checking every 30 seconds for better responsiveness
            if (alarmIntervalId) clearInterval(alarmIntervalId);
            alarmIntervalId = setInterval(checkAlarms, 30000);

            // Check immediately
            checkAlarms();
        }

        function stopAlarmSystem() {
            if (alarmIntervalId) {
                clearInterval(alarmIntervalId);
                alarmIntervalId = null;
            }
        }

        // ========================================================================
        // === END: COMPLETE CALENDAR & ALARM SYSTEM
        // ========================================================================

        // === FIX: Save event correctly with title, start, end, color, and userId ===
        async function saveEventToFirestore(userId, eventData) {
            try {
                const docRef = await addDoc(
                    collection(db, `users/${userId}/events`),
                    {
                        title: eventData.title,
                        start: eventData.start,
                        end: eventData.end,
                        color: eventData.color,
                        userId: userId,
                    }
                );
                console.log("✅ Event saved:", docRef.id);
            } catch (error) {
                console.error("❌ Error saving event:", error);
            }
        }

        // 5. Add these event listeners for the modal form somewhere in your script
        /*document.getElementById('eventForm').addEventListener('submit', async (e) => {
              e.preventDefault();
              const user = auth.currentUser;
              if (!user) return;
  
              const eventId = document.getElementById('eventId').value;
              const eventData = {
                  title: document.getElementById('eventTitle').value,
                  start: Timestamp.fromDate(new Date(document.getElementById('eventStart').value)),
                  end: Timestamp.fromDate(new Date(document.getElementById('eventEnd').value)),
                  allDay: document.getElementById('eventAllDay').checked,
                  userId: user.uid // Important for security rules
              };
  
              try {
                  if (eventId) { // Update existing event
                      const eventRef = doc(db, 'users', user.uid, 'events', eventId);
                      await updateDoc(eventRef, eventData);
                      showToast('Événement mis à jour !', 'success');
                  } else { // Create new event
                      const newEventRef = doc(collection(db, 'users', user.uid, 'events'));
                      await setDoc(newEventRef, eventData);
                      showToast('Événement ajouté !', 'success');
                  }
                  eventModal.hide();
                  calendar.refetchEvents(); // Refresh the calendar to show the new/updated event
              } catch (error) {
                  showToast('Erreur : ' + error.message, 'danger');
              }
          });
          */

        document
            .getElementById("deleteEventButton")
            .addEventListener("click", async () => {
                const user = auth.currentUser;
                const eventId = document.getElementById("eventId").value;
                if (!user || !eventId) return;

                if (confirm("Êtes-vous sûr de vouloir supprimer cet événement ?")) {
                    try {
                        await deleteDoc(doc(db, "users", user.uid, "events", eventId));
                        showToast("Événement supprimé.", "info");
                        eventModal.hide();
                        calendar.refetchEvents();
                    } catch (error) {
                        showToast("Erreur lors de la suppression.", "danger");
                    }
                }
            });

        function renderNotes() {
            const list = document.getElementById("notesList");
            list.innerHTML = "";

            if (notes.length === 0) {
                list.innerHTML =
                    '<div class="col-12 text-center text-muted py-5"><i class="bi bi-journal-x fs-1"></i><p class="mt-2">Vous n\'avez aucune note.</p></div>';
                return;
            }

            notes.forEach((note, index) => {
                const col = document.createElement("div");
                col.className = "col-md-4";
                col.innerHTML = `
        <div class="card card-modern fade-in">
          <div class="card-body">
            <h6>${note.title}</h6>
            <p class="text-muted small">${note.date}</p>
            <p>${note.content.substring(0, 100)}...</p>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteNote(${index})">Supprimer</button>
          </div>
        </div>
      `;
                list.appendChild(col);
            });
        }

        window.deleteNote = function (index) {
            notes.splice(index, 1);
            localStorage.setItem("notes", JSON.stringify(notes));
            renderNotes();
        };

        /*function renderProgress() {
              const ctx = document.getElementById('progressChart').getContext('2d');
              const completed = Object.values(userProgress).filter(p => p === 100).length;
              const inProgress = Object.values(userProgress).filter(p => p > 0 && p < 100).length;
              const notStarted = allFiles.length - completed - inProgress;
  
              new Chart(ctx, {
                  type: 'pie',
                  data: {
                      labels: ['Complétés', 'En cours', 'Non commencés'],
                      datasets: [{
                          data: [completed, inProgress, notStarted],
                          backgroundColor: ['var(--success)', 'var(--warning)', 'var(--danger)']
                      }]
                  },
                  options: {
                      responsive: true,
                      plugins: {
                          legend: { position: 'top' }
                      }
                  }
              });
          }
          */
        async function renderProgress() {
            const user = auth.currentUser;
            const progressView = document.getElementById("progressView");

            // Destroy previous chart instances to prevent memory leaks
            if (progressDonutChart) progressDonutChart.destroy();
            if (progressByCourseChart) progressByCourseChart.destroy();
            if (activityLineChart) activityLineChart.destroy();

            if (!user) {
                progressView.innerHTML =
                    '<div class="text-center text-muted p-5"><i class="bi bi-lock fs-1"></i><p class="mt-2">Veuillez vous connecter pour voir votre progression.</p></div>';
                return;
            }

            // --- DATA PREPARATION ---
            const completed = Object.values(userProgress).filter(
                (p) => p === 100
            ).length;
            const inProgress = Object.values(userProgress).filter(
                (p) => p > 0 && p < 100
            ).length;
            const notStarted = allFiles.length - completed - inProgress;

            // Update KPIs
            document.getElementById("kpiCompleted").textContent = completed;
            document.getElementById("kpiInProgress").textContent = inProgress;

            // Data for the Bar Chart (only show courses with progress > 0)
            const coursesWithProgress = allFiles
                .map((file) => ({
                    name: file.name,
                    progress: userProgress[file.id] || 0,
                }))
                .filter((course) => course.progress > 0)
                .sort((a, b) => a.progress - b.progress);

            // --- CHART.JS GLOBAL CONFIG ---
            // Use theme variables for chart colors and fonts
            const style = getComputedStyle(document.body);
            const brandColor = style.getPropertyValue("--brand").trim();
            const accentColor = style.getPropertyValue("--accent").trim();
            const successColor = style.getPropertyValue("--success").trim();
            const warningColor = style.getPropertyValue("--warning").trim();
            const dangerColor = style.getPropertyValue("--danger").trim();
            const textColor = style.getPropertyValue("--text").trim();
            const gridColor = style.getPropertyValue("--border").trim();

            Chart.defaults.color = textColor;
            Chart.defaults.font.family = "'Inter', sans-serif";
            Chart.defaults.plugins.legend.position = "bottom";

            // --- 1. OVERALL PROGRESS DONUT CHART ---
            const donutCtx = document
                .getElementById("progressDonutChart")
                .getContext("2d");
            progressDonutChart = new Chart(donutCtx, {
                type: "doughnut",
                data: {
                    labels: ["Terminés", "En cours", "Non commencés"],
                    datasets: [
                        {
                            data: [completed, inProgress, notStarted],
                            backgroundColor: [successColor, warningColor, dangerColor],
                            borderColor: style.getPropertyValue("--surface").trim(),
                            borderWidth: 4,
                            hoverOffset: 8,
                        },
                    ],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: "70%",
                    plugins: {
                        legend: { display: true },
                        tooltip: {
                            callbacks: {
                                label: (context) => `${context.label}: ${context.raw} cours`,
                            },
                        },
                    },
                },
            });

            // --- 2. PROGRESS BY COURSE BAR CHART ---
            const barCtx = document
                .getElementById("progressByCourseChart")
                .getContext("2d");
            progressByCourseChart = new Chart(barCtx, {
                type: "bar",
                data: {
                    labels: coursesWithProgress.map(
                        (c) => c.name.substring(0, 30) + (c.name.length > 30 ? "..." : "")
                    ),
                    datasets: [
                        {
                            label: "Progression (%)",
                            data: coursesWithProgress.map((c) => c.progress),
                            backgroundColor: brandColor,
                            borderRadius: 4,
                        },
                    ],
                },
                options: {
                    indexAxis: "y", // Horizontal bars
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100,
                            grid: { color: gridColor },
                        },
                        y: {
                            grid: { display: false },
                        },
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => `${context.raw}%`,
                            },
                        },
                    },
                },
            });

            // --- 3. RECENT ACTIVITY LINE CHART ---
            // NOTE: This uses randomly generated data for demonstration.
            // A real implementation would require storing timestamps of user actions.
            const lineCtx = document
                .getElementById("activityLineChart")
                .getContext("2d");
            const activityLabels = Array.from({ length: 7 }, (_, i) => {
                const d = new Date();
                d.setDate(d.getDate() - i);
                return d.toLocaleDateString("fr-FR", {
                    weekday: "short",
                    day: "numeric",
                });
            }).reverse();

            const gradient = lineCtx.createLinearGradient(0, 0, 0, 250);
            gradient.addColorStop(0, `${accentColor}80`); // 50% opacity
            gradient.addColorStop(1, `${accentColor}00`); // 0% opacity

            activityLineChart = new Chart(lineCtx, {
                type: "line",
                data: {
                    labels: activityLabels,
                    datasets: [
                        {
                            label: "Actions complétées",
                            data: Array.from({ length: 7 }, () =>
                                Math.floor(Math.random() * 5)
                            ), // FAKE DATA
                            fill: true,
                            backgroundColor: gradient,
                            borderColor: accentColor,
                            tension: 0.4, // Makes the line smooth
                            pointBackgroundColor: accentColor,
                            pointBorderColor: style.getPropertyValue("--surface").trim(),
                            pointHoverRadius: 7,
                            pointRadius: 5,
                        },
                    ],
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: gridColor },
                            ticks: {
                                precision: 0, // Only show whole numbers
                            },
                        },
                        x: {
                            grid: { display: false },
                        },
                    },
                    plugins: {
                        legend: { display: false },
                    },
                },
            });
        }

        // START: NEW FUNCTION FOR SETTINGS VIEW
        function renderSettings() {
            const user = auth.currentUser;
            const settingsWrapper = document.getElementById(
                "accountSettingsWrapper"
            );
            const passwordCard = document.getElementById('passwordSettingsCard');

            const photoPreview = document.getElementById('profilePhotoPreview');
            const btnRemove = document.getElementById('btnRemovePhoto');
            const photoUrlInput = document.getElementById('photoUrlInput'); // NOUVEAU INPUT
            if (user) {
                settingsWrapper.style.display = "block";
                document.getElementById("accountName").value = user.displayName || "";
                document.getElementById("accountEmail").value = user.email || "";

                const photoURL = user.photoURL || '';
                photoUrlInput.value = photoURL;

                // Afficher la photo de profil (avec fallback vers UI Avatars)
                const userPhotoUrl = photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName || user.email)}`;
                photoPreview.src = userPhotoUrl;


                // Afficher le bouton de suppression uniquement si une photo personnalisée existe
                if (user.photoURL && !user.photoURL.includes('ui-avatars.com')) {
                    btnRemove.classList.remove('d-none');
                } else {
                    btnRemove.classList.add('d-none');
                }
                // Check if user signed up with email/password
                const isPasswordProvider = user.providerData.some(
                    (provider) => provider.providerId === "password"
                );

                if (isPasswordProvider) {
                    passwordCard.style.display = "block";
                } else {
                    passwordCard.style.display = "none";
                }
            } else {
                // Hide settings if no user is logged in
                settingsWrapper.style.display = "none";
            }
        }
        // END: NEW FUNCTION

        function updateStats() {
            const total = allFiles.length;
            const completed = Object.values(userProgress).filter(
                (p) => p === 100
            ).length;
            const inProgress = Object.values(userProgress).filter(
                (p) => p > 0 && p < 100
            ).length;

            document.getElementById("totalCourses").innerText = total;
            document.getElementById("completedCourses").innerText = completed;
            document.getElementById("inProgressCourses").innerText = inProgress;
        }

        function filterCourses(query) {
            const cards = document.querySelectorAll(
                "#coursesGrid .col-xl-3, #coursesGrid .col-lg-4, #coursesGrid .col-md-6"
            );
            cards.forEach((card) => {
                const title =
                    card.querySelector(".card-title")?.innerText.toLowerCase() || "";
                card.style.display = title.includes(query) ? "" : "none";
            });
        }

        function showToast(message, type = "info") {
            const toastContainer = document.getElementById("toastContainer");

            const icons = {
                success: "bi-check-circle-fill",
                danger: "bi-exclamation-triangle-fill",
                warning: "bi-exclamation-triangle-fill",
                info: "bi-info-circle-fill",
            };
            const icon = icons[type] || icons.info;

            // Create the wrapper for Bootstrap's Toast component
            const toastEl = document.createElement("div");
            toastEl.className = `toast custom-toast alert-${type}`; // Use 'toast' class
            toastEl.setAttribute("role", "alert");
            toastEl.setAttribute("aria-live", "assertive");
            toastEl.setAttribute("aria-atomic", "true");

            toastEl.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body d-flex align-items-center">
                        <i class="bi ${icon} me-2 fs-5"></i>
                        <span class="fw-semibold me-auto">${message}</span>
                    </div>
                    <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;

            toastContainer.appendChild(toastEl);

            // Create a new Bootstrap Toast instance
            const bsToast = new bootstrap.Toast(toastEl, {
                delay: 5000, // Auto-hide after 5 seconds
                autohide: true,
            });

            // When the toast is hidden, remove it from the DOM to prevent clutter
            toastEl.addEventListener("hidden.bs.toast", () => {
                toastEl.remove();
            });

            // Show the toast!
            bsToast.show();
        }

        // Fonctions globales
        window.playVideo = function (fileId, title, url) {
            document.getElementById("videoTitle").innerText = title;
            const container = document.getElementById("videoContainer");

            const videoId = extractVideoId(url);
            if (videoId) {
                container.innerHTML = `<iframe src="https://www.youtube.com/embed/${videoId}?autoplay=1" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
            } else if (fileId) {
                container.innerHTML = `<iframe src="https://drive.google.com/file/d/${fileId}/preview" frameborder="0" allowfullscreen></iframe>`;
            } else {
                container.innerHTML = `<div class="p-5 text-center text-muted"><i class="bi bi-exclamation-triangle fs-1"></i><p class="mt-2">Vidéo non disponible</p></div>`;
            }

            videoModal.show();

            if (!userProgress[fileId]) {
                saveProgress(fileId, 25);
            }
        };

        window.playYoutube = async function (type, id, title) {
            const container = document.getElementById("videoContainer");
            container.innerHTML =
                '<div class="d-flex h-100 align-items-center justify-content-center"><div class="loader"></div></div>';

            // The side panel is now ALWAYS the history panel
            playlistPanel.classList.remove("d-none");
            playlistPanel.classList.add("d-flex");
            renderVideoHistory();

            let videoIdToPlay = id;

            if (type === "playlist") {
                // For a playlist, we fetch the *first* video's ID to start playing
                try {
                    const url = `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&maxResults=1&playlistId=${id}&key=${YOUTUBE_API_KEY}`;
                    const res = await fetch(url);
                    const data = await res.json();
                    if (data.items && data.items.length > 0) {
                        videoIdToPlay = data.items[0].snippet.resourceId.videoId;
                        // We could fetch the whole playlist and let the user navigate via YouTube's iframe controls
                    }
                } catch (err) {
                    console.error("Could not fetch first video of playlist:", err);
                    showToast("Impossible de charger la playlist.", "danger");
                    return;
                }
                // For playlists, we now just embed the whole list and let YouTube handle the queue inside the iframe.
                container.innerHTML = `<iframe src="https://www.youtube.com/embed/videoseries?list=${id}&autoplay=1" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
            } else {
                // For a single video, we add it to our history
                const videoData = {
                    videoId: id,
                    title: title,
                    thumbnailUrl: `https://img.youtube.com/vi/${id}/default.jpg`,
                };
                addVideoToHistory(videoData);
                container.innerHTML = `<iframe src="https://www.youtube.com/embed/${id}?autoplay=1" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
            }

            document.getElementById("videoTitle").innerText = title;
            videoModal.show();
        };

        window.viewDocument = function (fileId, title, url, kind) {
            document.getElementById("documentTitle").innerText = title;
            const container = document.getElementById("documentContainer");

            container.innerHTML = `<iframe src="https://drive.google.com/file/d/${fileId}/preview" frameborder="0"></iframe>`;

            documentModal.show();

            if (!userProgress[fileId]) {
                saveProgress(fileId, 25);
            }
        };

        window.markComplete = function (fileId) {
            saveProgress(fileId, 100);
            renderCourses();
            renderDashboard();
            showToast("Cours marqué comme complété !", "success");
        };

        window.resumeCourse = function (fileId) {
            const file = allFiles.find((f) => f.id === fileId);
            if (!file) return;

            const meta = getFileMeta(file.mimeType);
            if (meta.kind === "video") {
                playVideo(file.id, file.name, file.webViewLink);
            } else {
                viewDocument(file.id, file.name, file.webViewLink, meta.kind);
            }

            const currentProgress = userProgress[fileId] || 0;
            if (currentProgress < 100) {
                saveProgress(fileId, Math.min(currentProgress + 25, 100));
            }
        };

        window.saveForLater = function (fileId) {
            const saved = JSON.parse(localStorage.getItem("savedCourses") || "[]");
            if (!saved.includes(fileId)) {
                saved.push(fileId);
                localStorage.setItem("savedCourses", JSON.stringify(saved));
                showToast("Enregistré pour plus tard !", "info");
            }
        };

        window.openFolder = function (folderId, name) {
            folderPath.push({ id: folderId, name });
            currentFolderId = folderId;
            fetchDriveFolder(folderId);
        };

        // Filtre catégorie
        document
            .getElementById("categoryFilter")
            ?.addEventListener("change", (e) => {
                const value = e.target.value;
                const cards = document.querySelectorAll("#coursesGrid > div");

                cards.forEach((card) => {
                    if (value === "all") {
                        card.style.display = "";
                    } else {
                        const badge =
                            card.querySelector(".course-badge")?.innerText.toLowerCase() ||
                            "";
                        card.style.display = badge.includes(value) ? "" : "none";
                    }
                });
            });

        // Tri
        document.getElementById("sortBy")?.addEventListener("change", (e) => {
            const value = e.target.value;
            if (value === "Trier par nom") {
                currentFiles.sort((a, b) => a.name.localeCompare(b.name));
            } else if (value === "Trier par date") {
                currentFiles.sort(
                    (a, b) => new Date(b.modifiedTime) - new Date(a.modifiedTime)
                );
            } else if (value === "Trier par type") {
                currentFiles.sort((a, b) => a.mimeType.localeCompare(b.mimeType));
            }
            renderCourses();
        });

        function escapeHtml(text) {
            const map = {
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                '"': '&quot;',
                "'": '&#039;'
            };
            return text.replace(/[&<>"']/g, m => map[m]);
        }

        /*function escapeHtml(str) {
            if (!str) return "";
            const div = document.createElement("div");
            div.textContent = str;
            return div.innerHTML;
        }*/

        function setTheme(theme) {
            localStorage.setItem("theme", theme);
            if (theme === "system") {
                document.body.removeAttribute("data-theme");
            } else {
                document.body.setAttribute("data-theme", theme);
            }
        }

        function loadTheme() {
            const theme = localStorage.getItem("theme") || "system";
            const select = document.getElementById("themeSelect");
            if (select) select.value = theme;
            setTheme(theme);
            loadBackgroundImage();
        }

        function listenForNotifications(userId) {
            if (unsubscribeNotifications) unsubscribeNotifications(); // Prevent multiple listeners

            const notifQuery = query(
                collection(db, "users", userId, "notifications"),
                orderBy("createdAt", "desc")
            );

            unsubscribeNotifications = onSnapshot(notifQuery, (snapshot) => {
                const notifications = snapshot.docs.map((doc) => ({
                    id: doc.id,
                    ...doc.data(),
                }));
                console.log("Real-time notifications received:", notifications);
                updateNotificationUI(notifications);
            });
        }

        function updateNotificationUI(notifications) {
            const notifCountBadge = document.getElementById("notifCount");
            const notifListContainer =
                document.getElementById("notifListContainer");

            const unreadCount = notifications.filter((n) => !n.read).length;

            // Update the bell badge
            if (unreadCount > 0) {
                notifCountBadge.textContent = unreadCount;
                notifCountBadge.classList.remove("d-none");
            } else {
                notifCountBadge.classList.add("d-none");
            }

            // Update the dropdown list
            notifListContainer.innerHTML = "";
            if (notifications.length === 0) {
                notifListContainer.innerHTML =
                    '<div class="text-center text-muted p-4">Aucune notification</div>';
                return;
            }

            // Show the latest 5 notifications in the dropdown
            notifications.slice(0, 5).forEach((notif) => {
                const itemEl = document.createElement("a");
                itemEl.href = "#";
                itemEl.className = `list-group-item notification-item ${notif.read ? "" : "unread"
                    }`;
                itemEl.onclick = (e) => {
                    e.preventDefault();
                    handleNotificationClick(notif);
                };

                const icon = getNotificationIcon(notif.type);

                itemEl.innerHTML = `
            <div class="icon" style="color: ${icon.color};">${icon.html}</div>
            <div class="content flex-grow-1">
                ${notif.message}
                <div class="timestamp">${timeAgo(
                    notif.createdAt.toDate()
                )}</div>
            </div>
        `;
                notifListContainer.appendChild(itemEl);
            });
        }

        function getNotificationIcon(type) {
            switch (type) {
                case "new_reply":
                    return {
                        html: '<i class="bi bi-chat-dots-fill"></i>',
                        color: "var(--info)",
                    };
                case "new_content":
                    return {
                        html: '<i class="bi bi-cloud-arrow-up-fill"></i>',
                        color: "var(--success)",
                    };
                case "assignment_due":
                    return {
                        html: '<i class="bi bi-exclamation-triangle-fill"></i>',
                        color: "var(--warning)",
                    };
                default:
                    return {
                        html: '<i class="bi bi-info-circle-fill"></i>',
                        color: "var(--muted)",
                    };
            }
        }

        // --- FONCTION UTILITAIRE POUR METTRE À JOUR LE PROFIL GLOBALEMENT ---
        function updateProfileUI(url) {
            const user = auth.currentUser;
            if (!user) return;

            // 1. Mise à jour de l'objet utilisateur Firebase
            updateProfile(user, { photoURL: url })
                .then(() => {
                    // 2. Mise à jour des éléments DOM
                    const newUrl = url || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName || user.email)}`;
                    document.getElementById('userPhoto').src = newUrl;
                    document.getElementById('profilePhotoPreview').src = newUrl;

                    // 3. Mettre à jour l'input si l'URL est nulle (pour vider le champ)
                    document.getElementById('photoUrlInput').value = url || '';

                    showToast('Profil mis à jour !', 'success');
                })
                .catch(error => {
                    showToast('Erreur lors de la mise à jour du profil.', 'danger');
                    console.error('Update profile error:', error);
                });
        }

        // --- ÉCOUTEURS D'UPLOAD ET DE SUPPRESSION ---

        document.getElementById('photoUploadInput')?.addEventListener('change', async (e) => {
            const user = auth.currentUser;
            const file = e.target.files[0];
            if (!user || !file) return;

            if (file.size > 2 * 1024 * 1024) { // Max 2MB
                showToast("La taille du fichier ne doit pas dépasser 2 Mo.", 'warning');
                return;
            }

            // Afficher un aperçu local pendant le téléchargement
            const reader = new FileReader();
            reader.onload = (e) => {
                document.getElementById('profilePhotoPreview').src = e.target.result;
            };
            reader.readAsDataURL(file);

            showToast("Téléchargement de l'image en cours...", 'info');

            try {
                // 1. Créer la référence de stockage (chemin: profile_photos/{UID})
                const photoRef = ref(storage, `profile_photos/${user.uid}`);

                // 2. Télécharger le fichier
                await uploadBytes(photoRef, file);

                // 3. Obtenir l'URL publique
                const downloadURL = await getDownloadURL(photoRef);

                // 4. Mettre à jour l'utilisateur Firebase avec la nouvelle URL
                updateProfileUI(downloadURL);

            } catch (error) {
                showToast('Échec du téléchargement de la photo: ' + error.message, 'danger');
                console.error('Photo upload error:', error);
                // Revenir à la photo précédente en cas d'erreur
                renderSettings();
            }
        });

        document.getElementById('btnRemovePhoto')?.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user || !user.photoURL || user.photoURL.includes('ui-avatars.com')) return;

            if (!confirm("Voulez-vous vraiment supprimer votre photo de profil ?")) return;

            try {
                // 1. Supprimer l'image du Storage
                const photoRef = ref(storage, `profile_photos/${user.uid}`);
                await deleteObject(photoRef);

                // 2. Mettre à jour l'utilisateur pour supprimer l'URL de la photo
                updateProfileUI(null); // 'null' déclenche le fallback vers ui-avatars

                showToast('Photo supprimée avec succès.', 'info');

            } catch (error) {
                // Ignorer l'erreur si le fichier n'existe pas déjà (code 'storage/object-not-found')
                if (error.code !== 'storage/object-not-found') {
                    showToast('Erreur lors de la suppression de la photo: ' + error.message, 'danger');
                    console.error('Photo deletion error:', error);
                }
                // Même en cas d'échec de la suppression (si le fichier n'existait pas), on retire l'URL du profil
                updateProfileUI(null);
            }
        });

        function timeAgo(date) {
            // Simple time ago function (for a more advanced one, use a library like date-fns)
            const seconds = Math.floor((new Date() - date) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return `il y a ${Math.floor(interval)} ans`;
            interval = seconds / 2592000;
            if (interval > 1) return `il y a ${Math.floor(interval)} mois`;
            interval = seconds / 86400;
            if (interval > 1) return `il y a ${Math.floor(interval)} jours`;
            interval = seconds / 3600;
            if (interval > 1) return `il y a ${Math.floor(interval)} heures`;
            interval = seconds / 60;
            if (interval > 1) return `il y a ${Math.floor(interval)} minutes`;
            return "à l'instant";
        }

        async function handleNotificationClick(notification) {
            const user = auth.currentUser;
            if (!user) return;

            // Mark as read in Firestore
            if (!notification.read) {
                const notifRef = doc(
                    db,
                    "users",
                    user.uid,
                    "notifications",
                    notification.id
                );
                await updateDoc(notifRef, { read: true });
            }

            // TODO: Navigate to the relevant page based on notification.link
            if (notification.link) {
                // e.g., if link is '/discussions/threadId123', parse and navigate
                console.log("Navigate to:", notification.link);
                showToast(`Navigation vers: ${notification.link}`, "info");
            }
        }

        document
            .getElementById("markAllAsReadBtn")
            .addEventListener("click", async () => {
                const user = auth.currentUser;
                if (!user) return;

                const notifQuery = query(
                    collection(db, "users", user.uid, "notifications"),
                    where("read", "==", false)
                );
                const snapshot = await getDocs(notifQuery);

                // Use a batch write for efficiency
                const batch = writeBatch(db);
                snapshot.docs.forEach((doc) => {
                    batch.update(doc.ref, { read: true });
                });
                await batch.commit();

                showToast(
                    "Toutes les notifications ont été marquées comme lues.",
                    "success"
                );
            });

        // Logic for the full notification page (you can expand this later)
        // REPLACE your old, empty renderFullNotificationPage function with this one

        /**
         * Creates a "raw" notification event in the public inbox.
         * This is a client-side trigger that other clients will listen for.
         * @param {string} targetUserId The ID of the user to notify.
         * @param {object} payload The notification data (message, type, link).
         */
        async function triggerNotificationEvent(targetUserId, payload) {
            if (!targetUserId || !auth.currentUser) return;
            try {
                await addDoc(collection(db, "notification_inbox"), {
                    ...payload,
                    targetUserId: targetUserId,
                    creatorName: auth.currentUser.displayName || "Anonyme",
                    createdAt: Timestamp.now(),
                });
            } catch (error) {
                console.error(`Failed to trigger notification event:`, error);
            }
        }

        async function renderFullNotificationPage() {
            const container = document.getElementById("fullNotifList");
            if (!container) return;

            container.innerHTML =
                '<div class="text-center p-5"><div class="loader"></div></div>';

            const user = auth.currentUser;
            if (!user) {
                container.innerHTML =
                    '<div class="text-center text-muted p-5"><i class="bi bi-lock fs-1"></i><p class="mt-2">Veuillez vous connecter pour voir vos notifications.</p></div>';
                return;
            }

            try {
                // Fetch ALL notifications for the user, ordered by date
                const notifQuery = query(
                    collection(db, "users", user.uid, "notifications"),
                    orderBy("createdAt", "desc")
                );
                const snapshot = await getDocs(notifQuery);

                if (snapshot.empty) {
                    container.innerHTML =
                        '<div class="text-center text-muted p-5"><i class="bi bi-bell-slash fs-1"></i><p class="mt-2">Vous n\'avez aucune notification pour le moment.</p></div>';
                    return;
                }

                container.innerHTML = ""; // Clear the loader

                snapshot.docs.forEach((doc) => {
                    const notif = { id: doc.id, ...doc.data() };

                    const itemEl = document.createElement("a");
                    itemEl.href = "#";
                    // Use the same CSS classes as the dropdown for a consistent look
                    itemEl.className = `list-group-item notification-item ${notif.read ? "" : "unread"
                        }`;
                    itemEl.onclick = (e) => {
                        e.preventDefault();
                        handleNotificationClick(notif);
                        // After clicking, refresh this view to update the 'read' status visually
                        renderFullNotificationPage();
                    };

                    const icon = getNotificationIcon(notif.type);

                    itemEl.innerHTML = `
                <div class="icon" style="color: ${icon.color};">${icon.html
                        }</div>
                <div class="content flex-grow-1">
                    ${notif.message}
                    <div class="timestamp">${timeAgo(
                            notif.createdAt.toDate()
                        )}</div>
                </div>
                <!-- Add a chevron to indicate it's clickable -->
                <i class="bi bi-chevron-right ms-auto text-muted"></i>
            `;
                    container.appendChild(itemEl);
                });
            } catch (error) {
                console.error("Error fetching full notification list:", error);
                container.innerHTML =
                    '<div class="text-center text-danger p-5"><i class="bi bi-exclamation-triangle-fill fs-1"></i><p class="mt-2">Impossible de charger les notifications.</p></div>';
            }
        }
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
    <!-- Firestore Security Rules:
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    match /contributed/{document=**} {
      allow read: if true;
      allow create: if request.auth != null;
      allow update, delete: if request.auth.uid == resource.data.userId;
    }
  }
}
-->
</body>

</html>
