<!doctype html>
<html lang="fr">

<head>
    <meta charset="utf-8" />
    <meta name="viewport" content="width=device-width,initial-scale=1" />
    <title>Plateforme d'Apprentissage FPN — Université Mohamed Premier</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.min.css" rel="stylesheet">
    <link href="https://cdn.jsdelivr.net/npm/quill@2.0.0/dist/quill.snow.css" rel="stylesheet" />
    <script src="https://cdn.jsdelivr.net/npm/quill@2.0.0/dist/quill.js"></script>

    <script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/bootstrap5@6.1.11/index.global.min.js'></script>

    <style>
        /* ============================
   GLOBAL THEME VARIABLES
   ============================ */
        :root {
            --brand: #0b3b61;
            --accent: #d4af37;
            --muted: #6c757d;
            --surface: #ffffff;
            --soft: #f8f9fa;
            --text: #111827;
            --border: #e5e7eb;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --light-bg: #f8f9fa;
            --dark-bg: #0f172a;
            --dark-text: #f1f5f9;
            --dark-surface: #1e293b;
            --dark-border: #334155;
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.08);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.25);
            --transition-fast: 150ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-base: 250ms cubic-bezier(0.4, 0, 0.2, 1);
            --transition-slow: 350ms cubic-bezier(0.4, 0, 0.2, 1);
            --backdrop-blur: blur(12px);
        }

        /* ============================
   BASE STYLES
   ============================ */
        *,
        *::before,
        *::after {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
        }

        html {
            font-size: 16px;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        html,
        body {
            height: 100%;
            margin: 0;
            padding: 0;
            background: var(--soft);
            color: var(--text);
            font-family: 'Inter', -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, 'Helvetica Neue', Arial, sans-serif;
            transition: background var(--transition-base), color var(--transition-base);
            overflow-x: hidden;
            scroll-behavior: smooth;
        }

        a {
            color: var(--brand);
            text-decoration: none;
            transition: color var(--transition-fast);
        }

        a:hover {
            color: var(--accent);
        }

        a:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
            border-radius: 4px;
        }

        button,
        .btn {
            transition: all var(--transition-fast);
        }

        button:focus-visible,
        .btn:focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        /* ============================
   SCROLLBAR STYLING
   ============================ */
        ::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        ::-webkit-scrollbar-track {
            background: var(--soft);
        }

        ::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 5px;
            transition: background var(--transition-fast);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: var(--muted);
        }

        [data-theme="dark"] ::-webkit-scrollbar-track {
            background: var(--dark-bg);
        }

        [data-theme="dark"] ::-webkit-scrollbar-thumb {
            background: var(--dark-border);
        }

        [data-theme="dark"] ::-webkit-scrollbar-thumb:hover {
            background: var(--muted);
        }

        /* ============================
   THEMES
   ============================ */
        [data-theme="dark"] {
            --brand: #60a5fa;
            --accent: #fbbf24;
            --muted: #94a3b8;
            --text: var(--dark-text);
            --surface: var(--dark-surface);
            --soft: var(--dark-bg);
            --border: var(--dark-border);
            --success: #34d399;
            --danger: #f87171;
            --warning: #fbbf24;
            --info: #60a5fa;
            --shadow-sm: 0 1px 3px rgba(0, 0, 0, 0.5);
            --shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.4), 0 2px 4px -1px rgba(0, 0, 0, 0.3);
            --shadow-md: 0 10px 15px -3px rgba(0, 0, 0, 0.5), 0 4px 6px -2px rgba(0, 0, 0, 0.3);
            --shadow-lg: 0 20px 25px -5px rgba(0, 0, 0, 0.6), 0 10px 10px -5px rgba(0, 0, 0, 0.4);
            --shadow-xl: 0 25px 50px -12px rgba(0, 0, 0, 0.7);
        }

        [data-theme="modern"] {
            --brand: #2563eb;
            --accent: #f59e0b;
            --muted: #6b7280;
            --text: #111827;
            --surface: #ffffff;
            --soft: #f3f4f6;
            --border: #e5e7eb;
            --success: #10b981;
            --danger: #ef4444;
        }

        [data-theme="pastel"] {
            --brand: #8b5cf6;
            --accent: #ec4899;
            --muted: #6b7280;
            --text: #1f2937;
            --surface: #fef3c7;
            --soft: #fce7f3;
            --border: #e5e7eb;
            --success: #10b981;
            --danger: #ef4444;
        }

        [data-theme="elegant"] {
            --brand: #c6a664;
            /* Elegant gold */
            --accent: #ffebcd;
            /* Soft cream */
            --muted: #a1a1aa;
            /* Soft gray */
            --text: #f9fafb;
            /* Bright text */
            --surface: #1f1f1f;
            /* Deep dark surface */
            --soft: #111111;
            /* Rich black */
            --border: #2e2e2e;
            --success: #4ade80;
            --danger: #f87171;
            --warning: #fbbf24;
            --info: #60a5fa;
            --shadow-sm: 0 1px 3px rgba(198, 166, 100, 0.25);
            --shadow: 0 4px 6px rgba(198, 166, 100, 0.25);
            --shadow-md: 0 10px 15px rgba(198, 166, 100, 0.2);
            --shadow-lg: 0 20px 25px rgba(198, 166, 100, 0.15);
        }

        [data-theme="forest"] {
            --brand: #2e7d32;
            /* Forest green */
            --accent: #a5d6a7;
            /* Light green accent */
            --muted: #6b7280;
            --text: #1f2937;
            --surface: #f1f8f4;
            /* Light mint surface */
            --soft: #e8f5e9;
            /* Softer green */
            --border: #c8e6c9;
            --success: #16a34a;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #3b82f6;
            --shadow-sm: 0 1px 3px rgba(46, 125, 50, 0.15);
            --shadow: 0 4px 6px rgba(46, 125, 50, 0.15);
            --shadow-md: 0 10px 15px rgba(46, 125, 50, 0.15);
            --shadow-lg: 0 20px 25px rgba(46, 125, 50, 0.15);
        }

        [data-theme="ocean"] {
            --brand: #0284c7;
            /* Deep blue */
            --accent: #38bdf8;
            /* Sky blue */
            --muted: #64748b;
            --text: #0f172a;
            --surface: #f0f9ff;
            /* Very light blue surface */
            --soft: #e0f2fe;
            /* Softer blue */
            --border: #bae6fd;
            --success: #10b981;
            --danger: #ef4444;
            --warning: #f59e0b;
            --info: #0284c7;
            --shadow-sm: 0 1px 3px rgba(2, 132, 199, 0.15);
            --shadow: 0 4px 6px rgba(2, 132, 199, 0.15);
            --shadow-md: 0 10px 15px rgba(2, 132, 199, 0.15);
            --shadow-lg: 0 20px 25px rgba(2, 132, 199, 0.15);
        }

        [data-theme="midnight"] {
            --brand: #38bdf8;
            /* Neon cyan */
            --accent: #a855f7;
            /* Purple accent */
            --muted: #94a3b8;
            --text: #f1f5f9;
            --surface: #0f172a;
            /* Deep dark */
            --soft: #1e293b;
            /* Softer dark */
            --border: #334155;
            --success: #22c55e;
            --danger: #f87171;
            --warning: #facc15;
            --info: #3b82f6;
            --shadow-sm: 0 1px 3px rgba(56, 189, 248, 0.3);
            --shadow: 0 4px 6px rgba(56, 189, 248, 0.25);
            --shadow-md: 0 10px 15px rgba(168, 85, 247, 0.2);
            --shadow-lg: 0 20px 25px rgba(168, 85, 247, 0.15);
        }

        @media (prefers-color-scheme: dark) {
            [data-theme="system"] {
                --brand: #60a5fa;
                --accent: #fbbf24;
                --muted: #94a3b8;
                --text: var(--dark-text);
                --surface: var(--dark-surface);
                --soft: var(--dark-bg);
                --border: var(--dark-border);
                --success: #34d399;
                --danger: #f87171;
            }
        }

        /* ============================
   NAVBAR
   ============================ */
        .navbar {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            box-shadow: var(--shadow);
            border-bottom: 1px solid var(--border);
            transition: all var(--transition-base);
            position: sticky;
            top: 0;
            z-index: 1030;
        }

        [data-theme="dark"] .navbar {
            background: rgba(30, 41, 59, 0.95);
        }

        [data-theme="modern"] .navbar {
            background: rgba(255, 255, 255, 0.95);
        }

        [data-theme="pastel"] .navbar {
            background: rgba(254, 243, 199, 0.95);
        }

        .navbar-brand {
            font-weight: 700;
            display: flex;
            align-items: center;
            gap: 1rem;
            transition: transform var(--transition-fast);
        }

        .navbar-brand:hover {
            transform: translateY(-1px);
        }

        .navbar-brand img {
            height: 44px;
            transition: transform var(--transition-base);
        }

        .navbar-brand:hover img {
            transform: scale(1.02);
        }

        .navbar .btn-link {
            color: var(--muted);
            position: relative;
            padding: 0.5rem;
            border-radius: var(--radius-sm);
            transition: all var(--transition-fast);
        }

        .navbar .btn-link:hover {
            color: var(--brand);
            background: rgba(11, 59, 97, 0.05);
            transform: translateY(-1px);
        }

        [data-theme="dark"] .navbar .btn-link:hover {
            background: rgba(96, 165, 250, 0.1);
        }

        [data-theme="modern"] .navbar .btn-link:hover {
            background: rgba(37, 99, 235, 0.08);
        }

        [data-theme="pastel"] .navbar .btn-link:hover {
            background: rgba(139, 92, 246, 0.08);
        }

        /* ============================
   SEARCH BOX
   ============================ */
        .search-box {
            position: relative;
            max-width: 500px;
            width: 100%;
        }

        .search-box input {
            padding: 0.625rem 1rem 0.625rem 3rem;
            border-radius: 24px;
            border: 2px solid var(--border);
            background: var(--soft);
            color: var(--text);
            transition: all var(--transition-base);
            width: 100%;
            font-size: 0.9375rem;
        }

        .search-box input:focus {
            border-color: var(--brand);
            background: var(--surface);
            outline: none;
            box-shadow: 0 0 0 3px rgba(11, 59, 97, 0.08);
            transform: translateY(-1px);
        }

        [data-theme="dark"] .search-box input:focus {
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.12);
        }

        [data-theme="modern"] .search-box input:focus {
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        [data-theme="pastel"] .search-box input:focus {
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        .search-box input::placeholder {
            color: var(--muted);
            opacity: 0.7;
        }

        .search-box i {
            position: absolute;
            left: 1.125rem;
            top: 50%;
            transform: translateY(-50%);
            color: var(--muted);
            font-size: 1.125rem;
            transition: color var(--transition-fast);
            pointer-events: none;
        }

        .search-box input:focus~i {
            color: var(--brand);
        }

        /* ============================
   SIDEBAR
   ============================ */
        .sidebar {
            position: fixed;
            top: 72px;
            left: 0;
            width: 280px;
            height: calc(100vh - 72px);
            background: var(--surface);
            border-right: 1px solid var(--border);
            overflow-y: auto;
            overflow-x: hidden;
            transition: transform var(--transition-base), background var(--transition-base);
            z-index: 1020;
            box-shadow: var(--shadow);
        }

        .sidebar::-webkit-scrollbar {
            width: 6px;
        }

        .sidebar.collapsed {
            transform: translateX(-280px);
        }

        .sidebar-item {
            padding: 0.875rem 1.5rem;
            display: flex;
            align-items: center;
            gap: 0.875rem;
            color: var(--text);
            text-decoration: none;
            transition: all var(--transition-fast);
            cursor: pointer;
            border-left: 3px solid transparent;
            position: relative;
            font-weight: 500;
            font-size: 0.9375rem;
        }

        .sidebar-item::before {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 3px;
            background: var(--accent);
            transform: scaleY(0);
            transition: transform var(--transition-base);
            transform-origin: center;
        }

        .sidebar-item:hover {
            background: linear-gradient(90deg, rgba(11, 59, 97, 0.06) 0%, transparent 100%);
            color: var(--brand);
            padding-left: 1.625rem;
        }

        [data-theme="dark"] .sidebar-item:hover {
            background: linear-gradient(90deg, rgba(96, 165, 250, 0.1) 0%, transparent 100%);
        }

        [data-theme="modern"] .sidebar-item:hover {
            background: linear-gradient(90deg, rgba(37, 99, 235, 0.08) 0%, transparent 100%);
        }

        [data-theme="pastel"] .sidebar-item:hover {
            background: linear-gradient(90deg, rgba(139, 92, 246, 0.08) 0%, transparent 100%);
        }

        .sidebar-item.active {
            background: linear-gradient(90deg, rgba(11, 59, 97, 0.08) 0%, transparent 100%);
            color: var(--brand);
            font-weight: 600;
        }

        .sidebar-item.active::before {
            transform: scaleY(1);
        }

        [data-theme="dark"] .sidebar-item.active {
            background: linear-gradient(90deg, rgba(96, 165, 250, 0.12) 0%, transparent 100%);
        }

        [data-theme="modern"] .sidebar-item.active {
            background: linear-gradient(90deg, rgba(37, 99, 235, 0.1) 0%, transparent 100%);
        }

        [data-theme="pastel"] .sidebar-item.active {
            background: linear-gradient(90deg, rgba(139, 92, 246, 0.1) 0%, transparent 100%);
        }

        .sidebar-item i {
            font-size: 1.25rem;
            width: 24px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: transform var(--transition-fast);
        }

        .sidebar-item:hover i {
            transform: scale(1.05);
        }

        /* ============================
   MAIN CONTENT
   ============================ */
        .main-content {
            margin-left: 280px;
            min-height: calc(100vh - 72px);
            padding: 2rem;
            transition: margin-left var(--transition-base);
        }

        .main-content.expanded {
            margin-left: 0;
        }

        /* ============================
   CARDS
   ============================ */
        .card-modern {
            border: 0;
            background: var(--surface);
            box-shadow: var(--shadow);
            border-radius: var(--radius-md);
            overflow: hidden;
            color: var(--text);
            transition: all var(--transition-base);
            position: relative;
        }

        .card-modern::before {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: linear-gradient(90deg, var(--brand), var(--accent));
            opacity: 0;
            transition: opacity var(--transition-base);
        }

        .card-modern:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-md);
        }

        .card-modern:hover::before {
            opacity: 1;
        }

        /* ============================
   COURSE CARDS
   ============================ */
        .course-card {
            position: relative;
            overflow: hidden;
        }

        .course-thumbnail {
            height: 200px;
            width: 100%;
            object-fit: cover;
            background: linear-gradient(135deg, rgba(11, 59, 97, 0.1), rgba(212, 175, 55, 0.1));
            transition: all var(--transition-slow);
        }

        .course-card:hover .course-thumbnail {
            transform: scale(1.03);
        }

        .course-badge {
            position: absolute;
            top: 0.875rem;
            right: 0.875rem;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: var(--backdrop-blur);
            padding: 0.5rem 1rem;
            border-radius: 20px;
            font-size: 0.75rem;
            font-weight: 600;
            color: var(--brand);
            box-shadow: var(--shadow);
            transition: all var(--transition-fast);
            z-index: 10;
        }

        [data-theme="dark"] .course-badge {
            background: rgba(30, 41, 59, 0.98);
            color: var(--accent);
        }

        [data-theme="modern"] .course-badge {
            background: rgba(255, 255, 255, 0.98);
            color: var(--brand);
        }

        [data-theme="pastel"] .course-badge {
            background: rgba(254, 243, 199, 0.98);
            color: var(--brand);
        }

        .course-card:hover .course-badge {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .progress-ring {
            position: absolute;
            top: 0.875rem;
            left: 0.875rem;
            width: 52px;
            height: 52px;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: var(--backdrop-blur);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            color: var(--success);
            font-size: 0.75rem;
            box-shadow: var(--shadow);
            border: 3px solid var(--success);
            transition: all var(--transition-fast);
            z-index: 10;
        }

        [data-theme="dark"] .progress-ring {
            background: rgba(30, 41, 59, 0.98);
        }

        [data-theme="modern"] .progress-ring {
            background: rgba(255, 255, 255, 0.98);
        }

        [data-theme="pastel"] .progress-ring {
            background: rgba(254, 243, 199, 0.98);
        }

        .course-card:hover .progress-ring {
            transform: scale(1.05);
        }

        /* ============================
   STAT CARDS
   ============================ */
        .stat-card {
            background: linear-gradient(135deg, var(--brand) 0%, #0d5a8f 100%);
            color: #fff;
            border-radius: var(--radius-md);
            padding: 1.75rem;
            position: relative;
            overflow: hidden;
            transition: all var(--transition-base);
            box-shadow: var(--shadow-md);
        }

        [data-theme="dark"] .stat-card {
            background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
        }

        [data-theme="modern"] .stat-card {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        }

        [data-theme="pastel"] .stat-card {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }

        .stat-card::before {
            content: '';
            position: absolute;
            top: -60%;
            right: -25%;
            width: 240px;
            height: 240px;
            background: rgba(255, 255, 255, 0.08);
            border-radius: 50%;
            transition: transform var(--transition-slow);
        }

        .stat-card:hover::before {
            transform: scale(1.1) translate(-5px, 5px);
        }

        .stat-card:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-lg);
        }

        .stat-card h3 {
            font-size: 2.25rem;
            font-weight: 700;
            margin: 0.5rem 0;
            position: relative;
            z-index: 1;
        }

        .stat-card small {
            position: relative;
            z-index: 1;
            font-size: 0.875rem;
            opacity: 0.95;
        }

        .stat-card i {
            font-size: 3.5rem;
            opacity: 0.2;
            position: absolute;
            right: 1.25rem;
            top: 50%;
            transform: translateY(-50%);
            transition: all var(--transition-base);
        }

        .stat-card:hover i {
            opacity: 0.25;
            transform: translateY(-50%) rotate(5deg) scale(1.03);
        }

        /* ============================
   TIMELINE
   ============================ */
        .timeline-item {
            position: relative;
            padding-left: 3rem;
            padding-bottom: 2rem;
            transition: opacity var(--transition-fast);
        }

        .timeline-item:last-child {
            padding-bottom: 0;
        }

        .timeline-item:last-child::before {
            display: none;
        }

        .timeline-item::before {
            content: '';
            position: absolute;
            left: 0.6875rem;
            top: 2rem;
            bottom: 0;
            width: 2px;
            background: linear-gradient(180deg, var(--accent) 0%, transparent 100%);
        }

        .timeline-dot {
            position: absolute;
            left: 0;
            top: 0.25rem;
            width: 28px;
            height: 28px;
            background: var(--accent);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #fff;
            font-size: 0.875rem;
            box-shadow: 0 0 0 4px var(--surface), var(--shadow);
            transition: all var(--transition-base);
            z-index: 10;
        }

        .timeline-item:hover .timeline-dot {
            transform: scale(1.08);
            box-shadow: 0 0 0 6px var(--surface), var(--shadow-md);
        }

        /* ============================
   VIDEO CARDS
   ============================ */
        .video-card {
            background: var(--surface);
            border-radius: var(--radius-lg);
            box-shadow: var(--shadow);
            overflow: hidden;
            transition: all var(--transition-base);
            cursor: pointer;
            position: relative;
        }

        .video-card::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 4px;
            background: linear-gradient(90deg, var(--brand), var(--accent));
            transform: scaleX(0);
            transition: transform var(--transition-base);
            transform-origin: left;
        }

        .video-card:hover {
            transform: translateY(-4px);
            box-shadow: var(--shadow-lg);
        }

        .video-card:hover::after {
            transform: scaleX(1);
        }

        .video-thumb {
            position: relative;
            overflow: hidden;
            border-bottom: 1px solid var(--border);
        }

        .video-thumb-img {
            width: 100%;
            height: 200px;
            object-fit: cover;
            transition: transform var(--transition-slow), filter var(--transition-base);
            display: block;
        }

        .video-card:hover .video-thumb-img {
            transform: scale(1.04);
            filter: brightness(0.9);
        }

        .video-overlay {
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: radial-gradient(circle, rgba(11, 59, 97, 0.5) 0%, rgba(0, 0, 0, 0.6) 100%);
            opacity: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: opacity var(--transition-base);
        }

        [data-theme="dark"] .video-overlay {
            background: radial-gradient(circle, rgba(30, 41, 59, 0.6) 0%, rgba(0, 0, 0, 0.7) 100%);
        }

        .video-card:hover .video-overlay {
            opacity: 1;
        }

        .play-icon {
            color: #fff;
            font-size: 3.5rem;
            transition: transform var(--transition-base);
            filter: drop-shadow(0 4px 8px rgba(0, 0, 0, 0.3));
        }

        .video-card:hover .play-icon {
            transform: scale(1.1);
        }

        .video-badge {
            position: absolute;
            top: 0.875rem;
            left: 0.875rem;
            background: var(--brand);
            color: #fff;
            font-size: 0.6875rem;
            padding: 0.375rem 0.75rem;
            border-radius: 14px;
            font-weight: 600;
            box-shadow: var(--shadow);
            text-transform: uppercase;
            letter-spacing: 0.5px;
            transition: all var(--transition-fast);
            z-index: 10;
        }

        [data-theme="modern"] .video-badge {
            background: var(--accent);
        }

        [data-theme="pastel"] .video-badge {
            background: var(--accent);
        }

        .video-card:hover .video-badge {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .video-body {
            padding: 1rem 1.125rem;
        }

        .video-title {
            font-weight: 600;
            font-size: 0.9375rem;
            margin-bottom: 0.5rem;
            color: var(--text);
            line-height: 1.4;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }

        .video-author {
            color: var(--muted);
            font-size: 0.8125rem;
            margin: 0;
            display: flex;
            align-items: center;
            gap: 0.25rem;
        }

        /* ============================
   TABS
   ============================ */
        .nav-tabs-modern {
            border: 0;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
        }

        .nav-tabs-modern .nav-link {
            border: 0;
            border-radius: var(--radius-sm);
            padding: 0.75rem 1.5rem;
            color: var(--text);
            font-weight: 600;
            transition: all var(--transition-fast);
            position: relative;
            overflow: hidden;
        }

        .nav-tabs-modern .nav-link::before {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--brand);
            transform: scaleX(0);
            transition: transform var(--transition-base);
        }

        .nav-tabs-modern .nav-link:hover {
            background: rgba(11, 59, 97, 0.05);
            color: var(--brand);
        }

        [data-theme="dark"] .nav-tabs-modern .nav-link:hover {
            background: rgba(96, 165, 250, 0.08);
        }

        [data-theme="modern"] .nav-tabs-modern .nav-link:hover {
            background: rgba(37, 99, 235, 0.06);
        }

        [data-theme="pastel"] .nav-tabs-modern .nav-link:hover {
            background: rgba(139, 92, 246, 0.06);
        }

        .nav-tabs-modern .nav-link.active {
            background: var(--brand);
            color: #fff;
        }

        .nav-tabs-modern .nav-link.active::before {
            transform: scaleX(1);
        }

        /* ============================
   NOTIFICATIONS
   ============================ */
        .notification-badge {
            position: absolute;
            top: -4px;
            right: -4px;
            background: var(--danger);
            color: #fff;
            border-radius: 50%;
            width: 22px;
            height: 22px;
            font-size: 0.6875rem;
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 700;
            box-shadow: var(--shadow);
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }

        @keyframes pulse {

            0%,
            100% {
                opacity: 1;
            }

            50% {
                opacity: 0.7;
            }
        }

        /* ============================
   DROPDOWN MENU
   ============================ */
        .dropdown-menu {
            border-radius: var(--radius-md);
            background: var(--surface);
            box-shadow: var(--shadow-lg);
            animation: dropdownFade var(--transition-base) ease;
            border: 1px solid var(--border);
            padding: 0.5rem;
            min-width: 200px;
        }

        .dropdown-menu .dropdown-item {
            border-radius: var(--radius-sm);
            transition: all var(--transition-fast);
            padding: 0.625rem 1rem;
            display: flex;
            align-items: center;
            gap: 0.5rem;
        }

        .dropdown-menu .dropdown-item:hover {
            background: rgba(11, 59, 97, 0.05);
            color: var(--brand);
            transform: translateX(2px);
        }

        [data-theme="dark"] .dropdown-menu .dropdown-item:hover {
            background: rgba(96, 165, 250, 0.08);
        }

        [data-theme="modern"] .dropdown-menu .dropdown-item:hover {
            background: rgba(37, 99, 235, 0.06);
        }

        [data-theme="pastel"] .dropdown-menu .dropdown-item:hover {
            background: rgba(139, 92, 246, 0.06);
        }

        .dropdown-menu .dropdown-item:active {
            background: rgba(11, 59, 97, 0.08);
        }

        @keyframes dropdownFade {
            from {
                opacity: 0;
                transform: translateY(-8px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* ============================
   BUTTONS
   ============================ */
        .btn {
            border-radius: var(--radius-sm);
            font-weight: 600;
            transition: all var(--transition-fast);
            position: relative;
            overflow: hidden;
        }

        .btn::before {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 0;
            height: 0;
            border-radius: 50%;
            background: rgba(255, 255, 255, 0.3);
            transform: translate(-50%, -50%);
            transition: width var(--transition-base), height var(--transition-base);
        }

        .btn:hover::before {
            width: 300px;
            height: 300px;
        }

        .btn-primary {
            background: linear-gradient(135deg, var(--brand) 0%, #0d5a8f 100%);
            border: none;
            box-shadow: var(--shadow);
        }

        [data-theme="dark"] .btn-primary {
            background: linear-gradient(135deg, #1e40af 0%, #1e3a8a 100%);
        }

        [data-theme="modern"] .btn-primary {
            background: linear-gradient(135deg, #2563eb 0%, #1d4ed8 100%);
        }

        [data-theme="pastel"] .btn-primary {
            background: linear-gradient(135deg, #8b5cf6 0%, #7c3aed 100%);
        }

        .btn-primary:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .btn-primary:active {
            transform: translateY(0);
            box-shadow: var(--shadow-sm);
        }

        .btn-outline-primary {
            border: 2px solid var(--brand);
            color: var(--brand);
            background: transparent;
        }

        .btn-outline-primary:hover {
            background: var(--brand);
            color: #fff;
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .btn-outline-secondary {
            border: 2px solid var(--muted);
            color: var(--muted);
            background: transparent;
        }

        .btn-outline-secondary:hover {
            background: var(--muted);
            color: #fff;
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        .btn-outline-success {
            border: 2px solid var(--success);
            color: var(--success);
            background: transparent;
        }

        .btn-outline-success:hover {
            background: var(--success);
            color: #fff;
            transform: translateY(-1px);
            box-shadow: var(--shadow);
        }

        /* ============================
   PROGRESS BARS
   ============================ */
        .progress {
            border-radius: 10px;
            overflow: hidden;
            background: var(--border);
            box-shadow: inset 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .progress-bar {
            transition: width var(--transition-slow);
            background: linear-gradient(90deg, var(--brand), var(--accent));
            position: relative;
            overflow: hidden;
        }

        .progress-bar::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(90deg, transparent, rgba(255, 255, 255, 0.3), transparent);
            animation: shimmer 2s infinite;
        }

        @keyframes shimmer {
            0% {
                transform: translateX(-100%);
            }

            100% {
                transform: translateX(100%);
            }
        }

        /* ============================
   MODALS - ENLARGED
   ============================ */
        .modal-dialog {
            max-width: 900px;
            margin: 1.75rem auto;
        }

        .modal-dialog-centered {
            min-height: calc(100% - 3.5rem);
        }

        .video-modal .modal-dialog {
            max-width: 1200px;
            height: 95%;
        }

        .video-modal .modal-content {
            /* Make the content container fill the entire dialog height */
            height: 100%;
            /* Use flexbox to control the direct children (header, body) */
            display: flex;
            flex-direction: column;
        }

        .video-modal .modal-body {
            /* This is the key: tells the body to grow and fill remaining space */
            flex-grow: 1;
            /* This prevents content from overflowing on small screens */
            overflow: hidden;
        }

        /* Ensure the iframe itself also respects the container height */
        .video-modal .video-container iframe {
            height: 100%;
            width: 100%;
        }

        .document-modal .modal-dialog {
            max-width: 1100px;
        }

        .modal-content {
            border-radius: var(--radius-lg);
            border: none;
            box-shadow: var(--shadow-xl);
            overflow: hidden;
            background: var(--surface);
        }

        .modal-header {
            border-bottom: 1px solid var(--border);
            padding: 1.75rem 2rem;
            background: linear-gradient(135deg, rgba(11, 59, 97, 0.03), transparent);
        }

        [data-theme="dark"] .modal-header {
            background: linear-gradient(135deg, rgba(96, 165, 250, 0.05), transparent);
        }

        [data-theme="modern"] .modal-header {
            background: linear-gradient(135deg, rgba(37, 99, 235, 0.04), transparent);
        }

        [data-theme="pastel"] .modal-header {
            background: linear-gradient(135deg, rgba(139, 92, 246, 0.04), transparent);
        }

        .modal-title {
            font-size: 1.5rem;
            font-weight: 700;
            color: var(--brand);
        }

        .modal-body {
            padding: 2rem;
        }

        .modal-backdrop {
            backdrop-filter: blur(4px);
            background: rgba(0, 0, 0, 0.5);
        }

        [data-theme="dark"] .modal-backdrop {
            background: rgba(0, 0, 0, 0.7);
        }

        .btn-close {
            background: transparent url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23000'%3e%3cpath d='M.293.293a1 1 0 011.414 0L8 6.586 14.293.293a1 1 0 111.414 1.414L9.414 8l6.293 6.293a1 1 0 01-1.414 1.414L8 9.414l-6.293 6.293a1 1 0 01-1.414-1.414L6.586 8 .293 1.707a1 1 0 010-1.414z'/%3e%3c/svg%3e") center/1em auto no-repeat;
            width: 1.5rem;
            height: 1.5rem;
            opacity: 0.6;
            transition: all var(--transition-fast);
        }

        .btn-close:hover {
            opacity: 1;
            transform: rotate(90deg);
        }

        [data-theme="dark"] .btn-close {
            filter: invert(1) grayscale(100%) brightness(200%);
        }

        /* ============================
   FORM CONTROLS
   ============================ */
        .form-control,
        .form-select {
            border-radius: var(--radius-sm);
            border: 2px solid var(--border);
            transition: all var(--transition-fast);
            background: var(--soft);
            color: var(--text);
            padding: 0.625rem 1rem;
            font-size: 0.9375rem;
        }

        .form-control:focus,
        .form-select:focus {
            border-color: var(--brand);
            box-shadow: 0 0 0 3px rgba(11, 59, 97, 0.08);
            outline: none;
            background: var(--surface);
        }

        [data-theme="dark"] .form-control:focus,
        [data-theme="dark"] .form-select:focus {
            box-shadow: 0 0 0 3px rgba(96, 165, 250, 0.12);
        }

        [data-theme="modern"] .form-control:focus,
        [data-theme="modern"] .form-select:focus {
            box-shadow: 0 0 0 3px rgba(37, 99, 235, 0.1);
        }

        [data-theme="pastel"] .form-control:focus,
        [data-theme="pastel"] .form-select:focus {
            box-shadow: 0 0 0 3px rgba(139, 92, 246, 0.1);
        }

        .form-control::placeholder {
            color: var(--muted);
            opacity: 0.65;
        }

        /* ============================
   LOADER
   ============================ */
        .loader {
            width: 48px;
            height: 48px;
            border: 4px solid var(--border);
            border-top-color: var(--brand);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin: 0 auto;
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        /* ============================
   FADE IN ANIMATION
   ============================ */
        .fade-in {
            animation: fadeIn 0.5s ease-in-out both;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(12px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Staggered animation for grids */
        .fade-in:nth-child(1) {
            animation-delay: 0.05s;
        }

        .fade-in:nth-child(2) {
            animation-delay: 0.1s;
        }

        .fade-in:nth-child(3) {
            animation-delay: 0.15s;
        }

        .fade-in:nth-child(4) {
            animation-delay: 0.2s;
        }

        .fade-in:nth-child(5) {
            animation-delay: 0.25s;
        }

        .fade-in:nth-child(6) {
            animation-delay: 0.3s;
        }

        .fade-in:nth-child(7) {
            animation-delay: 0.35s;
        }

        .fade-in:nth-child(8) {
            animation-delay: 0.4s;
        }

        .fade-in:nth-child(9) {
            animation-delay: 0.45s;
        }

        .fade-in:nth-child(10) {
            animation-delay: 0.5s;
        }

        /* ============================
   WELCOME MESSAGE
   ============================ */
        #welcomeMessage {
            color: var(--brand);
            font-size: 0.9375rem;
            margin-right: 0.75rem;
            white-space: nowrap;
            font-weight: 500;
            transition: color var(--transition-fast);
        }

        [data-theme="dark"] #welcomeMessage {
            color: var(--accent);
        }

        [data-theme="modern"] #welcomeMessage {
            color: var(--brand);
        }

        [data-theme="pastel"] #welcomeMessage {
            color: var(--brand);
        }

        /* ============================
   BREADCRUMB
   ============================ */
        #breadcrumb {
            font-size: 0.875rem;
            color: var(--muted);
            display: flex;
            align-items: center;
            gap: 0.25rem;
            /* Reduced gap since the icon provides spacing */
            flex-wrap: wrap;
        }

        /* Common styles for both links and the current item */
        .breadcrumb-link,
        .breadcrumb-current {
            display: inline-block;
            padding: 0.3rem 0.75rem;
            border-radius: var(--radius-sm);
            background-color: var(--surface);
            border: 1px solid var(--border);
            font-weight: 500;
            transition: all var(--transition-fast);
        }

        /* Styles specific to the clickable links */
        .breadcrumb-link {
            color: var(--brand);
            text-decoration: none;
        }

        /* Hover effect for the links */
        .breadcrumb-link:hover {
            background-color: var(--brand);
            color: #fff;
            border-color: var(--brand);
            transform: translateY(-2px);
            box-shadow: var(--shadow-sm);
        }

        /* Styles for the current, non-clickable item */
        .breadcrumb-current {
            color: var(--text);
            background-color: var(--soft);
            /* A slightly different background */
        }

        [data-theme="dark"] #breadcrumb a:hover {
            background: rgba(96, 165, 250, 0.08);
        }

        [data-theme="modern"] #breadcrumb a:hover {
            background: rgba(37, 99, 235, 0.06);
        }

        [data-theme="pastel"] #breadcrumb a:hover {
            background: rgba(139, 92, 246, 0.06);
        }

        /* ============================
   ALERTS & TOASTS
   ============================ */
        .alert {
            border-radius: var(--radius-md);
            border: none;
            box-shadow: var(--shadow);
            animation: slideInRight 0.3s ease-out;
            padding: 1rem 1.25rem;
        }

        @keyframes slideInRight {
            from {
                transform: translateX(100%);
                opacity: 0;
            }

            to {
                transform: translateX(0);
                opacity: 1;
            }
        }

        .alert-success {
            background: linear-gradient(135deg, var(--success) 0%, #0d9488 100%);
            color: #fff;
        }

        .alert-info {
            background: linear-gradient(135deg, var(--info) 0%, #2563eb 100%);
            color: #fff;
        }

        .alert-warning {
            background: linear-gradient(135deg, var(--warning) 0%, #f59e0b 100%);
            color: #fff;
        }

        .alert-danger {
            background: linear-gradient(135deg, var(--danger) 0%, #dc2626 100%);
            color: #fff;
        }

        /* ============================
   PROFILE DROPDOWN
   ============================ */
        #profileDropdown img {
            transition: all var(--transition-fast);
            box-shadow: var(--shadow);
        }

        #profileDropdown:hover img {
            transform: scale(1.03);
            box-shadow: var(--shadow-md);
        }

        .dropdown-toggle::after {
            transition: transform var(--transition-fast);
        }

        .dropdown-toggle[aria-expanded="true"]::after {
            transform: rotate(180deg);
        }

        /* ============================
   VIDEO/DOCUMENT CONTAINERS
   ============================ */
        .video-container,
        .document-container {
            position: relative;
            width: 100%;
            padding-bottom: 56.25%;
            /* 16:9 aspect ratio */
            background: #000;
            border-radius: var(--radius-md);
            overflow: hidden;
            min-height: 500px;
        }

        .video-container iframe,
        .document-container iframe {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            border: none;
        }

        /* ============================
   CALENDAR EVENTS
   ============================ */
        #calendarEvents .d-flex {
            padding: 1rem;
            border-radius: var(--radius-sm);
            transition: all var(--transition-fast);
            cursor: pointer;
        }

        #calendarEvents .d-flex:hover {
            background: rgba(11, 59, 97, 0.03);
            transform: translateX(4px);
        }

        [data-theme="dark"] #calendarEvents .d-flex:hover {
            background: rgba(96, 165, 250, 0.05);
        }

        [data-theme="modern"] #calendarEvents .d-flex:hover {
            background: rgba(37, 99, 235, 0.04);
        }

        [data-theme="pastel"] #calendarEvents .d-flex:hover {
            background: rgba(139, 92, 246, 0.04);
        }

        #calendarEvents .bg-primary,
        #calendarEvents .bg-warning {
            border-radius: var(--radius-sm);
            box-shadow: var(--shadow);
            transition: all var(--transition-fast);
        }

        #calendarEvents .d-flex:hover .bg-primary,
        #calendarEvents .d-flex:hover .bg-warning {
            transform: scale(1.03);
            box-shadow: var(--shadow-md);
        }

        /* ============================
   NOTES CARDS
   ============================ */
        #notesList .card-modern {
            border-left: 4px solid var(--accent);
        }

        #notesList .card-modern:hover {
            border-left-color: var(--brand);
        }

        /* ============================
   CHART CONTAINER
   ============================ */
        #progressChart {
            border-radius: var(--radius-md);
            padding: 1rem;
        }

        /* ============================
   THEME SELECT
   ============================ */
        #themeSelect {
            background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' width='16' height='16' fill='%23666' viewBox='0 0 16 16'%3E%3Cpath d='M7.247 11.14L2.451 5.658C1.885 5.013 2.345 4 3.204 4h9.592a1 1 0 0 1 .753 1.659l-4.796 5.48a1 1 0 0 1-1.506 0z'/%3E%3C/svg%3E");
            background-repeat: no-repeat;
            background-position: right 0.75rem center;
            background-size: 16px 12px;
            padding-right: 2.5rem;
            cursor: pointer;
        }

        /* ============================
   AUTH MODAL ENHANCEMENTS
   ============================ */
        #modalAuth .modal-dialog {
            max-width: 550px;
        }

        #modalAuth .modal-header {
            background: linear-gradient(135deg, rgba(11, 59, 97, 0.04), transparent);
            border-bottom: 1px solid var(--border);
            padding: 1.5rem 2rem;
        }

        #modalAuth .nav-tabs-modern {
            border-bottom: none;
            margin-bottom: 0;
        }

        #modalAuth .tab-content {
            padding-top: 1rem;
        }

        #modalAuth input[type="email"],
        #modalAuth input[type="password"],
        #modalAuth input[type="text"] {
            font-size: 0.9375rem;
            padding: 0.875rem 1.125rem;
            border-radius: var(--radius-sm);
        }

        #modalAuth .btn {
            font-size: 0.9375rem;
            padding: 0.875rem;
            font-weight: 600;
        }

        #modalAuth .btn-outline-dark {
            border: 2px solid var(--border);
            color: var(--text);
        }

        #modalAuth .btn-outline-dark:hover {
            background: var(--dark-surface);
            color: #fff;
            border-color: var(--dark-surface);
        }

        [data-theme="dark"] #modalAuth .btn-outline-dark {
            border-color: var(--dark-border);
        }

        [data-theme="dark"] #modalAuth .btn-outline-dark:hover {
            background: var(--brand);
            border-color: var(--brand);
        }

        /* ============================
   EMPTY STATE
   ============================ */
        .text-center.text-muted {
            padding: 3rem 1rem;
            color: var(--brand);
        }

        .text-center.text-muted i {
            opacity: 0.5;
            transition: all var(--transition-base);
        }

        .card-modern:hover .text-center.text-muted i {
            opacity: 0.65;
            transform: scale(1.03);
        }

        /* ============================
   BADGES & LABELS
   ============================ */
        .badge {
            padding: 0.375rem 0.75rem;
            border-radius: 12px;
            font-weight: 600;
            font-size: 0.75rem;
            letter-spacing: 0.3px;
        }

        /* ============================
   RESPONSIVE ADJUSTMENTS
   ============================ */
        @media (max-width: 1399px) {
            .main-content {
                padding: 1.5rem;
            }

            .modal-dialog {
                max-width: 800px;
            }

            .video-modal .modal-dialog {
                max-width: 1000px;
            }
        }

        @media (max-width: 1199px) {
            .stat-card h3 {
                font-size: 2rem;
            }

            .stat-card i {
                font-size: 3rem;
            }

            .modal-dialog {
                max-width: 700px;
            }
        }

        @media (max-width: 991px) {
            .sidebar {
                transform: translateX(-280px);
                box-shadow: none;
            }

            .sidebar.show {
                transform: translateX(0);
                box-shadow: var(--shadow-xl);
            }

            .main-content {
                margin-left: 0;
                padding: 1.5rem;
            }

            .search-box {
                max-width: 100%;
            }

            .navbar-brand div {
                font-size: 0.8125rem;
            }

            .stat-card {
                padding: 1.5rem;
            }

            .stat-card h3 {
                font-size: 1.75rem;
            }

            .video-thumb-img {
                height: 180px;
            }

            .modal-dialog {
                max-width: 90%;
                margin: 1rem auto;
            }

            .modal-body {
                padding: 1.5rem;
            }

            .modal-header {
                padding: 1.25rem 1.5rem;
            }
        }

        @media (max-width: 767px) {
            .main-content {
                padding: 1rem;
            }

            .navbar-brand img {
                height: 36px;
            }

            .course-thumbnail {
                height: 160px;
            }

            .stat-card {
                padding: 1.25rem;
            }

            .stat-card h3 {
                font-size: 1.5rem;
            }

            .stat-card i {
                font-size: 2.5rem;
                right: 1rem;
            }

            .card-modern {
                border-radius: var(--radius-sm);
            }

            .video-thumb-img {
                height: 160px;
            }

            .timeline-item {
                padding-left: 2.5rem;
            }

            .dropdown-menu {
                min-width: 280px;
            }

            #modalAuth .modal-body {
                padding: 1.5rem 1rem;
            }

            .modal-dialog {
                max-width: 95%;
                margin: 0.5rem auto;
            }

            .modal-title {
                font-size: 1.25rem;
            }

            .video-container,
            .document-container {
                min-height: 350px;
            }
        }

        @media (max-width: 575px) {
            h2 {
                font-size: 1.5rem;
            }

            .stat-card h3 {
                font-size: 1.25rem;
            }

            .stat-card::before {
                width: 180px;
                height: 180px;
            }

            .play-icon {
                font-size: 2.5rem;
            }

            .course-thumbnail {
                height: 140px;
            }

            .video-thumb-img {
                height: 140px;
            }

            .navbar {
                padding: 0.5rem 0.75rem;
            }

            .search-box input {
                font-size: 0.875rem;
                padding: 0.5rem 0.875rem 0.5rem 2.5rem;
            }

            .search-box i {
                left: 0.875rem;
                font-size: 1rem;
            }

            .video-container,
            .document-container {
                min-height: 280px;
            }

            .modal-header {
                padding: 1rem;
            }

            .modal-body {
                padding: 1rem;
            }
        }

        /* ============================
   PRINT STYLES
   ============================ */
        @media print {

            .navbar,
            .sidebar,
            .btn,
            .dropdown {
                display: none !important;
            }

            .main-content {
                margin-left: 0 !important;
            }

            .card-modern {
                box-shadow: none !important;
                page-break-inside: avoid;
            }
        }

        /* ============================
   ACCESSIBILITY IMPROVEMENTS
   ============================ */
        .visually-hidden {
            position: absolute;
            width: 1px;
            height: 1px;
            padding: 0;
            margin: -1px;
            overflow: hidden;
            clip: rect(0, 0, 0, 0);
            white-space: nowrap;
            border-width: 0;
        }

        :focus-visible {
            outline: 2px solid var(--accent);
            outline-offset: 2px;
        }

        /* High contrast mode support */
        @media (prefers-contrast: high) {
            .card-modern {
                border: 2px solid var(--border);
            }

            .btn {
                border: 2px solid currentColor;
            }
        }

        /* Reduced motion support */
        @media (prefers-reduced-motion: reduce) {

            *,
            *::before,
            *::after {
                animation-duration: 0.01ms !important;
                animation-iteration-count: 1 !important;
                transition-duration: 0.01ms !important;
                scroll-behavior: auto !important;
            }
        }

        /* ============================
   UTILITY CLASSES
   ============================ */
        .text-gradient {
            background: linear-gradient(135deg, var(--brand), var(--accent));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .glass-effect {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: var(--backdrop-blur);
            -webkit-backdrop-filter: var(--backdrop-blur);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }

        [data-theme="dark"] .glass-effect {
            background: rgba(30, 41, 59, 0.5);
            border: 1px solid rgba(255, 255, 255, 0.1);
        }

        .hover-lift {
            transition: transform var(--transition-fast);
        }

        .hover-lift:hover {
            transform: translateY(-2px);
        }

        .text-shadow {
            text-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }

        .box-glow {
            box-shadow: 0 0 20px rgba(11, 59, 97, 0.3);
        }

        [data-theme="dark"] .box-glow {
            box-shadow: 0 0 20px rgba(96, 165, 250, 0.3);
        }

        /* ============================
   SKELETON LOADING
   ============================ */
        .skeleton {
            background: linear-gradient(90deg,
                    var(--border) 0%,
                    var(--soft) 50%,
                    var(--border) 100%);
            background-size: 200% 100%;
            animation: skeleton-loading 1.5s ease-in-out infinite;
            border-radius: var(--radius-sm);
        }

        @keyframes skeleton-loading {
            0% {
                background-position: 200% 0;
            }

            100% {
                background-position: -200% 0;
            }
        }

        /* ============================
   CUSTOM SELECT STYLING
   ============================ */
        .form-select {
            cursor: pointer;
            appearance: none;
            -webkit-appearance: none;
            -moz-appearance: none;
        }

        .form-select::-ms-expand {
            display: none;
        }

        /* ============================
   LOADING STATE
   ============================ */
        .loading {
            pointer-events: none;
            opacity: 0.6;
            position: relative;
        }

        .loading::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 24px;
            height: 24px;
            margin: -12px 0 0 -12px;
            border: 3px solid var(--border);
            border-top-color: var(--brand);
            border-radius: 50%;
            animation: spin 0.8s linear infinite;
        }

        /* ============================
   ENHANCED TRANSITIONS
   ============================ */
        .card-body {
            transition: all var(--transition-base);
        }

        /* Smooth color transitions for theme changes */
        * {
            transition-property: background-color, border-color, color, fill, stroke;
            transition-duration: var(--transition-base);
            transition-timing-function: ease-in-out;
        }

        /* Exclude specific properties from global transition */
        *:not(.no-transition) {
            transition: background-color var(--transition-base),
                border-color var(--transition-base),
                color var(--transition-base);
        }

        .video-card.playlist .video-thumb {
            background: linear-gradient(135deg,
                    var(--brand, #0b3b61),
                    var(--accent, #d4af37));
            border-radius: var(--radius-md);
            display: flex;
            justify-content: center;
            align-items: center;
            position: relative;
            overflow: hidden;
            box-shadow: var(--shadow-md);
            padding: 15px;
            min-height: 200px;
            transition: transform var(--transition-base), box-shadow var(--transition-base);
        }

        .video-card.playlist:hover {
            transform: translateY(-3px);
            box-shadow: var(--shadow-lg);
        }

        .video-card.playlist .video-thumb img {
            display: none;
            /* Hide the default thumbnail for playlists */
        }

        .video-card.playlist .playlist-title {
            color: var(--surface);
            font-weight: 600;
            font-size: 1rem;
            text-align: center;
            z-index: 2;
            line-height: 1.2;
        }

        /* Ensure chart canvases are responsive */
        canvas {
            max-width: 100%;
            height: auto !important;
        }

        /* ============================
   HISTORY PANEL STYLING (THEME-AWARE)
   ============================ */
        #playlistPanel .card {
            /* Use a slightly different background to distinguish the panel from the modal body */
            background-color: var(--soft);
            /* Add a subtle border to separate it from the video player */
            border-left: 1px solid var(--border);
            /* Remove the card's default border and shadow as it's inside the modal */
            border-top: none;
            border-right: none;
            border-bottom: none;
            box-shadow: none;
        }

        #historyQueue {
            overflow-y: auto;
            /* Enable scrolling for long history */
        }

        /* Custom scrollbar for the history queue to make it more subtle */
        #historyQueue::-webkit-scrollbar {
            width: 6px;
        }

        #historyQueue::-webkit-scrollbar-thumb {
            background: var(--border);
            border-radius: 3px;
        }

        #historyQueue::-webkit-scrollbar-thumb:hover {
            background: var(--muted);
        }

        .history-item {
            display: flex;
            align-items: center;
            gap: 0.75rem;
            padding: 0.5rem;
            border-radius: var(--radius-sm);
            cursor: pointer;
            transition: all var(--transition-fast);
            border: 1px solid transparent;
            border-bottom: 1px solid var(--border);
            background-color: transparent;
            width: 100%;
            text-align: left;
        }

        .history-item:last-child {
            border-bottom: none;
        }

        .history-item:hover {
            /* On hover, use the main surface color and the theme's accent color for the border */
            background-color: var(--surface);
            border-color: var(--accent);
            transform: translateX(2px);
        }

        .history-item.active {
            /* The active item uses the theme's primary brand colors */
            background-color: var(--brand);
            color: #fff;
            /* A safe default for brand text color */
            border-color: var(--brand);
            box-shadow: var(--shadow-sm);
        }

        .history-item.active .history-title {
            color: #fff !important;
        }

        /* Visual indicator for the currently playing item */
        .history-item.active::before {
            content: "\f4f4";
            /* Bootstrap Icon: play-circle-fill */
            font-family: "bootstrap-icons";
            font-size: 1.2rem;
            color: #fff;
            /* White icon on the brand background */
            margin-right: 0.5rem;
            animation: pulse-icon 1.5s infinite ease-in-out;
        }

        @keyframes pulse-icon {

            0%,
            100% {
                transform: scale(1);
            }

            50% {
                transform: scale(1.1);
            }
        }

        .history-item img {
            width: 80px;
            height: 45px;
            object-fit: cover;
            border-radius: var(--radius-sm);
            flex-shrink: 0;
        }

        .history-title {
            font-size: 0.8rem;
            font-weight: 600;
            color: var(--text);
            /* Theme-aware text color */
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
            overflow: hidden;
        }


        /* ============================
   PROFESSIONAL NOTIFICATIONS
   ============================ */
        #notifListContainer {
            max-height: 400px;
            overflow-y: auto;
        }

        .notification-item {
            display: flex;
            gap: 0.75rem;
            padding: 0.75rem;
            border: none !important;
            border-bottom: 1px solid var(--border) !important;
            background-color: transparent;
            transition: background-color var(--transition-fast);
        }

        .notification-item:hover {
            background-color: var(--soft);
        }

        .notification-item.unread {
            background-color: rgba(var(--brand-rgb), 0.05);
            /* Subtle highlight */
        }

        [data-theme="dark"] .notification-item.unread {
            background-color: rgba(var(--brand-rgb), 0.1);
        }

        .notification-item .icon {
            font-size: 1.5rem;
            min-width: 2rem;
            text-align: center;
        }

        .notification-item .content {
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .notification-item .timestamp {
            font-size: 0.75rem;
            color: var(--muted);
        }

        /* ============================
   QUILL CONTENT STYLING FIX
   ============================ */
        /* Target the read-only containers for discussion content */
        #threadContent .ql-editor,
        #repliesContainer .ql-editor {
            /* Use your theme's surface color for the background */
            background-color: var(--surface);
            /* Use your theme's text color */
            color: var(--text);
            /* Remove padding, as the card-body already has it */
            padding: 4px 8px;
            font-size: 1rem;
            border-radius: 8px;
            /* Prevent the container from collapsing */
            min-height: 1rem;
        }

        /* Override styles for list items within Quill content */
        .ql-editor ol li,
        .ql-editor ul li {
            background: transparent !important;
            /* Force transparent background */
            color: var(--text) !important;
            /* Force theme text color */
        }

        /* Override styles for code blocks, which often have a dark default */
        .ql-editor pre.ql-syntax {
            background-color: var(--soft) !important;
            /* Use your soft background */
            color: var(--text) !important;
            border-radius: var(--radius-sm);
            padding: 1rem;
        }

        /* ============================
   PERFECT TOAST NOTIFICATIONS
   ============================ */
        #toastContainer {
            z-index: 1100;
            /* Ensure it's on top of modals */
        }

        .custom-toast {
            /* Use theme variables for background and text color */
            color: #fff;
            border: none;
            border-radius: var(--radius-md);
            box-shadow: var(--shadow-lg);
            backdrop-filter: blur(8px);
            -webkit-backdrop-filter: blur(8px);
            padding: 0.75rem 1.25rem;
        }

        /* Specific theme colors */
        .custom-toast.alert-success {
            background: linear-gradient(135deg, rgba(16, 185, 129, 0.85), rgba(5, 150, 105, 0.85));
        }

        .custom-toast.alert-danger {
            background: linear-gradient(135deg, rgba(239, 68, 68, 0.85), rgba(220, 38, 38, 0.85));
        }

        .custom-toast.alert-warning {
            background: linear-gradient(135deg, rgba(245, 158, 11, 0.85), rgba(217, 119, 6, 0.85));
        }

        .custom-toast.alert-info {
            background: linear-gradient(135deg, rgba(59, 130, 246, 0.85), rgba(37, 99, 235, 0.85));
        }

        .custom-toast .btn-close {
            /* Custom styling for the close button */
            background: rgba(255, 255, 255, 0.2) url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 16 16' fill='%23fff'%3e%3cpath d='M.293.293a1 1 0 011.414 0L8 6.586 14.293.293a1 1 0 111.414 1.414L9.414 8l6.293 6.293a1 1 0 01-1.414 1.414L8 9.414l-6.293 6.293a1 1 0 01-1.414-1.414L6.586 8 .293 1.707a1 1 0 010-1.414z'/%3e%3c/svg%3e") center/0.7em auto no-repeat;
            border-radius: var(--radius-sm);
            opacity: 0.8;
            transition: all var(--transition-fast);
        }

        .custom-toast .btn-close:hover {
            background-color: rgba(255, 255, 255, 0.3);
            opacity: 1;
            transform: scale(1.1);
        }
    </style>
</head>

<body data-theme="light"> <!-- Thème par défaut -->

    <!-- Navigation -->
    <nav class="navbar navbar-expand-lg sticky-top">
        <div class="container-fluid">
            <!-- Sidebar Toggle -->
            <button class="btn btn-link me-2 d-lg-none" id="sidebarToggle">
                <i class="bi bi-list fs-4"></i>
            </button>

            <!-- Logo -->
            <a class="navbar-brand d-flex gap-3 align-items-center" href="#">
                <img src="https://espace-fpn.ump.ma/src/logo.svg" alt="logo" height="44">
                <div class="d-none d-md-block">
                    <div style="font-weight:700; color:var(--brand); font-size:14px">
                        Université Mohamed Premier
                    </div>
                    <div style="font-size:11px;color:var(--muted)">
                        Faculté des Sciences - Plateforme d'Apprentissage
                    </div>
                </div>
            </a>

            <!-- Right Side -->
            <div class="d-flex ms-auto gap-3 align-items-center">

                <!-- Search Box -->
                <div class="search-box d-none d-md-block">
                    <i class="bi bi-search"></i>
                    <input type="text" class="form-control" placeholder="Rechercher des cours, matériaux..."
                        id="searchInput">
                </div>

                <!-- Notifications -->
                <div class="dropdown">
                    <button class="btn btn-link position-relative" id="notifBtn" data-bs-toggle="dropdown"
                        aria-expanded="false">
                        <i class="bi bi-bell fs-5"></i>
                        <!-- Unread count badge (will be managed by JS) -->
                        <span class="notification-badge d-none" id="notifCount">0</span>
                    </button>
                    <div class="dropdown-menu dropdown-menu-end shadow-lg border-0 p-2" id="notifDropdown"
                        style="width:350px;">
                        <div class="px-3 py-2 d-flex justify-content-between align-items-center">
                            <h6 class="dropdown-header p-0">Notifications</h6>
                            <button class="btn btn-sm btn-link" id="markAllAsReadBtn">Tout marquer comme lu</button>
                        </div>
                        <div id="notifListContainer" class="list-group list-group-flush">
                            <!-- Notifications will be loaded here -->
                            <div class="text-center text-muted p-4">Chargement...</div>
                        </div>
                        <div class="text-center mt-2">
                            <a class="dropdown-item text-center" href="#" data-view="notifications">
                                Voir toutes les notifications
                            </a>
                        </div>
                    </div>
                </div>
                <!-- Profile Dropdown -->
                <div class="dropdown" id="profileDropdown" style="display: none;">
                    <a href="#" class="d-flex align-items-center gap-2 text-decoration-none dropdown-toggle"
                        id="profileMenu" data-bs-toggle="dropdown" aria-expanded="false">
                        <img id="userPhoto" src="" alt="Avatar"
                            style="width:40px;height:40px;border-radius:50%;object-fit:cover;border:2px solid var(--accent)">
                        <span id="userName" class="fw-semibold d-none d-md-inline"></span>
                    </a>
                    <ul class="dropdown-menu dropdown-menu-end shadow-sm border-0 p-2" aria-labelledby="profileMenu">
                        <li class="px-3 pb-2 border-bottom">
                            <small class="text-muted" id="userEmail"></small>
                        </li>
                        <li><a class="dropdown-item" href="#" data-view="settings"><i
                                    class="bi bi-gear me-2"></i>Paramètres</a></li>
                        <li><button class="dropdown-item text-danger" id="btnLogout"><i
                                    class="bi bi-box-arrow-right me-2"></i>Déconnexion</button></li>
                    </ul>
                </div>

                <!-- Login Button -->
                <button id="btnLogin" class="btn btn-primary">Se connecter</button>

            </div>
        </div>
    </nav>


    <!-- Sidebar -->
    <aside class="sidebar" id="sidebar">
        <div class="p-3">
            <h6 class="text-muted text-uppercase" style="font-size:11px; letter-spacing:1px">Navigation</h6>
        </div>

        <a class="sidebar-item active" data-view="dashboard">
            <i class="bi bi-speedometer2"></i>
            <span>Tableau de bord</span>
        </a>
        <a class="sidebar-item" data-view="courses">
            <i class="bi bi-collection"></i>
            <span>Tous les cours</span>
        </a>
        <a class="sidebar-item" data-view="videos">
            <i class="bi bi-play-circle"></i>
            <span>Tutoriels vidéo</span>
        </a>
        <a class="sidebar-item" data-view="contributed">
            <i class="bi bi-people"></i>
            <span>Contenu contribué</span>
        </a>
        <a class="sidebar-item" data-view="documents">
            <i class="bi bi-file-earmark-text"></i>
            <span>Documents</span>
        </a>
        <a class="sidebar-item" data-view="assignments">
            <i class="bi bi-clipboard-check"></i>
            <span>Devoirs</span>
        </a>
        <a class="sidebar-item" data-view="calendar">
            <i class="bi bi-calendar-event"></i>
            <span>Calendrier</span>
        </a>

        <a class="sidebar-item" data-view="discussions">
            <i class="bi bi-chat-square-dots"></i>
            <span>Discussions</span>
        </a>
        <a class="sidebar-item" data-view="notifications">
            <i class="bi bi-bell"></i>
            <span>Notifications</span>
        </a>
        <div class="p-3 mt-3">
            <h6 class="text-muted text-uppercase" style="font-size:11px; letter-spacing:1px">Outils</h6>
        </div>

        <a class="sidebar-item" data-view="notes">
            <i class="bi bi-journal-text"></i>
            <span>Mes notes</span>
        </a>
        <a class="sidebar-item" data-view="progress">
            <i class="bi bi-graph-up"></i>
            <span>Suivi des progrès</span>
        </a>
        <a class="sidebar-item" data-view="settings">
            <i class="bi bi-gear"></i>
            <span>Paramètres</span>
        </a>
    </aside>

    <!-- Main Content -->
    <main class="main-content" id="mainContent">
        <!-- Tableau de bord View -->
        <div id="dashboardView" class="view-content">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <div>
                    <h2 style="color:var(--brand); font-weight:700">
                        Bienvenue de retour, <span id="welcomeUserName" style="color:var(--accent)"></span> !
                    </h2>

                    <p class="text-muted">Continuez votre parcours d'apprentissage</p>
                </div>
                <div class="d-flex gap-2">
                    <select class="form-select" id="semesterFilter">
                        <option>Tous les semestres</option>
                        <option>Semestre 1</option>
                        <option>Semestre 2</option>
                    </select>
                </div>
            </div>

            <!-- Stats -->
            <div class="row g-4 mb-4">
                <div class="col-md-3">
                    <div class="stat-card">
                        <i class="bi bi-book"></i>
                        <div style="position:relative; z-index:1">
                            <small style="opacity:0.9">Total des cours</small>
                            <h3 id="totalCourses">0</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card" style="background:linear-gradient(135deg, var(--success), #20c997)">
                        <i class="bi bi-check-circle"></i>
                        <div style="position:relative; z-index:1">
                            <small style="opacity:0.9">Complétés</small>
                            <h3 id="completedCourses">0</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card" style="background:linear-gradient(135deg, var(--accent), #e6c84f)">
                        <i class="bi bi-clock-history"></i>
                        <div style="position:relative; z-index:1">
                            <small style="opacity:0.9">En cours</small>
                            <h3 id="inProgressCourses">0</h3>
                        </div>
                    </div>
                </div>
                <div class="col-md-3">
                    <div class="stat-card" style="background:linear-gradient(135deg, #6f42c1, #8b5cf6)">
                        <i class="bi bi-trophy"></i>
                        <div style="position:relative; z-index:1">
                            <small style="opacity:0.9">Score d'accomplissement</small>
                            <h3>85%</h3>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Continuer l'apprentissage -->
            <div class="card card-modern mb-4">
                <div class="card-body">
                    <h5 class="mb-3"><i class="bi bi-play-circle me-2"></i>Continuer l'apprentissage</h5>
                    <div class="row g-3" id="continueSection">
                        <div class="col-12 text-center text-muted py-4">
                            <i class="bi bi-folder2-open fs-1"></i>
                            <p class="mt-2">Chargement de vos cours...</p>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Activité récente -->
            <div class="row g-4">
                <div class="col-lg-8">
                    <div class="card card-modern">
                        <div class="card-body">
                            <h5 class="mb-4"><i class="bi bi-clock-history me-2"></i>Activité récente</h5>
                            <div id="activityTimeline">
                                <div class="timeline-item">
                                    <div class="timeline-dot"><i class="bi bi-check"></i></div>
                                    <div>
                                        <strong>Complété : Module de conception d'algorithmes</strong>
                                        <p class="text-muted small mb-0">Il y a 2 heures</p>
                                    </div>
                                </div>
                                <div class="timeline-item">
                                    <div class="timeline-dot"><i class="bi bi-file-earmark"></i></div>
                                    <div>
                                        <strong>Téléchargé : Notes de cours sur les structures de données</strong>
                                        <p class="text-muted small mb-0">Hier</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="card card-modern">
                        <div class="card-body">
                            <h5 class="mb-4"><i class="bi bi-calendar-event me-2"></i>À venir</h5>
                            <div class="d-flex flex-column gap-3">
                                <div class="d-flex gap-3 align-items-center">
                                    <div class="bg-primary text-white p-2 rounded"
                                        style="min-width:48px; text-align:center">
                                        <div style="font-size:20px; font-weight:700">18</div>
                                        <div style="font-size:10px">OCT</div>
                                    </div>
                                    <div>
                                        <strong style="font-size:14px">Examen de base de données</strong>
                                        <p class="text-muted small mb-0">10:00</p>
                                    </div>
                                </div>
                                <div class="d-flex gap-3 align-items-center">
                                    <div class="bg-warning text-white p-2 rounded"
                                        style="min-width:48px; text-align:center">
                                        <div style="font-size:20px; font-weight:700">20</div>
                                        <div style="font-size:10px">OCT</div>
                                    </div>
                                    <div>
                                        <strong style="font-size:14px">Soumission de projet</strong>
                                        <p class="text-muted small mb-0">23:59</p>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Tous les cours View -->
        <div id="coursesView" class="view-content d-none">
            <div id="breadcrumb" class="mb-3"></div>
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 style="color:var(--brand); font-weight:700">Tous les cours</h2>
                <div class="d-flex gap-2">
                    <select class="form-select" id="categoryFilter">
                        <option value="all">Toutes les catégories</option>
                        <option value="video">Vidéos</option>
                        <option value="document">Documents</option>
                        <option value="folder">Dossiers</option>
                    </select>
                    <select class="form-select" id="sortBy">
                        <option>Trier par nom</option>
                        <option>Trier par date</option>
                        <option>Trier par type</option>
                    </select>
                </div>
            </div>

            <div id="loader" class="py-5 text-center">
                <div class="loader"></div>
                <div class="mt-3 text-muted">Chargement des cours depuis Drive...</div>
            </div>

            <div class="row g-4" id="coursesGrid"></div>
            <div class="card card-modern mt-4 d-none" id="folderContributedSection">
                <div class="card-body">
                    <h5 class="mb-3">Tutoriels contribués pour ce cours</h5>
                    <div class="row g-4" id="folderContributedGrid"></div>
                </div>
            </div>
        </div>

        <!-- Tutoriels vidéo View -->
        <div id="videosView" class="view-content d-none">
            <h2 class="mb-4" style="color:var(--brand); font-weight:700">Tutoriels vidéo</h2>
            <div class="row g-4" id="videosGrid"></div>
            <div class="card card-modern mt-4">
                <div class="card-body">
                    <h5 class="mb-3">Tutoriels YouTube recommandés</h5>
                    <div class="row g-4" id="youtubeVideosGrid"></div>
                </div>
            </div>
            <div class="card card-modern mt-4">
                <div class="card-body">
                    <h5 class="mb-3">Tutoriels contribués</h5>
                    <div class="row g-4" id="contributedVideosGrid"></div>
                </div>
            </div>
        </div>

        <!-- Contenu contribué View -->
        <div id="contributedView" class="view-content d-none">
            <h2 class="mb-4" style="color:var(--brand); font-weight:700">Contenu contribué</h2>
            <!-- In #contributedView -->
            <form id="addContentForm" class="card card-modern mb-4">
                <div class="card-body">
                    <h5 class="card-title mb-3">Partager une ressource</h5>
                    <div class="row g-3">
                        <div class="col-md-6">
                            <label for="contentUrl" class="form-label">URL de la ressource</label>
                            <input id="contentUrl" class="form-control" placeholder="Collez l'URL ici..." required>
                        </div>
                        <div class="col-md-6">
                            <label for="contentType" class="form-label">Type de contenu</label>
                            <select id="contentType" class="form-select" required>
                                <option value="youtube" selected>Vidéo / Playlist YouTube</option>
                                <option value="gdrive_video">Vidéo Google Drive</option>
                                <option value="gdrive_doc">Document Google Drive (PDF, Livre)</option>
                                <option value="link">Lien Web / Article</option>
                            </select>
                        </div>
                        <div class="col-md-6">
                            <label for="contentTitle" class="form-label">Titre (optionnel)</label>
                            <input id="contentTitle" class="form-control" placeholder="Titre personnalisé...">
                        </div>
                        <div class="col-md-6">
                            <label for="contentCourse" class="form-label">Associer à un cours (optionnel)</label>
                            <select id="contentCourse" class="form-select">
                                <option value="">Aucun cours spécifique</option>
                            </select>
                        </div>
                    </div>
                    <button class="btn btn-primary mt-3" type="submit">Ajouter le contenu</button>
                </div>
            </form>
            <div class="row g-4" id="contributedGrid"></div>
        </div>

        <!-- Documents View 
        <div id="documentsView" class="view-content d-none">
            <h2 class="mb-4" style="color:var(--brand); font-weight:700">Documents & Matériaux</h2>
            <div class="row g-4" id="documentsGrid"></div>
        </div>-->

        <div id="documentsView" class="view-content d-none">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 style="color:var(--brand); font-weight:700">Documents & Matériaux</h2>

                <!-- START: NEW LAYOUT TOGGLE -->
                <div class="btn-group" role="group" aria-label="Layout Toggle">
                    <button type="button" class="btn btn-outline-primary active" id="btnGridDocuments">
                        <i class="bi bi-grid-3x3-gap-fill"></i> Grille
                    </button>
                    <button type="button" class="btn btn-outline-primary" id="btnListDocuments">
                        <i class="bi bi-list"></i> Liste
                    </button>
                </div>
                <!-- END: NEW LAYOUT TOGGLE -->

            </div>
            <div class="row g-4" id="documentsGrid"></div>
        </div>

        <!-- Devoirs View -->
        <div id="assignmentsView" class="view-content d-none">
            <h2 class="mb-4" style="color:var(--brand); font-weight:700">Devoirs</h2>
            <div class="row g-4" id="assignmentsGrid"></div>
        </div>

        <!-- Calendrier View 
        <div id="calendarView" class="view-content d-none">
            <h2 class="mb-4" style="color:var(--brand); font-weight:700">Calendrier</h2>
            <div class="card card-modern">
                <div class="card-body">
                    <div id="calendarEvents"></div>
                </div>
            </div>
        </div>-->


        <!-- Calendrier View -->
        <div id="calendarView" class="view-content d-none">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 style="color:var(--brand); font-weight:700">Calendrier</h2>
                <button id="addEventButton" class="btn btn-primary">
                    <i class="bi bi-plus-circle me-2"></i>Ajouter un événement
                </button>
            </div>
            <div class="card card-modern">
                <div class="card-body">
                    <!-- FullCalendar will be rendered here -->
                    <div id="calendar"></div>
                </div>
            </div>
        </div>

        <!-- Event Modal -->
        <div class="modal fade" id="eventModal" tabindex="-1" aria-labelledby="eventModalLabel" aria-hidden="true">
            <div class="modal-dialog modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="eventModalLabel">Ajouter/Modifier un événement</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="eventForm">
                            <!-- Hidden input to store event ID for updates -->
                            <input type="hidden" id="eventId">
                            <div class="mb-3">
                                <label for="eventTitle" class="form-label">Titre de l'événement</label>
                                <input type="text" class="form-control" id="eventTitle" required>
                            </div>
                            <!-- START: NEW ALARM SECTION -->
                            <div class="border-top pt-3">
                                <div class="row g-3">
                                    <div class="col-md-6">
                                        <label for="eventAlarm" class="form-label"><i
                                                class="bi bi-alarm me-2"></i>Rappel / Alarme</label>
                                        <select id="eventAlarm" class="form-select">
                                            <option value="none" selected>Aucun</option>
                                            <option value="5">5 minutes avant</option>
                                            <option value="15">15 minutes avant</option>
                                            <option value="30">30 minutes avant</option>
                                            <option value="60">1 heure avant</option>
                                        </select>
                                    </div>
                                    <div class="col-md-6">
                                        <label for="eventSound" class="form-label"><i
                                                class="bi bi-music-note-beamed me-2"></i>Son de l'alarme</label>
                                        <select id="eventSound" class="form-select">
                                            <option value="chime" selected>Carillon</option>
                                            <option value="notification">Notification</option>
                                            <option value="digital">Digital</option>
                                        </select>
                                    </div>
                                </div>
                            </div>
                            <!-- END: NEW ALARM SECTION -->
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <label for="eventStart" class="form-label">Début</label>
                                    <input type="datetime-local" class="form-control" id="eventStart" required>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <label for="eventEnd" class="form-label">Fin</label>
                                    <input type="datetime-local" class="form-control" id="eventEnd" required>
                                </div>
                            </div>
                            <div class="form-check mb-3">
                                <input class="form-check-input" type="checkbox" id="eventAllDay">
                                <label class="form-check-label" for="eventAllDay">
                                    Toute la journée
                                </label>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer justify-content-between">
                        <button type="button" class="btn btn-danger" id="deleteEventButton"
                            style="display: none;">Supprimer</button>
                        <div>
                            <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                            <button type="submit" form="eventForm" class="btn btn-primary">Enregistrer</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Discussions View -->
        <div id="discussionsView" class="view-content d-none">

            <!-- Sub-view: List of all discussion threads -->
            <div id="discussionsList">
                <div class="d-flex justify-content-between align-items-center mb-4">
                    <h2 style="color:var(--brand); font-weight:700">Discussions</h2>
                    <button class="btn btn-primary" data-bs-toggle="modal" data-bs-target="#newDiscussionModal">
                        <i class="bi bi-plus-circle me-2"></i>Démarrer une nouvelle discussion
                    </button>
                </div>
                <div id="threadsContainer" class="d-flex flex-column gap-3">
                    <!-- Discussion threads will be loaded here -->
                    <div class="text-center p-5">
                        <div class="loader"></div>
                    </div>
                </div>
            </div>

            <!-- Sub-view: A single discussion thread with replies -->
            <div id="discussionDetail" class="d-none">
                <div class="mb-4">
                    <button class="btn btn-outline-secondary" id="backToDiscussions">
                        <i class="bi bi-arrow-left me-2"></i>Retour aux discussions
                    </button>
                </div>

                <!-- Original Post -->
                <div class="card card-modern mb-4">
                    <div class="card-body">
                        <h3 id="threadTitle" style="color:var(--brand);"></h3>
                        <p class="text-muted border-bottom pb-2 mb-3">
                            Par <strong id="threadAuthor"></strong> le <span id="threadDate"></span>
                        </p>
                        <div id="threadContent" class="ql-snow">
                            <div class="ql-editor"></div>
                        </div>
                    </div>
                </div>

                <!-- Replies Section -->
                <h4 class="mb-3">Réponses</h4>
                <div id="repliesContainer" class="d-flex flex-column gap-3 mb-4">
                    <!-- Replies will be loaded here -->
                </div>

                <!-- Reply Editor -->
                <div class="card card-modern">
                    <div class="card-body">
                        <h5 class="mb-3">Votre réponse</h5>
                        <form id="replyForm">
                            <!-- Quill editor for the reply -->
                            <div id="replyEditor" style="min-height: 150px;"></div>
                            <button type="submit" class="btn btn-primary mt-3">Publier la réponse</button>
                        </form>
                    </div>
                </div>
            </div>
        </div>

        <!-- Notifications View (Full Page) -->
        <div id="notificationsView" class="view-content d-none">
            <div class="d-flex justify-content-between align-items-center mb-4">
                <h2 style="color:var(--brand); font-weight:700">Toutes les notifications</h2>
            </div>
            <div class="card card-modern">
                <div class="card-body">
                    <div id="fullNotifList" class="list-group list-group-flush">
                        <!-- Full notification history will be loaded here -->
                    </div>
                </div>
            </div>
        </div>

        <!-- Modal for Creating a New Discussion -->
        <div class="modal fade" id="newDiscussionModal" tabindex="-1" aria-labelledby="newDiscussionModalLabel"
            aria-hidden="true">
            <div class="modal-dialog modal-lg modal-dialog-centered">
                <div class="modal-content">
                    <div class="modal-header">
                        <h5 class="modal-title" id="newDiscussionModalLabel">Démarrer une nouvelle discussion</h5>
                        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                    </div>
                    <div class="modal-body">
                        <form id="newDiscussionForm">
                            <div class="mb-3">
                                <label for="newDiscussionTitle" class="form-label">Titre du sujet</label>
                                <input type="text" class="form-control" id="newDiscussionTitle" required>
                            </div>
                            <div class="mb-3">
                                <label class="form-label">Votre question ou sujet</label>
                                <!-- Quill editor will be mounted here -->
                                <div id="newDiscussionEditor" style="min-height: 200px;"></div>
                            </div>
                        </form>
                    </div>
                    <div class="modal-footer">
                        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Annuler</button>
                        <button type="submit" form="newDiscussionForm" class="btn btn-primary">Publier</button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Mes notes View -->
        <div id="notesView" class="view-content d-none">
            <h2 class="mb-4" style="color:var(--brand); font-weight:700">Mes notes</h2>
            <form id="noteForm" class="mb-4">
                <div class="mb-3">
                    <input id="noteTitle" class="form-control" placeholder="Titre de la note" required>
                </div>
                <div class="mb-3">
                    <textarea id="noteContent" class="form-control" rows="4" placeholder="Contenu de la note"
                        required></textarea>
                </div>
                <button class="btn btn-primary" type="submit">Ajouter une note</button>
            </form>
            <div id="notesList" class="row g-4"></div>
        </div>

        <!-- Suivi des progrès View 
        <div id="progressView" class="view-content d-none">
            <h2 class="mb-4" style="color:var(--brand); font-weight:700">Suivi des progrès</h2>
            <div class="card card-modern">
                <div class="card-body">
                    <canvas id="progressChart" height="200"></canvas>
                </div>
            </div>
        </div>-->

        <!-- Suivi des progrès View -->
        <div id="progressView" class="view-content d-none">
            <h2 class="mb-4" style="color:var(--brand); font-weight:700">Votre progression</h2>

            <div class="row g-4">
                <!-- Main Progress Donut and KPIs -->
                <div class="col-xl-5">
                    <div class="card card-modern h-100">
                        <div class="card-body d-flex flex-column">
                            <h5 class="card-title mb-3">Progression globale</h5>
                            <div class="flex-grow-1 d-flex align-items-center justify-content-center"
                                style="min-height: 250px;">
                                <canvas id="progressDonutChart"></canvas>
                            </div>
                            <div class="row text-center mt-3 pt-3 border-top">
                                <div class="col-6">
                                    <h4 id="kpiCompleted" class="mb-0">0</h4>
                                    <small class="text-muted">Cours terminés</small>
                                </div>
                                <div class="col-6">
                                    <h4 id="kpiInProgress" class="mb-0">0</h4>
                                    <small class="text-muted">En cours</small>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Progress by Course -->
                <div class="col-xl-7">
                    <div class="card card-modern h-100">
                        <div class="card-body">
                            <h5 class="card-title mb-3">Progression par cours</h5>
                            <div style="min-height: 400px;">
                                <canvas id="progressByCourseChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Recent Activity -->
                <div class="col-12">
                    <div class="card card-modern">
                        <div class="card-body">
                            <h5 class="card-title mb-3">Activité des 7 derniers jours</h5>
                            <div style="min-height: 250px;">
                                <canvas id="activityLineChart"></canvas>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Paramètres View -->
        <div id="settingsView" class="view-content d-none">
            <h2 class="mb-4" style="color:var(--brand); font-weight:700">Paramètres</h2>

            <!-- Theme Settings -->
            <div class="card card-modern">
                <div class="card-body">
                    <h5 class="card-title mb-3">Préférences d'affichage</h5>
                    <div class="mb-3">
                        <label for="themeSelect" class="form-label">Thème</label>
                        <select id="themeSelect" class="form-select">
                            <option value="light">Clair</option>
                            <option value="dark">Sombre</option>
                            <option value="modern">Moderne</option>
                            <option value="pastel">Pastel</option>
                            <option value="forest">Forêt</option>
                            <option value="ocean">Océan</option>
                            <option value="midnight">Minuit</option>
                            <option value="system">Système</option>
                        </select>
                    </div>
                </div>
            </div>

            <!-- START: NEW ACCOUNT SETTINGS SECTION -->
            <div id="accountSettingsWrapper">
                <!-- Account Profile Settings -->
                <div class="card card-modern mt-4">
                    <div class="card-body">
                        <h5 class="card-title mb-4">Profil du compte</h5>
                        <form id="profileSettingsForm">
                            <div class="mb-3">
                                <label for="accountName" class="form-label">Nom complet</label>
                                <input type="text" class="form-control" id="accountName"
                                    placeholder="Votre nom complet">
                            </div>
                            <div class="mb-3">
                                <label for="accountEmail" class="form-label">Adresse e-mail</label>
                                <input type="email" class="form-control" id="accountEmail"
                                    placeholder="Votre adresse e-mail" disabled>
                                <div class="form-text">L'adresse e-mail ne peut pas être modifiée.</div>
                            </div>
                            <button type="submit" class="btn btn-primary">Enregistrer les modifications</button>
                        </form>
                    </div>
                </div>

                <!-- Password Settings -->
                <div class="card card-modern mt-4" id="passwordSettingsCard" style="display: none;">
                    <div class="card-body">
                        <h5 class="card-title mb-4">Changer le mot de passe</h5>
                        <form id="passwordChangeForm">
                            <div class="mb-3">
                                <label for="newPassword" class="form-label">Nouveau mot de passe</label>
                                <input type="password" class="form-control" id="newPassword" required>
                            </div>
                            <button type="submit" class="btn btn-primary">Mettre à jour le mot de passe</button>
                        </form>
                    </div>
                </div>

                <!-- Danger Zone -->
                <div class="card card-modern mt-4">
                    <div class="card-body">
                        <h5 class="card-title mb-3 text-danger">Zone de danger</h5>
                        <p class="text-muted">
                            Cette action est irréversible. Toutes vos données, y compris vos progrès et vos notes,
                            seront définitivement supprimées.
                        </p>
                        <button class="btn btn-outline-danger" id="btnDeleteAccount">Supprimer mon compte</button>
                    </div>
                </div>
            </div>
            <!-- END: NEW ACCOUNT SETTINGS SECTION -->
        </div>
    </main>

    <!-- Vidéo Modal 
    <div class="modal fade video-modal" id="videoModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="videoTitle">Tutoriel vidéo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="video-container" id="videoContainer"></div>
                </div>
                <div class="modal-body">
                    <div id="videoDescription" class="text-muted"></div>
                    <div class="mt-3">
                        <button class="btn btn-sm btn-outline-primary me-2"><i class="bi bi-bookmark"></i>
                            Enregistrer</button>
                        <button class="btn btn-sm btn-outline-secondary"><i class="bi bi-share"></i> Partager</button>
                    </div>
                </div>
            </div>
        </div>
    </div>-->

    <!-- Vidéo Modal (Upgraded for Playlists) -->
    <div class="modal fade video-modal" id="videoModal" tabindex="-1">
        <div class="modal-dialog modal-fullscreen-lg-down modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="videoTitle">Tutoriel vidéo</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-2">
                    <div class="row g-2 h-100">
                        <!-- Main Video Player Column (80%) -->
                        <div class="col-lg-9 h-100">
                            <div class="video-container" id="videoContainer"
                                style="padding-bottom: 0; min-height: 0; height: 100%;">
                                <!-- Iframe will be inserted here -->
                            </div>
                        </div>
                        <!-- History Panel Column (20%) -->
                        <div class="col-lg-3 h-100 d-none flex-column" id="playlistPanel">
                            <div class="card h-100">
                                <div class="card-body d-flex flex-column p-2">
                                    <!-- START: NEW HEADER -->
                                    <div class="d-flex justify-content-between align-items-center px-2 pt-1 mb-2">
                                        <h6 class="card-title mb-0">Historique</h6>
                                        <button class="btn btn-sm btn-outline-danger" id="clearHistoryBtn"
                                            title="Effacer l'historique">
                                            <i class="bi bi-trash"></i>
                                        </button>
                                    </div>
                                    <!-- END: NEW HEADER -->
                                    <div id="historyQueue" class="list-group list-group-flush flex-grow-1">
                                        <!-- History items will be loaded here -->
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Document Modal -->
    <div class="modal fade document-modal" id="documentModal" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="documentTitle">Document</h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body p-0">
                    <div class="document-container" id="documentContainer"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Auth Modal -->
    <div class="modal fade" id="modalAuth" tabindex="-1">
        <div class="modal-dialog modal-dialog-centered">
            <div class="modal-content">
                <div class="modal-header">
                    <ul class="nav nav-tabs nav-tabs-modern w-100">
                        <li class="nav-item">
                            <button class="nav-link active" id="signinTab" data-bs-toggle="tab"
                                data-bs-target="#signin">Se connecter</button>
                        </li>
                        <li class="nav-item">
                            <button class="nav-link" id="signupTab" data-bs-toggle="tab" data-bs-target="#signup">Créer
                                un compte</button>
                        </li>
                    </ul>
                </div>
                <div class="modal-body p-4">
                    <div class="tab-content">
                        <div class="tab-pane fade show active" id="signin">
                            <h4 class="text-center mb-4" style="color:var(--brand)">Connectez-vous à votre compte</h4>

                            <button id="googleSignIn" class="btn btn-outline-dark w-100 mb-3 py-2">
                                <i class="bi bi-google me-2"></i> Continuer avec Google
                            </button>

                            <div class="text-center my-3 text-muted">ou</div>

                            <form id="signinForm">
                                <div class="mb-3">
                                    <input id="signinEmail" type="email" class="form-control"
                                        placeholder="Adresse email" required>
                                </div>
                                <div class="mb-3">
                                    <input id="signinPassword" type="password" class="form-control"
                                        placeholder="Mot de passe" required>
                                </div>
                                <button class="btn btn-primary w-100 py-2" type="submit">Se connecter</button>
                            </form>
                        </div>

                        <div class="tab-pane fade" id="signup">
                            <h4 class="text-center mb-4" style="color:var(--brand)">Créer un nouveau compte</h4>

                            <button id="googleSignup" class="btn btn-outline-dark w-100 mb-3 py-2">
                                <i class="bi bi-google me-2"></i> S'inscrire avec Google
                            </button>

                            <div class="text-center my-3 text-muted">ou</div>

                            <form id="signupForm">
                                <div class="mb-3">
                                    <input id="signupName" type="text" class="form-control" placeholder="Nom complet"
                                        required>
                                </div>
                                <div class="mb-3">
                                    <input id="signupEmail" type="email" class="form-control"
                                        placeholder="Adresse email" required>
                                </div>
                                <div class="mb-3">
                                    <input id="signupPassword" type="password" class="form-control"
                                        placeholder="Mot de passe" required>
                                </div>
                                <button class="btn btn-primary w-100 py-2" type="submit">Créer un compte</button>
                            </form>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>


    <div id="toastContainer" class="position-fixed top-0 end-0 p-3" style="z-index: 1100"></div>

    <script type="module">
        const DRIVE_API_KEY = 'AIzaSyAcOuFc10xwtujaClC_TZckrGkKx3h0iNI';
        const DRIVE_FOLDER_ID = '1rWQnAn8e2fLPpGa-8_GXYHmb0NeTLNH2';
        const YOUTUBE_API_KEY = 'AIzaSyBAdEcJt_IirVmn-NigdC4O4wMbrkvmR7k'; // Remplacer par une clé valide

        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-app.js";
        import {
            getAuth,
            GoogleAuthProvider,
            signInWithPopup,
            signInWithEmailAndPassword,
            createUserWithEmailAndPassword,
            signOut,
            onAuthStateChanged,
            updateProfile,
            updatePassword,
            deleteUser
        } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-auth.js";
        // THIS IS THE NEW, CORRECTED IMPORT. USE THIS ONE.
        /*
        import {
            getFirestore,
            collection,
            addDoc,
            getDocs,
            query,
            where,
            doc,
            setDoc,
            updateDoc,
            deleteDoc,
            Timestamp,
            onSnapshot,
            orderBy,
            limit,
            writeBatch // <<< ADD THIS LINE
        } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
         */

        import {
            getFirestore,
            collection,
            addDoc,
            getDocs,
            query,
            where,
            doc,
            setDoc,
            updateDoc,
            deleteDoc,
            Timestamp,
            onSnapshot,
            orderBy,
            limit,
            writeBatch // For "Mark All as Read"
        } from "https://www.gstatic.com/firebasejs/10.14.0/firebase-firestore.js";
        const firebaseConfig = {
            apiKey: "AIzaSyAgl557z1SyRSljc3UpIUELUpr2SM0SkBs",
            authDomain: "informatique-et-ia-fpn.firebaseapp.com",
            projectId: "informatique-et-ia-fpn",
            storageBucket: "informatique-et-ia-fpn.firebasestorage.app",
            messagingSenderId: "588259713629",
            appId: "1:588259713629:web:b4687934056edd5207e3b4",
            measurementId: "G-TG8DP35DG6"
        };

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        const provider = new GoogleAuthProvider();
        provider.addScope('https://www.googleapis.com/auth/drive.readonly');

        let allFiles = [];
        let currentFiles = [];
        let userProgress = {};
        let currentFolderId = DRIVE_FOLDER_ID;
        let folderPath = [{ id: DRIVE_FOLDER_ID, name: 'Racine' }];
        let notes = JSON.parse(localStorage.getItem('notes') || '[]');
        let contributedContent = [];

        let googleAccessToken = localStorage.getItem('googleAccessToken') || null;

        let newDiscussionQuill, replyQuill; // To hold Quill instances
        let currentDiscussionId = null;
        let progressDonutChart, progressByCourseChart, activityLineChart;
        let unsubscribeNotifications = null; // To manage the real-time listener
        const newDiscussionModal = new bootstrap.Modal(document.getElementById('newDiscussionModal'));
        // Éléments DOM
        const btnLogin = document.getElementById('btnLogin');
        const btnLogout = document.getElementById('btnLogout');
        const modalAuth = new bootstrap.Modal(document.getElementById('modalAuth'));
        const videoModal = new bootstrap.Modal(document.getElementById('videoModal'));
        const documentModal = new bootstrap.Modal(document.getElementById('documentModal'));
        const videoModalEl = document.getElementById('videoModal');
        const documentModalEl = document.getElementById('documentModal');
        const sidebarToggle = document.getElementById('sidebarToggle');
        const sidebar = document.getElementById('sidebar');
        const mainContent = document.getElementById('mainContent');
        const contentCourseSelect = document.getElementById('contentCourse');

        // 1. Add this constant near your other modal constants
        const playlistPanel = document.getElementById('playlistPanel');
        const playlistQueue = document.getElementById('playlistQueue');



        // Initialisation
        document.querySelectorAll('.sidebar-item, .dropdown-item[data-view]').forEach(item => {
            item.addEventListener('click', (e) => {
                e.preventDefault();
                const view = item.dataset.view;

                document.querySelectorAll('.sidebar-item').forEach(i => i.classList.remove('active'));
                const sidebarItem = document.querySelector(`.sidebar-item[data-view="${view}"]`);
                if (sidebarItem) sidebarItem.classList.add('active');

                switchView(view);

                if (window.innerWidth < 992) sidebar.classList.remove('show');
            });
        });

        sidebarToggle?.addEventListener('click', () => {
            sidebar.classList.toggle('show');
        });

        btnLogin.addEventListener('click', () => modalAuth.show());

        document.getElementById('googleSignIn').addEventListener('click', async () => {
            try {
                const result = await signInWithPopup(auth, provider);
                const credential = GoogleAuthProvider.credentialFromResult(result);
                googleAccessToken = credential.accessToken;
                localStorage.setItem('googleAccessToken', googleAccessToken);
                modalAuth.hide();
            } catch (err) {
                showToast('Erreur de connexion : ' + err.message, 'danger');
            }
        });

        document.getElementById('googleSignup').addEventListener('click', async () => {
            try {
                const result = await signInWithPopup(auth, provider);
                const credential = GoogleAuthProvider.credentialFromResult(result);
                googleAccessToken = credential.accessToken;
                localStorage.setItem('googleAccessToken', googleAccessToken);
                await updateProfile(result.user, { displayName: result.user.displayName });
                modalAuth.hide();
            } catch (err) {
                showToast('Erreur d\'inscription : ' + err.message, 'danger');
            }
        });
        document.getElementById('signinForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const email = document.getElementById('signinEmail').value;
            const password = document.getElementById('signinPassword').value;
            try {
                await signInWithEmailAndPassword(auth, email, password);
                modalAuth.hide();
            } catch (err) {
                showToast('Erreur de connexion : ' + err.message, 'danger');
            }
        });

        document.getElementById('signupForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            try {
                const result = await createUserWithEmailAndPassword(auth, email, password);
                await updateProfile(result.user, { displayName: name });
                modalAuth.hide();
            } catch (err) {
                showToast('Erreur d\'inscription : ' + err.message, 'danger');
            }
        });

        btnLogout.addEventListener('click', async () => {
            await signOut(auth);
            localStorage.removeItem('googleAccessToken');
            googleAccessToken = null;
            location.reload();
        });

        onAuthStateChanged(auth, (user) => {
            const profileDropdown = document.getElementById('profileDropdown');
            const btnLogin = document.getElementById('btnLogin');
            const welcomeEl = document.getElementById('welcomeUserName');

            if (user) {
                profileDropdown.style.display = 'block';
                btnLogin.classList.add('d-none');
                if (welcomeEl) welcomeEl.textContent = user.displayName || 'Utilisateur';

                document.getElementById('userPhoto').src =
                    user.photoURL || `https://ui-avatars.com/api/?name=${encodeURIComponent(user.displayName || user.email)}`;
                document.getElementById('userName').innerText = user.displayName || 'Utilisateur';
                document.getElementById('userEmail').innerText = user.email;

                googleAccessToken = localStorage.getItem('googleAccessToken') || null;

                loadUserProgress();
                fetchDriveFolder(currentFolderId);
                loadContributedContent();
                listenForNotifications(user.uid); // START the listener on login
                listenForInboxMessages(user.uid);
                setInterval(checkAlarms, 60000);
                // Request permission for notifications on login
                if (Notification.permission === 'default') {
                    Notification.requestPermission();
                }
            } else {
                profileDropdown.style.display = 'none';
                btnLogin.classList.remove('d-none');
                if (welcomeEl) welcomeEl.textContent = '';

                googleAccessToken = null;
                document.getElementById('coursesGrid').innerHTML = '<div class="col-12 text-center text-muted py-5"><i class="bi bi-lock fs-1"></i><p class="mt-2">Veuillez vous connecter avec Google pour accéder aux cours.</p></div>';
                if (unsubscribeNotifications) unsubscribeNotifications();
                if (unsubscribeInbox) unsubscribeInbox(); // <<< ADD THIS LINE to stop the inbox checker
                updateNotificationUI([]);
            }

            loadTheme();
        });

        // Recherche
        document.getElementById('searchInput')?.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            filterCourses(query);
        });

        // Formulaire de notes
        document.getElementById('noteForm')?.addEventListener('submit', (e) => {
            e.preventDefault();
            const title = document.getElementById('noteTitle').value;
            const content = document.getElementById('noteContent').value;
            notes.push({ title, content, date: new Date().toLocaleString('fr-FR') });
            localStorage.setItem('notes', JSON.stringify(notes));
            renderNotes();
            e.target.reset();
        });

        function extractGoogleDriveId(url) {
            const match = url.match(/\/file\/d\/([a-zA-Z0-9_-]+)/);
            return match ? match[1] : null;
        }
        // Formulaire ajouter contenu
        /*document.getElementById('addContentForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const url = document.getElementById('contentUrl').value;
            const title = document.getElementById('contentTitle').value || '';
            const courseId = document.getElementById('contentCourse').value;
            const type = url.includes('list=') ? 'playlist' : 'video';
            const id = extractYoutubeId(url, type);
            if (id) {
                try {
                    await addDoc(collection(db, 'contributed'), {
                        type,
                        id,
                        title,
                        courseId,
                        userId: auth.currentUser.uid,
                        userName: auth.currentUser.displayName || 'Anonyme',
                        createdAt: new Date()
                    });
                    loadContributedContent();
                    showToast('Contenu ajouté avec succès !', 'success');
                    e.target.reset();
                } catch (err) {
                    showToast('Erreur : ' + err.message, 'danger');
                }
            } else {
                showToast('URL YouTube invalide', 'warning');
            }
        });*/


        document.getElementById('addContentForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) {
                showToast("Veuillez vous connecter pour contribuer.", "warning");
                return;
            }

            // ... (your existing code for getting form data and validating it)
            const url = document.getElementById('contentUrl').value;
            const type = document.getElementById('contentType').value;
            const title = document.getElementById('contentTitle').value;
            const courseId = document.getElementById('contentCourse').value;

            let contentData = {
                title: title,
                url: url,
                courseId: courseId,
                type: type,
                userId: user.uid,
                userName: user.displayName || 'Anonyme',
                createdAt: new Date()
            };

            try {
                // --- DATA VALIDATION (your existing code) ---
                if (type === 'youtube') {
                    const isPlaylist = url.includes('list=');
                    const id = isPlaylist ? extractPlaylistId(url) : extractVideoId(url);
                    if (!id) throw new Error("URL YouTube invalide.");
                    contentData.youtubeType = isPlaylist ? 'playlist' : 'video';
                    contentData.youtubeId = id;
                } else if (type === 'gdrive_doc' || type === 'gdrive_video') {
                    const id = extractGoogleDriveId(url);
                    if (!id) throw new Error("URL Google Drive invalide.");
                    contentData.gdriveId = id;
                }

                // --- Step 1: Add the content document (your existing code) ---
                await addDoc(collection(db, 'contributed'), contentData);
                showToast('Contenu ajouté avec succès !', 'success');
                e.target.reset();
                loadContributedContent();

                // --- Step 2: NEW - Send broadcast notification to all users ---
                const notificationPayload = {
                    message: `Une nouvelle ressource a été ajoutée : <strong>${title || "Nouveau contenu"}</strong>`,
                    type: "new_content",
                    link: "/contributed"
                };

                const usersSnapshot = await getDocs(collection(db, 'users'));
                usersSnapshot.forEach(userDoc => {
                    const targetUserId = userDoc.id;
                    // Don't notify the user who added the content
                    if (targetUserId !== user.uid) {
                        createNotification(targetUserId, notificationPayload);
                    }
                });

            } catch (err) {
                showToast('Erreur : ' + err.message, 'danger');
            }
        });

        /*async function fetchAndRenderPlaylist(playlistId) {
            playlistQueue.innerHTML = '<div class="p-3 text-center text-muted">Chargement de la playlist...</div>';

            try {
                const url = `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&maxResults=50&playlistId=${playlistId}&key=${YOUTUBE_API_KEY}`;
                const res = await fetch(url);
                const data = await res.json();

                // --- ESSENTIAL DEBUGGING ---
                console.log("YouTube API Response for Playlist:", data);

                // More robust error checking
                if (data.error || !data.items || data.items.length === 0) {
                    throw new Error(data.error?.message || "Playlist vide ou introuvable. Vérifiez votre clé API YouTube et l'ID de la playlist.");
                }

                playlistQueue.innerHTML = ''; // Clear loader

                let firstVideoPlayed = false;

                data.items.forEach((item) => {
                    const snippet = item.snippet;

                    // --- THE CRITICAL FIX ---
                    // This checks if the video is valid (not deleted or private).
                    // If it's not valid, we just skip it instead of crashing.
                    if (!snippet.resourceId || !snippet.thumbnails?.default) {
                        console.warn("Skipping an invalid item in the playlist:", snippet);
                        return; // Skips this iteration and continues the loop
                    }

                    const videoId = snippet.resourceId.videoId;
                    const title = snippet.title;
                    const thumbnailUrl = snippet.thumbnails.default.url;

                    const itemEl = document.createElement('button');
                    itemEl.className = 'list-group-item playlist-item';
                    itemEl.innerHTML = `
                <img src="${thumbnailUrl}" alt="">
                <div class="flex-grow-1">
                    <span class="playlist-title">${escapeHtml(title)}</span>
                </div>
            `;

                    itemEl.addEventListener('click', (e) => {
                        e.preventDefault();
                        playVideoFromQueue(videoId, itemEl);
                    });

                    playlistQueue.appendChild(itemEl);

                    // Play the *first valid* video automatically
                    if (!firstVideoPlayed) {
                        playVideoFromQueue(videoId, itemEl);
                        firstVideoPlayed = true;
                    }
                });

            } catch (err) {
                playlistQueue.innerHTML = `<div class="p-3 text-center text-danger"><strong>Erreur:</strong> ${err.message}</div>`;
                console.error(err);
            }
        }


        window.playVideoFromQueue = function (videoId, clickedElement) {
            const container = document.getElementById('videoContainer');
            container.innerHTML = `<iframe src="https://www.youtube.com/embed/${videoId}?autoplay=1" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;

            // Update the active state in the queue
            document.querySelectorAll('.playlist-item.active').forEach(el => el.classList.remove('active'));
            if (clickedElement) {
                clickedElement.classList.add('active');
                // Scroll the active item into view if needed
                clickedElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }
        }*/


        // --- FIX: Stop video/document from playing when modal is closed ---
        videoModalEl.addEventListener('hidden.bs.modal', () => {
            const videoContainer = document.getElementById('videoContainer');
            const iframe = videoContainer.querySelector('iframe');
            if (iframe) {
                iframe.src = '';
            }
            historyQueue.innerHTML = ''; // This line is correct
            playlistPanel.classList.add('d-none');
            playlistPanel.classList.remove('d-flex');
        });




        documentModalEl.addEventListener('hidden.bs.modal', () => {
            const documentContainer = document.getElementById('documentContainer');
            const iframe = documentContainer.querySelector('iframe');
            if (iframe) {
                // This is also good practice for document modals to free up resources
                iframe.src = '';
            }
        });

        // 1. Add this variable at the top with your other global variables
        let documentViewMode = 'grid'; // Can be 'grid' or 'list'

        // 2. Add these event listeners for the new buttons in your initialization section
        document.getElementById('btnGridDocuments').addEventListener('click', () => {
            documentViewMode = 'grid';
            document.getElementById('btnGridDocuments').classList.add('active');
            document.getElementById('btnListDocuments').classList.remove('active');
            renderDocuments();
        });

        document.getElementById('btnListDocuments').addEventListener('click', () => {
            documentViewMode = 'list';
            document.getElementById('btnListDocuments').classList.add('active');
            document.getElementById('btnGridDocuments').classList.remove('active');
            renderDocuments();
        });

        // Sélecteur de thème
        document.getElementById('themeSelect')?.addEventListener('change', (e) => {
            const theme = e.target.value;
            setTheme(theme);
        });

        // START: EVENT LISTENERS FOR ACCOUNT SETTINGS
        document.getElementById('profileSettingsForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) return;

            const newName = document.getElementById('accountName').value;
            if (newName !== user.displayName) {
                try {
                    await updateProfile(user, { displayName: newName });
                    document.getElementById('userName').innerText = newName;
                    document.getElementById('welcomeUserName').innerText = newName;
                    showToast('Profil mis à jour avec succès !', 'success');
                } catch (error) {
                    showToast('Erreur lors de la mise à jour du profil.', 'danger');
                }
            }
        });

        document.getElementById('passwordChangeForm')?.addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) return;

            const newPassword = document.getElementById('newPassword').value;
            try {
                await updatePassword(user, newPassword);
                showToast('Mot de passe mis à jour avec succès.', 'success');
                e.target.reset();
            } catch (error) {
                showToast('Erreur: ' + error.message, 'danger');
            }
        });

        document.getElementById('btnDeleteAccount')?.addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user) return;

            if (confirm("Êtes-vous sûr de vouloir supprimer votre compte ? Cette action est irréversible.")) {
                try {
                    await deleteUser(user);
                    showToast('Compte supprimé avec succès.', 'info');
                    // The onAuthStateChanged will handle the UI changes after deletion.
                } catch (error) {
                    showToast('Erreur lors de la suppression du compte: ' + error.message, 'danger');
                }
            }
        });
        // END: EVENT LISTENERS FOR ACCOUNT SETTINGS


        function switchView(view) {
            document.querySelectorAll('.view-content').forEach(v => v.classList.add('d-none'));
            const viewEl = document.getElementById(`${view}View`);
            if (viewEl) viewEl.classList.remove('d-none');

            if (view === 'videos') {
                renderVideos();
                fetchYoutubeTutorials();
                renderContributedVideos();
            }
            if (view === 'contributed') renderContributed();
            if (view === 'documents') renderDocuments();
            if (view === 'assignments') renderAssignments();
            if (view === 'calendar') renderCalendar();
            if (view === 'discussions') showDiscussionsList();
            if (view === 'notifications') renderFullNotificationPage();
            if (view === 'notes') renderNotes();
            if (view === 'progress') renderProgress();
            if (view === 'settings') renderSettings();
        }

        function loadUserProgress() {
            const saved = localStorage.getItem('userProgress');
            if (saved) userProgress = JSON.parse(saved);
        }

        function saveProgress(fileId, progress) {
            userProgress[fileId] = progress;
            localStorage.setItem('userProgress', JSON.stringify(userProgress));
            updateStats();
        }

        async function fetchDriveFolder(folderId) {
            document.getElementById('loader').style.display = 'block';
            const coursesGrid = document.getElementById('coursesGrid');

            try {
                let param = '';
                if (googleAccessToken) {
                    param = `&access_token=${googleAccessToken}`;
                } else if (DRIVE_API_KEY) {
                    param = `&key=${DRIVE_API_KEY}`;
                }

                const url = `https://www.googleapis.com/drive/v3/files?q='${folderId}'+in+parents&fields=files(id,name,mimeType,webViewLink,thumbnailLink,iconLink,webContentLink,description,createdTime,modifiedTime)&pageSize=200${param}`;

                const res = await fetch(url);
                if (!res.ok) {
                    throw new Error(`HTTP error! status: ${res.status}`);
                }
                const json = await res.json();

                if (json.error) {
                    throw new Error(json.error.message);
                }

                currentFiles = json.files || [];
                if (folderId === DRIVE_FOLDER_ID) allFiles = currentFiles;
                document.getElementById('loader').style.display = 'none';

                renderCourses();
                renderFolderContributed();
                renderDashboard();
                updateStats();
                renderBreadcrumb();
                populateCourseSelect();
            } catch (err) {
                console.error('Erreur de fetch', err);
                document.getElementById('loader').style.display = 'none';
                coursesGrid.innerHTML = `<div class="col-12 text-center text-danger py-5"><i class="bi bi-exclamation-triangle fs-1"></i><p class="mt-2">Erreur de chargement des cours : ${err.message}. Vérifiez votre connexion ou les permissions Drive.</p></div>`;
            }
        }
        function populateCourseSelect() {
            contentCourseSelect.innerHTML = '<option value="">Associé à aucun cours</option>';
            allFiles.filter(f => f.mimeType === 'application/vnd.google-apps.folder').forEach(folder => {
                const option = document.createElement('option');
                option.value = folder.id;
                option.textContent = folder.name;
                contentCourseSelect.appendChild(option);
            });
        }

        async function loadContributedContent() {
            contributedContent = [];
            const q = query(collection(db, 'contributed'));
            const snapshot = await getDocs(q);
            snapshot.forEach(doc => contributedContent.push({ id: doc.id, ...doc.data() }));
            renderContributed();
        }

        function getFileMeta(mime) {
            if (!mime) return { kind: 'file', icon: 'bi-file-earmark-text', label: 'Fichier', color: '#6c757d' };
            if (mime === 'application/vnd.google-apps.folder') return { kind: 'folder', icon: 'bi-folder-fill', label: 'Dossier', color: '#ffc107' };
            if (mime.startsWith('video/')) return { kind: 'video', icon: 'bi-camera-video-fill', label: 'Vidéo', color: '#dc3545' };
            if (mime === 'application/pdf') return { kind: 'document', icon: 'bi-file-earmark-pdf-fill', label: 'PDF', color: '#0d6efd' };
            if (mime.includes('document')) return { kind: 'document', icon: 'bi-file-earmark-text-fill', label: 'Document', color: '#0d6efd' };
            if (mime.includes('spreadsheet')) return { kind: 'document', icon: 'bi-file-earmark-spreadsheet', label: 'Tableur', color: '#198754' };
            if (mime.includes('presentation')) return { kind: 'document', icon: 'bi-file-earmark-slides', label: 'Présentation', color: '#fd7e14' };
            return { kind: 'file', icon: 'bi-file-earmark', label: 'Fichier', color: '#6c757d' };
        }

        function extractVideoId(url) {
            if (!url) return null;
            const match = url.match(/(?:youtube\.com\/(?:[^\/]+\/.+\/|(?:v|e(?:mbed)?)\/|.*[?&]v=)|youtu\.be\/)([^"&?\/\s]{11})/);
            return match ? match[1] : null;
        }

        function extractPlaylistId(url) {
            const match = url.match(/[&?]list=([a-zA-Z0-9_-]+)/);
            return match ? match[1] : null;
        }

        function extractYoutubeId(url, type) {
            return type === 'playlist' ? extractPlaylistId(url) : extractVideoId(url);
        }

        /*
        function renderBreadcrumb() {
            const breadcrumb = document.getElementById('breadcrumb');
            if (!breadcrumb) return;
            breadcrumb.innerHTML = folderPath.map((folder, index) => {
                return index === folderPath.length - 1 ?
                    `<span>${escapeHtml(folder.name)}</span>` :
                    `<a href="#" onclick="navigateToFolder('${folder.id}', ${index})">${escapeHtml(folder.name)}</a> > `;
            }).join('');
        }
        */

        function renderBreadcrumb() {
            const breadcrumb = document.getElementById('breadcrumb');
            if (!breadcrumb) return;

            // Use join() with a separator element for cleaner logic
            breadcrumb.innerHTML = folderPath.map((folder, index) => {
                if (index === folderPath.length - 1) {
                    // This is the current, non-clickable folder
                    return `<span class="breadcrumb-current">${escapeHtml(folder.name)}</span>`;
                } else {
                    // These are the clickable parent folders
                    return `<a href="#" class="breadcrumb-link" onclick="navigateToFolder('${folder.id}', ${index})">${escapeHtml(folder.name)}</a>`;
                }
            }).join(' <i class="bi bi-chevron-right text-muted mx-1"></i> ');
        }

        window.navigateToFolder = function (folderId, index) {
            folderPath = folderPath.slice(0, index + 1);
            currentFolderId = folderId;
            fetchDriveFolder(folderId);
        };

        function renderCourses() {
            const grid = document.getElementById('coursesGrid');
            grid.innerHTML = '';

            if (!currentFiles.length) {
                grid.innerHTML = '<div class="col-12 text-center text-muted py-5"><i class="bi bi-inbox fs-1"></i><p class="mt-2">Aucun cours trouvé</p></div>';
                return;
            }

            currentFiles.forEach(file => {
                const meta = getFileMeta(file.mimeType);
                const progress = userProgress[file.id] || 0;
                const thumb = file.thumbnailLink || `https://via.placeholder.com/400x250/${meta.color.replace('#', '')}/ffffff?text=${encodeURIComponent(meta.label)}`;

                const col = document.createElement('div');
                col.className = 'col-xl-3 col-lg-4 col-md-6';
                col.innerHTML = `
        <div class="card card-modern course-card h-100 fade-in">
          ${progress > 0 ? `<div class="progress-ring">${progress}%</div>` : ''}
          <span class="course-badge"><i class="${meta.icon} me-1"></i>${meta.label}</span>
          ${meta.kind === 'folder' ?
                        `<div class="course-thumbnail d-flex align-items-center justify-content-center" style="background:linear-gradient(135deg, ${meta.color}22, ${meta.color}11)">
              <i class="${meta.icon}" style="font-size:64px; color:${meta.color}"></i>
            </div>` :
                        `<img class="course-thumbnail" src="${thumb}" alt="${escapeHtml(file.name)}" loading="lazy">`
                    }
          <div class="card-body d-flex flex-column">
            <h6 class="card-title mb-2" style="min-height:44px; line-height:1.4">${escapeHtml(file.name)}</h6>
            ${file.description ? `<p class="small text-muted mb-3">${escapeHtml(file.description.substring(0, 80))}...</p>` : ''}
            ${progress > 0 ? `
              <div class="progress mb-3" style="height:6px">
                <div class="progress-bar bg-success" style="width:${progress}%"></div>
              </div>` : ''}
            <div class="mt-auto d-grid gap-2">
              ${meta.kind === 'folder' ?
                        `<button class="btn btn-sm btn-primary" onclick="openFolder('${file.id}', '${escapeHtml(file.name)}')">
                  <i class="bi bi-folder-symlink me-1"></i>Ouvrir
                </button>` :
                        (meta.kind === 'video' ?
                            `<button class="btn btn-sm btn-primary" onclick="playVideo('${file.id}', '${escapeHtml(file.name)}', '${file.webViewLink || ''}')">
                    <i class="bi bi-play-fill me-1"></i>Regarder
                  </button>` :
                            `<button class="btn btn-sm btn-primary" onclick="viewDocument('${file.id}', '${escapeHtml(file.name)}', '${file.webViewLink || ''}', '${meta.kind}')">
                    <i class="bi bi-eye me-1"></i>Voir
                  </button>`
                        )
                    }
              ${file.webContentLink ?
                        `<a class="btn btn-sm btn-outline-secondary" href="${file.webContentLink}" target="_blank">
                  <i class="bi bi-download me-1"></i>Télécharger
                </a>` : ''}
              <button class="btn btn-sm btn-outline-success" onclick="markComplete('${file.id}')">
                <i class="bi bi-check-circle me-1"></i>${progress === 100 ? 'Complété' : 'Marquer comme complété'}
              </button>
            </div>
          </div>
        </div>
      `;
                grid.appendChild(col);
            });
        }

        function renderFolderContributed() {
            const section = document.getElementById('folderContributedSection');
            if (!section) return;
            if (currentFolderId === DRIVE_FOLDER_ID) {
                section.classList.add('d-none');
                return;
            }

            section.classList.remove('d-none');
            const grid = document.getElementById('folderContributedGrid');
            grid.innerHTML = '';

            const filtered = contributedContent.filter(c => c.courseId === currentFolderId);

            if (!filtered.length) {
                grid.innerHTML = `
                    <div class="col-12 text-center text-muted py-5">
                       <i class="bi bi-camera-video-off fs-2 d-block mb-2"></i>
                       Aucun tutoriel contribué
                    </div>`;
                return;
            }

            filtered.forEach(content => {
                const col = document.createElement('div');
                col.className = 'col-md-4 col-sm-6 mb-4';

                const isPlaylist = content.type === 'playlist';
                const thumbnailUrl = isPlaylist
                    ? ''
                    : `https://img.youtube.com/vi/${content.id}/mqdefault.jpg`;

                col.innerHTML = `
                    <div class="video-card fade-in ${isPlaylist ? 'playlist' : ''}" 
                        onclick="playYoutube('${content.type}', '${content.id}', '${escapeHtml(content.title)}')">
                        <div class="video-thumb">
                            ${isPlaylist ? `<span class="playlist-title">${escapeHtml(content.title || 'Playlist')}</span>` : `<img src="${thumbnailUrl}" alt="${escapeHtml(content.title)}" class="video-thumb-img">`}
                            <div class="video-overlay">
                               <i class="bi bi-play-fill play-icon"></i>
                            </div>
                            <span class="video-badge">${content.type.charAt(0).toUpperCase() + content.type.slice(1)}</span>
                        </div>
                        <div class="video-body">
                            <h6 class="video-title">${escapeHtml(content.title || 'Sans titre')}</h6>
                            <p class="video-author">
                                <i class="bi bi-person-circle me-1"></i>${escapeHtml(content.userName || 'Inconnu')}
                            </p>
                        </div>
                    </div>`;

                grid.appendChild(col);
            });
        }

        function renderDashboard() {
            const continueSection = document.getElementById('continueSection');
            const inProgress = allFiles.filter(f => {
                const prog = userProgress[f.id] || 0;
                return prog > 0 && prog < 100;
            }).slice(0, 3);

            if (!inProgress.length) {
                continueSection.innerHTML = `
        <div class="col-12 text-center text-muted py-3">
          <i class="bi bi-play-circle fs-1"></i>
          <p class="mt-2">Commencez un cours pour le voir ici</p>
        </div>`;
                return;
            }

            continueSection.innerHTML = '';
            inProgress.forEach(file => {
                const meta = getFileMeta(file.mimeType);
                const progress = userProgress[file.id] || 0;

                const col = document.createElement('div');
                col.className = 'col-md-4';
                col.innerHTML = `
        <div class="card border-0 bg-light fade-in">
          <div class="card-body">
            <div class="d-flex gap-3">
              <div class="text-primary" style="font-size:32px">
                <i class="${meta.icon}"></i>
              </div>
              <div class="flex-grow-1">
                <h6 class="mb-1">${escapeHtml(file.name)}</h6>
                <small class="text-muted">${meta.label}</small>
                <div class="progress mt-2" style="height:6px">
                  <div class="progress-bar" style="width:${progress}%"></div>
                </div>
                <small class="text-muted">${progress}% complété</small>
              </div>
            </div>
            <button class="btn btn-sm btn-primary w-100 mt-3" onclick="resumeCourse('${file.id}')">
              <i class="bi bi-play-fill me-1"></i>Continuer
            </button>
          </div>
        </div>
      `;
                continueSection.appendChild(col);
            });
        }

        function initializeQuill(selector) {
            return new Quill(selector, {
                theme: 'snow',
                modules: {
                    toolbar: [
                        [{ 'header': [1, 2, false] }],
                        ['bold', 'italic', 'underline'],
                        ['link', 'image'],
                        [{ 'list': 'ordered' }, { 'list': 'bullet' }]
                    ]
                }
            });
        }


        // 1. Add/update these variables at the top of your script
        const historyQueue = document.getElementById('historyQueue');
        let videoHistory = JSON.parse(localStorage.getItem('videoHistory')) || [];


        // 2. Add this NEW function. It's the brain of the history feature.
        function addVideoToHistory(videoData) {
            // videoData should be an object: { videoId, title, thumbnailUrl }

            // Remove any existing instance of this video to avoid duplicates
            videoHistory = videoHistory.filter(v => v.videoId !== videoData.videoId);

            // Add the new video to the beginning of the array
            videoHistory.unshift(videoData);

            // Limit the history to the last 30 videos
            if (videoHistory.length > 30) {
                videoHistory = videoHistory.slice(0, 30);
            }

            // Save to localStorage
            localStorage.setItem('videoHistory', JSON.stringify(videoHistory));

            // Refresh the visible history panel
            renderVideoHistory();
        }


        // 3. Add this NEW function to render the history panel
        function renderVideoHistory() {
            historyQueue.innerHTML = '';
            if (videoHistory.length === 0) {
                historyQueue.innerHTML = '<div class="p-3 text-center text-muted small">Votre historique de lecture est vide.</div>';
                return;
            }

            videoHistory.forEach(video => {
                const itemEl = document.createElement('button');
                itemEl.className = 'list-group-item history-item';
                itemEl.innerHTML = `
            <img src="${video.thumbnailUrl}" alt="">
            <div class="flex-grow-1">
                <span class="history-title">${escapeHtml(video.title)}</span>
            </div>
        `;
                itemEl.addEventListener('click', (e) => {
                    e.preventDefault();
                    playVideoFromHistory(video, itemEl);
                });
                historyQueue.appendChild(itemEl);
            });
        }


        // 4. Add the event listener for the "Clear History" button
        document.getElementById('clearHistoryBtn').addEventListener('click', () => {
            if (confirm("Êtes-vous sûr de vouloir effacer tout votre historique de lecture ?")) {
                videoHistory = [];
                localStorage.removeItem('videoHistory');
                renderVideoHistory();
                showToast("L'historique a été effacé.", 'info');
            }
        });


        // 5. RENAME `playVideoFromQueue` to `playVideoFromHistory` and update it
        window.playVideoFromHistory = function (videoData, clickedElement) {
            const container = document.getElementById('videoContainer');
            container.innerHTML = `<iframe src="https://www.youtube.com/embed/${videoData.videoId}?autoplay=1" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;

            // Update the active state in the queue
            document.querySelectorAll('.history-item.active').forEach(el => el.classList.remove('active'));
            if (clickedElement) {
                clickedElement.classList.add('active');
                clickedElement.scrollIntoView({ behavior: 'smooth', block: 'center' });
            }

            // Add to history again to move it to the top
            addVideoToHistory(videoData);
            document.getElementById('videoTitle').innerText = videoData.title;
        }



        function formatDate(timestamp) {
            if (!timestamp) return 'date inconnue';
            return new Date(timestamp.seconds * 1000).toLocaleString('fr-FR', {
                dateStyle: 'medium',
                timeStyle: 'short'
            });
        }

        // Shows the main list of discussion threads
        async function showDiscussionsList() {
            document.getElementById('discussionsList').classList.remove('d-none');
            document.getElementById('discussionDetail').classList.add('d-none');
            currentDiscussionId = null;

            const threadsContainer = document.getElementById('threadsContainer');
            threadsContainer.innerHTML = '<div class="text-center p-5"><div class="loader"></div></div>';

            try {
                const q = query(collection(db, 'discussions'), where('createdAt', '!=', null));
                const querySnapshot = await getDocs(q);
                if (querySnapshot.empty) {
                    threadsContainer.innerHTML = '<div class="col-12 text-center text-muted py-5"><i class="bi bi-chat-square-quote fs-1"></i><p class="mt-2">Aucune discussion pour le moment. Soyez le premier à en démarrer une !</p></div>';
                    return;
                }

                threadsContainer.innerHTML = '';
                /*querySnapshot.forEach(doc => {
                    const thread = doc.data();
                    const threadCard = document.createElement('div');
                    threadCard.className = 'card card-modern hover-lift';
                    threadCard.style.cursor = 'pointer';
                    threadCard.onclick = () => showDiscussionDetail(doc.id);
                    threadCard.innerHTML = `
                <div class="card-body d-flex align-items-center">
                    <div class="flex-grow-1">
                        <h5 class="card-title mb-1">${escapeHtml(thread.title)}</h5>
                        <small class="text-muted">
                            Par ${escapeHtml(thread.authorName)} - ${formatDate(thread.createdAt)}
                        </small>
                    </div>
                    <div class="text-center ms-3" style="min-width: 80px;">
                        <span class="fs-4 fw-bold">${thread.replyCount || 0}</span><br>
                        <small class="text-muted">Réponses</small>
                    </div>
                </div>
            `;
                    threadsContainer.appendChild(threadCard);
                });*/
                querySnapshot.forEach(doc => {
                    const thread = doc.data();
                    const isAuthor = auth.currentUser && thread.authorId === auth.currentUser.uid;

                    const threadCard = document.createElement('div');
                    threadCard.className = 'card card-modern hover-lift';
                    threadCard.style.cursor = 'pointer';
                    threadCard.onclick = () => showDiscussionDetail(doc.id);

                    threadCard.innerHTML = `
    <div class="card-body d-flex align-items-center justify-content-between">
      <div class="flex-grow-1">
        <h5 class="card-title mb-1">${escapeHtml(thread.title)}</h5>
        <small class="text-muted">
          Par ${escapeHtml(thread.authorName)} - ${formatDate(thread.createdAt)}
        </small>
      </div>
      <div class="text-center ms-3" style="min-width: 80px;">
        <span class="fs-4 fw-bold">${thread.replyCount || 0}</span><br>
        <small class="text-muted">Réponses</small>
      </div>
      ${isAuthor ? `
        <div class="ms-3">
          <button class="btn btn-sm btn-outline-primary edit-thread" data-id="${doc.id}">
            <i class="bi bi-pencil"></i>
          </button>
          <button class="btn btn-sm btn-outline-danger delete-thread" data-id="${doc.id}">
            <i class="bi bi-trash"></i>
          </button>
        </div>` : ''}
    </div>
  `;
                    threadsContainer.appendChild(threadCard);
                });

            } catch (error) {
                threadsContainer.innerHTML = '<div class="text-center text-danger p-5">Erreur de chargement des discussions.</div>';
                console.error("Error fetching discussions: ", error);
            }
        }

        // Shows a single thread and its replies
        async function showDiscussionDetail(threadId) {
            document.getElementById('discussionsList').classList.add('d-none');
            document.getElementById('discussionDetail').classList.remove('d-none');
            currentDiscussionId = threadId;

            try {
                // Fetch original post
                const threadRef = doc(db, 'discussions', threadId);
                const threadSnap = await getDocs(query(collection(db, 'discussions'), where('__name__', '==', threadId)));
                if (!threadSnap.empty) {
                    const threadData = threadSnap.docs[0].data();
                    document.getElementById('threadTitle').textContent = threadData.title;
                    document.getElementById('threadAuthor').textContent = threadData.authorName;
                    document.getElementById('threadDate').textContent = formatDate(threadData.createdAt);
                    document.querySelector('#threadContent .ql-editor').innerHTML = threadData.content;
                }

                // Fetch replies
                const repliesContainer = document.getElementById('repliesContainer');
                repliesContainer.innerHTML = '<div class="text-center p-3"><div class="loader"></div></div>';
                const repliesQuery = query(collection(db, 'discussions', threadId, 'replies'));
                const repliesSnapshot = await getDocs(repliesQuery);

                if (repliesSnapshot.empty) {
                    repliesContainer.innerHTML = '<p class="text-muted">Aucune réponse pour le moment.</p>';
                } else {
                    repliesContainer.innerHTML = '';
                    /*repliesSnapshot.forEach(replyDoc => {
                        const replyData = replyDoc.data();
                        const replyCard = document.createElement('div');
                        replyCard.className = 'card';
                        replyCard.innerHTML = `
                    <div class="card-body">
                        <p class="text-muted border-bottom pb-2 mb-2">
                            Par <strong>${escapeHtml(replyData.authorName)}</strong> le ${formatDate(replyData.createdAt)}
                        </p>
                        <div class="ql-snow"><div class="ql-editor">${replyData.content}</div></div>
                    </div>
                `;
                        repliesContainer.appendChild(replyCard);
                    });*/

                    repliesSnapshot.forEach(replyDoc => {
                        const replyData = replyDoc.data();
                        const isAuthor = auth.currentUser && replyData.authorId === auth.currentUser.uid;

                        const replyCard = document.createElement('div');
                        replyCard.className = 'card mb-2';
                        replyCard.innerHTML = `
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-start">
        <p class="text-muted border-bottom pb-2 mb-2 flex-grow-1">
          Par <strong>${escapeHtml(replyData.authorName)}</strong> le ${formatDate(replyData.createdAt)}
        </p>
        ${isAuthor ? `
          <div>
            <button class="btn btn-sm btn-outline-primary edit-reply" data-id="${replyDoc.id}">
              <i class="bi bi-pencil"></i>
            </button>
            <button class="btn btn-sm btn-outline-danger delete-reply" data-id="${replyDoc.id}">
              <i class="bi bi-trash"></i>
            </button>
          </div>
        ` : ''}
      </div>
      <div class="ql-snow">
        <div class="ql-editor reply-content">${replyData.content}</div>
      </div>
    </div>
  `;
                        repliesContainer.appendChild(replyCard);
                    });

                }

            } catch (error) {
                console.error("Error fetching thread detail:", error);
            }
        }

        // 4. Add all these event listeners to your script
        document.addEventListener('DOMContentLoaded', () => {
            // Initialize Quill editors when the modals are shown to ensure the containers are visible
            document.getElementById('newDiscussionModal').addEventListener('shown.bs.modal', () => {
                if (!newDiscussionQuill) {
                    newDiscussionQuill = initializeQuill('#newDiscussionEditor');
                }
            });

            if (document.getElementById('discussionDetail')) { // Check if element exists before adding listener
                replyQuill = initializeQuill('#replyEditor');
            }
        });

        document.getElementById('newDiscussionForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) {
                showToast('Vous devez être connecté pour poster.', 'warning');
                return;
            }

            const title = document.getElementById('newDiscussionTitle').value;
            const content = newDiscussionQuill.root.innerHTML;

            try {
                await addDoc(collection(db, 'discussions'), {
                    title: title,
                    content: content,
                    authorId: user.uid,
                    authorName: user.displayName || 'Anonyme',
                    createdAt: Timestamp.now(),
                    replyCount: 0
                });
                showToast('Discussion publiée avec succès !', 'success');
                newDiscussionModal.hide();
                document.getElementById('newDiscussionForm').reset();
                newDiscussionQuill.setText('');
                showDiscussionsList(); // Refresh the list
            } catch (error) {
                showToast('Erreur : ' + error.message, 'danger');
            }
        });

        // ============================
        // EDIT & DELETE HANDLERS
        // ============================

        // Delete Thread
        document.addEventListener('click', async (e) => {
            if (e.target.closest('.delete-thread')) {
                e.stopPropagation();
                const id = e.target.closest('.delete-thread').dataset.id;
                if (confirm('Supprimer cette discussion ?')) {
                    await deleteDoc(doc(db, 'discussions', id));
                    showToast('Discussion supprimée.', 'success');
                    showDiscussionsList();
                }
            }
        });

        // Edit Thread
        document.addEventListener('click', async (e) => {
            if (e.target.closest('.edit-thread')) {
                e.stopPropagation();
                const id = e.target.closest('.edit-thread').dataset.id;
                const threadRef = doc(db, 'discussions', id);
                const snap = await getDoc(threadRef);
                if (!snap.exists()) return;

                const threadData = snap.data();
                const newTitle = prompt('Modifier le titre :', threadData.title);
                if (newTitle === null) return;

                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = threadData.content;
                const oldContent = tempDiv.innerText;

                const newContent = prompt('Modifier le contenu :', oldContent);
                if (newContent !== null) {
                    await updateDoc(threadRef, {
                        title: newTitle,
                        content: newContent
                    });
                    showToast('Discussion mise à jour.', 'success');
                    showDiscussionsList();
                }
            }
        });

        // Delete Reply
        document.addEventListener('click', async (e) => {
            if (e.target.closest('.delete-reply')) {
                const replyId = e.target.closest('.delete-reply').dataset.id;
                if (confirm('Supprimer cette réponse ?')) {
                    await deleteDoc(doc(db, 'discussions', currentDiscussionId, 'replies', replyId));
                    showToast('Réponse supprimée.', 'success');
                    showDiscussionDetail(currentDiscussionId);
                }
            }
        });

        // Edit Reply
        document.addEventListener('click', async (e) => {
            if (e.target.closest('.edit-reply')) {
                const replyId = e.target.closest('.edit-reply').dataset.id;
                const replyRef = doc(db, 'discussions', currentDiscussionId, 'replies', replyId);
                const snap = await getDoc(replyRef);
                if (!snap.exists()) return;

                const replyData = snap.data();
                const tempDiv = document.createElement('div');
                tempDiv.innerHTML = replyData.content;
                const oldContent = tempDiv.innerText;
                const newContent = prompt('Modifier votre réponse :', oldContent);
                if (newContent !== null) {
                    await updateDoc(replyRef, { content: newContent });
                    showToast('Réponse mise à jour.', 'success');
                    showDiscussionDetail(currentDiscussionId);
                }
            }
        });
        /*
        document.getElementById('replyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user || !currentDiscussionId) return;

            const content = replyQuill.root.innerHTML;

            try {
                await addDoc(collection(db, 'discussions', currentDiscussionId, 'replies'), {
                    content: content,
                    authorId: user.uid,
                    authorName: user.displayName || 'Anonyme',
                    createdAt: Timestamp.now()
                });

                // This is a simple way to update reply count. For high-traffic apps, use Cloud Functions.
                const threadRef = doc(db, 'discussions', currentDiscussionId);
                const threadSnap = await getDocs(query(collection(db, 'discussions'), where('__name__', '==', currentDiscussionId)));
                if (!threadSnap.empty) {
                    const currentCount = threadSnap.docs[0].data().replyCount || 0;
                    await updateDoc(threadRef, { replyCount: currentCount + 1 });
                }

                showToast('Réponse publiée !', 'success');
                replyQuill.setText('');
                showDiscussionDetail(currentDiscussionId); // Refresh the detail view
            } catch (error) {
                showToast('Erreur : ' + error.message, 'danger');
            }
        });
        */

        document.getElementById('replyForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user || !currentDiscussionId) return;

            const content = replyQuill.root.innerHTML;

            try {
                // --- Step 1: Add the reply (this is your existing code) ---
                await addDoc(collection(db, 'discussions', currentDiscussionId, 'replies'), {
                    content: content,
                    authorId: user.uid,
                    authorName: user.displayName || 'Anonyme',
                    createdAt: Timestamp.now()
                });

                // --- Step 2: Update the reply count (this is your existing code) ---
                const threadRef = doc(db, 'discussions', currentDiscussionId);
                const threadSnap = await getDocs(query(collection(db, 'discussions'), where('__name__', '==', currentDiscussionId)));
                let threadData;
                if (!threadSnap.empty) {
                    threadData = threadSnap.docs[0].data();
                    const currentCount = threadData.replyCount || 0;
                    await updateDoc(threadRef, { replyCount: currentCount + 1 });
                }

                showToast('Réponse publiée !', 'success');
                replyQuill.setText('');
                showDiscussionDetail(currentDiscussionId);

                // --- Step 3: NEW - Create the notification ---
                if (threadData) {
                    const originalAuthorId = threadData.authorId;
                    // IMPORTANT: Don't notify the user if they reply to their own post
                    if (originalAuthorId !== user.uid) {
                        const notificationPayload = {
                            message: `<strong>User B</strong> a répondu à votre discussion.`,
                            type: "new_reply",
                            link: "/discussions/the_thread_id"
                        };
                        await createNotification(originalAuthorId, notificationPayload);
                    }
                }

            } catch (error) {
                showToast('Erreur : ' + error.message, 'danger');
            }
        });
        document.getElementById('backToDiscussions').addEventListener('click', showDiscussionsList);

        function renderVideos() {
            const grid = document.getElementById('videosGrid');
            const videos = allFiles.filter(f => f.mimeType?.startsWith('video/'));

            grid.innerHTML = '';
            if (!videos.length) {
                grid.innerHTML = '<div class="col-12 text-center text-muted py-5"><i class="bi bi-camera-video fs-1"></i><p class="mt-2">Aucune vidéo trouvée</p></div>';
                return;
            }

            videos.forEach(file => {
                const progress = userProgress[file.id] || 0;
                const col = document.createElement('div');
                col.className = 'col-lg-6 col-xl-4';
                col.innerHTML = `
        <div class="card card-modern h-100 fade-in">
          <div class="position-relative">
            <img src="${file.thumbnailLink || 'https://via.placeholder.com/400x225/dc3545/ffffff?text=Vidéo'}" class="course-thumbnail w-100" alt="${escapeHtml(file.name)}">
            <div class="position-absolute top-50 start-50 translate-middle">
              <button class="btn btn-danger btn-lg rounded-circle" style="width:64px; height:64px" onclick="playVideo('${file.id}', '${escapeHtml(file.name)}', '${file.webViewLink || ''}')">
                <i class="bi bi-play-fill fs-3"></i>
              </button>
            </div>
            ${progress > 0 ? `<div class="progress-ring">${progress}%</div>` : ''}
          </div>
          <div class="card-body">
            <h6>${escapeHtml(file.name)}</h6>
            ${progress > 0 ? `
              <div class="progress mt-2" style="height:6px">
                <div class="progress-bar bg-danger" style="width:${progress}%"></div>
              </div>` : ''}
            <div class="d-flex gap-2 mt-3">
              <button class="btn btn-sm btn-outline-primary flex-grow-1" onclick="playVideo('${file.id}', '${escapeHtml(file.name)}', '${file.webViewLink || ''}')">
                <i class="bi bi-play me-1"></i>Regarder
              </button>
              <button class="btn btn-sm btn-outline-secondary" onclick="saveForLater('${file.id}')">
                <i class="bi bi-bookmark"></i>
              </button>
            </div>
          </div>
        </div>
      `;
                grid.appendChild(col);
            });
        }

        /*

        async function fetchYoutubeTutorials() {
            const grid = document.getElementById('youtubeVideosGrid');
            grid.innerHTML = '<div class="col-12 text-center"><div class="loader"></div></div>';

            try {
                const queries = allFiles.filter(f => f.mimeType === 'application/vnd.google-apps.folder').map(f => f.name + ' tutorial');
                const results = [];
                for (const q of queries) {
                    const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(q)}&type=video,playlist&maxResults=5&key=${YOUTUBE_API_KEY}`;
                    const res = await fetch(url);
                    const json = await res.json();
                    results.push(...(json.items || []));
                }
                renderYoutubeResults(results);
            } catch (err) {
                grid.innerHTML = '<div class="col-12 text-center text-muted">Erreur de chargement des tutoriels YouTube</div>';
            }
        }
        */

        async function fetchYoutubeTutorials() {
            const grid = document.getElementById('youtubeVideosGrid');
            if (!grid) return;

            // --- CACHING LOGIC (for YouTube results) ---
            const cachedResults = sessionStorage.getItem('youtubeRecommendations');
            const cacheTimestamp = sessionStorage.getItem('youtubeRecsTimestamp');

            if (cachedResults && cacheTimestamp && (new Date() - new Date(cacheTimestamp)) < 3600000) { // 1 hour
                console.log("Loading YouTube recommendations from cache.");
                renderYoutubeResults(JSON.parse(cachedResults));
                return;
            }

            grid.innerHTML = '<div class="col-12 text-center"><div class="loader"></div><p class="text-muted mt-2">Recherche de tutoriels...</p></div>';

            try {
                // --- THE FIX: Call the new self-sufficient function ---
                const queries = await getYoutubeSearchQueries();

                if (queries.length === 0) {
                    grid.innerHTML = '<div class="col-12 text-center text-muted py-3"><i class="bi bi-search-heart fs-2"></i><p class="mt-2">Aucun cours trouvé pour générer des recommandations.</p></div>';
                    return;
                }

                const fetchPromises = queries.map(q => {
                    const url = `https://www.googleapis.com/youtube/v3/search?part=snippet&q=${encodeURIComponent(q)}&type=video,playlist&maxResults=3&key=${YOUTUBE_API_KEY}`;
                    return fetch(url).then(res => res.json());
                });

                const results = await Promise.all(fetchPromises);

                const allItems = [];
                results.forEach(json => {
                    if (json.error) {
                        throw new Error(`Erreur API YouTube: ${json.error.message}`);
                    }
                    if (json.items) {
                        allItems.push(...json.items);
                    }
                });

                // Save the final results to cache
                sessionStorage.setItem('youtubeRecommendations', JSON.stringify(allItems));
                sessionStorage.setItem('youtubeRecsTimestamp', new Date().toISOString());

                renderYoutubeResults(allItems);

            } catch (err) {
                console.error('Erreur de chargement des tutoriels YouTube:', err);
                grid.innerHTML = `<div class="col-12 text-center text-danger py-3"><i class="bi bi-exclamation-triangle fs-2"></i><p class="mt-2">Impossible de charger les recommandations.<br><small>${err.message}</small></p></div>`;
            }
        }
        // Add this NEW helper function somewhere in your script
        async function getYoutubeSearchQueries() {
            // Use a simple cache to avoid calling the Drive API every time
            const cachedFolders = sessionStorage.getItem('courseFoldersForYT');
            if (cachedFolders) {
                return JSON.parse(cachedFolders);
            }

            try {
                // This is a targeted, lightweight API call just to get folder names
                const url = `https://www.googleapis.com/drive/v3/files?q='${DRIVE_FOLDER_ID}'+in+parents+and+mimeType='application/vnd.google-apps.folder'&fields=files(name)&key=${DRIVE_API_KEY}`;
                const res = await fetch(url);
                const json = await res.json();

                if (json.error) throw new Error(json.error.message);

                const queries = json.files.map(f => f.name + ' tutorial');

                // Save the generated queries to cache for next time
                sessionStorage.setItem('courseFoldersForYT', JSON.stringify(queries));
                return queries;

            } catch (err) {
                console.error("Could not fetch course folders for YouTube search:", err);
                return []; // Return an empty array on failure
            }
        }

        function renderYoutubeResults(items) {
            const grid = document.getElementById('youtubeVideosGrid');
            grid.innerHTML = '';
            items.forEach(item => {
                const isPlaylist = item.id.kind === 'youtube#playlist';
                const id = isPlaylist ? item.id.playlistId : item.id.videoId;
                const type = isPlaylist ? 'playlist' : 'video';
                const thumb = item.snippet.thumbnails?.medium?.url || 'https://via.placeholder.com/320x180';
                const col = document.createElement('div');
                col.className = 'col-md-4';
                col.innerHTML = `
        <div class="card card-modern h-100 fade-in">
          <div class="position-relative">
            <img src="${thumb}" class="card-img-top" alt="${escapeHtml(item.snippet.title)}">
            <div class="position-absolute top-50 start-50 translate-middle">
              <button class="btn btn-danger rounded-circle" onclick="playYoutube('${type}', '${id}', '${escapeHtml(item.snippet.title)}')">
                <i class="bi bi-play-fill fs-4"></i>
              </button>
            </div>
          </div>
          <div class="card-body">
            <h6 class="card-title">${escapeHtml(item.snippet.title)}</h6>
            <small class="text-muted">${item.snippet.channelTitle}</small>
          </div>
        </div>
      `;
                grid.appendChild(col);
            });
        }

        function renderContributedVideos() {
            const grid = document.getElementById('contributedVideosGrid');
            grid.innerHTML = '';
            contributedContent.forEach(content => {
                const col = document.createElement('div');
                col.className = 'col-md-4';
                col.innerHTML = `
        <div class="card card-modern h-100 fade-in">
          <div class="position-relative">
            <img src="https://img.youtube.com/vi/${content.type === 'playlist' ? '' : content.id}/mqdefault.jpg" class="card-img-top" alt="${escapeHtml(content.title)}">
            <div class="position-absolute top-50 start-50 translate-middle">
              <button class="btn btn-danger rounded-circle" onclick="playYoutube('${content.type}', '${content.id}', '${escapeHtml(content.title)}')">
                <i class="bi bi-play-fill fs-4"></i>
              </button>
            </div>
          </div>
          <div class="card-body">
            <h6 class="card-title">${escapeHtml(content.title || 'Sans titre')}</h6>
            <small class="text-muted">${content.type.charAt(0).toUpperCase() + content.type.slice(1)} - Par ${escapeHtml(content.userName)}</small>
          </div>
        </div>
      `;
                grid.appendChild(col);
            });
        }

        /*function renderContributed() {
            const grid = document.getElementById('contributedGrid');
            grid.innerHTML = '';
            contributedContent.forEach(content => {
                const col = document.createElement('div');
                col.className = 'col-md-4';
                col.innerHTML = `
        <div class="card card-modern h-100 fade-in">
          <div class="position-relative">
            <img src="https://img.youtube.com/vi/${content.type === 'playlist' ? '' : content.id}/mqdefault.jpg" class="card-img-top" alt="${escapeHtml(content.title)}">
            <div class="position-absolute top-50 start-50 translate-middle">
              <button class="btn btn-danger rounded-circle" onclick="playYoutube('${content.type}', '${content.id}', '${escapeHtml(content.title)}')">
                <i class="bi bi-play-fill fs-4"></i>
              </button>
            </div>
          </div>
          <div class="card-body">
            <h6 class="card-title">${escapeHtml(content.title || 'Sans titre')}</h6>
            <small class="text-muted">${content.type.charAt(0).toUpperCase() + content.type.slice(1)} - Par ${escapeHtml(content.userName)}</small>
          </div>
        </div>
      `;
                grid.appendChild(col);
            });
        }*/

        function renderContributed() {
            const grid = document.getElementById('contributedGrid');
            grid.innerHTML = '';

            if (contributedContent.length === 0) {
                grid.innerHTML = '<div class="col-12 text-center text-muted py-5"><i class="bi bi-cloud-slash fs-1"></i><p class="mt-2">Aucun contenu contribué pour le moment.</p></div>';
                return;
            }

            contributedContent.forEach(content => {
                const col = document.createElement('div');
                col.className = 'col-lg-4 col-md-6';
                let cardHTML = '';

                // --- STYLING OVERHAUL ---
                switch (content.type) {
                    case 'youtube':
                        cardHTML = `
                    <div class="video-card h-100 fade-in" style="cursor: pointer;" onclick='viewContributedContent(${JSON.stringify(content)})'>
                        <div class="video-thumb">
                            <img src="https://img.youtube.com/vi/${content.youtubeId}/mqdefault.jpg" class="video-thumb-img" alt="${escapeHtml(content.title)}">
                            <div class="video-overlay"><i class="bi bi-play-fill play-icon"></i></div>
                        </div>
                        <div class="video-body d-flex flex-column">
                            <h6 class="video-title"><i class="bi bi-youtube text-danger me-2"></i>${escapeHtml(content.title || 'Vidéo YouTube')}</h6>
                            <p class="video-author mt-auto"><i class="bi bi-person-circle me-1"></i>${escapeHtml(content.userName)}</p>
                        </div>
                    </div>`;
                        break;

                    case 'gdrive_video':
                    case 'gdrive_doc':
                        const isVideo = content.type === 'gdrive_video';
                        const iconClass = isVideo ? 'bi-camera-video-fill text-primary' : 'bi-file-earmark-pdf-fill text-danger';
                        const iconBg = isVideo ? 'linear-gradient(135deg, var(--info) 20%, var(--brand) 100%)' : 'linear-gradient(135deg, var(--danger) 20%, #841212 100%)';

                        cardHTML = `
                    <div class="card card-modern h-100 fade-in hover-lift" style="cursor: pointer;" onclick='viewContributedContent(${JSON.stringify(content)})'>
                        <div class="card-body d-flex flex-column">
                             <div class="flex-grow-1 rounded d-flex align-items-center justify-content-center" style="background: ${iconBg};">
                                <i class="bi ${iconClass}" style="font-size: 4rem; color: #fff; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2));"></i>
                            </div>
                            <h6 class="card-title mt-3"><i class="bi bi-google me-2"></i>${escapeHtml(content.title || 'Document Drive')}</h6>
                            <p class="video-author mt-auto text-muted"><i class="bi bi-person-circle me-1"></i>${escapeHtml(content.userName)}</p>
                        </div>
                    </div>`;
                        break;

                    case 'link':
                        cardHTML = `
                     <div class="card card-modern h-100 fade-in hover-lift" style="cursor: pointer;" onclick='viewContributedContent(${JSON.stringify(content)})'>
                        <div class="card-body d-flex flex-column">
                             <div class="flex-grow-1 rounded d-flex align-items-center justify-content-center" style="background: linear-gradient(135deg, var(--muted) 20%, var(--text) 100%);">
                                <i class="bi bi-link-45deg" style="font-size: 5rem; color: #fff; filter: drop-shadow(0 4px 6px rgba(0,0,0,0.2));"></i>
                            </div>
                            <h6 class="card-title mt-3"><i class="bi bi-globe me-2"></i>${escapeHtml(content.title || 'Lien Web')}</h6>
                            <p class="video-author mt-auto text-muted"><i class="bi bi-person-circle me-1"></i>${escapeHtml(content.userName)}</p>
                        </div>
                    </div>`;
                        break;
                }
                col.innerHTML = cardHTML;
                grid.appendChild(col);
            });
        }

        window.viewContributedContent = function (content) {
            const safeContent = JSON.parse(JSON.stringify(content));

            switch (safeContent.type) {
                case 'youtube':
                    playYoutube(safeContent.youtubeType, safeContent.youtubeId, safeContent.title);
                    break;

                // --- THE FIX: NEW CASE FOR GDRIVE VIDEOS ---
                case 'gdrive_video':
                    // Open in the VIDEO modal
                    document.getElementById('videoTitle').innerText = safeContent.title || 'Vidéo';
                    const videoContainer = document.getElementById('videoContainer');
                    videoContainer.innerHTML = `<iframe src="https://drive.google.com/file/d/${safeContent.gdriveId}/preview" frameborder="0" allow="autoplay" allowfullscreen></iframe>`;

                    // Hide the history panel for non-YouTube videos
                    playlistPanel.classList.add('d-none');
                    playlistPanel.classList.remove('d-flex');

                    videoModal.show();
                    break;

                case 'gdrive_doc':
                    // Open in the DOCUMENT modal
                    document.getElementById('documentTitle').innerText = safeContent.title || 'Document';
                    const docContainer = document.getElementById('documentContainer');
                    docContainer.innerHTML = `<iframe src="https://drive.google.com/file/d/${safeContent.gdriveId}/preview" frameborder="0"></iframe>`;
                    documentModal.show();
                    break;

                case 'link':
                    if (confirm(`Vous allez être redirigé vers un lien externe:\n\n${safeContent.url}\n\nVoulez-vous continuer ?`)) {
                        window.open(safeContent.url, '_blank', 'noopener,noreferrer');
                    }
                    break;
            }
        }
        /*function renderDocuments() {
            const grid = document.getElementById('documentsGrid');
            const docs = allFiles.filter(f => {
                const mime = f.mimeType || '';
                return mime.includes('pdf') || mime.includes('document') || mime.includes('spreadsheet') || mime.includes('presentation');
            });

            grid.innerHTML = '';
            if (!docs.length) {
                grid.innerHTML = '<div class="col-12 text-center text-muted py-5"><i class="bi bi-file-earmark fs-1"></i><p class="mt-2">Aucun document trouvé</p></div>';
                return;
            }

            docs.forEach(file => {
                const meta = getFileMeta(file.mimeType);
                const col = document.createElement('div');
                col.className = 'col-lg-4 col-md-6';
                col.innerHTML = `
        <div class="card card-modern h-100 fade-in">
          <div class="card-body">
            <div class="d-flex gap-3 mb-3">
              <div style="font-size:48px; color:${meta.color}">
                <i class="${meta.icon}"></i>
              </div>
              <div class="flex-grow-1">
                <h6 class="mb-1">${escapeHtml(file.name)}</h6>
                <small class="text-muted">${meta.label}</small>
                ${file.modifiedTime ? `<div><small class="text-muted">Modifié : ${new Date(file.modifiedTime).toLocaleDateString('fr-FR')}</small></div>` : ''}
              </div>
            </div>
            <div class="d-grid gap-2">
              <button class="btn btn-sm btn-primary" onclick="viewDocument('${file.id}', '${escapeHtml(file.name)}', '${file.webViewLink || ''}', '${meta.kind}')">
                <i class="bi bi-eye me-1"></i>Voir
              </button>
              ${file.webContentLink ?
                        `<a class="btn btn-sm btn-outline-secondary" href="${file.webContentLink}" target="_blank">
                  <i class="bi bi-download me-1"></i>Télécharger
                </a>` : ''}
            </div>
          </div>
        </div>
      `;
                grid.appendChild(col);
            });
        }*/

        function renderDocuments() {
            const grid = document.getElementById('documentsGrid');
            const docs = allFiles.filter(f => {
                const mime = f.mimeType || '';
                return mime.includes('pdf') || mime.includes('document') || mime.includes('spreadsheet') || mime.includes('presentation');
            });

            grid.innerHTML = '';
            if (!docs.length) {
                grid.innerHTML = '<div class="col-12 text-center text-muted py-5"><i class="bi bi-file-earmark-x fs-1"></i><p class="mt-2">Aucun document trouvé</p></div>';
                return;
            }

            // Adjust grid classes based on view mode
            grid.className = documentViewMode === 'grid' ? 'row g-4' : 'row g-2';

            docs.forEach(file => {
                const meta = getFileMeta(file.mimeType);
                const col = document.createElement('div');

                if (documentViewMode === 'grid') {
                    // --- GRID VIEW RENDER ---
                    col.className = 'col-lg-4 col-md-6';
                    col.innerHTML = `
                <div class="card card-modern h-100 fade-in">
                    <div class="card-body d-flex flex-column">
                        <div class="d-flex gap-3 mb-3">
                            <div style="font-size:48px; color:${meta.color}">
                                <i class="${meta.icon}"></i>
                            </div>
                            <div class="flex-grow-1">
                                <h6 class="mb-1">${escapeHtml(file.name)}</h6>
                                <small class="text-muted">${meta.label}</small>
                                ${file.modifiedTime ? `<div><small class="text-muted">Modifié : ${new Date(file.modifiedTime).toLocaleDateString('fr-FR')}</small></div>` : ''}
                            </div>
                            <button class="btn btn-sm btn-link text-warning p-0" onclick="toggleFavorite('${file.id}', event)" title="Ajouter aux favoris">
                                <i class="bi ${favoriteDocuments.includes(file.id) ? 'bi-star-fill' : 'bi-star'}"></i>
                            </button>
                        </div>
                        <div class="mt-auto d-grid gap-2">
                            <button class="btn btn-sm btn-primary" onclick="viewDocument('${file.id}', '${escapeHtml(file.name)}', '${file.webViewLink || ''}', '${meta.kind}')">
                                <i class="bi bi-eye me-1"></i>Voir
                            </button>
                            ${file.webContentLink ? `<a class="btn btn-sm btn-outline-secondary" href="${file.webContentLink}" target="_blank"><i class="bi bi-download me-1"></i>Télécharger</a>` : ''}
                        </div>
                    </div>
                </div>
            `;
                } else {
                    // --- LIST VIEW RENDER ---
                    col.className = 'col-12';
                    col.innerHTML = `
                <div class="card card-modern fade-in">
                    <div class="card-body p-2 d-flex align-items-center gap-3">
                        <div style="font-size:32px; color:${meta.color}; min-width: 40px; text-align: center;">
                            <i class="${meta.icon}"></i>
                        </div>
                        <div class="flex-grow-1">
                            <h6 class="mb-0 small">${escapeHtml(file.name)}</h6>
                            <small class="text-muted">${meta.label} - Modifié le ${new Date(file.modifiedTime).toLocaleDateString('fr-FR')}</small>
                        </div>
                        <div class="ms-auto">
                            <button class="btn btn-sm btn-outline-warning" onclick="toggleFavorite('${file.id}', event)" title="Ajouter aux favoris">
                                <i class="bi ${favoriteDocuments.includes(file.id) ? 'bi-star-fill' : 'bi-star'}"></i>
                            </button>
                            <button class="btn btn-sm btn-outline-primary" onclick="viewDocument('${file.id}', '${escapeHtml(file.name)}', '${file.webViewLink || ''}', '${meta.kind}')" title="Voir">
                                <i class="bi bi-eye"></i>
                            </button>
                             ${file.webContentLink ? `<a class="btn btn-sm btn-outline-secondary" href="${file.webContentLink}" target="_blank" title="Télécharger"><i class="bi bi-download"></i></a>` : ''}
                        </div>
                    </div>
                </div>
            `;
                }
                grid.appendChild(col);
            });
        }

        // 1. Add these variables at the top
        let favoriteDocuments = JSON.parse(localStorage.getItem('favoriteDocuments')) || [];

        // 2. Add this new function to handle toggling favorites
        window.toggleFavorite = function (fileId, event) {
            event.stopPropagation(); // Prevents the card from being clicked
            const starIcon = event.currentTarget.querySelector('i');

            const index = favoriteDocuments.indexOf(fileId);
            if (index > -1) {
                favoriteDocuments.splice(index, 1); // Remove from favorites
                starIcon.classList.remove('bi-star-fill');
                starIcon.classList.add('bi-star');
            } else {
                favoriteDocuments.push(fileId); // Add to favorites
                starIcon.classList.add('bi-star-fill');
                starIcon.classList.remove('bi-star');
            }

            localStorage.setItem('favoriteDocuments', JSON.stringify(favoriteDocuments));
            showToast('Favoris mis à jour !', 'info');
        }

        function renderAssignments() {
            const grid = document.getElementById('assignmentsGrid');
            grid.innerHTML = '<div class="col-12 text-center text-muted py-5"><i class="bi bi-tools fs-1"></i><p class="mt-2">Cette fonctionnalité est en cours de développement.</p></div>';
        }

        /*function renderCalendar() {
            const eventsDiv = document.getElementById('calendarEvents');
            eventsDiv.innerHTML = '<div class="text-center text-muted py-5"><i class="bi bi-tools fs-1"></i><p class="mt-2">Cette fonctionnalité est en cours de développement.</p></div>';
        }*/

        // 2. Add these constants near your other modal constants
        const eventModal = new bootstrap.Modal(document.getElementById('eventModal'));
        let calendar; // Will hold the FullCalendar instance


        // 3. ENTIRELY REPLACE your old `renderCalendar` function with this new one
        async function renderCalendar() {
            const calendarEl = document.getElementById('calendar');
            if (!calendarEl) return;

            // Clear any previous calendar instance to prevent memory leaks
            if (calendar) {
                calendar.destroy();
            }

            const user = auth.currentUser;
            if (!user) {
                calendarEl.innerHTML = '<div class="text-center text-muted p-5"><i class="bi bi-lock fs-1"></i><p class="mt-2">Veuillez vous connecter pour voir votre calendrier.</p></div>';
                return;
            }

            calendar = new FullCalendar.Calendar(calendarEl, {
                themeSystem: 'bootstrap5',
                locale: 'fr',
                headerToolbar: {
                    left: 'prev,next today',
                    center: 'title',
                    right: 'dayGridMonth,timeGridWeek,timeGridDay,listWeek'
                },
                initialView: 'dayGridMonth',
                editable: true,    // Allow dragging and resizing
                selectable: true,  // Allow clicking and dragging to select dates
                events: async (fetchInfo, successCallback, failureCallback) => {
                    // Fetch events from Firestore
                    try {
                        const eventsCol = collection(db, 'users', user.uid, 'events');
                        const eventSnapshot = await getDocs(eventsCol);
                        const events = eventSnapshot.docs.map(doc => ({
                            id: doc.id,
                            title: doc.data().title,
                            start: doc.data().start.toDate(),
                            end: doc.data().end.toDate(),
                            allDay: doc.data().allDay
                        }));
                        successCallback(events);
                    } catch (error) {
                        console.error("Error fetching events: ", error);
                        failureCallback(error);
                    }
                },

                // --- Event Handlers ---

                // Fired when a user clicks and drags on a date range
                select: (selectionInfo) => {
                    const eventForm = document.getElementById('eventForm');
                    eventForm.reset();
                    document.getElementById('eventId').value = '';
                    document.getElementById('deleteEventButton').style.display = 'none';

                    // Pre-fill dates in the modal
                    document.getElementById('eventStart').value = formatDateTimeLocal(selectionInfo.start);
                    document.getElementById('eventEnd').value = formatDateTimeLocal(selectionInfo.end);
                    document.getElementById('eventAllDay').checked = selectionInfo.allDay;

                    eventModal.show();
                },

                // Fired when a user clicks an existing event
                eventClick: (clickInfo) => {
                    const event = clickInfo.event;
                    document.getElementById('eventId').value = event.id;
                    document.getElementById('eventTitle').value = event.title;
                    document.getElementById('eventStart').value = formatDateTimeLocal(event.start);
                    document.getElementById('eventEnd').value = event.end ? formatDateTimeLocal(event.end) : formatDateTimeLocal(event.start);
                    document.getElementById('eventAllDay').checked = event.allDay;

                    document.getElementById('deleteEventButton').style.display = 'block';
                    eventModal.show();
                },

                // Fired when an event is dragged and dropped
                eventDrop: async (dropInfo) => {
                    try {
                        const eventRef = doc(db, 'users', user.uid, 'events', dropInfo.event.id);
                        await updateDoc(eventRef, {
                            start: Timestamp.fromDate(dropInfo.event.start),
                            end: Timestamp.fromDate(dropInfo.event.end || dropInfo.event.start),
                            allDay: dropInfo.event.allDay
                        });
                        showToast('Événement déplacé avec succès !', 'success');
                    } catch (error) {
                        showToast('Erreur lors du déplacement de l\'événement.', 'danger');
                        dropInfo.revert(); // Revert the change on failure
                    }
                },
            });

            calendar.render();
        }

        // 4. Add this new helper function somewhere in your script
        function formatDateTimeLocal(date) {
            if (!date) return '';
            const ten = (i) => (i < 10 ? '0' : '') + i;
            const YYYY = date.getFullYear();
            const MM = ten(date.getMonth() + 1);
            const DD = ten(date.getDate());
            const HH = ten(date.getHours());
            const II = ten(date.getMinutes());
            return `${YYYY}-${MM}-${DD}T${HH}:${II}`;
        }

        // 5. Add these event listeners for the modal form somewhere in your script
        /*document.getElementById('eventForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) return;

            const eventId = document.getElementById('eventId').value;
            const eventData = {
                title: document.getElementById('eventTitle').value,
                start: Timestamp.fromDate(new Date(document.getElementById('eventStart').value)),
                end: Timestamp.fromDate(new Date(document.getElementById('eventEnd').value)),
                allDay: document.getElementById('eventAllDay').checked,
                userId: user.uid // Important for security rules
            };

            try {
                if (eventId) { // Update existing event
                    const eventRef = doc(db, 'users', user.uid, 'events', eventId);
                    await updateDoc(eventRef, eventData);
                    showToast('Événement mis à jour !', 'success');
                } else { // Create new event
                    const newEventRef = doc(collection(db, 'users', user.uid, 'events'));
                    await setDoc(newEventRef, eventData);
                    showToast('Événement ajouté !', 'success');
                }
                eventModal.hide();
                calendar.refetchEvents(); // Refresh the calendar to show the new/updated event
            } catch (error) {
                showToast('Erreur : ' + error.message, 'danger');
            }
        });
        */

        document.getElementById('eventForm').addEventListener('submit', async (e) => {
            e.preventDefault();
            const user = auth.currentUser;
            if (!user) return;

            const eventId = document.getElementById('eventId').value;

            // THE FIX: Add the new alarm and sound fields to the data object
            const eventData = {
                title: document.getElementById('eventTitle').value,
                start: Timestamp.fromDate(new Date(document.getElementById('eventStart').value)),
                end: Timestamp.fromDate(new Date(document.getElementById('eventEnd').value)),
                allDay: document.getElementById('eventAllDay').checked,
                alarm: document.getElementById('eventAlarm').value, // <-- NEW
                sound: document.getElementById('eventSound').value, // <-- NEW
                userId: user.uid
            };

            try {
                if (eventId) {
                    const eventRef = doc(db, 'users', user.uid, 'events', eventId);
                    await updateDoc(eventRef, eventData);
                    showToast('Événement mis à jour !', 'success');
                } else {
                    const newEventRef = doc(collection(db, 'users', user.uid, 'events'));
                    await setDoc(newEventRef, eventData);
                    showToast('Événement ajouté !', 'success');
                }
                eventModal.hide();
                calendar.refetchEvents();
            } catch (error) {
                showToast('Erreur : ' + error.message, 'danger');
            }
        });

        document.getElementById('deleteEventButton').addEventListener('click', async () => {
            const user = auth.currentUser;
            const eventId = document.getElementById('eventId').value;
            if (!user || !eventId) return;

            if (confirm("Êtes-vous sûr de vouloir supprimer cet événement ?")) {
                try {
                    await deleteDoc(doc(db, 'users', user.uid, 'events', eventId));
                    showToast('Événement supprimé.', 'info');
                    eventModal.hide();
                    calendar.refetchEvents();
                } catch (error) {
                    showToast('Erreur lors de la suppression.', 'danger');
                }
            }
        });

        function renderNotes() {
            const list = document.getElementById('notesList');
            list.innerHTML = '';

            if (notes.length === 0) {
                list.innerHTML = '<div class="col-12 text-center text-muted py-5"><i class="bi bi-journal-x fs-1"></i><p class="mt-2">Vous n\'avez aucune note.</p></div>';
                return;
            }

            notes.forEach((note, index) => {
                const col = document.createElement('div');
                col.className = 'col-md-4';
                col.innerHTML = `
        <div class="card card-modern fade-in">
          <div class="card-body">
            <h6>${note.title}</h6>
            <p class="text-muted small">${note.date}</p>
            <p>${note.content.substring(0, 100)}...</p>
            <button class="btn btn-sm btn-outline-danger" onclick="deleteNote(${index})">Supprimer</button>
          </div>
        </div>
      `;
                list.appendChild(col);
            });
        }

        window.deleteNote = function (index) {
            notes.splice(index, 1);
            localStorage.setItem('notes', JSON.stringify(notes));
            renderNotes();
        };

        /*function renderProgress() {
            const ctx = document.getElementById('progressChart').getContext('2d');
            const completed = Object.values(userProgress).filter(p => p === 100).length;
            const inProgress = Object.values(userProgress).filter(p => p > 0 && p < 100).length;
            const notStarted = allFiles.length - completed - inProgress;

            new Chart(ctx, {
                type: 'pie',
                data: {
                    labels: ['Complétés', 'En cours', 'Non commencés'],
                    datasets: [{
                        data: [completed, inProgress, notStarted],
                        backgroundColor: ['var(--success)', 'var(--warning)', 'var(--danger)']
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: { position: 'top' }
                    }
                }
            });
        }
        */
        async function renderProgress() {
            const user = auth.currentUser;
            const progressView = document.getElementById('progressView');

            // Destroy previous chart instances to prevent memory leaks
            if (progressDonutChart) progressDonutChart.destroy();
            if (progressByCourseChart) progressByCourseChart.destroy();
            if (activityLineChart) activityLineChart.destroy();

            if (!user) {
                progressView.innerHTML = '<div class="text-center text-muted p-5"><i class="bi bi-lock fs-1"></i><p class="mt-2">Veuillez vous connecter pour voir votre progression.</p></div>';
                return;
            }

            // --- DATA PREPARATION ---
            const completed = Object.values(userProgress).filter(p => p === 100).length;
            const inProgress = Object.values(userProgress).filter(p => p > 0 && p < 100).length;
            const notStarted = allFiles.length - completed - inProgress;

            // Update KPIs
            document.getElementById('kpiCompleted').textContent = completed;
            document.getElementById('kpiInProgress').textContent = inProgress;

            // Data for the Bar Chart (only show courses with progress > 0)
            const coursesWithProgress = allFiles
                .map(file => ({ name: file.name, progress: userProgress[file.id] || 0 }))
                .filter(course => course.progress > 0)
                .sort((a, b) => a.progress - b.progress);

            // --- CHART.JS GLOBAL CONFIG ---
            // Use theme variables for chart colors and fonts
            const style = getComputedStyle(document.body);
            const brandColor = style.getPropertyValue('--brand').trim();
            const accentColor = style.getPropertyValue('--accent').trim();
            const successColor = style.getPropertyValue('--success').trim();
            const warningColor = style.getPropertyValue('--warning').trim();
            const dangerColor = style.getPropertyValue('--danger').trim();
            const textColor = style.getPropertyValue('--text').trim();
            const gridColor = style.getPropertyValue('--border').trim();

            Chart.defaults.color = textColor;
            Chart.defaults.font.family = "'Inter', sans-serif";
            Chart.defaults.plugins.legend.position = 'bottom';

            // --- 1. OVERALL PROGRESS DONUT CHART ---
            const donutCtx = document.getElementById('progressDonutChart').getContext('2d');
            progressDonutChart = new Chart(donutCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Terminés', 'En cours', 'Non commencés'],
                    datasets: [{
                        data: [completed, inProgress, notStarted],
                        backgroundColor: [successColor, warningColor, dangerColor],
                        borderColor: style.getPropertyValue('--surface').trim(),
                        borderWidth: 4,
                        hoverOffset: 8
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: { display: true },
                        tooltip: {
                            callbacks: {
                                label: (context) => `${context.label}: ${context.raw} cours`
                            }
                        }
                    }
                }
            });

            // --- 2. PROGRESS BY COURSE BAR CHART ---
            const barCtx = document.getElementById('progressByCourseChart').getContext('2d');
            progressByCourseChart = new Chart(barCtx, {
                type: 'bar',
                data: {
                    labels: coursesWithProgress.map(c => c.name.substring(0, 30) + (c.name.length > 30 ? '...' : '')),
                    datasets: [{
                        label: 'Progression (%)',
                        data: coursesWithProgress.map(c => c.progress),
                        backgroundColor: brandColor,
                        borderRadius: 4
                    }]
                },
                options: {
                    indexAxis: 'y', // Horizontal bars
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        x: {
                            beginAtZero: true,
                            max: 100,
                            grid: { color: gridColor }
                        },
                        y: {
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: { display: false },
                        tooltip: {
                            callbacks: {
                                label: (context) => `${context.raw}%`
                            }
                        }
                    }
                }
            });

            // --- 3. RECENT ACTIVITY LINE CHART ---
            // NOTE: This uses randomly generated data for demonstration.
            // A real implementation would require storing timestamps of user actions.
            const lineCtx = document.getElementById('activityLineChart').getContext('2d');
            const activityLabels = Array.from({ length: 7 }, (_, i) => {
                const d = new Date();
                d.setDate(d.getDate() - i);
                return d.toLocaleDateString('fr-FR', { weekday: 'short', day: 'numeric' });
            }).reverse();

            const gradient = lineCtx.createLinearGradient(0, 0, 0, 250);
            gradient.addColorStop(0, `${accentColor}80`); // 50% opacity
            gradient.addColorStop(1, `${accentColor}00`); // 0% opacity

            activityLineChart = new Chart(lineCtx, {
                type: 'line',
                data: {
                    labels: activityLabels,
                    datasets: [{
                        label: 'Actions complétées',
                        data: Array.from({ length: 7 }, () => Math.floor(Math.random() * 5)), // FAKE DATA
                        fill: true,
                        backgroundColor: gradient,
                        borderColor: accentColor,
                        tension: 0.4, // Makes the line smooth
                        pointBackgroundColor: accentColor,
                        pointBorderColor: style.getPropertyValue('--surface').trim(),
                        pointHoverRadius: 7,
                        pointRadius: 5
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    scales: {
                        y: {
                            beginAtZero: true,
                            grid: { color: gridColor },
                            ticks: {
                                precision: 0 // Only show whole numbers
                            }
                        },
                        x: {
                            grid: { display: false }
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        // START: NEW FUNCTION FOR SETTINGS VIEW
        function renderSettings() {
            const user = auth.currentUser;
            const settingsWrapper = document.getElementById('accountSettingsWrapper');
            const passwordCard = document.getElementById('passwordSettingsCard');

            if (user) {
                settingsWrapper.style.display = 'block';
                document.getElementById('accountName').value = user.displayName || '';
                document.getElementById('accountEmail').value = user.email || '';

                // Check if user signed up with email/password
                const isPasswordProvider = user.providerData.some(
                    (provider) => provider.providerId === 'password'
                );

                if (isPasswordProvider) {
                    passwordCard.style.display = 'block';
                } else {
                    passwordCard.style.display = 'none';
                }
            } else {
                // Hide settings if no user is logged in
                settingsWrapper.style.display = 'none';
            }
        }
        // END: NEW FUNCTION

        function updateStats() {
            const total = allFiles.length;
            const completed = Object.values(userProgress).filter(p => p === 100).length;
            const inProgress = Object.values(userProgress).filter(p => p > 0 && p < 100).length;

            document.getElementById('totalCourses').innerText = total;
            document.getElementById('completedCourses').innerText = completed;
            document.getElementById('inProgressCourses').innerText = inProgress;
        }

        function filterCourses(query) {
            const cards = document.querySelectorAll('#coursesGrid .col-xl-3, #coursesGrid .col-lg-4, #coursesGrid .col-md-6');
            cards.forEach(card => {
                const title = card.querySelector('.card-title')?.innerText.toLowerCase() || '';
                card.style.display = title.includes(query) ? '' : 'none';
            });
        }

        function showToast(message, type = 'info') {
            const toastContainer = document.getElementById('toastContainer');

            const icons = {
                success: 'bi-check-circle-fill',
                danger: 'bi-exclamation-triangle-fill',
                warning: 'bi-exclamation-triangle-fill',
                info: 'bi-info-circle-fill'
            };
            const icon = icons[type] || icons.info;

            // Create the wrapper for Bootstrap's Toast component
            const toastEl = document.createElement('div');
            toastEl.className = `toast custom-toast alert-${type}`; // Use 'toast' class
            toastEl.setAttribute('role', 'alert');
            toastEl.setAttribute('aria-live', 'assertive');
            toastEl.setAttribute('aria-atomic', 'true');

            toastEl.innerHTML = `
                <div class="d-flex">
                    <div class="toast-body d-flex align-items-center">
                        <i class="bi ${icon} me-2 fs-5"></i>
                        <span class="fw-semibold me-auto">${message}</span>
                    </div>
                    <button type="button" class="btn-close me-2 m-auto" data-bs-dismiss="toast" aria-label="Close"></button>
                </div>
            `;

            toastContainer.appendChild(toastEl);

            // Create a new Bootstrap Toast instance
            const bsToast = new bootstrap.Toast(toastEl, {
                delay: 5000,   // Auto-hide after 5 seconds
                autohide: true
            });

            // When the toast is hidden, remove it from the DOM to prevent clutter
            toastEl.addEventListener('hidden.bs.toast', () => {
                toastEl.remove();
            });

            // Show the toast!
            bsToast.show();
        }

        // Fonctions globales
        window.playVideo = function (fileId, title, url) {
            document.getElementById('videoTitle').innerText = title;
            const container = document.getElementById('videoContainer');

            const videoId = extractVideoId(url);
            if (videoId) {
                container.innerHTML = `<iframe src="https://www.youtube.com/embed/${videoId}?autoplay=1" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
            } else if (fileId) {
                container.innerHTML = `<iframe src="https://drive.google.com/file/d/${fileId}/preview" frameborder="0" allowfullscreen></iframe>`;
            } else {
                container.innerHTML = `<div class="p-5 text-center text-muted"><i class="bi bi-exclamation-triangle fs-1"></i><p class="mt-2">Vidéo non disponible</p></div>`;
            }

            videoModal.show();

            if (!userProgress[fileId]) {
                saveProgress(fileId, 25);
            }
        };

        window.playYoutube = async function (type, id, title) {
            const container = document.getElementById('videoContainer');
            container.innerHTML = '<div class="d-flex h-100 align-items-center justify-content-center"><div class="loader"></div></div>';

            // The side panel is now ALWAYS the history panel
            playlistPanel.classList.remove('d-none');
            playlistPanel.classList.add('d-flex');
            renderVideoHistory();

            let videoIdToPlay = id;

            if (type === 'playlist') {
                // For a playlist, we fetch the *first* video's ID to start playing
                try {
                    const url = `https://www.googleapis.com/youtube/v3/playlistItems?part=snippet&maxResults=1&playlistId=${id}&key=${YOUTUBE_API_KEY}`;
                    const res = await fetch(url);
                    const data = await res.json();
                    if (data.items && data.items.length > 0) {
                        videoIdToPlay = data.items[0].snippet.resourceId.videoId;
                        // We could fetch the whole playlist and let the user navigate via YouTube's iframe controls
                    }
                } catch (err) {
                    console.error("Could not fetch first video of playlist:", err);
                    showToast("Impossible de charger la playlist.", "danger");
                    return;
                }
                // For playlists, we now just embed the whole list and let YouTube handle the queue inside the iframe.
                container.innerHTML = `<iframe src="https://www.youtube.com/embed/videoseries?list=${id}&autoplay=1" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
            } else {
                // For a single video, we add it to our history
                const videoData = {
                    videoId: id,
                    title: title,
                    thumbnailUrl: `https://img.youtube.com/vi/${id}/default.jpg`
                };
                addVideoToHistory(videoData);
                container.innerHTML = `<iframe src="https://www.youtube.com/embed/${id}?autoplay=1" frameborder="0" allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture" allowfullscreen></iframe>`;
            }

            document.getElementById('videoTitle').innerText = title;
            videoModal.show();
        };



        window.viewDocument = function (fileId, title, url, kind) {
            document.getElementById('documentTitle').innerText = title;
            const container = document.getElementById('documentContainer');

            container.innerHTML = `<iframe src="https://drive.google.com/file/d/${fileId}/preview" frameborder="0"></iframe>`;

            documentModal.show();

            if (!userProgress[fileId]) {
                saveProgress(fileId, 25);
            }
        };

        window.markComplete = function (fileId) {
            saveProgress(fileId, 100);
            renderCourses();
            renderDashboard();
            showToast('Cours marqué comme complété !', 'success');
        };

        window.resumeCourse = function (fileId) {
            const file = allFiles.find(f => f.id === fileId);
            if (!file) return;

            const meta = getFileMeta(file.mimeType);
            if (meta.kind === 'video') {
                playVideo(file.id, file.name, file.webViewLink);
            } else {
                viewDocument(file.id, file.name, file.webViewLink, meta.kind);
            }

            const currentProgress = userProgress[fileId] || 0;
            if (currentProgress < 100) {
                saveProgress(fileId, Math.min(currentProgress + 25, 100));
            }
        };

        window.saveForLater = function (fileId) {
            const saved = JSON.parse(localStorage.getItem('savedCourses') || '[]');
            if (!saved.includes(fileId)) {
                saved.push(fileId);
                localStorage.setItem('savedCourses', JSON.stringify(saved));
                showToast('Enregistré pour plus tard !', 'info');
            }
        };

        window.openFolder = function (folderId, name) {
            folderPath.push({ id: folderId, name });
            currentFolderId = folderId;
            fetchDriveFolder(folderId);
        };

        // Filtre catégorie
        document.getElementById('categoryFilter')?.addEventListener('change', (e) => {
            const value = e.target.value;
            const cards = document.querySelectorAll('#coursesGrid > div');

            cards.forEach(card => {
                if (value === 'all') {
                    card.style.display = '';
                } else {
                    const badge = card.querySelector('.course-badge')?.innerText.toLowerCase() || '';
                    card.style.display = badge.includes(value) ? '' : 'none';
                }
            });
        });

        // Tri
        document.getElementById('sortBy')?.addEventListener('change', (e) => {
            const value = e.target.value;
            if (value === 'Trier par nom') {
                currentFiles.sort((a, b) => a.name.localeCompare(b.name));
            } else if (value === 'Trier par date') {
                currentFiles.sort((a, b) => new Date(b.modifiedTime) - new Date(a.modifiedTime));
            } else if (value === 'Trier par type') {
                currentFiles.sort((a, b) => a.mimeType.localeCompare(b.mimeType));
            }
            renderCourses();
        });

        function escapeHtml(str) {
            if (!str) return '';
            const div = document.createElement('div');
            div.textContent = str;
            return div.innerHTML;
        }

        function setTheme(theme) {
            localStorage.setItem('theme', theme);
            if (theme === 'system') {
                document.body.removeAttribute('data-theme');
            } else {
                document.body.setAttribute('data-theme', theme);
            }
        }

        function loadTheme() {
            const theme = localStorage.getItem('theme') || 'system';
            const select = document.getElementById('themeSelect');
            if (select) select.value = theme;
            setTheme(theme);
        }

        // ======================================
        // ALARM SYSTEM LOGIC
        // ======================================

        // An object to hold our alarm sounds
        const alarmSounds = {
            chime: new Audio('https://cdn.freesound.org/previews/510/510323_10899534-lq.mp3'),
            notification: new Audio('https://cdn.freesound.org/previews/415/415763_6142149-lq.mp3'),
            digital: new Audio('https://cdn.freesound.org/previews/142/142641_228222-lq.mp3')
        };

        // This function will run every minute to check for pending alarms
        function checkAlarms() {
            const user = auth.currentUser;
            if (!user) return; // Don't run if logged out

            const now = new Date();
            // Fetch all events from Firestore to check their alarm times
            const eventsQuery = query(collection(db, 'users', user.uid, 'events'));
            getDocs(eventsQuery).then(snapshot => {
                snapshot.forEach(doc => {
                    const event = { id: doc.id, ...doc.data() };
                    // Check if the event has an alarm set
                    if (event.alarm && event.alarm !== 'none') {
                        const startTime = event.start.toDate();
                        const alarmTime = new Date(startTime.getTime() - (parseInt(event.alarm) * 60000));

                        // Check if the alarm time is in the current minute
                        if (alarmTime.getFullYear() === now.getFullYear() &&
                            alarmTime.getMonth() === now.getMonth() &&
                            alarmTime.getDate() === now.getDate() &&
                            alarmTime.getHours() === now.getHours() &&
                            alarmTime.getMinutes() === now.getMinutes()) {
                            console.log("ALARM TRIGGERED FOR:", event.title);
                            triggerAlarm(event);
                        }
                    }
                });
            });
        }

        // Function to show the browser notification and play the sound
        function triggerAlarm(event) {
            // 1. Play the selected sound
            const sound = alarmSounds[event.sound] || alarmSounds.chime;
            sound.play();

            // 2. Show a browser notification
            const notificationMessage = `Rappel : "${event.title}" commence bientôt !`;

            if (Notification.permission === 'granted') {
                new Notification("Rappel d'événement", {
                    body: notificationMessage,
                    icon: 'https://img.icons8.com/color/96/000000/alarm.png' // A generic alarm icon
                });
            } else if (Notification.permission !== 'denied') {
                Notification.requestPermission().then(permission => {
                    if (permission === 'granted') {
                        new Notification("Rappel d'événement", {
                            body: notificationMessage,
                            icon: 'https://img.icons8.com/color/96/000000/alarm.png'
                        });
                    }
                });
            }

            // You can also show an in-app toast for good measure
            showToast(notificationMessage, 'warning');
        }


        function listenForNotifications(userId) {
            if (unsubscribeNotifications) unsubscribeNotifications(); // Prevent multiple listeners

            const notifQuery = query(
                collection(db, 'users', userId, 'notifications'),
                orderBy('createdAt', 'desc')
            );

            unsubscribeNotifications = onSnapshot(notifQuery, (snapshot) => {
                const notifications = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                console.log("Real-time notifications received:", notifications);
                updateNotificationUI(notifications);
            });
        }

        function updateNotificationUI(notifications) {
            const notifCountBadge = document.getElementById('notifCount');
            const notifListContainer = document.getElementById('notifListContainer');

            const unreadCount = notifications.filter(n => !n.read).length;

            // Update the bell badge
            if (unreadCount > 0) {
                notifCountBadge.textContent = unreadCount;
                notifCountBadge.classList.remove('d-none');
            } else {
                notifCountBadge.classList.add('d-none');
            }

            // Update the dropdown list
            notifListContainer.innerHTML = '';
            if (notifications.length === 0) {
                notifListContainer.innerHTML = '<div class="text-center text-muted p-4">Aucune notification</div>';
                return;
            }

            // Show the latest 5 notifications in the dropdown
            notifications.slice(0, 5).forEach(notif => {
                const itemEl = document.createElement('a');
                itemEl.href = '#';
                itemEl.className = `list-group-item notification-item ${notif.read ? '' : 'unread'}`;
                itemEl.onclick = (e) => {
                    e.preventDefault();
                    handleNotificationClick(notif);
                };

                const icon = getNotificationIcon(notif.type);

                itemEl.innerHTML = `
            <div class="icon" style="color: ${icon.color};">${icon.html}</div>
            <div class="content flex-grow-1">
                ${notif.message}
                <div class="timestamp">${timeAgo(notif.createdAt.toDate())}</div>
            </div>
        `;
                notifListContainer.appendChild(itemEl);
            });
        }

        function getNotificationIcon(type) {
            switch (type) {
                case 'new_reply':
                    return { html: '<i class="bi bi-chat-dots-fill"></i>', color: 'var(--info)' };
                case 'new_content':
                    return { html: '<i class="bi bi-cloud-arrow-up-fill"></i>', color: 'var(--success)' };
                case 'assignment_due':
                    return { html: '<i class="bi bi-exclamation-triangle-fill"></i>', color: 'var(--warning)' };
                default:
                    return { html: '<i class="bi bi-info-circle-fill"></i>', color: 'var(--muted)' };
            }
        }

        function timeAgo(date) {
            // Simple time ago function (for a more advanced one, use a library like date-fns)
            const seconds = Math.floor((new Date() - date) / 1000);
            let interval = seconds / 31536000;
            if (interval > 1) return `il y a ${Math.floor(interval)} ans`;
            interval = seconds / 2592000;
            if (interval > 1) return `il y a ${Math.floor(interval)} mois`;
            interval = seconds / 86400;
            if (interval > 1) return `il y a ${Math.floor(interval)} jours`;
            interval = seconds / 3600;
            if (interval > 1) return `il y a ${Math.floor(interval)} heures`;
            interval = seconds / 60;
            if (interval > 1) return `il y a ${Math.floor(interval)} minutes`;
            return "à l'instant";
        }

        async function handleNotificationClick(notification) {
            const user = auth.currentUser;
            if (!user) return;

            // Mark as read in Firestore
            if (!notification.read) {
                const notifRef = doc(db, 'users', user.uid, 'notifications', notification.id);
                await updateDoc(notifRef, { read: true });
            }

            // TODO: Navigate to the relevant page based on notification.link
            if (notification.link) {
                // e.g., if link is '/discussions/threadId123', parse and navigate
                console.log("Navigate to:", notification.link);
                showToast(`Navigation vers: ${notification.link}`, 'info');
            }
        }

        document.getElementById('markAllAsReadBtn').addEventListener('click', async () => {
            const user = auth.currentUser;
            if (!user) return;

            const notifQuery = query(
                collection(db, 'users', user.uid, 'notifications'),
                where('read', '==', false)
            );
            const snapshot = await getDocs(notifQuery);

            // Use a batch write for efficiency
            const batch = writeBatch(db);
            snapshot.docs.forEach(doc => {
                batch.update(doc.ref, { read: true });
            });
            await batch.commit();

            showToast("Toutes les notifications ont été marquées comme lues.", 'success');
        });

        // Logic for the full notification page (you can expand this later)
        // REPLACE your old, empty renderFullNotificationPage function with this one

        /**
        * Creates a "raw" notification event in the public inbox.
        * This is a client-side trigger that other clients will listen for.
        * @param {string} targetUserId The ID of the user to notify.
        * @param {object} payload The notification data (message, type, link).
        */
        async function triggerNotificationEvent(targetUserId, payload) {
            if (!targetUserId || !auth.currentUser) return;

            try {
                const inboxCollection = collection(db, 'notification_inbox');
                await addDoc(inboxCollection, {
                    ...payload,
                    targetUserId: targetUserId,
                    creatorName: auth.currentUser.displayName || 'Anonyme',
                    createdAt: Timestamp.now(), // Firestore server timestamp is better
                });
                console.log(`Notification event triggered for user ${targetUserId}`);
            } catch (error) {
                console.error(`Failed to trigger notification event:`, error);
            }
        }

        async function renderFullNotificationPage() {
            const container = document.getElementById('fullNotifList');
            if (!container) return;

            container.innerHTML = '<div class="text-center p-5"><div class="loader"></div></div>';

            const user = auth.currentUser;
            if (!user) {
                container.innerHTML = '<div class="text-center text-muted p-5"><i class="bi bi-lock fs-1"></i><p class="mt-2">Veuillez vous connecter pour voir vos notifications.</p></div>';
                return;
            }

            try {
                // Fetch ALL notifications for the user, ordered by date
                const notifQuery = query(
                    collection(db, 'users', user.uid, 'notifications'),
                    orderBy('createdAt', 'desc')
                );
                const snapshot = await getDocs(notifQuery);

                if (snapshot.empty) {
                    container.innerHTML = '<div class="text-center text-muted p-5"><i class="bi bi-bell-slash fs-1"></i><p class="mt-2">Vous n\'avez aucune notification pour le moment.</p></div>';
                    return;
                }

                container.innerHTML = ''; // Clear the loader

                snapshot.docs.forEach(doc => {
                    const notif = { id: doc.id, ...doc.data() };

                    const itemEl = document.createElement('a');
                    itemEl.href = '#';
                    // Use the same CSS classes as the dropdown for a consistent look
                    itemEl.className = `list-group-item notification-item ${notif.read ? '' : 'unread'}`;
                    itemEl.onclick = (e) => {
                        e.preventDefault();
                        handleNotificationClick(notif);
                        // After clicking, refresh this view to update the 'read' status visually
                        renderFullNotificationPage();
                    };

                    const icon = getNotificationIcon(notif.type);

                    itemEl.innerHTML = `
                <div class="icon" style="color: ${icon.color};">${icon.html}</div>
                <div class="content flex-grow-1">
                    ${notif.message}
                    <div class="timestamp">${timeAgo(notif.createdAt.toDate())}</div>
                </div>
                <!-- Add a chevron to indicate it's clickable -->
                <i class="bi bi-chevron-right ms-auto text-muted"></i>
            `;
                    container.appendChild(itemEl);
                });

            } catch (error) {
                console.error("Error fetching full notification list:", error);
                container.innerHTML = '<div class="text-center text-danger p-5"><i class="bi bi-exclamation-triangle-fill fs-1"></i><p class="mt-2">Impossible de charger les notifications.</p></div>';
            }
        }

    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
   
</body>

</html>
