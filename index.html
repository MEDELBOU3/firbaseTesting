<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AuraBeat - Find Your Vibe</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        /* --- Dark Nebula Theme --- */
        :root {
            --bg-color: #10111A; /* Very dark deep blue */
            --surface-color: #1A1B2D; /* Slightly lighter surface */
            --primary-color: #8B5CF6; /* Vibrant Purple */
            --primary-hover-color: #A78BFA;
            --primary-text-color: #E5E7EB; /* Light Gray */
            --secondary-text-color: #9CA3AF; /* Medium Gray */
            --border-color: #374151; /* Darker gray border */
            --highlight-color: #252744; /* Hover/Active Surface */
            --card-shadow-color: rgba(0, 0, 0, 0.4);
            --navbar-bg: rgba(16, 17, 26, 0.85); /* Darker navbar */
            --scrollbar-thumb: #4B5563;
            --scrollbar-track: #1F2937;
            --btn-primary-text: #FFFFFF; /* Text on purple buttons */
            --error-color: #EF4444;
            --warning-color: #F59E0B;
            --info-color: #3B82F6;
            --success-color: #10B981; /* Tealish Green for Success */
        }

        /* --- Base Styles --- */
        *, *::before, *::after { box-sizing: border-box; }

        body {
            background-color: var(--bg-color);
            color: var(--primary-text-color);
            font-family: 'Inter', 'Helvetica Neue', Helvetica, Arial, sans-serif; /* Using Inter */
            min-height: 100vh;
            padding-bottom: 120px; /* Increased for player */
            overflow-x: hidden;
            line-height: 1.6;
            font-weight: 400;
        }

        h1, h2, h3, h4, h5, h6 { font-weight: 600; letter-spacing: -0.5px; }

        /* Scrollbar */
        ::-webkit-scrollbar { height: 8px; width: 8px; }
        ::-webkit-scrollbar-track { background: var(--scrollbar-track); border-radius: 10px; }
        ::-webkit-scrollbar-thumb { background-color: var(--scrollbar-thumb); border-radius: 10px; border: 2px solid var(--scrollbar-track); }
        ::-webkit-scrollbar-thumb:hover { background-color: var(--secondary-text-color); }

        /* Navbar */
        .navbar-custom { background-color: var(--navbar-bg); backdrop-filter: blur(12px); position: sticky; top: 0; z-index: 1050; border-bottom: 1px solid var(--border-color); padding: 0.75rem 0; }
        .logo { height: 32px; filter: drop-shadow(0 1px 3px rgba(0,0,0,0.3)); margin-top: -2px; }
        .navbar-brand span { font-weight: 700; font-size: 1.25rem; margin-left: 8px; letter-spacing: -0.5px; }
        .user-avatar { border: 2px solid var(--secondary-text-color); transition: border-color 0.3s ease;}
        .user-avatar:hover { border-color: var(--primary-text-color); }

        /* Content Wrapper */
        .content-wrapper { padding-top: 30px; }

        /* Login Section */
        .login-section { display: flex; flex-direction: column; align-items: center; justify-content: center; min-height: calc(100vh - 200px); text-align: center; }
        .login-button { background: linear-gradient(to right, var(--primary-color), var(--primary-hover-color)); color: var(--btn-primary-text); border: none; border-radius: 500px; padding: 14px 45px; font-weight: 600; font-size: 1.05rem; transition: all 0.3s ease; box-shadow: 0 6px 12px rgba(0,0,0,0.3); }
        .login-button:hover { transform: scale(1.03) translateY(-2px); box-shadow: 0 8px 16px rgba(0,0,0,0.4); }
        .login-button i { margin-right: 10px; font-size: 1.2em; }
        .login-title { font-weight: 700; letter-spacing: -1px; }
        .login-subtitle { color: var(--secondary-text-color); font-size: 1.1rem; }

        /* Search & Filters */
        .search-container { padding: 10px 0; margin-bottom: 35px; }
        .search-input { background-color: var(--surface-color); border: 1px solid var(--border-color); color: var(--primary-text-color); border-radius: 500px; padding: 12px 25px; font-size: 1rem; transition: all 0.3s ease; box-shadow: 0 2px 5px rgba(0,0,0,0.2); }
        .search-input::placeholder { color: var(--secondary-text-color); }
        .search-input:focus { background-color: var(--highlight-color); box-shadow: 0 0 0 3px color-mix(in srgb, var(--primary-color), transparent 70%); border-color: var(--primary-color); }
        .search-button { background-color: var(--primary-color); color: var(--btn-primary-text); border: none; border-radius: 500px; padding: 12px 25px; font-weight: 600; transition: all 0.3s ease; }
        .search-button:hover { background-color: var(--primary-hover-color); }

        .category-pills { margin-bottom: 30px; display: flex; flex-wrap: nowrap; overflow-x: auto; padding-bottom: 15px; scrollbar-width: thin; scrollbar-color: var(--scrollbar-thumb) var(--bg-color); }
        .category-pill { background-color: var(--highlight-color); color: var(--primary-text-color); border: 1px solid var(--border-color); border-radius: 500px; padding: 7px 18px; margin-right: 10px; white-space: nowrap; transition: all 0.2s ease; cursor: pointer; font-size: 0.85rem; font-weight: 500; }
        .category-pill:hover { background-color: color-mix(in srgb, var(--highlight-color), white 5%); border-color: var(--secondary-text-color); }
        .category-pill.active { background-color: var(--primary-color); color: var(--btn-primary-text); font-weight: 600; border-color: var(--primary-color); }

        /* Cards */
        .item-card-wrapper { padding: 8px; }
        .item-card { background-color: var(--surface-color); border-radius: 12px; /* Softer radius */ transition: background-color 0.3s ease, transform 0.3s ease; margin-bottom: 15px; box-shadow: 0 5px 15px var(--card-shadow-color); position: relative; cursor: pointer; padding: 18px; height: 100%; display: flex; flex-direction: column; border: 1px solid transparent; /* For hover effect */ }
        .item-card:hover { background-color: var(--highlight-color); transform: translateY(-4px); border-color: var(--border-color); }
        .item-card:hover .play-button-wrapper { opacity: 1; transform: translateY(0) scale(1); }

        .card-img-container { position: relative; margin-bottom: 18px; }
        .item-img { width: 100%; aspect-ratio: 1/1; object-fit: cover; border-radius: 8px; box-shadow: 0 6px 18px rgba(0,0,0,0.3); }
        .artist-img { border-radius: 50%; }

        .card-info { flex-grow: 1; min-height: 65px; }
        .item-title { font-weight: 600; margin-bottom: 6px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 1rem; color: var(--primary-text-color); }
        .item-subtitle { color: var(--secondary-text-color); font-size: 0.8rem; display: -webkit-box; -webkit-line-clamp: 2; -webkit-box-orient: vertical; overflow: hidden; text-overflow: ellipsis; line-height: 1.4; margin-bottom: 8px; }
        .item-type-badge { font-size: 0.65rem; font-weight: 600; text-transform: uppercase; color: var(--bg-color); background-color: var(--primary-color); padding: 3px 7px; border-radius: 4px; display: inline-block; margin-top: 5px; letter-spacing: 0.5px; }

        .play-button-wrapper { position: absolute; bottom: 12px; right: 12px; opacity: 0; transform: translateY(5px) scale(0.9); transition: all 0.25s ease-out; z-index: 5; }
        .play-button { background-color: var(--primary-color); color: var(--btn-primary-text); width: 42px; height: 42px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: none; box-shadow: 0 5px 10px rgba(0,0,0,0.3); transition: all 0.2s ease; cursor: pointer; }
        .play-button:hover { transform: scale(1.1); background-color: var(--primary-hover-color); }
        .play-button i { font-size: 1rem; }

        /* Sections */
        .section-title { font-size: 1.7rem; font-weight: 700; margin-bottom: 20px; position: relative; padding-bottom: 8px; border-bottom: 1px solid var(--border-color); letter-spacing: -0.5px; }
        .section-title::after { content: ''; position: absolute; bottom: -1px; left: 0; width: 50px; height: 3px; background: linear-gradient(to right, var(--primary-color), var(--primary-hover-color)); border-radius: 3px; }

        /* Loading Animation */
        .loading-animation { display: flex; justify-content: center; align-items: center; padding: 60px 0; width: 100%; }
        .loading-bar { width: 4px; height: 22px; margin: 0 5px; background-color: var(--primary-color); border-radius: 2px; animation: loading 1.2s cubic-bezier(0.65, 0.05, 0.36, 1) infinite; }
        @keyframes loading { 0%, 100% { transform: scaleY(0.4); opacity: 0.6;} 50% { transform: scaleY(1.1); opacity: 1;} }
        .loading-bar:nth-child(1){animation-delay: 0s;} .loading-bar:nth-child(2){animation-delay: 0.1s;} .loading-bar:nth-child(3){animation-delay: 0.2s;} .loading-bar:nth-child(4){animation-delay: 0.3s;}

        /* Player Container */
        .player-container { position: fixed; bottom: 0; left: 0; width: 100%; background-color: var(--surface-color); padding: 12px 20px; box-shadow: 0 -6px 25px rgba(0,0,0,0.5); display: none; z-index: 1000; border-top: 1px solid var(--border-color); }
        .currently-playing { display: flex; align-items: center; }
        .currently-playing-img { width: 52px; height: 52px; border-radius: 6px; margin-right: 15px; box-shadow: 0 3px 8px rgba(0,0,0,0.3); }
        .currently-playing-info { flex-grow: 1; min-width: 0; }
        .currently-playing-title { font-weight: 600; font-size: 0.9rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; margin-bottom: 1px; }
        .currently-playing-artist { color: var(--secondary-text-color); font-size: 0.8rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }

        .player-controls-center { display: flex; flex-direction: column; align-items: center; }
        .player-buttons { display: flex; align-items: center; justify-content: center; margin-bottom: 6px; }
        .control-button { background: none; border: none; color: var(--secondary-text-color); font-size: 1.05rem; margin: 0 14px; cursor: pointer; transition: all 0.2s ease; padding: 5px; }
        .control-button:hover:not(:disabled) { color: var(--primary-text-color); }
        .control-button:disabled { color: #4B5563; cursor: not-allowed; } /* Adjusted disabled color */
        .play-pause { width: 34px; height: 34px; border-radius: 50%; background-color: var(--primary-text-color); color: var(--bg-color); display: flex; align-items: center; justify-content: center; margin: 0 16px; transition: all 0.2s ease; border: none; }
        .play-pause:hover:not(:disabled) { transform: scale(1.08); background-color: #f0f0f0; }
        .play-pause:disabled { background-color: var(--secondary-text-color); cursor: not-allowed; opacity: 0.7; }
        .play-pause i { font-size: 0.9rem; }

        .progress-wrapper { display: flex; align-items: center; width: 100%; max-width: 450px; margin: 0 auto; }
        .time-display { color: var(--secondary-text-color); font-size: 0.7rem; min-width: 35px; text-align: center; font-weight: 500; }
        .progress-container { flex-grow: 1; height: 14px; display: flex; align-items: center; margin: 0 12px; cursor: pointer; }
        .progress { height: 5px; background-color: var(--highlight-color); border-radius: 3px; width: 100%; overflow: visible; position: relative;}
        .progress-bar { background-color: var(--secondary-text-color); border-radius: 3px; height: 100%; width: 0%; transition: width 0.15s linear, background-color 0.2s ease; display: block; position: relative; }
        .progress-container:hover .progress-bar { background-color: var(--primary-color); }
        .progress-bar::after { content: ''; position: absolute; right: -6px; top: 50%; transform: translateY(-50%); width: 12px; height: 12px; background-color: var(--primary-text-color); border-radius: 50%; display: none; box-shadow: 0 1px 3px rgba(0,0,0,0.4); }
        .progress-container:hover .progress-bar::after { display: block; }

        .volume-control { display: flex; align-items: center; justify-content: flex-end; }
        .volume-slider { width: 90px; height: 5px; cursor: pointer; background-color: var(--highlight-color); border-radius: 3px; -webkit-appearance: none; appearance: none; }
        .volume-slider::-webkit-slider-thumb { -webkit-appearance: none; appearance: none; width: 12px; height: 12px; background-color: var(--secondary-text-color); border-radius: 50%; cursor: pointer; transition: background-color 0.2s ease; }
        .volume-slider::-moz-range-thumb { width: 12px; height: 12px; background-color: var(--secondary-text-color); border-radius: 50%; cursor: pointer; border: none; transition: background-color 0.2s ease; }
        .volume-slider:hover::-webkit-slider-thumb { background-color: var(--primary-color); }
        .volume-slider:hover::-moz-range-thumb { background-color: var(--primary-color); }
        #volume-button { margin-right: 8px; font-size: 1.05rem; }

        /* Details View */
        #details-view { padding: 25px 0; }
        .details-header { display: flex; align-items: flex-end; margin-bottom: 40px; gap: 35px; /* Increased gap */ background: linear-gradient(to bottom, color-mix(in srgb, var(--surface-color), black 30%) 0%, var(--bg-color) 100%); padding: 40px; border-radius: 16px; }
        .details-img { width: 200px; height: 200px; object-fit: cover; border-radius: 12px; box-shadow: 0 12px 35px var(--card-shadow-color); flex-shrink: 0;}
        .details-img.artist { border-radius: 50%; }
        .details-info { flex-grow: 1; }
        .details-info .item-type-badge { margin-bottom: 12px; font-size: 0.7rem; padding: 4px 8px; background-color: color-mix(in srgb, var(--primary-color), black 20%); color: var(--primary-text-color); }
        .details-info h1 { font-size: clamp(2rem, 6vw, 4rem); font-weight: 800; margin-bottom: 18px; line-height: 1.1; letter-spacing: -1.5px; }
        .details-info p { color: var(--secondary-text-color); font-size: 0.9rem; margin-bottom: 6px; font-weight: 500; }
        .back-button { margin-bottom: 25px; background-color: var(--surface-color); border: 1px solid var(--border-color); color: var(--secondary-text-color); border-radius: 500px; padding: 9px 20px; transition: all 0.3s ease; font-weight: 500; }
        .back-button:hover { color: var(--primary-text-color); border-color: var(--secondary-text-color); background-color: var(--highlight-color); }
        .track-list { list-style: none; padding: 0; }
        .track-list-item { display: grid; grid-template-columns: 30px 1fr auto auto; align-items: center; gap: 15px; padding: 12px 15px; border-radius: 8px; margin-bottom: 5px; transition: background-color 0.2s ease; cursor: pointer; border: 1px solid transparent; }
        .track-list-item:hover { background-color: var(--highlight-color); border-color: var(--border-color); }
        .track-number { color: var(--secondary-text-color); text-align: right; font-size: 0.85rem; font-weight: 500; }
        .track-list-title { color: var(--primary-text-color); font-weight: 500; margin-bottom: 2px; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; font-size: 0.95rem; }
        .track-list-artist { color: var(--secondary-text-color); font-size: 0.8rem; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
        .track-duration { color: var(--secondary-text-color); font-size: 0.85rem; justify-self: end; font-weight: 500; }
        .track-play-button { background: none; border: none; color: var(--secondary-text-color); font-size: 1rem; cursor: pointer; justify-self: end; opacity: 0; transition: opacity 0.2s ease, color 0.2s ease; padding: 6px; margin-left: 5px; }
        .track-list-item:hover .track-play-button { opacity: 1; }
        .track-play-button:hover:not(:disabled) { color: var(--primary-color); }
        .track-play-button:disabled { color: #4B5563; cursor: not-allowed; opacity: 0.4 !important; }

        /* Toast Notification */
        .toast-container { position: fixed; bottom: 130px; /* Above taller player */ right: 20px; z-index: 1100; }
        .toast { color: var(--primary-text-color); padding: 14px 22px; border-radius: 8px; margin-bottom: 12px; box-shadow: 0 6px 18px rgba(0,0,0,0.4); opacity: 0; transform: translateX(110%); transition: all 0.5s cubic-bezier(0.68, -0.55, 0.27, 1.55); font-weight: 500; font-size: 0.9rem; background-color: var(--highlight-color); border-left: 5px solid var(--info-color); }
        .toast.show { opacity: 1; transform: translateX(0); }
        .toast.error { border-left-color: var(--error-color); }
        .toast.warning { border-left-color: var(--warning-color); }
        .toast.info { border-left-color: var(--info-color); }
        .toast.success { border-left-color: var(--success-color); }

        /* Responsive */
        @media (max-width: 992px) { .player-container .col-md-3:last-child { justify-content: flex-start; margin-top: 5px; } }
        @media (max-width: 768px) {
             body { padding-bottom: 190px; } /* More space for stacked player */
             .player-container .row > div { margin-bottom: 12px; }
             .player-container .col-md-3:first-child { width: 100%; justify-content: flex-start; }
             .player-controls-center { order: 1;} .currently-playing { order: 2;} .volume-control { order: 3; justify-content: center !important;}
             .currently-playing-title, .currently-playing-artist { max-width: calc(100vw - 90px); }
             .details-header { flex-direction: column; align-items: center; text-align: center; padding: 30px;}
             .details-img { width: 160px; height: 160px;}
             .details-info h1 { font-size: 2.2rem;}
             .track-list-item { grid-template-columns: 25px 1fr auto; gap: 10px; padding: 10px 8px;}
             .track-number { font-size: 0.8rem;}
             .track-play-button { opacity: 1; grid-column: 3; } .track-duration { grid-column: 3; font-size: 0.8rem; }
             .track-list-item:hover .track-play-button { opacity: 1; }
        }
        @media (max-width: 576px) {
            .item-card-wrapper { width: 50%; }
            .details-info h1 { font-size: 1.8rem; }
            .search-button span { display: none !important; } /* Hide text on small screens */
            .search-button i { margin: 0 !important; }
            .navbar-brand span { font-size: 1.1rem;}
        }
    </style>
</head>
<body>
    <!-- Audio Element for Previews -->
    <audio id="audio-player"></audio>

    <nav class="navbar navbar-dark navbar-custom">
        <div class="container">
            <a class="navbar-brand d-flex align-items-center" href="#" onclick="showMainView(true); return false;">
                <svg class="logo" fill="var(--primary-color)" viewBox="0 0 16 16" xmlns="http://www.w3.org/2000/svg"><path d="M8 0a8 8 0 1 0 0 16A8 8 0 0 0 8 0zm3.669 11.538a.498.498 0 0 1-.686.165c-1.879-1.147-4.243-1.407-7.027-.77a.499.499 0 0 1-.581-.494.498.498 0 0 1 .493-.58c3.07-.69 5.692-.384 7.82.985a.498.498 0 0 1 .166.685zm.129-2.078a.62.62 0 0 1-.858.205c-2.15-1.321-5.428-1.704-7.972-.932a.62.62 0 0 1-.74-.619.62.62 0 0 1 .619-.74c2.99-.858 6.56.11 8.986 1.663a.62.62 0 0 1 .206.858zm.083-2.143a.743.743 0 0 1-1.026.247c-2.52-1.536-6.752-1.654-8.943-.91a.743.743 0 0 1-.88-.73.744.744 0 0 1 .73-.881c2.61-.81 7.287-.645 10.118 1.06a.743.743 0 0 1 .247 1.026z"/></svg>
                <span>AuraBeat</span>
            </a>
            <div id="user-profile" class="d-none d-flex align-items-center">
                <span id="user-name" class="text-white me-2 d-none d-sm-inline"></span>
                <img id="user-avatar" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="User Avatar" class="rounded-circle user-avatar" width="32" height="32">
            </div>
        </div>
    </nav>

    <div class="container content-wrapper">
        <div id="login-section" class="login-section">
            <h1 class="mb-3 display-5 login-title">Unlock Your Aura</h1>
            <p class="mb-4 fs-5 login-subtitle">Connect your Spotify account to start listening.</p>
            <button id="login-button" class="login-button">
                <i class="fab fa-spotify"></i> Connect with Spotify
            </button>
        </div>

        <div id="main-content" class="d-none">
             <div class="search-container">
                 <div class="row g-2 align-items-center">
                    <div class="col"><input type="text" id="search-input" class="form-control search-input" placeholder="What vibe are you feeling?"></div>
                    <div class="col-auto"><button id="search-button" class="btn search-button"><i class="fas fa-search me-1"></i><span class="d-none d-md-inline"> Search</span></button></div>
                </div>
            </div>
            <div id="category-pills-container" class="category-pills d-none">
                <div class="category-pill active" data-category="all">All</div>
                <div class="category-pill" data-category="track">Songs</div>
                <div class="category-pill" data-category="artist">Artists</div>
                <div class="category-pill" data-category="album">Albums</div>
                <div class="category-pill" data-category="playlist">Playlists</div>
            </div>

            <div id="loading" class="loading-animation d-none"></div>

            <div id="browse-sections">
                <div id="featured-playlists-section" class="mt-4"><h2 class="section-title">Featured Playlists</h2><div id="featured-playlists" class="row g-2"></div><div id="loading-featured" class="loading-animation d-none"></div></div>
                <div id="new-releases-section" class="mt-5"><h2 class="section-title">New Releases</h2><div id="new-releases" class="row g-2"></div><div id="loading-releases" class="loading-animation d-none"></div></div>
            </div>

             <div id="search-results-container" class="d-none">
                 <h2 id="search-results-title" class="section-title mt-4">Search Results</h2>
                 <div id="search-results" class="row g-2"></div><div id="loading-search" class="loading-animation d-none"></div>
             </div>
        </div>

        <div id="details-view" class="d-none">
            <button id="back-button" class="back-button"><i class="fas fa-arrow-left me-2"></i> Back</button>
            <div id="details-content"></div><div id="loading-details" class="loading-animation d-none"></div>
        </div>
    </div>

    <div id="player-container" class="player-container">
        <div class="row align-items-center g-2">
            <div class="col-md-3 col-sm-12">
                <div class="currently-playing">
                    <img id="currently-playing-img" src="data:image/gif;base64,R0lGODlhAQABAIAAAAAAAP///yH5BAEAAAAALAAAAAABAAEAAAIBRAA7" alt="Currently Playing" class="currently-playing-img">
                    <div class="currently-playing-info">
                        <div id="currently-playing-title" class="currently-playing-title">AuraBeat</div>
                        <div id="currently-playing-artist" class="currently-playing-artist">Connect to listen</div>
                    </div>
                </div>
            </div>
            <div class="col-md-6 col-sm-12 player-controls-center">
                 <div class="player-buttons">
                    <button id="prev-button" class="control-button" title="Previous (Preview Only)" disabled><i class="fas fa-step-backward"></i></button>
                    <button id="play-pause-button" class="play-pause" title="Play/Pause Preview" disabled><i class="fas fa-play"></i></button>
                    <button id="next-button" class="control-button" title="Next (Preview Only)" disabled><i class="fas fa-step-forward"></i></button>
                 </div>
                 <div class="progress-wrapper">
                    <span id="current-time" class="time-display">0:00</span>
                     <div class="progress-container" id="progress-bar-container">
                         <div class="progress"><div id="progress-bar" class="progress-bar"></div></div>
                     </div>
                     <span id="total-time" class="time-display">0:30</span> <!-- Max preview time -->
                 </div>
            </div>
            <div class="col-md-3 col-sm-12">
                <div class="volume-control">
                    <button id="volume-button" class="control-button" title="Mute/Unmute"><i class="fas fa-volume-up"></i></button>
                    <input type="range" class="form-range volume-slider" id="volume-slider" min="0" max="100" value="80">
                </div>
            </div>
        </div>
    </div>

    <div class="toast-container" id="toast-container"></div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/js/bootstrap.bundle.min.js"></script>
    <script>
        // --- Configuration ---
        const SPOTIFY_CLIENT_ID = '4d0ff47f37aa45778cba889ad86cfb5a'; // Your new Client ID
        // ** Client Secret is NOT used in this client-side implementation **
        const REDIRECT_URI = window.location.origin + window.location.pathname;
        const SCOPE = [ // Scopes for user data access (no 'streaming' needed now)
            'user-read-private',
            'user-read-email',
            'user-top-read',
            'playlist-read-private',
            'playlist-read-collaborative'
            // Removed: user-read-playback-state, user-modify-playback-state
        ].join(' ');
        const APP_NAME = 'AuraBeat';

        // --- State Variables ---
        let accessToken = null;
        let currentTrack = null; // Track object being played (preview)
        let isPlaying = false;
        let currentVolume = 80;
        let isMuted = false;
        let previousVolume = 80;
        let audioElement = null; // Will get reference to the <audio> element
        let currentQueue = []; // Array of track objects for potential next/prev preview
        let currentQueueIndex = -1;
        let progressUpdateInterval = null;

        let currentView = 'main';
        let lastSearchData = null;
        let currentCategory = 'all';

        // --- DOM Elements ---
        const loginSection = document.getElementById('login-section');
        const mainContent = document.getElementById('main-content');
        const browseSections = document.getElementById('browse-sections');
        const searchResultsContainerEl = document.getElementById('search-results-container');
        const searchResultsTitle = document.getElementById('search-results-title');
        const detailsView = document.getElementById('details-view');
        const detailsContent = document.getElementById('details-content');
        const loginButton = document.getElementById('login-button');
        const searchInput = document.getElementById('search-input');
        const searchButton = document.getElementById('search-button');
        const searchResults = document.getElementById('search-results');
        const categoryPillsContainer = document.getElementById('category-pills-container');
        const categoryPills = categoryPillsContainer.querySelectorAll('.category-pill');
        const loadingElement = document.getElementById('loading');
        const loadingFeatured = document.getElementById('loading-featured');
        const loadingReleases = document.getElementById('loading-releases');
        const loadingSearch = document.getElementById('loading-search');
        const loadingDetails = document.getElementById('loading-details');
        const playerContainer = document.getElementById('player-container');
        const currentlyPlayingImg = document.getElementById('currently-playing-img');
        const currentlyPlayingTitle = document.getElementById('currently-playing-title');
        const currentlyPlayingArtist = document.getElementById('currently-playing-artist');
        const playPauseButton = document.getElementById('play-pause-button');
        const prevButton = document.getElementById('prev-button');
        const nextButton = document.getElementById('next-button');
        const progressBar = document.getElementById('progress-bar');
        const progressBarContainer = document.getElementById('progress-bar-container');
        const currentTimeDisplay = document.getElementById('current-time');
        const totalTimeDisplay = document.getElementById('total-time');
        const volumeSlider = document.getElementById('volume-slider');
        const volumeButton = document.getElementById('volume-button');
        const userProfile = document.getElementById('user-profile');
        const userName = document.getElementById('user-name');
        const userAvatar = document.getElementById('user-avatar');
        const featuredPlaylistsContainer = document.getElementById('featured-playlists');
        const newReleasesContainer = document.getElementById('new-releases');
        const backButton = document.getElementById('back-button');
        const toastContainer = document.getElementById('toast-container');
        const audioPlayer = document.getElementById('audio-player'); // Get the audio element

        // --- Constants ---
        const PLACEHOLDER_IMAGE = 'data:image/svg+xml;charset=UTF-8,%3Csvg%20width%3D%22300%22%20height%3D%22300%22%20xmlns%3D%22http%3A%2F%2Fwww.w3.org%2F2000%2Fsvg%22%20viewBox%3D%220%200%20300%20300%22%20preserveAspectRatio%3D%22none%22%3E%3Cdefs%3E%3Cstyle%20type%3D%22text%2Fcss%22%3E%23holder_17a7b2b7c8c%20text%20%7B%20fill%3A%23aaa%3Bfont-weight%3Anormal%3Bfont-family%3AHelvetica%2C%20monospace%3Bfont-size%3A15pt%20%7D%20%3C%2Fstyle%3E%3C%2Fdefs%3E%3Cg%20id%3D%22holder_17a7b2b7c8c%22%3E%3Crect%20width%3D%22300%22%20height%3D%22300%22%20fill%3D%22%23374151%22%3E%3C%2Frect%3E%3Cg%3E%3Ctext%20x%3D%22112.5%22%20y%3D%22156.6%22%3ENo%20Image%3C%2Ftext%3E%3C%2Fg%3E%3C%2Fg%3E%3C%2Fsvg%3E'; // Updated placeholder color
        const VOLUME_STORAGE_KEY = 'auraBeatVolume';

        // --- Initialization ---
        function init() {
             if (!SPOTIFY_CLIENT_ID || SPOTIFY_CLIENT_ID.includes('REPLACE')) {
                 alert('CRITICAL ERROR: Spotify Client ID is not set correctly.');
                 loginButton.disabled = true; loginButton.textContent = 'Setup Required'; return;
             }
             audioElement = document.getElementById('audio-player'); // Assign the audio element
             if (!audioElement) { console.error("Fatal Error: Audio element not found!"); return; }

             loadVolume();
             checkAuth();
             setupEventListeners();
             updateVolumeIcon();
        }

        // --- Authentication ---
        function checkAuth() { // Uses Implicit Grant (No Client Secret)
            const hash = window.location.hash.substring(1);
            const params = new URLSearchParams(hash);
            const token = params.get('access_token');
            const error = params.get('error');

             if (error) { console.error("Auth Error:", error); showToast(`Login failed: ${error}`, 'error'); window.location.hash = ''; showLoginView(); return; }
             if (token) { accessToken = token; sessionStorage.setItem('spotify_access_token', token); window.location.hash = ''; onAuthenticated(); }
             else { accessToken = sessionStorage.getItem('spotify_access_token'); if (accessToken) { spotifyApiFetch('me').then(() => onAuthenticated()).catch(() => { clearTokenAndReload(); }); } else { showLoginView(); } }
        }

        function authenticate() {
             if (!SPOTIFY_CLIENT_ID || SPOTIFY_CLIENT_ID.includes('REPLACE')) { alert("Spotify Client ID is not configured."); return; }
             const authUrl = `https://accounts.spotify.com/authorize?client_id=${SPOTIFY_CLIENT_ID}&response_type=token&redirect_uri=${encodeURIComponent(REDIRECT_URI)}&scope=${encodeURIComponent(SCOPE)}&show_dialog=true`;
             window.location.href = authUrl;
        }

        function onAuthenticated() {
            loginSection.classList.add('d-none');
            mainContent.classList.remove('d-none');
            detailsView.classList.add('d-none');
            currentView = 'main';
            fetchUserProfile();
            loadBrowseSections();
        }

        function clearTokenAndReload() { sessionStorage.removeItem('spotify_access_token'); accessToken = null; window.location.reload(); }

        // --- API Fetch Helper ---
        async function spotifyApiFetch(endpoint, options = {}) { /* Unchanged from SDK version, but 403/429 errors might be less critical now */
             if (!accessToken) { console.error("API Call Error: No Access Token."); showToast('Authentication needed.', 'error'); clearTokenAndReload(); throw new Error('No access token'); }
             const config = { ...options, headers: { ...options.headers, 'Authorization': `Bearer ${accessToken}`, 'Content-Type': 'application/json' } };
             if (config.body && typeof config.body === 'object') config.body = JSON.stringify(config.body);

             try {
                 const response = await fetch(`https://api.spotify.com/v1/${endpoint}`, config);
                 if (response.status === 401) { console.error("API Error 401: Unauthorized."); showToast('Session expired. Please log in.', 'warning'); clearTokenAndReload(); throw new Error('Unauthorized'); }
                 if (response.status === 403) { const err = await response.json().catch(() => ({})); console.error("API Error 403: Forbidden.", err); showToast(`Action Forbidden: ${err?.error?.message || 'Permission Denied'}`, 'warning'); throw new Error('Forbidden'); }
                 if (response.status === 429) { console.warn("API Error 429: Rate Limit Exceeded."); showToast('Too many requests. Please wait a moment.', 'warning'); throw new Error('Rate limited'); }
                 if (!response.ok) { const err = await response.json().catch(() => ({})); console.error(`API Error ${response.status}:`, err); throw new Error(`API Error (${response.status}): ${err?.error?.message || response.statusText}`); }
                 if (response.status === 204 || response.headers.get('content-length') === '0') return null;
                 return await response.json();
             } catch (error) { if (!(error.message === 'Unauthorized' || error.message === 'Forbidden' || error.message === 'Rate limited')) { console.error('Network/Fetch Error:', error); showToast(`Network Error: ${error.message}`, 'error'); } throw error; }
        }


        // --- UI / Data Fetching ---
        async function fetchUserProfile() { /* Unchanged */ try { const d = await spotifyApiFetch('me'); userName.textContent = d.display_name||'User'; userAvatar.src = d.images?.[0]?.url||PLACEHOLDER_IMAGE; userProfile.classList.remove('d-none'); } catch(e){ showToast('Failed to load profile.', 'error');} }
        function loadBrowseSections() { fetchFeaturedPlaylists(); fetchNewReleases(); }
        async function fetchFeaturedPlaylists() { /* Unchanged */ showLoading(featuredPlaylistsContainer, loadingFeatured); try { const d = await spotifyApiFetch('browse/featured-playlists?limit=10&country=US'); displayItems(d?.playlists?.items||[], featuredPlaylistsContainer, 'playlist'); } catch (e) { featuredPlaylistsContainer.innerHTML = '<p class="text-secondary col-12">Could not load featured playlists.</p>'; } finally { hideLoading(featuredPlaylistsContainer, loadingFeatured); } }
        async function fetchNewReleases() { /* Unchanged */ showLoading(newReleasesContainer, loadingReleases); try { const d = await spotifyApiFetch('browse/new-releases?limit=10&country=US'); displayItems(d?.albums?.items||[], newReleasesContainer, 'album'); } catch (e) { newReleasesContainer.innerHTML = '<p class="text-secondary col-12">Could not load new releases.</p>'; } finally { hideLoading(newReleasesContainer, loadingReleases); } }
        async function performSearch() { /* Unchanged */ const q = searchInput.value.trim(); if (!q) { showToast('Enter something to search for.', 'info'); return; } showMainView(false); browseSections.classList.add('d-none'); searchResultsContainerEl.classList.remove('d-none'); categoryPillsContainer.classList.remove('d-none'); searchResultsTitle.textContent = `Results for "${q}"`; currentView = 'search'; showLoading(searchResults, loadingSearch); try { const d = await spotifyApiFetch(`search?q=${encodeURIComponent(q)}&type=track,artist,album,playlist&limit=20&market=from_token`); lastSearchData = { ...d, query: q }; filterAndDisplayResults(lastSearchData); } catch (e) { searchResults.innerHTML = `<p class="text-center text-secondary col-12">Search failed.</p>`; } finally { hideLoading(searchResults, loadingSearch); } }
        function filterAndDisplayResults(data) { /* Unchanged */ if (!data || currentView !== 'search') return; searchResults.innerHTML = ''; let hasResults = false; const frag = document.createDocumentFragment(); const match = (type) => currentCategory === 'all' || currentCategory === type; const add = (items, type) => { if(items && match(type)) items.forEach(i => {if(i){frag.appendChild(createCard(i,type));hasResults=true;}});}; add(data.tracks?.items,'track'); add(data.artists?.items,'artist'); add(data.albums?.items,'album'); add(data.playlists?.items,'playlist'); searchResults.appendChild(frag); if(!hasResults){searchResults.innerHTML = `<div class="col-12 text-center p-5"><h4 class="text-secondary">No results found for "${data.query}" in this category.</h4></div>`;}}
        async function fetchDetails(type, id) { /* Mostly unchanged, calls renderDetailsPage */ showMainView(false); browseSections.classList.add('d-none'); searchResultsContainerEl.classList.add('d-none'); mainContent.classList.add('d-none'); detailsView.classList.remove('d-none'); showDetailsLoading(); currentView = 'details'; try { let d, items=[], headerHtml='', contextUri=''; switch(type) { case 'artist': d=await spotifyApiFetch(`artists/${id}`); const top=await spotifyApiFetch(`artists/${id}/top-tracks?market=US`); items=top?.tracks||[]; headerHtml=createDetailsHeader(d,type); contextUri=d.uri; break; case 'album': d=await spotifyApiFetch(`albums/${id}?market=US`); items=await fetchFullTracksForAlbum(d?.tracks?.items||[]); headerHtml=createDetailsHeader(d,type); contextUri=d.uri; break; case 'playlist': d=await spotifyApiFetch(`playlists/${id}?market=US`); const plItems=await spotifyApiFetch(`playlists/${id}/tracks?limit=50&market=US`); items=plItems?.items?.map(i=>i.track).filter(t=>t&&t.type==='track')||[]; headerHtml=createDetailsHeader(d,type); contextUri=d.uri; break; default: throw new Error('Unknown type'); } renderDetailsPage(headerHtml, items, 'track', { uri: contextUri, type: type, name: d.name }); } catch(e){ detailsContent.innerHTML = `<p class="text-center text-secondary col-12">Failed to load details: ${e.message}</p>`; showToast('Error loading details.','error');} finally { hideDetailsLoading(); } }
        async function fetchFullTracksForAlbum(simpleTracks) { /* Unchanged */ if (!simpleTracks || simpleTracks.length === 0) return []; const trackIds = simpleTracks.map(t => t.id).filter(Boolean).join(','); if (!trackIds) return []; try { const d = await spotifyApiFetch(`tracks?ids=${trackIds}&market=US`); return d?.tracks || []; } catch (e) { console.error("Failed fetch full album tracks:", e); return simpleTracks; } }


        // --- UI Rendering ---
        function displayItems(items, container, type, isRecommendation = false) { /* Unchanged */ container.innerHTML = ''; if (!items || items.length === 0) { container.innerHTML = `<p class="text-center text-secondary col-12">Nothing found here right now.</p>`; return; } const frag = document.createDocumentFragment(); items.forEach(item => { if (item) frag.appendChild(createCard(item, type, isRecommendation)); }); container.appendChild(frag); }
        function createCard(item, type, isRecommendation = false) { /* Play button calls handlePreviewPlayAction */ const w = document.createElement('div'); w.className='col-lg-3 col-md-4 col-sm-6 item-card-wrapper'; w.dataset.id=item.id; w.dataset.type=type; w.dataset.uri=item.uri; let img, title, sub, badge, imgClass='item-img', tabIdx=0; try{ switch(type){ case 'track': img=item.album?.images?.[0]?.url||PLACEHOLDER_IMAGE; title=item.name; sub=item.artists?.map(a=>a.name).join(', ')||''; badge='Song'; break; case 'artist': img=item.images?.[0]?.url||PLACEHOLDER_IMAGE; title=item.name; sub=item.genres?.slice(0,2).join(', ')||(item.followers?.total||0).toLocaleString()+' followers'; badge='Artist'; imgClass+=' artist-img'; break; case 'album': img=item.images?.[0]?.url||PLACEHOLDER_IMAGE; title=item.name; sub=item.artists?.map(a=>a.name).join(', ')||''; badge=item.album_type?item.album_type[0].toUpperCase()+item.album_type.slice(1):'Album'; break; case 'playlist': img=item.images?.[0]?.url||PLACEHOLDER_IMAGE; title=item.name; sub=item.description||`By ${item.owner?.display_name||'Spotify'}`; badge='Playlist'; break; default: return w; } }catch(e){ console.error("Card data error:",item,e); return w;} w.innerHTML=`<div class="item-card" tabindex="${tabIdx}"><div class="card-img-container"><img src="${img}" alt="" class="${imgClass}" loading="lazy"><div class="play-button-wrapper"><button class="play-button" aria-label="Play Preview ${title}"><i class="fas fa-play"></i></button></div></div><div class="card-info"><div class="item-title">${title||''}</div><div class="item-subtitle">${sub||''}</div>${badge?`<span class="item-type-badge">${badge}</span>`:''}</div></div>`; const card=w.querySelector('.item-card'); const btn=w.querySelector('.play-button'); btn.addEventListener('click',(e)=>{ e.stopPropagation(); handlePreviewPlayAction(item, type); }); if(type!=='track'){card.addEventListener('click',()=>fetchDetails(type, item.id)); card.addEventListener('keydown',(e)=>{if(e.key==='Enter')fetchDetails(type, item.id);});} else { card.addEventListener('click',()=>handlePreviewPlayAction(item,type)); card.addEventListener('keydown',(e)=>{if(e.key==='Enter')handlePreviewPlayAction(item, type);}); card.style.cursor='pointer';} return w; }
        function createDetailsHeader(data, type, trackData = null) { /* Unchanged */ let img, title, sub1='', sub2='', badge='', imgCls='details-img', ctxUri=data.uri; switch(type){ case 'artist': img=data.images?.[0]?.url||PLACEHOLDER_IMAGE; title=data.name; sub1=`${(data.followers?.total||0).toLocaleString()} followers`; sub2=data.genres?.slice(0,3).map(g=>g[0].toUpperCase()+g.slice(1)).join(', ')||(data.popularity?`Popularity: ${data.popularity}`:''); badge='Artist'; imgCls+=' artist'; break; case 'album': img=data.images?.[0]?.url||PLACEHOLDER_IMAGE; title=data.name; if(trackData){title=trackData.name; sub1=`From "${data.name}"`; sub2=trackData.artists?.map(a=>a.name).join(', ')||''; badge='Song'; ctxUri=trackData.uri;} else {sub1=data.artists?.map(a=>a.name).join(', ')||''; sub2=`${data.total_tracks||0} tracks • ${data.release_date?.substring(0,4)||''}`; badge=data.album_type?data.album_type[0].toUpperCase()+data.album_type.slice(1):'Album';} break; case 'playlist': img=data.images?.[0]?.url||PLACEHOLDER_IMAGE; title=data.name; sub1=`By ${data.owner?.display_name||'Spotify'}`; sub2=`${data.tracks?.total||0} tracks ${data.followers?.total?'• '+data.followers.total.toLocaleString()+' likes':''}`; badge='Playlist'; break; default: return ''; } return `<div class="details-header"><img src="${img}" alt="" class="${imgCls}"><div class="details-info">${badge?`<span class="item-type-badge mb-2">${badge}</span>`:''}<h1>${title}</h1>${sub1?`<p>${sub1}</p>`:''}${sub2?`<p class="text-secondary">${sub2}</p>`:''}<button class="btn btn-success btn-lg mt-3 play-context-button" data-uri="${ctxUri}" data-type="${type}"><i class="fas fa-play me-2"></i>Play Preview</button></div></div>`; }
        function renderDetailsPage(headerHtml, items, itemType, contextData) { /* Play buttons call handlePreviewPlayAction */ let listHtml=`<h3 class="section-title mt-4">${items.length > 0 ? 'Tracks (Previews Available)' : 'No Playable Tracks Found'}</h3>`; let playableCount = 0; if(items.length>0){ listHtml+='<ul class="track-list">'; items.forEach((track, idx)=>{ if(track&&track.id&&track.type==='track'){ const dur=track.duration_ms?formatTime(track.duration_ms/1000):'--:--'; const canPlay=!!track.preview_url && track.is_playable!==false && !track.is_local; if(canPlay) playableCount++; listHtml+=`<li class="track-list-item" data-track-index="${idx}" data-track-uri="${track.uri}" tabindex="0"><span class="track-number">${idx+1}</span><div class="track-details"><div class="track-list-title">${track.name||''}</div><div class="track-list-artist">${track.artists?.map(a=>a.name).join(', ')||''}</div></div><span class="track-duration">${dur}</span><button class="track-play-button" aria-label="Play Preview ${track.name}" ${!canPlay?'disabled title="Preview unavailable"':''}><i class="fas fa-play"></i></button></li>`; }}); listHtml+='</ul>'; } if(playableCount === 0 && items.length > 0) { listHtml += `<p class="text-secondary text-center mt-3">No 30-second previews available for tracks in this ${contextData.type}.</p>`;} else if (items.length === 0) { listHtml += `<p class="text-secondary text-center mt-3">This ${contextData.type} appears to be empty.</p>`; } detailsContent.innerHTML=headerHtml+listHtml; const ctxPlayBtn=detailsContent.querySelector('.play-context-button'); if(ctxPlayBtn)ctxPlayBtn.addEventListener('click',()=>{handlePreviewPlayAction(contextData, contextData.type);}); detailsContent.querySelectorAll('.track-list-item').forEach(itemEl=>{ const btn=itemEl.querySelector('.track-play-button'); const idx=parseInt(itemEl.dataset.trackIndex,10); const track=items[idx]; const playFunc=()=>{if(btn.disabled||!track)return; handlePreviewPlayAction(track,'track',items,idx);}; if(btn){btn.addEventListener('click',playFunc);} itemEl.addEventListener('click',(e)=>{if(e.target!==btn&&!btn.contains(e.target))playFunc();}); itemEl.addEventListener('keydown',(e)=>{if(e.key==='Enter')playFunc();}); }); }

        // --- Player Logic (Using <audio> Element for Previews) ---

        // Action handler - determines what track/context to play preview for
        async function handlePreviewPlayAction(item, type, contextList = [], startIndex = 0) {
            let trackToPlay = null;
            let queue = [];
            let queueIndex = 0;

            showToast(`Loading preview for ${item.name}...`, 'info');

            try {
                switch (type) {
                    case 'track':
                        trackToPlay = item;
                        queue = contextList.length > 0 ? contextList : [item]; // Use context if provided
                        queueIndex = startIndex;
                        break;
                    case 'artist':
                         // Get top tracks to find one with a preview
                         const topTracks = await spotifyApiFetch(`artists/${item.id}/top-tracks?market=US`);
                         queue = topTracks?.tracks || [];
                         trackToPlay = queue.find(t => t.preview_url); // Find first playable
                         queueIndex = trackToPlay ? queue.findIndex(t => t.id === trackToPlay.id) : -1;
                         if (!trackToPlay) throw new Error(`No previews available for ${item.name}'s top tracks.`);
                        break;
                    case 'album':
                         // Get album tracks (preferably full ones fetched earlier)
                         const albumTracks = contextList.length > 0 ? contextList : await fetchFullTracksForAlbum(item?.tracks?.items || []);
                         queue = albumTracks;
                         trackToPlay = queue.find(t => t && t.preview_url);
                         queueIndex = trackToPlay ? queue.findIndex(t => t.id === trackToPlay.id) : -1;
                         if (!trackToPlay) throw new Error(`No previews available in album ${item.name}.`);
                        break;
                    case 'playlist':
                         // Get playlist tracks (preferably full ones fetched earlier)
                         const plTracks = contextList.length > 0 ? contextList : (await spotifyApiFetch(`playlists/${item.id}/tracks?limit=50&market=US`))?.items?.map(i=>i.track).filter(Boolean) || [];
                         queue = plTracks;
                         trackToPlay = queue.find(t => t && t.preview_url);
                         queueIndex = trackToPlay ? queue.findIndex(t => t.id === trackToPlay.id) : -1;
                         if (!trackToPlay) throw new Error(`No previews available in playlist ${item.name}.`);
                        break;
                    default:
                        throw new Error(`Cannot play type: ${type}`);
                }

                // Filter queue for only playable tracks (with previews) for next/prev
                currentQueue = queue.filter(t => t && t.preview_url);
                currentQueueIndex = currentQueue.findIndex(t => t.id === trackToPlay.id); // Find index in filtered queue

                await playPreview(trackToPlay); // Pass the single track object to play

            } catch (error) {
                showToast(`Error loading preview: ${error.message}`, 'error');
                console.error("Preview Play Action Error:", error);
            }
        }


        // Plays a single track's preview URL
        async function playPreview(track) {
            if (!track) { console.error("playPreview: track is null"); return; }

             // Ensure we have preview_url, fetch full track if missing initially
            if (!track.preview_url && track.id && track.type === 'track') {
                try {
                    console.log(`Fetching full track details for preview: ${track.name}`);
                    const fullTrack = await spotifyApiFetch(`tracks/${track.id}?market=US`);
                    if (fullTrack?.preview_url) {
                        track = fullTrack; // Use the full track data
                    } else {
                        throw new Error("Preview URL not found even after fetching full track.");
                    }
                } catch (fetchError) {
                     showToast(`Preview unavailable for ${track.name}.`, 'warning');
                     console.error(fetchError);
                     stopPlayback(); // Ensure player stops if previous track was playing
                     updatePlayerUI(null); // Clear player UI
                     return;
                }
            } else if (!track.preview_url) {
                showToast(`Preview unavailable for ${track.name}.`, 'warning');
                 stopPlayback();
                 updatePlayerUI(null);
                return;
            }

            console.log(`Playing preview: ${track.name} - ${track.preview_url}`);
            currentTrack = track; // Set the currently playing track object
            audioElement.src = track.preview_url;
            audioElement.volume = isMuted ? 0 : currentVolume / 100;

            try {
                await audioElement.play();
                // isPlaying state and UI updates are handled by 'play'/'pause' event listeners
            } catch (error) {
                console.error("Error playing audio:", error);
                showToast(`Could not play preview: ${error.message}`, 'error');
                stopPlayback();
                updatePlayerUI(null);
            }
        }

        function togglePlayPause() {
            if (!currentTrack || !audioElement.src) { return; } // No track loaded

            if (audioElement.paused) {
                audioElement.play().catch(e => { console.error("Play error:", e); showToast("Playback failed.", "error"); });
            } else {
                audioElement.pause();
            }
            // Button icon updated by event listeners
        }

         function playNextPreview() {
             if (currentQueue.length > 0 && currentQueueIndex < currentQueue.length - 1) {
                 currentQueueIndex++;
                 playPreview(currentQueue[currentQueueIndex]);
             } else {
                 showToast('End of preview queue.', 'info');
                 stopPlayback(); // Stop at the end
                 updatePlayerUI(null); // Clear UI or show last track paused? Clear for now.
             }
         }

         function playPreviousPreview() {
             if (audioElement.currentTime > 3 && currentQueueIndex >= 0) {
                 // Restart current preview if played more than 3 seconds
                 audioElement.currentTime = 0;
                 audioElement.play().catch(e => console.error("Restart error:", e));
             } else if (currentQueue.length > 0 && currentQueueIndex > 0) {
                 // Go to previous track in the filtered queue
                 currentQueueIndex--;
                 playPreview(currentQueue[currentQueueIndex]);
             } else if (currentQueue.length > 0 && currentQueueIndex === 0) {
                  // At the start, just restart
                  audioElement.currentTime = 0;
                  audioElement.play().catch(e => console.error("Restart error:", e));
             }
         }

        function stopPlayback() {
             audioElement.pause();
             audioElement.currentTime = 0;
             audioElement.src = ''; // Clear source
             isPlaying = false;
             currentTrack = null;
             // currentQueue = []; // Decide if queue should be cleared on stop
             // currentQueueIndex = -1;
             if (progressUpdateInterval) clearInterval(progressUpdateInterval);
             progressUpdateInterval = null;
             updatePlayPauseButton();
             updateNextPrevButtons();
             updateProgressBar(); // Reset progress bar
             // Don't call updatePlayerUI(null) here, let the caller decide if UI should clear
        }

        function seekTrack(event) {
            if (!currentTrack || !audioElement.duration || !isFinite(audioElement.duration)) return;
            const rect = progressBarContainer.getBoundingClientRect();
            const percentage = Math.max(0, Math.min(1, (event.clientX - rect.left) / rect.width));
            audioElement.currentTime = percentage * audioElement.duration;
            updateProgressBar(); // Update UI immediately
        }

        function changeVolume() {
            currentVolume = parseInt(volumeSlider.value, 10);
            isMuted = currentVolume === 0;
            if (!isMuted) previousVolume = currentVolume;
            audioElement.volume = currentVolume / 100; // Volume 0.0 to 1.0
            saveVolume();
            updateVolumeIcon();
        }

        function toggleMute() {
            const targetVolume = isMuted ? (previousVolume > 0 ? previousVolume : 50) : 0;
            currentVolume = targetVolume;
            isMuted = targetVolume === 0;
            volumeSlider.value = currentVolume;
            audioElement.volume = currentVolume / 100;
            saveVolume();
            updateVolumeIcon();
        }

        // --- UI Updates ---
        function updatePlayerUI(track) {
            if (track) {
                currentlyPlayingImg.src = track.album?.images?.[0]?.url || PLACEHOLDER_IMAGE;
                currentlyPlayingTitle.textContent = track.name;
                currentlyPlayingArtist.textContent = track.artists?.map(a => a.name).join(', ') || '';
                playerContainer.style.display = 'flex';
                playPauseButton.disabled = false; // Enable play button
                updateNextPrevButtons(); // Update next/prev based on queue
            } else { // No track playing or stopped
                currentlyPlayingImg.src = PLACEHOLDER_IMAGE;
                currentlyPlayingTitle.textContent = APP_NAME;
                currentlyPlayingArtist.textContent = 'Select a preview';
                playerContainer.style.display = 'flex'; // Keep player visible
                playPauseButton.disabled = true;
                prevButton.disabled = true;
                nextButton.disabled = true;
                updateProgressBar(); // Reset progress
            }
        }

        function updatePlayPauseButton() { playPauseButton.innerHTML = isPlaying ? '<i class="fas fa-pause"></i>' : '<i class="fas fa-play"></i>'; playPauseButton.title = isPlaying ? 'Pause Preview' : 'Play Preview'; playPauseButton.disabled = !currentTrack; }
        function updateNextPrevButtons() { prevButton.disabled = currentQueueIndex <= 0; nextButton.disabled = currentQueueIndex >= currentQueue.length - 1; }
        function updateProgressBar() {
            if (progressUpdateInterval) clearInterval(progressUpdateInterval);
            if (!currentTrack || !audioElement.duration || !isFinite(audioElement.duration) || audioElement.duration === 0) {
                progressBar.style.width = '0%';
                currentTimeDisplay.textContent = '0:00';
                totalTimeDisplay.textContent = '0:30'; // Default to 30s for preview
                return;
            }
            const duration = audioElement.duration; // Actual duration, likely ~30s
            const update = () => {
                const currentTime = audioElement.currentTime;
                const percentage = (currentTime / duration) * 100;
                progressBar.style.width = `${Math.min(100, percentage)}%`;
                currentTimeDisplay.textContent = formatTime(currentTime);
                totalTimeDisplay.textContent = formatTime(duration); // Show actual preview duration
            };
            update();
            if (isPlaying) { progressUpdateInterval = setInterval(update, 250); }
        }
        function updateVolumeIcon() { let i='up'; if(currentVolume===0||isMuted)i='mute'; else if(currentVolume<=50)i='down'; volumeButton.innerHTML=`<i class="fas fa-volume-${i}"></i>`; volumeButton.title=isMuted?'Unmute':'Mute'; }
        function disablePlayerControls() { [playPauseButton, prevButton, nextButton].forEach(el=>el.disabled=true); progressBarContainer.style.cursor='default'; if(progressUpdateInterval)clearInterval(progressUpdateInterval);progressUpdateInterval=null; }
        function enablePlayerControls() { /* Play/Pause/Next/Prev enabled by state updates */ progressBarContainer.style.cursor='pointer'; }


        // --- Utilities ---
        function formatTime(s){if(isNaN(s)||s===Infinity)return'--:--'; const t=Math.floor(s); const m=Math.floor(t/60); const se=t%60; return`${m}:${se<10?'0':''}${se}`;}
        function saveVolume(){localStorage.setItem(VOLUME_STORAGE_KEY, currentVolume.toString());}
        function loadVolume(){const v=localStorage.getItem(VOLUME_STORAGE_KEY); if(v!==null){ currentVolume=parseInt(v,10); volumeSlider.value=currentVolume; previousVolume=currentVolume; audioElement.volume=currentVolume/100;} else { audioElement.volume = currentVolume / 100; }} // Set initial volume
        function showLoginView(){loginSection.classList.remove('d-none'); mainContent.classList.add('d-none'); detailsView.classList.add('d-none'); playerContainer.style.display='none'; userProfile.classList.add('d-none');}
        function showMainView(reloadBrowse=false){loginSection.classList.add('d-none'); mainContent.classList.remove('d-none'); detailsView.classList.add('d-none'); browseSections.classList.remove('d-none'); searchResultsContainerEl.classList.add('d-none'); categoryPillsContainer.classList.add('d-none'); currentView='main'; if(reloadBrowse)loadBrowseSections();}
        function showDetailsLoading(){detailsContent.innerHTML=''; loadingDetails.classList.remove('d-none');}
        function hideDetailsLoading(){loadingDetails.classList.add('d-none');}
        function showLoading(c, l){if(l){l.classList.remove('d-none'); if(c)c.innerHTML=''; c?.appendChild(l);}}
        function hideLoading(c, l){if(l)l.classList.add('d-none'); if(c && c.contains(l))c.removeChild(l);}
        function showToast(m,t='info'){const d=document.createElement('div'); d.className=`toast ${t}`; d.textContent=m; toastContainer.appendChild(d); setTimeout(()=>{d.classList.add('show')},10); setTimeout(()=>{d.classList.remove('show');setTimeout(()=>{if(d.parentNode===toastContainer)toastContainer.removeChild(d)},500)},3500);}

        // --- Event Listeners Setup ---
        function setupEventListeners() {
            loginButton.addEventListener('click', authenticate);
            searchButton.addEventListener('click', performSearch);
            searchInput.addEventListener('keypress', (e) => { if (e.key === 'Enter') performSearch(); });
            playPauseButton.addEventListener('click', togglePlayPause);
            prevButton.addEventListener('click', playPreviousPreview);
            nextButton.addEventListener('click', playNextPreview);
            progressBarContainer.addEventListener('click', seekTrack);
            volumeSlider.addEventListener('input', changeVolume);
            volumeButton.addEventListener('click', toggleMute);
            backButton.addEventListener('click', () => showMainView(false));

            categoryPills.forEach(pill => { pill.addEventListener('click', function() { categoryPills.forEach(p => p.classList.remove('active')); this.classList.add('active'); currentCategory = this.dataset.category; filterAndDisplayResults(lastSearchData); }); });

            // Audio Element Listeners
            audioElement.addEventListener('play', () => { isPlaying = true; updatePlayPauseButton(); updateProgressBar(); });
            audioElement.addEventListener('pause', () => { isPlaying = false; if(progressUpdateInterval)clearInterval(progressUpdateInterval);progressUpdateInterval=null; updatePlayPauseButton(); });
            audioElement.addEventListener('ended', () => { isPlaying = false; if(progressUpdateInterval)clearInterval(progressUpdateInterval);progressUpdateInterval=null; updatePlayPauseButton(); updateProgressBar(); showToast('Preview ended.', 'info'); playNextPreview(); /* Attempt to play next */ }); // Play next on end
            audioElement.addEventListener('timeupdate', updateProgressBar); // Update progress while playing
            audioElement.addEventListener('loadedmetadata', updateProgressBar); // Update duration display when loaded
            audioElement.addEventListener('error', (e) => { console.error("Audio Error:", e); showToast('Error playing preview.', 'error'); stopPlayback(); updatePlayerUI(null); });
        }

        // --- Run ---
        window.addEventListener('DOMContentLoaded', init);
    </script>

</body>
</html>
